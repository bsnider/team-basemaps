// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/extendsHelper","../core/tsSupport/decorateHelper","../core/JSONSupporter","../Viewpoint","../Basemap","../support/basemapUtils","../core/Collection","../core/collectionUtils","../core/promiseUtils","./Environment","./Lighting","dojo/_base/lang","../views/3d/lib/glMatrix","../core/accessoireSupport/typescript"],function(t,e,i,n,r,o,a,s,p,l,u,c,h,m,v,y){function d(t){return t.map(function(t){return{id:t.id}})}var g=0,b=function(t){function e(e){t.call(this,e),this._currentAnimation=null,this.id=null,this.title=null,this.description=null,this.thumbnail=null,this.viewpoint=null,this.basemap=null,this.visibleLayers=null,this.environment=null}return i(e,t),e.prototype.getDefaults=function(){return{id:Date.now().toString(16)+"-slide-"+g++,thumbnail:{},title:{},description:{},viewpoint:new o,environment:new c,visibleLayers:[]}},e.prototype.clone=function(){return new e({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,visibleLayers:d(this.visibleLayers),environment:this.environment&&this.environment.clone()||null})},e.prototype.toJSON=function(){var t={id:this.id,title:this.title.toJSON(),thumbnail:this.thumbnail.toJSON(),viewpoint:this.viewpoint.toJSON(),baseMap:this.basemap.toJSON(),visibleLayers:d(this.visibleLayers).toArray(),environment:this.environment.toJSON()};return null!=this.description&&this.description.text&&(t.description=this.description.toJSON()),t},e.prototype._updateVisibleLayersFrom=function(t){var e=this,i=[];return u.eachAlways(this._allLayers(t.map).map(function(e){return t.whenLayerView(e).then(function(t){t.visible&&i.push({id:t.layer.id})})}).toArray()).then(function(){e.visibleLayers.removeAll(),e.visibleLayers.addMany(i)})},e.prototype.updateFrom=function(t,e){var i=this;return e=m.mixin({screenshot:m.mixin({format:"jpeg",quality:80,width:120,height:75},e&&e.screenshot)},e),this._updateVisibleLayersFrom(t).then(function(){return i.viewpoint=t.viewpoint.clone(),i.environment.lighting=h.prototype.clone.apply(t.environment.lighting),i.basemap=t.map.basemap&&t.map.basemap.clone()||null,t.takeScreenshot(e.screenshot)}).then(function(t){return i.thumbnail=new f({url:t.dataURL}),i})},e.prototype.applyTo=function(t,e){var i=this,n=m.mixin({animate:!0},e);return this._applyBasemap(t).then(function(){return i._applyLayerVisibility(t)}).then(function(){return i._applyViewpoint(t,n)}).then(function(){return i})},e.prototype._applyBasemap=function(t){var e=this;return this.basemap?this.basemap.load().always(function(){t.map.basemap=s.clonePreservingTiledLayers(e.basemap,t.map.basemap)}):u.resolve()},e.prototype._allLayers=function(t){var e=new p;return this._collectLayers(t,e),this._collectLayers(t.ground,e),e},e.prototype._collectLayers=function(t,e){var i=this;t.layers.forEach(function(t){e.add(t);var n=t;n.layers&&i._collectLayers(n,e)})},e.prototype._applyLayerVisibility=function(t){var e=this;if(this.visibleLayers)return u.eachAlways(this._allLayers(t.map).map(function(i){return t.whenLayerView(i).then(function(t){t.visible=e.visibleLayers.some(function(e){var i=e.id;return i===t.layer.id})})}).toArray())},e.prototype._applyViewpoint=function(t,e){return this.viewpoint.camera.fov=t.camera.fov,e.animate?this.get("environment.lighting.date")?this._animateToLighting(t).then(function(){}):(t.environment.lighting=this.environment.lighting.clone(),t.goTo(this.viewpoint).then(function(){})):(t.viewpoint=this.viewpoint,t.environment.lighting=this.environment.lighting.clone(),u.resolve())},e.prototype._animateToLighting=function(t){var e,i=this;return"global"===t.viewingMode&&(e=this._animateLightingWithCamera(t)),this._currentAnimation&&(this._currentAnimation.stop(),this._currentAnimation=null),t.environment.lighting.cameraTrackingEnabled=!1,t.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,t.environment.lighting.ambientOcclusionEnabled=this.environment.lighting.ambientOcclusionEnabled,null!=this.environment.lighting.displayUTCOffset&&(t.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset),this._currentAnimation=t.goTo(this.viewpoint),this._currentAnimation.then(function(n){e&&e.remove(),i._currentAnimation===n&&(t.environment.lighting.cameraTrackingEnabled=!0),"finished"===n.state&&(t.environment.lighting=i.environment.lighting.clone())}),this._currentAnimation},e.prototype._getTime=function(t){var e=t.getTime(),i=3600*t.getUTCHours()+60*t.getUTCMinutes()+t.getUTCSeconds();return[e,i]},e.prototype._setTime=function(t,e,i){return t.setTime(e),t.setUTCHours(i/3600),t.setUTCMinutes(i%3600/60),t.setUTCSeconds(i%3600%60),t},e.prototype._animateLightingWithCamera=function(t){var e=this,i=v.vec3d,n=new Date(t.environment.lighting.date.toString()),r=this._getTime(n),o=r[0],a=r[1],s=this._getTime(this.environment.lighting.date),p=s[0],l=s[1],u=t.renderCoordsHelper,c=[0,0,0];u.toRenderCoords(t.camera.position,c);var h=[0,0,0];u.toRenderCoords(this.viewpoint.camera.position,h);var m=[0,0,0],y=new Date;return t.watch("camera",function(n){u.toRenderCoords(n.position,m);var r=i.dist2(c,m),s=i.dist2(h,m),v=0;r+s!==0&&(v=r/(r+s));var d=o+(p-o)*v,g=a+(l-a)*v;t.environment.lighting.date=e._setTime(y,d,g)})},e.createFrom=function(t,i){var n=new e;return n.updateFrom(t,i)},e.sanitizeJSON=function(t){var e;e=void 0!==t.visibleLayers&&Array.isArray(t.visibleLayers)?d(t.visibleLayers):[];var i={id:t.id||"",title:t.title||{text:""},thumbnail:t.thumbnail||{url:""},viewpoint:t.viewpoint,baseMap:t.baseMap,visibleLayers:e};return void 0!==t.description&&(i.description=t.description),void 0!==t.environment&&(i.environment=c.sanitizeJSON(t.environment)),i},n([y.shared("esri.webscene.Slide")],e.prototype,"declaredClass",void 0),n([y.shared({reader:{exclude:["baseMap"],add:["basemap"]}})],e.prototype,"classMetadata",void 0),n([y.property({value:""})],e.prototype,"id",void 0),n([y.property({type:w})],e.prototype,"title",void 0),n([y.property({type:L})],e.prototype,"description",void 0),n([y.property({type:f})],e.prototype,"thumbnail",void 0),n([y.property({type:o})],e.prototype,"viewpoint",void 0),n([y.property({reader:function(t,e){return e.baseMap&&0!==e.baseMap.baseMapLayers.length?a.fromJSON(e.baseMap):null},setter:function(t){return s.ensureType(t)}})],e.prototype,"basemap",void 0),n([y.property({reader:function(t){return t.map(function(t){return{id:t.id}})},setter:l.referenceSetter})],e.prototype,"visibleLayers",void 0),n([y.property({type:c})],e.prototype,"environment",void 0),e=n([y.subclass()],e)}(r),f=function(t){function e(){t.apply(this,arguments)}return i(e,t),e.prototype.toJSON=function(){return{url:this.url}},e.prototype.clone=function(){return new e({url:this.url})},n([y.property({value:""})],e.prototype,"url",void 0),e=n([y.subclass()],e)}(r),w=function(t){function e(){t.apply(this,arguments)}return i(e,t),e.prototype.toJSON=function(){return{text:this.text}},e.prototype.clone=function(){return new e({text:this.text})},n([y.property({value:""})],e.prototype,"text",void 0),e=n([y.subclass()],e)}(r),L=function(t){function e(){t.apply(this,arguments)}return i(e,t),e.prototype.toJSON=function(){return{text:this.text}},e.prototype.clone=function(){return new e({text:this.text})},n([y.property({value:""})],e.prototype,"text",void 0),e=n([y.subclass()],e)}(r);return b});