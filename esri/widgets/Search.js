// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../core/lang","../core/watchUtils","./Search/SearchViewModel","./support/viewModelWiring","./Widget","dijit/_FocusMixin","dijit/_TemplatedMixin","dijit/a11yclick","dojo/dom","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/keys","dojo/on","dojo/query","dojo/i18n!./Search/nls/Search","dojo/text!./Search/templates/Search.html"],function(e,t,s,r,i,o,a,n,u,c,l,d,h,g,_,p,v){var S={base:"esri-search",hasValue:"esri-search--has-value",hasMultipleSources:"esri-search--multiple-sources",isSearchLoading:"esri-search--loading",showSuggestions:"esri-search--show-suggestions",showSources:"esri-search--sources",showNoResults:"esri-search--no-results",container:"esri-search__container",input:"esri-search__input",inputContainer:"esri-search__input-container",form:"esri-search__form",submitButton:"esri-search__submit-button",sourcesButton:"esri-search__sources-button",clearButton:"esri-search__clear-button",sourceName:"esri-search__source-name",suggestionsMenu:"esri-search__suggestions-menu",sourcesMenu:"esri-search__sources-menu",source:"esri-search__source",activeSource:"esri-search__source--active",noResultsMenu:"esri-search__no-results-menu",noResultsBody:"esri-search__no-results-body",noResultsHeader:"esri-search__no-results-header",noResultsText:"esri-search__no-results-text",noValueText:"esri-search__no-value-text",showMoreResults:"esri-search__more-results--show-more-results",moreResults:"esri-search__more-results",moreResultsList:"esri-search__more-results-list",moreResultsHeader:"esri-search__more-results-header",moreResultsLatLonHeader:"esri-search__more-results-lat-long-header",moreResultsItem:"esri-search__more-results-item",moreResultsListHeader:"esri-search__more-results-list-header",button:"esri-widget-button",fallbackText:"esri-icon-font-fallback-text",rotating:"esri-rotating",menu:"esri-menu",header:"esri-header",searchIcon:"esri-icon-search",dropdownIcon:"esri-icon-down-arrow esri-search__sources-button--down",dropupIcon:"esri-icon-up-arrow esri-search__sources-button--up",clearIcon:"esri-icon-close",spinnerIcon:"esri-icon-loading-indicator",noticeIcon:"esri-icon-notice-triangle"},m=i.createSubclass([a,o],{properties:{activeSource:{dependsOn:["viewModel.activeSource"]},activeSourceIndex:{dependsOn:["viewModel.activeSourceIndex"]},allPlaceholder:{dependsOn:["viewModel.allPlaceholder"]},autoNavigate:{dependsOn:["viewModel.autoNavigate"]},autoSelect:{dependsOn:["viewModel.autoSelect"]},defaultSource:{dependsOn:["viewModel.defaultSource"]},resultGraphicEnabled:{dependsOn:["viewModel.resultGraphicEnabled"]},resultGraphic:{dependsOn:["viewModel.resultGraphic"]},locationToAddressDistance:{dependsOn:["viewModel.locationToAddressDistance"]},minSuggestCharacters:{dependsOn:["viewModel.minSuggestCharacters"]},popupEnabled:{dependsOn:["viewModel.popupEnabled"]},popupTemplate:{dependsOn:["viewModel.popupTemplate"]},results:{dependsOn:["viewModel.results"]},searchAllEnabled:{dependsOn:["viewModel.searchAllEnabled"]},selectedResult:{dependsOn:["viewModel.selectedResult"]},popupOpenOnSelect:{dependsOn:["viewModel.popupOpenOnSelect"]},searchTerm:{dependsOn:["viewModel.searchTerm"]},sources:{dependsOn:["viewModel.sources"]},suggestions:{dependsOn:["viewModel.suggestions"]},suggestionsEnabled:{dependsOn:["viewModel.suggestionsEnabled"]},view:{dependsOn:["viewModel.view"]},viewModel:{type:s}},declaredClass:"esri.widgets.Search",baseClass:S.base,templateString:v,postCreate:function(){this.inherited(arguments);var e=this,s=this.viewModel,i=this.id+"_more_results";this._moreResultsId=i,s.getExtraSearchResultAttributes=this._getExtraSearchResultAttributes.bind(this),s.popupTemplate.set({title:p.searchResult,content:'<div class="{searchTheme}"><div id="{searchMoreResultsId}" class="{searchMoreResults}"><div class="{searchMoreResultsItem}">{searchResult}</div><div>{searchMoreResultsHtml}</div></div></div>'}),this.own(t.init(s,"placeholder",function(e){var t=this._getSourceName(s.activeSourceIndex);c.set(this._sourceNameNode,"textContent",t),c.set(this._inputNode,{placeholder:e})}.bind(this)),t.init(s,"searchTerm",function(e){var t=e?p.clearButtonTitle:"";e||(s.clear(),this._hideMenus(),this._hideLoading()),e!==this._inputNode.value&&c.set(this._inputNode,"value",e),c.set(this._clearNode,"title",t),l.toggle(this._containerNode,S.hasValue,e)}.bind(this)),t.init(s,"sources",function(e){this._updateSourcesMenu(e)}.bind(this)),t.init(s,"view.popup",function(e){var t=e&&e.domNode;t&&s.popupEnabled&&this.own(g(t,g.selector("#"+i+"_show",n),this._handleShowMoreResultsClick.bind(this)),g(t,g.selector("#"+i+"_list li a",n),this._handleMoreResultClick.bind(this)),g(t,g.selector("#"+i+" [data-switch-coordinates]",n),this._handleSwitchCoordinatesClick.bind(this)))}.bind(this)),s.on("search-complete",function(e){0===e.numResults&&(this._createEmptyResultsStructure(e.searchTerm),this._showNoResultsMenu()),this._hideLoading()}.bind(this)),s.on("suggest-complete",function(e){this._updateSuggestionsMenu(e.results,e.searchTerm)}.bind(this)),s.on("select-result",function(){this._hideMenus(),this._hideLoading()}.bind(this)),s.on("search-start",function(){this._hideMenus(),this._showLoading()}.bind(this)),s.on("search-clear, search-start",this._closePopup.bind(this)),g(this._submitNode,n,this._handleSearchButtonClick.bind(this)),g(this._sourceButtonNode,n,this._handleSourcesMenuToggleClick.bind(this)),g(this._inputNode,n,this._handleInputClick.bind(this)),g(this._clearNode,n,this._handleClearButtonClick.bind(this)),g(this._formNode,"submit",function(e){e.preventDefault(),s.cancelSuggest(),s.search()}.bind(this)),g(this._inputNode,"keyup",this._handleInputKey.bind(this)),g(this._sourceButtonNode,"keyup",this._handleSourceButtonKey.bind(this)),g(this._suggestionsNode,"li:click, li:keyup",function(t){e._suggestionsEvent(t,this)}),g(this._sourcesNode,"li:click, li:keyup",function(t){e._sourcesEvent(t,this)}),g(this._inputNode,"input, paste",function(){s.searchTerm!==this._inputNode.value&&(s.searchTerm=this._inputNode.value),s.suggest()}.bind(this)),this.on("blur",function(){this._hideMenus()}.bind(this))),r.setUpEventDelegates(this,["search-clear","search-complete","search-start","select-result","suggest-complete"])},_css:S,_i18n:p,_getActiveSourceAttr:r.createGetterDelegate("activeSource"),_setActiveSourceAttr:r.createSetterDelegate("activeSource"),_getActiveSourceIndexAttr:r.createGetterDelegate("activeSourceIndex"),_setActiveSourceIndexAttr:r.createSetterDelegate("activeSourceIndex"),_getAllPlaceholderAttr:r.createGetterDelegate("allPlaceholder"),_setAllPlaceholderAttr:r.createSetterDelegate("allPlaceholder"),_getAutoSelectAttr:r.createGetterDelegate("autoSelect"),_setAutoSelectAttr:r.createSetterDelegate("autoSelect"),_getDefaultSourceAttr:r.createGetterDelegate("defaultSource"),_setDefaultSourceAttr:r.createSetterDelegate("defaultSource"),_getResultGraphicAttr:r.createGetterDelegate("resultGraphic"),_setResultGraphicAttr:r.createSetterDelegate("resultGraphic"),_getMaxResultsAttr:r.createGetterDelegate("maxResults"),_setMaxResultsAttr:r.createSetterDelegate("maxResults"),_getMaxSuggestionsAttr:r.createGetterDelegate("maxSuggestions"),_setMaxSuggestionsAttr:r.createSetterDelegate("maxSuggestions"),_getMinSuggestCharactersAttr:r.createGetterDelegate("minSuggestCharacters"),_setMinSuggestCharactersAttr:r.createSetterDelegate("minSuggestCharacters"),_getPopupEnabledAttr:r.createGetterDelegate("popupEnabled"),_setPopupEnabledAttr:r.createSetterDelegate("popupEnabled"),_getPopupTemplateAttr:r.createGetterDelegate("popupTemplate"),_setPopupTemplateAttr:r.createSetterDelegate("popupTemplate"),_getSearchAllEnabledAttr:r.createGetterDelegate("searchAllEnabled"),_setSearchAllEnabledAttr:r.createSetterDelegate("searchAllEnabled"),_getResultsAttr:r.createGetterDelegate("results"),_setResultsAttr:r.createSetterDelegate("results"),_getSelectedResultAttr:r.createGetterDelegate("selectedResult"),_setSelectedResultAttr:r.createSetterDelegate("selectedResult"),_getPopupOpenOnSelectAttr:r.createGetterDelegate("popupOpenOnSelect"),_setPopupOpenOnSelectAttr:r.createSetterDelegate("popupOpenOnSelect"),_getSearchTermAttr:r.createGetterDelegate("searchTerm"),_setSearchTermAttr:r.createSetterDelegate("searchTerm"),_getSourcesAttr:r.createGetterDelegate("sources"),_setSourcesAttr:r.createSetterDelegate("sources"),_getSuggestionsAttr:r.createGetterDelegate("suggestions"),_setSuggestionsAttr:r.createSetterDelegate("suggestions"),_getSuggestionsEnabledAttr:r.createGetterDelegate("suggestionsEnabled"),_setSuggestionsEnabledAttr:r.createSetterDelegate("suggestionsEnabled"),_getViewAttr:r.createGetterDelegate("view"),_setViewAttr:r.createSetterDelegate("view"),clear:function(){var e=this.viewModel;e.clearGraphics(),c.get(this._inputNode,"value")&&c.set(this._inputNode,"value",""),e.searchTerm="",l.remove(this._containerNode,S.hasValue),c.set(this._clearNode,"title",""),this._hideMenus(),this._hideLoading(),this._closePopup()},focus:function(){this._focusManager.focus(this._inputNode)},blur:function(){this._focusManager.curNode&&this._focusManager.curNode.blur()},search:r.createMethodDelegate("search"),suggest:r.createMethodDelegate("suggest"),_getSourceName:function(e){var t=this.viewModel,r=t.sources;return e===s.ALL_INDEX?p.all:r.getItemAt(e).name},_getExtraSearchResultAttributes:function(e){return{searchTheme:S.root,searchResult:this._toSearchResultHTML(e),searchMoreResults:S.moreResults,searchMoreResultsItem:S.moreResultsItem,searchMoreResultsId:this._moreResultsId,searchMoreResultsHtml:this._toMoreResultsHTML()}},_handleClearButtonClick:function(){this.viewModel.clear(),this.focus()},_handleSwitchCoordinatesClick:function(e){e.preventDefault();var t=e.target,s=c.get(t,"data-switch-coordinates"),r=this.viewModel;s&&(r.cancelSuggest(),r.searchTerm=s,r.search())},_handleMoreResultClick:function(e){e.preventDefault();var t=e.target,s=parseInt(c.get(t,"data-source-index"),10),r=parseInt(c.get(t,"data-index"),10),i=this.viewModel,o=i.results;if(o&&o[s]&&o[s].results){var a=o[s].results[r];a&&i.select(a)}},_handleShowMoreResultsClick:function(e){e.preventDefault();var t,s=this._moreResultsId,r=u.byId(s);if(r){l.toggle(r,S.showMoreResults);var i=u.byId(s+"_show");i&&(t=l.contains(r,S.showMoreResults)?p.hideMoreResults:p.showMoreResults,c.set(i,"textContent",t))}this._repositionPopup()},_closePopup:function(){var e=this.viewModel;e.popupEnabled&&e.get("view.popup")&&e.view.popup.set("visible",!1)},_repositionPopup:function(){var e=this.viewModel;e.get("view.popup")&&e.view.popup.reposition()},_sourcesEvent:function(e,t){var r,i,o=c.get(t,"data-index"),a=_("li",this._sourcesNode),n=a.indexOf(t),u=e.keyCode;return o!==s.ALL_INDEX&&(o=parseInt(o,10)),u===h.ESCAPE?(this._hideSourcesMenu(),void this.focus()):"click"===e.type||u===h.ENTER?(this.viewModel.activeSourceIndex=o,this.focus(),this._updateSourcesMenu(this.viewModel.sources),void this._hideSourcesMenu()):u===h.UP_ARROW?(e.stopPropagation(),e.preventDefault(),r=n-1,i=0>r?this._sourceButtonNode:a[r],void this._focusManager.focus(i)):void(u===h.DOWN_ARROW&&(e.stopPropagation(),e.preventDefault(),r=n+1,i=r>=a.length?this._sourceButtonNode:a[r],this._focusManager.focus(i)))},_suggestionsEvent:function(e,t){var r,i=c.get(t,"data-source-index"),o=parseInt(c.get(t,"data-index"),10),a=_("li",this._suggestionsNode),n=this.viewModel,u=n.sources,l=a.indexOf(t),d=e.keyCode;if(i!==s.ALL_INDEX&&(i=parseInt(i,10)),n.cancelSuggest(),d===h.BACKSPACE||d===h.DELETE)return void this.focus();if(d===h.ESCAPE)return this._hideMenus(),void this.focus();if(d===h.UP_ARROW)return e.stopPropagation(),e.preventDefault(),r=l-1,void(0>r?this.focus():this._focusManager.focus(a[r]));if(d===h.DOWN_ARROW)return e.stopPropagation(),e.preventDefault(),r=l+1,void(r>=a.length?this.focus():this._focusManager.focus(a[r]));if("click"===e.type||d===h.ENTER){for(var g,p,v=n.suggestions,S=0;S<v.length;S++){var m=v[S];if(m.sourceIndex===i){g=m.results,p=g[o];break}}if(p){if(p.index=i,u.getItemAt(i).featureLayer){var f=u.getItemAt(i).featureLayer.objectIdField;p[s.OBJECT_ID_FIELD]=p.feature.attributes[f]}else p.magicKey&&p.text&&(n.searchTerm=p.text,n.currentSuggestion=p);n.search(p),this.focus()}}},_toSearchResultHTML:function(e){var t=e.feature&&e.feature.attributes&&e.feature.attributes.Addr_type&&"LatLong"===e.feature.attributes.Addr_type;if(!t)return e.name;var s,r,i=e.name.split(" ");if(2===i.length&&(s=i[0],r=i[1]),!r||!s)return e.name;s=parseFloat(s),r=parseFloat(r);var o=s+", "+r,a=r+", "+s,n=p,u="";return u+='<div class="'+S.moreResultsItem+'">',u+='<div class="'+S.moreResultsLatLonHeader+'">'+n.lonlat+"</div>",u+=o,u+="</div>",u+='<div class="'+S.moreResultsItem+'">',this._validSwitchCoordinates(r,s)&&(u+='<div class="'+S.moreResultsLatLonHeader+'">'+n.reverseLonLatHeader+"</div>",u+='<a data-switch-coordinates="'+a+'" tabindex="0" href="#">'+a+"</a>",u+="</div>"),u},_validSwitchCoordinates:function(e,t){return t!==e&&!(t>90||-90>t||e>180||-180>e)},_toMoreResultsHTML:function(){var e,t,s,r=this.viewModel,i="",o="",a=r.results,n=r.sources,u=0;if(a){o+='<div class="'+S.moreResultsItem+'">',o+='<a href="#" id="'+this._moreResultsId+'_show">'+p.showMoreResults+"</a>",o+="</div>",o+='<div class="'+S.moreResultsList+'">',o+='<div id="'+this._moreResultsId+'_list">';for(var c=0;c<a.length;c++)if(e=a[c].results,s=e&&e.length>0){t=e.length;var l=1===t&&e[0]===e;if(this._totalResults(a)>1&&!l){var d=this._getSourceName(c);o+='<div class="'+S.moreResultsListHeader+'">'+d+"</div>"}if(t&&!l){o+="<ul>";for(var h=n.getItemAt(c).maxResults||r.maxResults,g=0;t>g&&h>g;++g)e[g]!==e&&r.selectedResult!==e[g]&&(o+='<li><a tabindex="0" data-index="'+g+'" data-source-index="'+c+'" href="#">'+e[g].name+"</a></li>",u++);o+="</ul>"}}o+="</div>",o+="</div>"}return u>0&&(i+=o),i},_totalResults:function(e){return Object.keys(e).length},_handleSearchButtonClick:function(){var e=this.viewModel;e.cancelSuggest(),e.search()},_handleSourceButtonKey:function(e){if(e){var t=e.keyCode===h.UP_ARROW,s=e.keyCode===h.DOWN_ARROW;if(t||s){e.stopPropagation(),e.preventDefault(),this._showSourcesMenu();var r=_("li",this._sourcesNode),i=t?r.length-1:0;this._focusManager.focus(r[i])}}},_handleInputKey:function(e){if(e){var t,s,r,i=e.keyCode,o=e.ctrlKey||e.metaKey||i===h.copyKey||i===h.LEFT_ARROW||i===h.RIGHT_ARROW||i===h.ENTER,a=_("li",this._suggestionsNode),n=this.viewModel,u=n.suggestions;return o?e:i===h.TAB||i===h.ESCAPE?(n.cancelSuggest(),void this._hideMenus()):(t=i===h.UP_ARROW,s=i===h.DOWN_ARROW,t||s?(e.stopPropagation(),e.preventDefault(),n.cancelSuggest(),s&&u&&this._showSuggestionsMenu(),r=t?a.length-1:0,void this._focusManager.focus(a[r])):void n.suggest())}},_handleInputClick:function(){this._hideSourcesMenu(),this._hideNoResultsMenu()},_updateSuggestionsMenu:function(e,t){var r=this.viewModel;if(this._suggestionsNode){this._hideSourcesMenu(),this._hideNoResultsMenu();var i,o=r.sources;if(!e)return d.empty(this._suggestionsNode),void this._hideSuggestionsMenu();i=d.create("div");for(var a=0;a<e.length;a++)if(e[a]&&e[a].results&&e[a].results.length){var n=this._getSourceName(a);o.length>1&&r.activeSourceIndex===s.ALL_INDEX&&d.create("div",{className:S.header,textContent:n},i);for(var u=d.create("ul",{},i),c=o.getItemAt(a).maxSuggestions||r.maxSuggestions,l=0;l<e[a].results.length&&c>l;++l){var h=d.create("li",{"data-index":l,"data-source-index":e[a].sourceIndex,role:"menuitem",tabindex:0},u),g=new RegExp("("+t+")","gi"),_=e[a].results[l],p=_.text||_.name,v=p.replace(g,"|$1|"),m=v.split("|");m.forEach(function(e){if(e.toLowerCase()===t.toLowerCase())d.create("strong",{textContent:e},h);else{var s=document.createTextNode(e);d.place(s,h)}})}}d.place(i,this._suggestionsNode,"only"),this._suggestionsNode.scrollTop=0,this._showSuggestionsMenu()}},_updateSourcesMenu:function(e){var t=this.viewModel,r=this._containerNode,i=this._sourcesNode;if(!e||e.length<=1)return l.remove(r,S.hasMultipleSources),void d.empty(i);var o,a,n=t.activeSourceIndex,u=d.create("ul");if(t.searchAllEnabled){var c=n===s.ALL_INDEX?S.source+" "+S.activeSource:S.source;d.create("li",{"data-index":s.ALL_INDEX,role:"menuitem",className:c,tabIndex:0,textContent:p.all},u)}for(a=0;a<e.length;a++)o=a===n?S.source+" "+S.activeSource:S.source,d.create("li",{"data-index":a,role:"menuitem",className:o,tabIndex:0,textContent:this._getSourceName(a)},u);l.add(r,S.hasMultipleSources),d.place(u,i,"only"),i.scrollTop=0},_showLoading:function(){l.add(this._containerNode,S.isSearchLoading)},_hideLoading:function(){l.remove(this._containerNode,S.isSearchLoading)},_createEmptyResultsStructure:function(t){var s=t&&t.trim(),r=p,i=d.create("div",{className:S.noResultsBody});if(t&&s)d.create("div",{className:S.noResultsHeader,textContent:r.noResults},i),d.create("div",{className:S.noResultsText,textContent:e.substitute({value:'"'+t+'"'},r.noResultsFound)},i);else{var o=d.create("div",{},i);d.create("span",{"aria-hidden":"true",className:S.noticeIcon},o),d.create("span",{className:S.noValueText,textContent:r.emptyValue},o)}d.place(i,this._noResultsMenuNode,"only")},_hideMenus:function(){this._hideSourcesMenu(),this._hideSuggestionsMenu(),this._hideNoResultsMenu()},_hideNoResultsMenu:function(){l.remove(this._containerNode,S.showNoResults)},_showNoResultsMenu:function(){this._hideSourcesMenu(),this._hideSuggestionsMenu(),l.add(this._containerNode,S.showNoResults)},_hideSourcesMenu:function(){l.remove(this._containerNode,S.showSources)},_hideSuggestionsMenu:function(){l.remove(this._containerNode,S.showSuggestions)},_showSourcesMenu:function(){this._hideSuggestionsMenu(),this._hideNoResultsMenu(),l.add(this._containerNode,S.showSources)},_showSuggestionsMenu:function(){this._hideSourcesMenu(),this._hideNoResultsMenu(),l.add(this._containerNode,S.showSuggestions)},_handleSourcesMenuToggleClick:function(){this._hideSuggestionsMenu(),this._hideNoResultsMenu(),l.toggle(this._containerNode,S.showSources)}});return m});