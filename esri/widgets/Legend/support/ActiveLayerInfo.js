// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../../Color","../../../renderers/SimpleRenderer","../../../renderers/ClassBreaksRenderer","../../../renderers/UniqueValueRenderer","../../../core/Accessor","./colorRampUtils","./sizeRampUtils","dojo/_base/lang"],function(e,l,t,o,n,r,i,a){return n.createSubclass({properties:{layer:{},legendElements:{type:Array},ready:{},tearingDown:{},title:{},version:{readOnly:!0,dependsOn:["ready"]}},declaredClass:"esri.widgets.Legend.support.ActiveLayerInfo",getDefaults:function(){return{ready:!1,tearingDown:!1,legendElements:[]}},layer:null,legendElements:null,ready:!1,tearingDown:!1,title:null,version:0,_versionGetter:function(){return this._get("version")+1},buildLegendElements:function(e,n){var a=e.visualVariables,s=[],p=this.layer.opacity,u=null,f=null,c=!1,d=[],y=[],m=[];if(a){if(a.forEach(function(e){"color"===e.type?d.push(e):"opacity"===e.type?y.push(e):"size"===e.type&&m.push(e)}),a=[],Array.prototype.push.apply(a,d),Array.prototype.push.apply(a,y),Array.prototype.push.apply(a,m),0===d.length&&e.isInstanceOf(t)&&e.classBreakInfos&&1===e.classBreakInfos.length){var g=e.classBreakInfos[0];f=g&&g.symbol.color.toRgba()}s=a.map(function(l){var t,o=this._getRampTitle(l,this.layer),a=r._getRampBorderColor(e),s=r._getRampOverlayColor(p);return"color"===l.type?(u=this._getMedianColor(e,l),t={type:"color-ramp",title:o,borderColor:a,overlayColor:s,infos:r._getRampStops(e,l)}):"opacity"===l.type?t={type:"opacity-ramp",title:o,borderColor:a,overlayColor:s,infos:r._getRampStops(e,l,f)}:"size"===l.type&&(t={type:"size-ramp",title:o,infos:i._getRampStops(e,l,u,n)},c||(c=!!t.infos)),t.infos&&t},this).filter(function(e){return!!e})}var b={type:"symbol-table",title:this._getRendererTitle(e,this.layer),infos:[]};if(e.isInstanceOf(t)){var h=this._isUnclassedRenderer(e,a),v=!h||!c;if(v){var _=e.classBreakInfos.slice().reverse();b.infos=_.map(function(e){return{label:e.label||(h?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(e.symbol,u,p)}},this),h&&(b.title=null)}}e.isInstanceOf(o)&&(b.infos=e.uniqueValueInfos.map(function(e){return{label:e.label||e.value,value:e.value,symbol:this._getAppliedCloneSymbol(e.symbol,u,p)}},this));var R=e.label||e.defaultLabel,I=e.symbol||e.defaultSymbol;I&&!h&&b.infos.push({label:e.isInstanceOf(l)?R:R||"others",symbol:this._getAppliedCloneSymbol(I,u,p)}),b.infos.length>0&&this.legendElements.push(b),Array.prototype.push.apply(this.legendElements,s)},_getMedianColor:function(e,l){var t,o;l.colors?(t=l.minDataValue,o=l.maxDataValue):l.stops&&(t=l.stops[0].value,o=l.stops[l.stops.length-1].value);var n=t+(o-t)/2;return e.getColor(n,{colorInfo:l})},_getAppliedCloneSymbol:function(l,t,o){var n,r=l.clone(),i=r.type;if(t&&(r.color=new e(t.toRgba())),"simple-line-symbol"===i||"cartographic-line-symbol"===i||"text-symbol"===i){if(!r.color)return;n=r.color.toRgba(),n[3]=n[3]*o,r.color=n}else("simple-marker-symbol"===i||"simple-fill-symbol"===i)&&(r.color&&(n=r.color.toRgba(),n[3]=n[3]*o,r.color=n),r.outline&&r.outline.color&&(n=r.outline.color.toRgba(),n[3]=n[3]*o,r.outline.color=n));return r},_getRampTitle:function(e,l){var t,o=e.field,n=e.normalizationField,r=!1,i=!1,s=!1;if(o=a.isFunction(o)?null:o,n=a.isFunction(n)?null:n,e.legendOptions&&e.legendOptions.title)t=e.legendOptions.title;else{if(l.renderer.authoringInfo&&l.renderer.authoringInfo.visualVariables)for(var p=l.renderer.authoringInfo.visualVariables,u=0;u<p.length;u++){var f=p[u];if("colorInfo"===f.type){if("ratio"===f.style){r=!0;break}if("percent"===f.style){i=!0;break}if("percentTotal"===f.style){s=!0;break}}}t={field:o&&this._getFieldAlias(o,l),normField:n&&this._getFieldAlias(n,l),ratio:r,ratioPercent:i,ratioPercentTotal:s}}return t},_getRendererTitle:function(e,l){var o,n,r,i=e.field;return e instanceof t&&(o=e.normalizationField,n="percent-of-total"===e.normalizationType),i=a.isFunction(i)?null:i,o=a.isFunction(o)?null:o,(i||o)&&(r={field:i&&this._getFieldAlias(i,l),normField:o&&this._getFieldAlias(o,l),normByPct:n}),r},_getFieldAlias:function(e,l){var t,o,n,r=l.popupTemplate,i=r&&r.fieldInfos,s=a.isFunction(e)?null:l.getField(e);return i&&i.some(function(l){return e===l.fieldName?(o=l,!0):void 0}),n=o||s,n&&(t=o&&o.label||s&&s.alias||n.name||n.fieldName),t},_isUnclassedRenderer:function(e,l){var o=!1,n=e.isInstanceOf(t)&&e.classBreakInfos&&1===e.classBreakInfos.length;return n&&l&&(o=l.some(function(l){return!(!l||e.field!==l.field||e.normalizationField!=l.normalizationField)})),o}})});