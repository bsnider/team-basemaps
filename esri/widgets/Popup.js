// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["./support/viewModelWiring","./Widget","./Popup/PopupViewModel","../core/HandleRegistry","../core/watchUtils","../views/2d/viewpointUtils","dijit/a11yclick","dijit/_TemplatedMixin","dojo/keys","dojo/on","dojo/query","dojo/Deferred","dojo/i18n!./Popup/nls/Popup","dojo/text!./Popup/templates/Popup.html","../core/lang","dojo/_base/lang","dojo/dom-class","dojo/dom-attr","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","./Popup/PopupRenderer","./Popup/PopupRendererViewModel","./Spinner","./Message"],function(e,t,i,o,n,s,r,a,d,c,p,h,l,u,g,_,v,m,f,b,k,w,M,P,x){var y={base:"esri-popup",container:"esri-container",invisible:"esri-invisible",showDock:"esri-show-dock",docked:"esri-docked",dockedTopLeft:"esri-docked-top-left",dockedTopCenter:"esri-docked-top-center",dockedTopRight:"esri-docked-top-right",dockedBottomLeft:"esri-docked-bottom-left",dockedBottomCenter:"esri-docked-bottom-center",dockedBottomRight:"esri-docked-bottom-right",dockToLeft:"esri-dock-to-left",dockToRight:"esri-dock-to-right",dockToTop:"esri-dock-to-top",dockToBottom:"esri-dock-to-bottom",menuOpen:"esri-menu-open",shadow:"esri-popup-shadow",main:"esri-popup-main",header:"esri-popup-header",headerButtons:"esri-popup-header-buttons",hidden:"esri-hidden",content:"esri-popup-content",showContent:"esri-show-content",footer:"esri-footer",showFooter:"esri-show-footer",title:"esri-title",showTitle:"esri-show-title",btn:"esri-button",icon:"esri-popup-icon",iconText:"esri-icon-font-fallback-text",close:"esri-close",closeIcon:"esri-close-icon esri-icon-close",collapseIcon:"esri-down-icon esri-icon-down",dockBtn:"esri-dock",dockIcon:"esri-dock-icon",dockIconTop:"esri-icon-maximize",dockIconBottom:"esri-icon-dock-bottom",dockIconLeft:"esri-icon-dock-left",dockIconRight:"esri-icon-dock-right",dockIconText:"esri-dock-text",undockIcon:"esri-undock-icon esri-icon-minimize",undockIconText:"esri-undock-text",actions:"esri-actions",action:"esri-action",actionImage:"esri-action-image",actionText:"esri-action-text",pagination:"esri-pagination",paginationDocked:"esri-pagination-docked",paginationDockedButtons:"esri-pagination-docked-buttons",showPagination:"esri-show-pagination",pointer:"esri-pointer",pointerDirection:"esri-pointer-direction",previous:"esri-previous",previousIconLTR:"esri-previous-icon-ltr esri-icon-left-triangle-arrow",previousIconRTL:"esri-previous-icon-rtl esri-icon-right-triangle-arrow",next:"esri-next",nextIconLTR:"esri-next-icon-ltr esri-icon-right-triangle-arrow",nextIconRTL:"esri-next-icon-rtl esri-icon-left-triangle-arrow",pageMenu:"esri-page-menu",pageMenuList:"esri-page-menu-list",pageMenuItem:"esri-page-menu-item",pageMenuViewport:"esri-page-menu-viewport",pageMenuHeader:"esri-page-menu-header",pageMenuNote:"esri-page-menu-note",pageMenuSelected:"esri-selected",pageMenuBtn:"esri-page-menu-button",pageMenuIcon:"esri-page-menu-icon esri-icon-layer-list",pageMenuTitle:"esri-page-menu-title",pageMenuCheckMark:"esri-page-menu-check-mark esri-icon-check-mark",pageText:"esri-page-text",zoomIcon:"esri-icon-zoom-in-magnifying-glass",top:"esri-top",bottom:"esri-bottom",left:"esri-left",right:"esri-right",hasPopupRenderer:"esri-has-popup-renderer",hasPromiseFeatures:"esri-has-promise-features",pendingPromises:"esri-pending-promises",pendingPromisesResult:"esri-pending-promises-result",featureUpdated:"esri-feature-updated",loadingContainer:"esri-loading-container",loadingIcon:"esri-rotating esri-icon-loading-indicator"},N="zoom-to",R={top:"top",left:"left",bottom:"bottom",right:"right"},T={auto:"auto",topLeft:"top-left",topCenter:"top-center",topRight:"top-right",bottomLeft:"bottom-left",bottomCenter:"bottom-center",bottomRight:"bottom-right"},C={buttonEnabled:!0,position:T.auto,breakpoint:{width:544}},D={popupRenderer:"popup-renderer",acions:"actions",actionsChange:"actions-change",paginationTitles:"pagination-titles",view:"view"},E={actionIndex:"data-action-index",featureIndex:"data-feature-index",layerName:"data-layer-name",layerId:"data-layer-id"},F=t.createSubclass([a],{properties:{actions:{dependsOn:["viewModel.actions"]},alignment:{},autoPanEnabled:{},content:{dependsOn:["viewModel.content"]},closeOnViewChangeEnabled:{},currentDockPosition:{readOnly:!0},dockOptions:{},featureCount:{dependsOn:["viewModel.featureCount"]},features:{dependsOn:["viewModel.features"]},location:{dependsOn:["viewModel.location"]},messageEnabled:{},paginationEnabled:{},promises:{dependsOn:["viewModel.promises"]},selectedFeature:{dependsOn:["viewModel.selectedFeature"]},selectedFeatureIndex:{dependsOn:["viewModel.selectedFeatureIndex"]},spinnerEnabled:{},title:{dependsOn:["viewModel.title"]},view:{dependsOn:["viewModel.view"]},viewModel:{type:i},visible:{}},declaredClass:"esri.widgets.Popup",baseClass:y.base,templateString:u,constructor:function(){this._handleRegistry=new o,this._contentStorage=f.create("div")},postCreate:function(){var t=this;this.inherited(arguments);var i=this.viewModel;this.own(n.whenTrue(i,"view.ready",function(){var e=this.viewModel;this._wireUpView(e.view)}.bind(this)),n.init(i,"pendingPromisesCount,featureCount,promises,location",function(){var e=this.viewModel;this._displayPendingFeaturesStatus(e.pendingPromisesCount,e.featureCount,e.promises,e.location)}.bind(this)),n.init(i,"features",this._updateFeatures.bind(this)),n.init(i,"selectedFeatureIndex,selectedFeature",function(){var e=this.viewModel;this._updateSelectedFeature(e.selectedFeature),this._updatePageText(e.features,e.selectedFeatureIndex),this._createPaginationNodes(e.features,e.selectedFeatureIndex),this._bodyContentNode.scrollTop=0}.bind(this)),n.init(i,"title",function(e){this._updateTitle(e),this.reposition()}.bind(this)),n.init(i,"actions",function(e){var t=this.viewModel;this._updateActions(e,t.features),this._actionChangeListener(e)}.bind(this)),n.init(i,"content",function(e){this._updateContent(e),this.reposition()}.bind(this)),n.init(i,"location",function(){this._togglePopupLocationRepositioning(this.visible),this.reposition()}.bind(this)),c(this._dockNode,r,this._toggleDock.bind(this)),c(this._closeNode,r,this.close.bind(this)),c(this._previousNode,r,i.previous.bind(i)),c(this._previousDockedNode,r,i.previous.bind(i)),c(this._nextNode,r,i.next.bind(i)),c(this._nextDockedNode,r,i.next.bind(i)),c(this._pageMenuNode,r,this._togglePageMenu.bind(this)),c(this._pageMenuDockedNode,r,this._togglePageMenu.bind(this)),c(this._pageMenuInfoNode,r,this._togglePageMenu.bind(this)),c(this._paginationNode,c.selector("li",r),function(){t._selectFeature(this)}),c(this._paginationNode,c.selector("li","keyup"),function(e){t._keyupFeature(e,this)}),c(this._actionsNode,c.selector("["+E.actionIndex+"]",r),function(){t._actionEvent(this)}),c(i,"trigger-action",function(e){e.action&&e.action.id===N&&this.viewModel.zoomToLocation()}.bind(this))),e.setUpEventDelegates(this,"trigger-action")},destroy:function(){this._destroyPopupRendererVMs(),this._destroyMessage(),this._destroySpinner(),this._destroyPopupRenderer(),this._handleRegistry.destroy(),this._handleRegistry=null},_getActionsAttr:e.createGetterDelegate("actions"),_setActionsAttr:e.createSetterDelegate("actions"),alignment:"top",_setAlignmentAttr:function(e){this._set("alignment",e),this.reposition()},autoPanEnabled:!0,_getContentAttr:e.createGetterDelegate("content"),_setContentAttr:e.createSetterDelegate("content"),closeOnViewChangeEnabled:!1,dockOptions:C,_setDockOptionsAttr:function(e){var t=_.clone(C),i=this.viewModel.get("view.breakpoints"),o={};i&&(o.width=i.xsmall,o.height=i.xsmall);var n=_.mixin({},t,e),s=_.mixin({},t.breakpoint,o);n.breakpoint===!0?n.breakpoint=s:"object"==typeof n.breakpoint&&(n.breakpoint=_.mixin({},s,n.breakpoint)),this._set("dockOptions",n),this._toggleDockButton(n)},dockEnabled:!1,_setDockEnabledAttr:function(e){this._set("dockEnabled",e),this._togglePopupDocking(e),this._togglePopupLocationRepositioning(this.visible),this.reposition()},currentDockPosition:null,_getFeatureCountAttr:e.createGetterDelegate("featureCount"),_setFeatureCountAttr:e.createSetterDelegate("featureCount"),_getFeaturesAttr:e.createGetterDelegate("features"),_setFeaturesAttr:e.createSetterDelegate("features"),_getLocationAttr:e.createGetterDelegate("location"),_setLocationAttr:e.createSetterDelegate("location"),messageEnabled:!0,_setMessageEnabledAttr:function(e){this._set("messageEnabled",e),this._createMessage(e,this.viewModel.view)},paginationEnabled:!0,_setPaginationEnabledAttr:function(e){var t=this.viewModel;this._set("paginationEnabled",e),this._updatePagination(t.features,t.selectedFeatureIndex),this._updateFooterVisibility(t.features,t.actions),this.reposition()},_getPromisesAttr:e.createGetterDelegate("promises"),_setPromisesAttr:e.createSetterDelegate("promises"),_getSelectedFeatureAttr:e.createGetterDelegate("selectedFeature"),_setSelectedFeatureAttr:e.createSetterDelegate("selectedFeature"),_getSelectedFeatureIndexAttr:e.createGetterDelegate("selectedFeatureIndex"),_setSelectedFeatureIndexAttr:e.createSetterDelegate("selectedFeatureIndex"),spinnerEnabled:!0,_setSpinnerEnabledAttr:function(e){this._set("spinnerEnabled",e),this._createSpinner(e,this.viewModel.view)},_getTitleAttr:e.createGetterDelegate("title"),_setTitleAttr:e.createSetterDelegate("title"),_getViewAttr:e.createGetterDelegate("view"),_setViewAttr:e.createSetterDelegate("view"),visible:!1,_setVisibleAttr:function(e){this._set("visible",e),v.remove(this._containerNode,y.menuOpen),v.toggle(this.domNode,y.invisible,!e),this._togglePopupLocationRepositioning(e),this._toggleContentVisibility(e),this.reposition()},_css:y,_i18n:l,_hideActionsTextNum:3,_animationDelay:10,_popupRendererVMs:[],clear:e.createMethodDelegate("clear"),close:function(){this.set("visible",!1)},next:e.createMethodDelegate("next"),previous:e.createMethodDelegate("previous"),reposition:function(){return this._positionPopup(),this._moveIntoView()},open:function(e){var t={updateLocationEnabled:!1},i=_.mixin(t,e);this.viewModel.set(i),this.set("visible",!0)},triggerAction:e.createMethodDelegate("triggerAction"),_actionChangeListener:function(e){this._handleRegistry.remove(D.actionsChange),e&&this._handleRegistry.add([e.on("change",function(){var e=this.viewModel;this._updateActions(e.actions,e.features)}.bind(this))],D.actionsChange)},_actionEvent:function(e){var t=this.viewModel,i=m.get(e,E.actionIndex);if(i){var o=parseInt(i,10);t.triggerAction(o)}},_addContent:function(){var e=this.viewModel;this._updateSelectedFeature(e.selectedFeature),this._updateContent(e.content),this._updateTitle(e.title),this._updatePageText(e.features,e.selectedFeatureIndex)},_updateActions:function(e,t){this._updateActionButtons(e),this._updateFooterVisibility(t,e),this.reposition()},_updateActionButtons:function(e){if(this._handleRegistry.remove(D.actions),this._actionsNode){var t=document.createDocumentFragment(),i=e.length;i&&e.forEach(function(e,o){e.id===N&&(e.title=this._i18n.zoom,e.className=y.zoomIcon);var s=f.create("div",{tabindex:"0",title:e.title},t);m.set(s,E.actionIndex,o),v.add(s,[y.btn,y.action]);var r=f.create("span",{"aria-hidden":!0},s);v.add(r,y.icon),e.className&&v.add(r,e.className),e.image&&(v.add(r,y.actionImage),k.set(r,"background-image","url("+e.image+")"));var a={className:y.actionText,textContent:e.title};i>=this._hideActionsTextNum&&(a.className=y.iconText);var d=f.create("span",a,s);this._handleRegistry.add([n.init(e,"visible",function(e){v.toggle(s,y.hidden,!e)}),n.init(e,"className",function(e,t){v.remove(r,t),v.add(r,e)}),n.init(e,"image",function(e){v.toggle(r,y.actionImage,!!e),k.set(r,"background-image",e?"url("+e+")":"")}),n.init(e,"title",function(e){var t=e||"";m.set(s,"title",t),m.set(d,"textContent",t)})],D.actions)},this),f.place(t,this._actionsNode,"only")}},_getLocationScreenPoint:function(){var e,t=this.viewModel;if(t.location&&this.visible){var i=t.location;i&&t.get("view.ready")&&(e=t.view.toScreen(i))}return e},_calculatePosition:function(e,t){var i,o,n,s,r,a;if(e&&t){var d=t.pointer.h,c=t.pointer.w;i=t.popup.h;var p=R;switch((t.alignment===p.top||t.alignment===p.bottom)&&(i+=d),o=t.popup.w,(t.alignment===p.left||t.alignment===p.right)&&(o+=c),t.alignment){case p.bottom:n=e.y+d,s=e.x-o/2,r=e.y+i,a=s+o;break;case p.left:n=e.y-i/2,s=e.x-o,r=n+i,a=s+o;break;case p.right:n=e.y-i/2,s=e.x+c,r=n+i,a=e.x+o;break;default:n=e.y-i,s=e.x-o/2,r=n+i,a=s+o}return{height:i,width:o,top:n,left:s,bottom:r,right:a}}},_createPopupRendererVMs:function(e){this._destroyPopupRendererVMs(),e&&e.length>1&&e.forEach(function(e){var t=new M({contentEnabled:!1,graphic:e});this._popupRendererVMs.push(t)},this)},_destroyPopupRendererVMs:function(){this._handleRegistry.remove(D.paginationTitles),this._popupRendererVMs.forEach(function(e){e.destroy()}),this._popupRendererVMs.length=0},_createPaginationNodes:function(e,t){if(this._handleRegistry.remove(D.paginationTitles),e){var i=e.length;if(this._paginationNode&&m.set(this._paginationNode,"innerHTML",""),i>1){var o=g.substitute({total:i},this._i18n.selectedFeatures);m.set(this._pageMenuInfoNode,"textContent",o),e.forEach(function(e,i){var o=this._i18n.untitled,s=f.create("li",{role:"menu-item",className:y.pageMenuItem},this._paginationNode);i===t?(m.set(s,"aria-label",l.selectedFeature),v.add(s,y.pageMenuSelected)):m.set(s,E.featureIndex,i);var r=f.create("span",{className:y.pageMenuTitle,innerHTML:o},s),a=this._popupRendererVMs[i];if(a){var d=n.init(a,"title",function(e){m.set(r,"innerHTML",e)});this._handleRegistry.add(d,D.paginationTitles)}i===t&&f.create("span",{className:y.pageMenuCheckMark},r)},this)}}},_createMessage:function(e,t){this._destroyMessage(),e&&t&&(this._message=new x({visible:!1,text:this._i18n.noFeaturesFound,viewModel:{view:t}}),this._message.startup(),f.place(this._message.domNode,t.root))},_createSpinner:function(e,t){this._destroySpinner(),e&&t&&(this._spinner=new P({visible:!1,viewModel:{view:t}}),this._spinner.startup(),f.place(this._spinner.domNode,t.root))},_updateContent:function(e){e&&e.nodeName?(f.place(e,this._contentStorage),f.place(e,this._bodyContentNode,"only")):"string"==typeof e&&(this._destroyPopupRenderer(),m.set(this._bodyContentNode,"innerHTML",e)),this._bodyContentNode.scrollTop=0;var t=!(!this._popupRenderer||this._popupRenderer.viewModel.content!==e);v.toggle(this._containerNode,y.hasPopupRenderer,t),v.toggle(this._containerNode,y.showContent,!!e),v.remove(this._containerNode,y.menuOpen)},_destroyPopupRenderer:function(){this._popupRenderer&&!this._popupRenderer._destroyed&&(this._handleRegistry.remove(D.popupRenderer),this._popupRenderer.destroy(),this._popupRenderer=null)},_destroyMessage:function(){this._message&&(this._message.destroyRendering(),this._message.destroy(),this._message=null)},_destroySpinner:function(){this._spinner&&(this._spinner.destroyRendering(),this._spinner.destroy(),this._spinner=null)},_setDockEnabledForViewSize:function(e){e.breakpoint&&this.set("dockEnabled",this._shouldDockAtCurrentViewSize(e))},_togglePopupDocking:function(e){v.remove(this._containerNode,y.menuOpen),v.toggle(this._containerNode,y.docked,!!e),m.set(this._dockNode,"title",e?this._i18n.undock:this._i18n.dock),this._updateDockPosition(this.dockOptions)},_dockingThresholdCrossed:function(e,t,i){var o=e[0],n=e[1],s=t[0],r=t[1],a=i.width,d=i.height;return a>=o&&s>a||o>a&&a>=s||d>=n&&r>d||n>d&&d>=r},_determineDockPosition:function(e){var t=this.viewModel,i=t.view,o=i&&i.padding,n=i&&i.width-o.left-o.right,s=i&&t.get("view.breakpoints");if(s&&n<=s.xsmall)return e.bottomCenter;var r=!this.isLeftToRight();return r?e.topLeft:e.topRight},_updateDockPosition:function(e){v.remove(this._containerNode,[y.dockedTopLeft,y.dockedTopCenter,y.dockedTopRight,y.dockedBottomLeft,y.dockedBottomCenter,y.dockedBottomRight,y.dockToTop,y.dockToBottom,y.dockToLeft,y.dockToRight]);var t,i,o,n=T,s=e.position;switch(t=s===n.auto?this._determineDockPosition(n):s){case n.topLeft:i=y.dockedTopLeft,o=y.dockToLeft;break;case n.topCenter:i=y.dockedTopCenter,o=y.dockToTop;break;case n.bottomLeft:i=y.dockedBottomLeft,o=y.dockToLeft;break;case n.bottomCenter:i=y.dockedBottomCenter,o=y.dockToBottom;break;case n.bottomRight:i=y.dockedBottomRight,o=y.dockToRight;break;default:i=y.dockedTopRight,o=y.dockToRight}v.toggle(this._containerNode,o,!!e.buttonEnabled),this.dockEnabled?(v.add(this._containerNode,i),this._set("currentDockPosition",t)):this._set("currentDockPosition",null),this._popupRenderer&&this._popupRenderer.resize(),this.reposition()},_toggleDockButton:function(e){var t=this._containerNode;v.toggle(t,y.showDock,!!e.buttonEnabled),v.toggle(t,y.docked,!!this.dockEnabled),this._updateDockPosition(e)},_updateFooterVisibility:function(e,t){var i=this._isPaginationEnabled(e)||t&&t.length;v.toggle(this._containerNode,y.showFooter,!!i)},_isPaginationEnabled:function(e){return this.paginationEnabled&&e&&e.length>1},_updatePagination:function(e,t){this._updatePageText(e,t),this._createPaginationNodes(e,t),v.toggle(this._containerNode,y.showPagination,this._isPaginationEnabled(e))},_displayPendingFeaturesStatus:function(e,t,i,o){var n=e>0&&0===t;e&&i.length&&e===i.length&&this.set("visible",!1),v.toggle(this._containerNode,y.pendingPromises,!!e),v.toggle(this._containerNode,y.pendingPromisesResult,!!n),v.toggle(this._containerNode,y.hasPromiseFeatures,!!t),this._message&&this._message.set({visible:!1}),n?this._spinner&&(this._spinner.set({visible:!0}),this._spinner.viewModel.point=o):(this._spinner&&(this._spinner.viewModel.point=null),t&&!this.visible&&this.set("visible",!0),!t&&i&&i.length&&this._message&&(this._message.set({visible:!0}),this._message.viewModel.point=o))},_moveIntoView:function(){var e=new h;return setTimeout(e.resolve.bind(this),this._animationDelay),e.then(function(){if(!this._destroyed){var e=this.viewModel,t=this.get("viewModel.view");if(e&&t&&t.stationary){var i=this._getLocationScreenPoint();if(i){var o=this._sizePopup(),n=this._calculatePosition(i,o),r=t.width,a=t.height,d=t.padding,c=t.ui.padding;if(this.autoPanEnabled){if(i.y<d.top||i.y>a-d.bottom||i.x<d.left||i.x>r-d.right)return e.centerAtLocation();if(!this.dockEnabled&&n&&n.width<t.width&&n.height<t.height){var p=0,h=0;if(n.top<d.top?h=-n.top+c.top+d.top:n.bottom>a-d.bottom&&(h=-(n.bottom-a+d.bottom)-c.bottom),n.left<d.left?p=n.left-c.left-d.left:n.right>r-d.right&&(p=n.right-r+d.right+c.right),p||h){var l=s.translateBy(s.create(),t.viewpoint,[p,h]);return t.goTo(l,e.animationOptions)}}}}}}}.bind(this))},_positionPopup:function(){var e=this.viewModel,t=e.view;if(t){v.remove(this._containerNode,[y.top,y.bottom,y.left,y.right]);var i;switch(this.alignment){case R.bottom:i=y.bottom;break;case R.right:i=y.right;break;case R.left:i=y.left;break;default:i=y.top}v.add(this._containerNode,i);var o=this._getLocationScreenPoint(),n=this._sizePopup(),s=this._calculatePosition(o,n);if(s){var r,a=t.padding;r=this.dockEnabled?{left:a.left?a.left+"px":"",top:a.top?a.top+"px":"",right:a.right?a.right+"px":"",bottom:a.bottom?a.bottom+"px":""}:{left:s.left+"px",top:s.top+"px",right:"",bottom:""},k.set(this._containerNode,r)}}},_removeContent:function(){this._destroyPopupRenderer(),m.set(this._bodyContentNode,"innerHTML",""),m.set(this._titleNode,"innerHTML",""),m.set(this._pageTextNode,"innerHTML",""),m.set(this._pageTextDockedNode,"innerHTML",""),v.remove(this._containerNode,[y.showTitle,y.showContent])},_keyupFeature:function(e,t){var i=e.keyCode;if(i===d.UP_ARROW||i===d.DOWN_ARROW){e.stopPropagation(),e.preventDefault();var o,n=p("li",this._paginationNode),s=n.length,r=n.indexOf(t);i===d.UP_ARROW?o=r-1:i===d.DOWN_ARROW&&(o=r+1),0>o?o=s-1:o>=s&&(o=0),n[o].focus()}},_selectFeature:function(e){var t=this.viewModel,i=-1,o=m.get(e,E.featureIndex);o&&(i=parseInt(o,10)),-1!==i&&(t.selectedFeatureIndex=i),v.remove(this._containerNode,y.menuOpen),this._pageMenuNode.focus()},_updateSelectedFeature:function(e){var t,i=this.viewModel,o="",n="";if(e){if(t=e.layer,t&&(o=t.id||"",n=t.name||""),!this._popupRenderer||this._popupRenderer&&this._popupRenderer._destroyed){this._handleRegistry.remove(D.popupRenderer),this._popupRenderer=new w;var s=this._popupRenderer.viewModel.watch("title",function(e){i.title=e}),r=this._popupRenderer.viewModel.watch("content",function(e){i.content=e?this._popupRenderer.domNode:null}.bind(this)),a=c(this._popupRenderer,"resize",this.reposition.bind(this));this._handleRegistry.add([s,r,a],D.popupRenderer),this._popupRenderer.startup()}this._popupRenderer.viewModel.graphic=e}this._toggleFeatureUpdatedClass(),m.set(this._containerNode,E.layerName,n),m.set(this._containerNode,E.layerId,o),this.reposition()},_updateFeatures:function(e){var t=this.viewModel;this._createPopupRendererVMs(e),this._updatePagination(e,t.selectedFeatureIndex),this._updateFooterVisibility(e,t.actions),this.reposition()},_shouldDockAtCurrentViewSize:function(e){var t=this.viewModel,i=e.breakpoint;return t.view&&(i.hasOwnProperty("width")&&t.view.ui.width<=i.width||i.hasOwnProperty("height")&&t.view.ui.height<=i.height)},_sizePopup:function(){var e=b.getContentBox(this._containerNode),t=b.getContentBox(this._pointerNode),i={alignment:this.alignment,popup:e,pointer:t};return i},_updateTitle:function(e){e=e||"",m.set(this._titleNode,"innerHTML",e),v.toggle(this._containerNode,y.showTitle,!!e),v.remove(this._containerNode,y.menuOpen)},_toggleDock:function(){this.set("dockEnabled",!this.dockEnabled)},_togglePageMenu:function(){v.toggle(this._containerNode,y.menuOpen);var e=v.contains(this._containerNode,y.menuOpen);m.set(this._pageMenuSectionNode,"aria-hidden",!e);var t=p("li",this._paginationNode),i=t[0];t.forEach(function(t){m.set(t,"tabIndex",e?"0":"")}),e?i&&i.focus():this._pageMenuNode.focus()},_updatePageText:function(e,t){var i="";this._isPaginationEnabled(e)&&(i=g.substitute({index:t+1,total:e.length},this._i18n.pageText)),this._pageTextNode&&m.set(this._pageTextNode,{textContent:i}),this._pageTextDockedNode&&m.set(this._pageTextDockedNode,{textContent:i})},_toggleFeatureUpdatedClass:function(){v.remove(this._containerNode,y.featureUpdated),this._containerNode.offsetWidth=this._containerNode.offsetWidth,v.add(this._containerNode,y.featureUpdated)},_viewPointChanged:function(){this.closeOnViewChangeEnabled?this.close():this._positionPopup()},_wireUpView:function(e){if(this._handleRegistry.remove(D.view),this._viewPointEvent=null,e){var t="viewpoint";"3d"===e.type&&(t="camera"),this._viewPointEvent=n.pausable(e,t,this._viewPointChanged.bind(this)),this._handleRegistry.add([e.watch("padding",this.reposition.bind(this)),e.watch("size",this._updateDockEnabledForViewSize.bind(this)),c(e,"resize",this.reposition.bind(this)),this._viewPointEvent],D.view),this._togglePopupLocationRepositioning(this.visible),this._createMessage(this.messageEnabled,e),this._createSpinner(this.spinnerEnabled,e),this._setDockEnabledForViewSize(this.dockOptions),this._toggleDockButton(this.dockOptions),this.reposition()}},_updateDockEnabledForViewSize:function(e,t){var i=this.get("viewModel.view.padding"),o=i.left+i.right,n=i.top+i.bottom,s=[],r=[];s[0]=e[0]-o,s[1]=e[1]-n,r[0]=t[0]-o,r[1]=t[1]-n;var a=this.dockOptions,d=a.breakpoint;this._dockingThresholdCrossed(s,r,d)&&this._setDockEnabledForViewSize(a),this._updateDockPosition(a)},_togglePopupLocationRepositioning:function(e){var t=this.viewModel;this._viewPointEvent&&(e&&t.location&&!this.dockEnabled?this._viewPointEvent.resume():this._viewPointEvent.pause())},_toggleContentVisibility:function(e){e?this._addContent():this._removeContent()}});return F});