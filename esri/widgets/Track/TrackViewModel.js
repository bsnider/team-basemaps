// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../config","../../core/Accessor","../../core/Error","../../core/Evented","../../core/promiseUtils","../../geometry/Point","../../geometry/support/webMercatorUtils","../../Graphic","../../symbols/PictureMarkerSymbol","../../tasks/GeometryService","../../tasks/support/ProjectParameters","../../portal/Portal","dojo/_base/lang","dojo/Deferred","require"],function(t,i,e,r,n,o,s,a,c,h,l,u,g,d,p){var _={disabled:"disabled",ready:"ready",waiting:"waiting",tracking:"tracking",unsupported:"feature-unsupported"},f=15e3,w=i.createSubclass([r],{properties:{geolocationOptions:{},goToLocationEnabled:{},graphic:{type:a},state:{dependsOn:["view.ready","tracking"],readOnly:!0},tracking:{readOnly:!0},view:{}},declaredClass:"esri.widgets.Track.TrackViewModel",getDefaults:function(){return g.mixin(this.inherited(arguments),{geolocationOptions:{maximumAge:0,timeout:15e3,enableHighAccuracy:!0},graphic:{}})},initialize:function(){navigator.geolocation?window.hasOwnProperty("isSecureContext")&&!window.isSecureContext&&(console.log(this.declaredClass,"navigator.geolocation requires a secure origin."),this._geolocationUsable=!1):(console.log(this.declaredClass,"navigator.geolocation unsupported."),this._geolocationUsable=!1)},destroy:function(){this._clear(),this._viewReady&&this._viewReady.cancel(),this._stopWatchingPosition()},_geolocationUsable:!0,_watchId:null,_trackStartingTimeoutId:null,geolocationOptions:null,goToLocationEnabled:!0,graphic:null,_graphicSetter:function(t){t&&!t.symbol&&(t.symbol=new c({url:p.toUrl("./images/sdk_gps_location.png"),width:21,height:21})),this._set("graphic",t)},state:_.disabled,_stateGetter:function(){return this._geolocationUsable?this.get("view.ready")?this.tracking?_.tracking:null!==this._trackStartingTimeoutId?_.waiting:_.ready:_.disabled:_.unsupported},tracking:!1,_trackingGetter:function(){return null!==this._watchId},view:null,start:function(){this.state===_.disabled||this.tracking||this._startTracking()},stop:function(){this.state!==_.disabled&&this.tracking&&this._stopTracking()},_clear:function(){this.view&&this.view.graphics.remove(this.graphic)},_stopWatchingPosition:function(){null!==this._watchId&&(navigator.geolocation.clearWatch(this._watchId),this._watchId=null),this.notifyChange("tracking"),this._clearCurrentLocationVars()},_stopTracking:function(){this._stopWatchingPosition(),this._clear()},_startTracking:function(){this._stopWatchingPosition();var t=navigator.geolocation.watchPosition(function(i){this._watchId=t,this.notifyChange("tracking"),i=this._positionToObject(i),this._setPosition(i).then(function(){this.view.graphics.remove(this.graphic),this.graphic&&(this.graphic=this.graphic.clone(),this.view.graphics.push(this.graphic)),this.emit("track",{position:i})}.bind(this)).otherwise(function(t){t||(t=new e(this.declaredClass,"Error setting the position.")),this._emitError(t)}.bind(this)).always(function(){clearTimeout(this._trackStartingTimeoutId),this._trackStartingTimeoutId=null,this.notifyChange("state")}.bind(this))}.bind(this),function(t){t||(t=new e(this.declaredClass,"Could not get tracking position.")),this._emitError(t),clearTimeout(this._trackStartingTimeoutId),this._trackStartingTimeoutId=null,this.notifyChange("state")}.bind(this),this.geolocationOptions);this._trackStartingTimeoutId=setTimeout(function(){this._trackStartingTimeoutId=null,this.notifyChange("state")}.bind(this),f),this.notifyChange("state")},_clearCurrentLocationVars:function(){this._graphic=null,this._position=null,this._scale=null},_positionToObject:function(t){return t?{coords:g.mixin({},t.coords),timestamp:t.timestamp}:{}},_getGeometryServiceUrl:function(){var i=new d,e=t.geometryServiceUrl;if(e)i.resolve(e);else{var r=u.getDefault();r.load().always(function(){e=r.get("helperServices.geometry.url"),i.resolve(e)})}return i.promise},_projectPoint:function(t){var i=new d,r=this.get("view.spatialReference");return r.isWebMercator?i.resolve(s.geographicToWebMercator(t)):r.isWGS84?i.resolve(t):this._getGeometryServiceUrl().then(function(n){if(n){var o=new l({geometries:[t],outSR:r}),s=new h({url:n});s.project(o).then(function(t){t&&t.length?i.resolve(t[0]):i.reject(new e(this.declaredClass,"Point was not projected."))}.bind(this),i.reject)}else i.resolve(new e(this.declaredClass,"please specify a geometry service on esri/config to project."))}),i.promise},_getScale:function(t){var i=5e4,e=t&&t.coords&&t.coords.accuracy,r=this.scale;return r||e||i},_createPoint:function(t){var i=t&&t.coords;if(i)return new o({longitude:i.longitude,latitude:i.latitude,z:i.altitude||null,spatialReference:{wkid:4326}})},_animatePoint:function(t,i,r,o){return o=this._createGraphic(t,i),this._graphic=o,this.goToLocationEnabled?this.view.goTo({target:t,scale:r}).then(function(){return i}.bind(this)).otherwise(function(t){return t||(t=new e(this.declaredClass,"Could not center.")),t}.bind(this)):n.resolve(i)},_setPosition:function(t){var i;this._clearCurrentLocationVars(),this._position=t;var r=this._createPoint(t);r&&(i=this._createGraphic(r,t),this._graphic=i);var o=this._getScale(t);return this._scale=o,r?this._projectPoint(r).then(function(e){return this._animatePoint(e,t,o,i)}.bind(this)).otherwise(function(t){return t||(t=new e(this.declaredClass,"Error projecting point.")),t}.bind(this)):n.reject(new e(this.declaredClass,"Invalid point"))},_createGraphic:function(t,i){var e=this.graphic;if(t&&i&&e)return e.geometry=t,e},_emitError:function(t){this.emit("track-error",{error:t})}});return w});