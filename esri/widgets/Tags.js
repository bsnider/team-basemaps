// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/_base/array","../core/declare","dojo/_base/lang","dojo/dom","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/html","dojo/keys","dojo/on","dojo/query","dojo/sniff","dojo/string","dstore/Memory","dijit/focus","dijit/form/TextBox","dijit/registry","dijit/Tooltip","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","./Widget","dgrid/OnDemandGrid","dgrid/Selection","dgrid/Keyboard","../core/lang","dojo/i18n!./Tags/nls/Tags","dojo/NodeList-traverse","dojo/NodeList-manipulate"],function(t,i,e,s,h,r,o,a,d,n,_,c,l,u,g,f,C,S,p,m,E,T,L,v,y,I,O){return i([T,m,E],{_attachmentNode:"",_autocompleteList:"",_grid:"",_store:"",_matchParam:"",_idProperty:"",_gridId:"",_filterId:"",_placeHolder:"",_noDataMsg:"",_inputTextBox:"",_gridHasFocus:!1,_metaKeyPressed:!1,_shiftKeyPressed:!1,_CSS_STYLES:{CLASS_SELECTOR:".",ALL_SELECTOR:">",MULTI:"select2-container select2-container-multi",CHOICES:"select2-choices",CHOICE:"select2-search-choice",SEARCH_CHOICE_FOCUS:"select2-search-choice-focus",SEARCH_FIELD:"select2-search-field",CLOSE_ICON:"select2-search-choice-close"},_selRows:[],_CHOICE_SELECTOR:"",_CHOICE_FOCUS:"",_CHOICE_FOCUS_ALL:"",declaredClass:"esri.dijit.Tags",templateString:'<div class="${baseClass}"></div>',baseClass:"esri-tags",required:!1,values:[],_setValueAttr:function(t){this._setTagsAttr(t)},_getValueAttr:function(){return this._getTagsAttr()},_setTagsAttr:function(t){t&&!Array.isArray(t)&&(t=t.split(",")),this.clearTags(),this.prepopulate(t?this._getUniqueTags(t):[])},_getTagsAttr:function(){return this.values?this.values.join(","):""},maxWidth:"auto",minWidth:"auto",_setKnownTagsAttr:function(i){var e,s=[];for(e=0;e<i.length;e++)t.indexOf(this.values,i[e])<0&&s.push(i[e]);this._store=new g({idProperty:this._idProperty,data:s}),this._grid.set("collection",this._store),this._grid.refresh()},constructor:function(t){this._idProperty=t.idProperty||"tag",this.maxWidth=t.maxWidth||"auto",this.minWidth=t.minWidth||"auto",this._matchParam=t.matchParam||"first",this.values=[],this._selRows=[],this._CHOICE_ALL_SELECTOR=this._CSS_STYLES.CLASS_SELECTOR+this._CSS_STYLES.CHOICE+this._CSS_STYLES.ALL_SELECTOR,this._CHOICE_FOCUS=this._CSS_STYLES.CLASS_SELECTOR+this._CSS_STYLES.SEARCH_CHOICE_FOCUS,this._CHOICE_FOCUS_ALL=this._CHOICE_FOCUS+this._CSS_STYLES.ALL_SELECTOR},postMixInProperties:function(){this.inherited(arguments);var t=(new Date).getTime();this._tagsId="userTags-"+t,this._gridId="grid-"+t,this._filterId="filter-"+t,this.i18n=O},postCreate:function(){this._attachmentNode=o.create("div",{id:this._tagsId,className:"grid_1"},this.domNode),this._createContainerNode(),this._createTagList(),this._createDropDownList(),this._createInput();var t=[{field:this._idProperty}],s=[{property:this._idProperty,ascending:!0}];this._store=new g({idProperty:this._idProperty,data:[]});var h=i([L,v,y]);this._grid=new h({collection:this._store,showHeader:!1,noDataMessage:this.i18n.noTagsFound,selectionMode:"extended",allowSelectAll:!0,cellNavigation:!1,columns:t,sort:s,renderRow:this._renderItem},this._dropDownList),this._grid.startup(),r.add(this._grid.domNode,"grid-height-limiter");var a;this.own(this._inputTextBox.watch("value",e.hitch(this,function(){a&&(clearTimeout(a),a=null),this._grid.refresh()}))),this.own(this._grid.on(".dgrid-row:click",e.hitch(this,function(t){var i="";this._shiftKeyPressed||this._metaKeyPressed?t.shiftKey||t.metaKey||t.ctrlKey||(i=this._selRows[0],this._createTags(i),this._store.remove(i),this._grid.refresh(),this._resetInputTextBox()):(i=this._grid.row(t).data.tag,this._createTags(i),this._store.remove(i),this._grid.refresh(),this._resetInputTextBox())}))),this.own(this._grid.on("dgrid-deselect",e.hitch(this,function(){this._selRows=[];for(var t in this._grid.selection)this._grid.selection.hasOwnProperty(t)&&this._selRows.push(t)}))),this.own(this._grid.on("dgrid-select",e.hitch(this,function(){this._selRows=[];for(var t in this._grid.selection)this._grid.selection.hasOwnProperty(t)&&this._selRows.push(t)}))),this.own(_(this.domNode,"keydown",e.hitch(this,this._keydownHandler))),this.own(_(this.domNode,"keyup",e.hitch(this,this._keyupHandler))),window.onkeydown=e.hitch(this,function(t){(t.shiftKey||t.ctrlKey||224===t.keyCode)&&(this._metaKeyPressed=!0)}),this.own(_(document,"onkeydown",e.hitch(this,function(){this._shiftKeyPressed=!0,this._metaKeyPressed=!0})))},_keyupHandler:function(){var t=this._inputTextBox?this._inputTextBox.get("value").length:0;t>0?this._applyFilter():this._removeFilter()},_keydownHandler:function(i){this._clearMessage();var h,r,d,_,l,g=c(this._CHOICE_FOCUS,s.byId(this.id)),C=c(this._CSS_STYLES.CLASS_SELECTOR+this._CSS_STYLES.CHOICE,s.byId(this.id)).last();switch(void 0!==f.curNode.value&&(l=f.curNode.value.length),i.keyCode){case n.RIGHT_ARROW:this._navigate(g,l,C,"right"),this._hideGrid();break;case n.LEFT_ARROW:this._navigate(g,l,C,"left"),this._hideGrid();break;case n.DOWN_ARROW:i.preventDefault(),this._unhighlightTag(g),"none"===a.get(this._gridId,"display")&&this._showGrid(),this._gridHasFocus||(this._grid.focus(this._setFocusOnFirstRow(this._grid,0)),this._gridHasFocus=!0);break;case n.UP_ARROW:break;case n.BACKSPACE:var S;if(0===l&&0===c(this._CHOICE_FOCUS_ALL).length&&void 0!==c(this._CHOICE_ALL_SELECTOR)[c(this._CHOICE_ALL_SELECTOR).length-1]&&(S=c(this._CHOICE_ALL_SELECTOR)[c(this._CHOICE_ALL_SELECTOR).length-1].title,c("li",this._attachmentNode).length>0&&(o.destroy(C[0]),void 0!==S)))try{this._store.add({tag:S})}catch(p){}if(c(this._CHOICE_FOCUS_ALL).length>0&&(S=c(this._CHOICE_FOCUS_ALL).text(),o.destroy(g[0]),void 0!==S))try{this._store.add({tag:S})}catch(p){}this._grid.refresh(),0===l&&this._hideGrid(),this._removeTag(S),this._emitRemoved(S),this._emitChanged(),this.validate();break;case n.CTRL:this._metaKeyPressed=!0;break;case n.META:this._metaKeyPressed=!0;break;case n.SHIFT:this._shiftKeyPressed=!0;break;case n.ENTER:if(l>0)h=this._stripHTML(f.curNode.value),r=h.split(","),d=[],t.forEach(r,function(i){-1===t.indexOf(d,i)&&d.push(u.trim(i))}),t.forEach(d,e.hitch(this,function(t){this._isEmpty(t)||this._contains(this.values,t)||this._createTags(t)}));else{for(_=0;_<this._selRows.length;_++)this._createTags(this._selRows[_]),this._store.remove(this._selRows[_]);this._shiftKeyPressed=!1,this._metaKeyPressed=!1}this._resetInputTextBox(),i.preventDefault(),f.focus(s.byId(this._filterId));break;case n.TAB:if(f.curNode.id!==this._filterId||0!==l){if(l>0)h=this._stripHTML(f.curNode.value),r=h.split(","),d=[],t.forEach(r,function(i){-1===t.indexOf(d,i)&&d.push(u.trim(i))}),t.forEach(d,e.hitch(this,function(t){this._isEmpty(t)||this._contains(this.values,t)||this._createTags(t)}));else{for(_=0;_<this._selRows.length;_++)this._createTags(this._selRows[_]),this._store.remove(this._selRows[_]);this._shiftKeyPressed=!1,this._metaKeyPressed=!1}this._resetInputTextBox(),i.preventDefault(),f.focus(s.byId(this._filterId))}break;case n.ESCAPE:this._hideGrid();break;default:l>-1&&("none"===a.get(s.byId(this._gridId),"display")&&this._showGrid(),this._unhighlightTag(g)),this._metaKeyPressed=!1}},_applyFilter:function(){var t,i=new this._store.Filter,e=this._inputTextBox?this._inputTextBox.get("value")+"":"",s=new RegExp("^"+e.toLowerCase(),"i"),h=new RegExp(e.toLowerCase(),"i");t="first"===this._matchParam?i.match(this._idProperty,s):i.match(this._idProperty,h),this._grid.set("collection",this._store.filter(t)),this._grid.refresh()},_removeFilter:function(){this._grid.set("collection",this._store),this._grid.refresh()},_blurHandler:function(){if(!this.focused){var i=this._stripHTML(this._inputTextBox.value);if(i.length>0){var s=[],h=i.split(",");t.forEach(h,function(i){-1===t.indexOf(s,i)&&s.push(u.trim(i))}),t.forEach(s,e.hitch(this,function(t){this._isEmpty(t)||this._contains(this.values,t)||this._createTags(t)})),this._resetInputTextBox(),this._hideGrid()}else this._hideGrid()}this.validate()},_clearMessage:function(){this._displayMessage(null)},_displayMessage:function(t){var i=s.byId(this._tagsId);t&&this.focused?p.show(t,i):p.hide(i)},_resetInputTextBox:function(){this._inputTextBox.set("value","")},_isEmpty:function(t){return 0===t.trim().length},_navigate:function(t,i,e,s){t.length>0&&1>i?(this._hightlightTag("right"===s?t.next():t.prev()),this._unhighlightTag(t)):1>i&&this._hightlightTag(e)},_contains:function(i,e){return t.indexOf(i,e)>=0},_hightlightTag:function(t){t.addClass(this._CSS_STYLES.SEARCH_CHOICE_FOCUS)},_unhighlightTag:function(t){t.removeClass(this._CSS_STYLES.SEARCH_CHOICE_FOCUS)},_removeTag:function(i){i&&-1!==t.indexOf(this.values,i)&&this.values.splice(t.indexOf(this.values,i),1)},_hideGrid:function(){s.byId(this._gridId)&&a.set(s.byId(this._gridId),"display","none"),this._gridHasFocus=!1},_showGrid:function(){a.set(s.byId(this._gridId),"display","block");var t=a.get(s.byId(this._attachmentNode),"width");a.set(s.byId(this._gridId),"width",t+"px")},_setFocusOnFirstRow:function(t,i){return c(".dgrid-content .dgrid-cell",this._grid.domNode)[i]||c(".dgrid-content .dgrid-row",this._grid.domNode)[i]},_createTags:function(t){c(this._CHOICE_FOCUS,s.byId(this.id)).removeClass("select2-search-choice-focus");var i=o.create("li",null,this._autocompleteList);r.add(i,this._CSS_STYLES.CHOICE);var h=o.create("div",{title:t},i);d.set(h,this._htmlEncode(t));var a=o.create("a",{href:"#"},h);r.add(a,this._CSS_STYLES.CLOSE_ICON),_(a,"click",e.hitch(this,function(t){var i=t.target.parentElement.innerText||t.target.parentElement.textContent;try{this._store.add({tag:i})}catch(e){}this._grid.refresh(),this._removeTag(i),this._emitRemoved(i),this._emitChanged(),o.destroy(t.target.parentNode.parentNode),t.preventDefault()}));var n=S.byId(this._filterId);o.place(n.domNode,this._autocompleteList,"last"),this._hideGrid(),this.values.push(t),this._emitAdded(t),this._emitChanged()},_emitAdded:function(t){this.emit("tags-add",{tag:t})},_emitRemoved:function(t){this.emit("tags-remove",{tag:t})},_emitChanged:function(){this.emit("tags-change",{tags:this.get("tags")})},_renderItem:function(t){return o.create("div",{innerHTML:t.tag})},_createContainerNode:function(){this._containerNode=o.create("div",null,this._attachmentNode),r.add(this._containerNode,this._CSS_STYLES.MULTI),a.set(this._containerNode,{maxWidth:this.maxWidth,minWidth:this.minWidth})},_createTagList:function(){this._autocompleteList=o.create("ul",null,this._containerNode),r.add(this._autocompleteList,this._CSS_STYLES.CHOICES)},_createInput:function(){var t=o.create("li",null,this._autocompleteList,"last");r.add(t,this._CSS_STYLES.SEARCH_FIELD),this._inputTextBox=new C({id:this._filterId,placeHolder:this.i18n.addTags,intermediateChanges:!0,trim:!0,style:{border:"none"}},t),r.add(this._inputTextBox,"input-text-box"),a.set(this._inputTextBox,"width",this.minWidth),(l("ie")>8||l("trident")>4)&&r.add(this._inputTextBox.domNode,"ie-style"),this.own(f.watch("curNode",e.hitch(this,this._blurHandler)))},_createDropDownList:function(){this._dropDownList=o.create("div",{id:this._gridId},this._containerNode),r.add(this._dropDownList,"drop-down-list"),a.set(this._dropDownList,"width",this.minWidth)},_getUniqueTags:function(i){var s,h=[];return t.forEach(i,e.hitch(this,function(t){s=this._stripHTML(t),I.isDefined(s)&&s.length>0&&h.push(s)})),t.filter(h,e.hitch(this,function(i,e){return t.indexOf(h,i)===e}))},_stripHTML:function(t){return t&&t.replace(/<(?:.|\s)*?>/g,"")},_htmlEncode:function(t){return t?u.escape(t):t},isValid:function(){var t=this.get("value");return!this.required||I.isDefined(t)&&t.length>0},validate:function(){this._created&&!this.isValid()?(h.set(this.domNode,"aria-invalid","true"),this._displayMessage(this.i18n.required)):(h.set(this.domNode,"aria-invalid","false"),this._clearMessage())},reset:function(){this.clearTags()},focus:function(){f.focus(this.domNode),this._inputTextBox.focus()},prepopulate:function(i){t.forEach(i,e.hitch(this,function(t){this._createTags(t),this._store.remove(t)}))},clearTags:function(){var i,h=c(this._CSS_STYLES.CLASS_SELECTOR+this._CSS_STYLES.CHOICE,s.byId(this.id)),r=!1;h.length>0&&(r=!0,t.forEach(h,e.hitch(this,function(t){try{i=c(this._CHOICE_ALL_SELECTOR,s.byId(this.id))[0].title,this._store.add({tag:i})}catch(e){}o.destroy(t),this._emitRemoved(i)})),this.values=[],r&&this._emitChanged())},addStyledTags:function(i,e){r.add(s.byId(e),this._CSS_STYLES.MULTI);var h=o.create("ul",null,s.byId(e));r.add(h,this._CSS_STYLES.CHOICES),a.set(h,"border","none"),t.forEach(i,function(t){var i=o.create("li",null,h);a.set(i,"padding","3px 5px 3px 5px"),r.add(i,"select2-search-resultSet");var e=o.create("div",{title:t},i);d.set(e,t)})}})});