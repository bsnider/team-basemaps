// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","../Widget","./PopupRendererViewModel","../../core/requireUtils","../../core/watchUtils","dojo/_base/lang","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/on","dijit/_TemplatedMixin","dijit/a11yclick","dojo/i18n!./nls/PopupRenderer","dojo/text!./templates/PopupRenderer.html"],function(e,t,i,r,a,n,s,o,d,c,m,h,l,p){var u={base:"esri-popup-renderer",container:"esri-popup-renderer-container",main:"esri-popup-renderer-main",content:"esri-popup-renderer-content",contentElement:"esri-popup-renderer-content-element",text:"esri-popup-renderer-text",attachments:"esri-popup-renderer-attachments",attachmentsTitle:"esri-popup-renderer-attachments-title",attachmentsItem:"esri-popup-renderer-attachments-item",attachmentsItemIcon:"esri-popup-renderer-attachments-item-icon esri-icon-download",fields:"esri-popup-renderer-fields",btn:"esri-popup-renderer-button",icon:"esri-popup-renderer-icon",iconText:"esri-icon-font-fallback-text",media:"esri-popup-renderer-media",mediaContainer:"esri-popup-renderer-media-container",mediaItemContainer:"esri-popup-renderer-media-item-container",mediaItem:"esri-popup-renderer-media-item",mediaItemTitle:"esri-popup-renderer-media-item-title",mediaItemCaption:"esri-popup-renderer-media-item-caption",mediaPrevious:"esri-media-previous",previousIconLTR:"esri-previous-icon-ltr esri-icon-left-triangle-arrow",previousIconRTL:"esri-previous-icon-rtl esri-icon-right-triangle-arrow",mediaNext:"esri-media-next",nextIconLTR:"esri-next-icon-ltr esri-icon-right-triangle-arrow",nextIconRTL:"esri-next-icon-rtl esri-icon-left-triangle-arrow",mediaSummary:"esri-popup-renderer-media-summary",mediaCount:"esri-popup-renderer-media-count",mediaImageSummary:"esri-popup-renderer-media-image-summary",mediaImageIcon:"esri-popup-renderer-media-image-icon esri-icon-media",mediaChartSummary:"esri-popup-renderer-media-chart-summary",mediaChartIcon:"esri-popup-renderer-MediaChartIcon esri-icon-chart",loading:"esri-popup-renderer-loading",loadingSpinnerContainer:"esri-popup-renderer-loading-container",loadingSpinner:"esri-icon esri-icon-loading-indicator esri-rotating",showMediaPagination:"esri-popup-renderer-show-media-pagination",chart:"esri-chart"},f=/^\s*(https?:\/\/[^\s]+)\s*$/i,v="data-element-index",_={previous:"previous",next:"next"},g=t.createSubclass([m],{declaredClass:"esri.widgets.Popup.PopupRenderer",templateString:p,properties:{viewModel:{type:i}},baseClass:u.base,constructor:function(){this._charts=[],this._chartTooltips=[]},postCreate:function(){this.inherited(arguments);var e=this,t=this.viewModel;this.own(a.init(t,"waitingForContent",this._loadingSpinner.bind(this)),a.init(t,"content",this._render.bind(this)),c(this._contentNode,c.selector("."+u.mediaNext,h),function(){e._nextMedia(this)}),c(this._contentNode,c.selector("."+u.mediaPrevious,h),function(){e._previousMedia(this)}))},destroy:function(){this._destroyCharts(),this._clearResizeTimer()},_i18n:l,_css:u,resize:function(){this._resizeCharts(),this.emit("resize")},_clearResizeTimer:function(){this._mediaResizeTimer&&(clearTimeout(this._mediaResizeTimer),this._mediaResizeTimer=0)},_countMediaInfos:function(e){var t=0,i=0;return e.forEach(function(e){"image"===e.type?t++:-1!==e.type.indexOf("chart")&&i++}),{total:i+t,images:t,charts:i}},_createMediaNodes:function(e){this._destroyCharts();var t=e.mediaIndex,i=e.mediaInfos[t],r=e.node;d.empty(r);var a=d.create("div",{className:u.mediaItem},r),n=this._createMediaType(i,t);d.place(n,a,"only"),i.title&&d.create("div",{className:u.mediaItemTitle,innerHTML:i.title},r),i.caption&&d.create("div",{className:u.mediaItemCaption,innerHTML:i.caption},r),this._clearResizeTimer(),this._mediaResizeTimer=setTimeout(function(){this.resize(),this._clearResizeTimer()}.bind(this),0)},_createMediaType:function(t){var i,a=t.value;if("image"===t.type){var n=d.create("img",{alt:t.title||"",src:a.sourceURL});a.linkURL?(i=d.create("a",{title:t.title||"",href:a.linkURL,target:this._preventNewTab(a.linkURL)?"":"_blank"}),d.place(n,i)):i=n}else if(-1!==t.type.indexOf("chart")){i=d.create("div",{className:u.chart},i);var s=["dojox/charting/Chart2D","dojox/charting/action2d/Tooltip"],o=t.value.theme||this.chartTheme;"string"==typeof o&&(o=o.replace(/\./gi,"/"),-1===o.indexOf("/")&&(o="dojox/charting/themes/"+o)),o||(o="dojox/charting/themes/Claro"),s.push(o),this._cancelChartModules(),this._chartsPromise=r.when(e,s).then(function(e){var r=e[0],a=e[1],n=e[2];this._showChart(i,t.type,t.value,r,a,n),this._chartsPromise=null}.bind(this))}return i},_cancelChartModules:function(){this._chartsPromise&&this._chartsPromise.cancel()},_destroyCharts:function(){this._cancelChartModules();var e;if(this._chartTooltips&&this._chartTooltips.length)for(e=0;e<this._chartTooltips.length;e++)this._chartTooltips[e].destroy();if(this._chartTooltips.length=0,this._charts&&this._charts.length)for(e=0;e<this._charts.length;e++)this._charts[e].destroy();this._charts.length=0},_loadingSpinner:function(e){o.toggle(this.domNode,u.loading,!!e)},_nextMedia:function(e){this._pageMedia(e,_.next)},_pageMedia:function(e,t){var i,r,a=s.get(e,v);if(a&&(i=parseInt(a,10),r=this._elementInfo[i]),r){var n=r.mediaInfos,o=r.mediaIndex;t===_.previous?o--:o++,n&&n.length&&(o=(o+n.length)%n.length),r.mediaIndex=o,this._createMediaNodes(r)}},_preventNewTab:function(e){return e=e&&n.trim(e).toLowerCase(),e&&(0===e.indexOf("mailto:")||0===e.indexOf("tel:"))},_previousMedia:function(e){this._pageMedia(e,_.previous)},_render:function(e){this._elementInfo=[],this._destroyCharts(),d.empty(this._contentNode);var t=this.viewModel;if(e)if("string"==typeof e){var i=this._renderText({type:"text",text:e});i&&d.place(i,this._contentNode,"only")}else Array.isArray(e)&&e.forEach(function(e,i){var r,a=e.type;switch(a){case t.contentTypes.attachments:r=this._renderAttachments(e,i);break;case t.contentTypes.fields:r=this._renderFields(e,i);break;case t.contentTypes.media:r=this._renderMedia(e,i);break;case t.contentTypes.text:r=this._renderText(e,i)}r&&d.place(r,this._contentNode,0===i?"only":"last")},this);this.resize()},_renderAttachments:function(e){var t,i=e.attachmentInfos;if(i&&i.length){t=d.create("div"),o.add(t,[u.attachments,u.contentElement]),d.create("div",{className:u.attachmentsTitle,textContent:l.attach},t);var r=d.create("ul",{},t);i.forEach(function(e){var t=d.create("li",{},r),i=d.create("a",{href:e.url,target:"_blank"},t);d.create("span",{className:u.attachmentsItemIcon},i),d.create("span",{className:u.attachmentsItem,textContent:e.name||l.noTitle},i)},this)}return t},_renderFields:function(e){var t,i=this.viewModel,r=i.graphic.getEffectivePopupTemplate(),a=e.fieldInfos||r&&r.fieldInfos;if(a){var n=i.formattedAttributes;t=d.create("div"),o.add(t,[u.fields,u.contentElement]);var s=d.create("table",{summary:l.fieldsSummary},t),c=d.create("tbody",{},s);a.forEach(function(e){var t=e.visible;if(t){var i,r=e.fieldName,a=e.label||r,s=n[r]||"";s&&"string"==typeof s&&(i=s.replace(f,'<a target="_blank" href="$1" title="'+a+'">'+l.view+"</a>"));var o=d.create("tr",{},c),m=a,h=s;i&&i!==s&&(m=a,h=i),d.create("th",{innerHTML:m},o),d.create("td",{innerHTML:h},o)}},this)}return t},_renderMedia:function(e,t){var i,r=e.mediaInfos;if(r&&r.length){var a=this._countMediaInfos(r),s={tabIndex:"0",role:"button"};s[v]=t,i=d.create("div"),o.add(i,[u.media,u.contentElement]);var c=a.total>1;o.toggle(i,u.showMediaPagination,c);var m=d.create("ul",{className:u.mediaSummary},i),h=d.create("li",{className:u.mediaImageSummary},m);d.create("span",{className:u.mediaCount,"aria-label":l.numImages,textContent:"("+a.images+")"},h),d.create("span",{"aria-hidden":!0,className:u.mediaImageIcon},h);var p=d.create("li",{className:u.mediaImageSummary},m);d.create("span",{className:u.mediaCount,"aria-label":l.numCharts,textContent:"("+a.charts+")"},p),d.create("span",{"aria-hidden":!0,className:u.mediaChartIcon},p);var f=d.create("div",{className:u.mediaContainer},i),_=d.create("div",n.mixin({title:l.previous},s),f);o.add(_,[u.btn,u.mediaPrevious]);var g=d.create("span",{"aria-hidden":!0},_);o.add(g,[u.icon,u.previousIconLTR]);var x=d.create("span",{"aria-hidden":!0},_);o.add(x,[u.icon,u.previousIconRTL]),d.create("span",{className:u.iconText,textContent:l.previous},_);var T=d.create("div",{className:u.mediaItemContainer},f),y={mediaIndex:0,node:T,mediaInfos:r};this._elementInfo[t]=y,this._createMediaNodes(y);var I=d.create("div",n.mixin({title:l.next},s),f);o.add(I,[u.btn,u.mediaNext]);var b=d.create("span",{"aria-hidden":!0},I);o.add(b,[u.icon,u.nextIconLTR]);var C=d.create("span",{"aria-hidden":!0},I);o.add(C,[u.icon,u.nextIconRTL]),d.create("span",{className:u.iconText,textContent:l.next},I)}return i},_renderText:function(e){var t;return e&&e.text&&(t=d.create("div",{innerHTML:e.text}),o.add(t,[u.text,u.contentElement])),t},_resizeCharts:function(){if(this._charts&&this._charts.length)for(var e=0;e<this._charts.length;e++){var t=this._charts[e],i=t.node;i&&i.offsetWidth&&i.offsetHeight&&t.resize()}},_showChart:function(e,t,i,r,a,n){var s=new r(e,{margins:{l:4,t:4,r:4,b:4}});switch(n&&s.setTheme(n),t){case"pie-chart":s.addPlot("default",{type:"Pie",labels:!1}),s.addSeries("Series A",i.fields);break;case"line-chart":s.addPlot("default",{type:"Markers"}),s.addAxis("x",{min:0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),s.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"}),i.fields.forEach(function(e,t){e.x=t+1}),s.addSeries("Series A",i.fields);break;case"column-chart":s.addPlot("default",{type:"Columns",gap:3}),s.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"}),s.addSeries("Series A",i.fields);break;case"bar-chart":s.addPlot("default",{type:"Bars",gap:3}),s.addAxis("x",{includeZero:!0,fixUpper:"minor",minorLabels:!1}),s.addAxis("y",{vertical:!0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),s.addSeries("Series A",i.fields)}var o=new a(s);s.render(),this._charts.push(s),this._chartTooltips.push(o)}});return g});