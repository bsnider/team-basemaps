// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../PopupTemplate","../../core/Accessor","../../core/Collection","../../core/Evented","../../core/HandleRegistry","../../core/promiseUtils","../../core/watchUtils","dojo/fx/easing","dojo/_base/lang"],function(e,t,i,n,s,o,a,r,c){var u="temporary",l={disabled:"disabled",ready:"ready"},h={id:"zoom-to"};return t.createSubclass([n],{declaredClass:"esri.widgets.Popup.PopupViewModel",properties:{actions:{type:i.ofType(e.Action)},animationOptions:{},content:{},featureCount:{readOnly:!0},features:{},location:{},pendingPromisesCount:{readOnly:!0},promises:{},selectedFeature:{readOnly:!0},selectedFeatureIndex:{},state:{readOnly:!0},title:{},updateLocationEnabled:{},view:{},waitingForResult:{dependsOn:["pendingPromisesCount","featureCount"],readOnly:!0},zoomFactor:{},zoomScale:{readOnly:!0}},_handles:null,constructor:function(){this._handles=new s},getDefaults:function(){return c.mixin(this.inherited(arguments),{actions:[h],animationOptions:{duration:300,easing:r.quadInOut},promises:[]})},initialize:function(){this._handles.add(a.init(this,"view.scale",this._scaleWatcher))},destroy:function(){this._handles.destroy(),this._handles=null,this.view=null},actions:[h],animationOptions:{duration:300,easing:r.quadInOut},content:null,featureCount:0,features:null,_featuresSetter:function(e){this._set("features",e),this._updateFeatureCount(e),this.pendingPromisesCount||(this.selectedFeatureIndex=-1,e.length&&(this.selectedFeatureIndex=0))},location:null,pendingPromisesCount:0,waitingForResult:!1,_waitingForResultGetter:function(){return this.pendingPromisesCount>0&&0===this.featureCount},promises:[],_promisesSetter:function(e){var t=this._get("promises"),i=e;t&&t.forEach(function(e){e.cancel()}),this.features=[],this._set("pendingPromisesCount",0),this._set("promises",i),i&&i.length&&(this._set("pendingPromisesCount",i.length),i=i.slice(0),i.forEach(function(e){e.always(function(t){if(!e.isCanceled()){var i=this.pendingPromisesCount-1;this._set("pendingPromisesCount",i),this._updateFeatures(e,t)}}.bind(this))},this))},selectedFeature:null,selectedFeatureIndex:-1,_selectedFeatureIndexSetter:function(e){(isNaN(e)||-1>e)&&(e=-1);var t=null,i=this.features;i&&i.length&&(e=(e+i.length)%i.length,t=i[e]),this._set("selectedFeature",t),this._set("selectedFeatureIndex",e),this._selectedFeatureChange(t,this.updateLocationEnabled)},_stateGetter:function(){this._set("state",this.get("view.ready")?l.ready:l.disabled)},title:"",updateLocationEnabled:!1,_updateLocationEnabledSetter:function(e){this._selectedFeatureChange(this.selectedFeature,e),this._set("updateLocationEnabled",e)},view:null,zoomFactor:4,_zoomFactorSetter:function(e){var t=this.view;t&&this._setZoomScale(t.scale,e),this._set("zoomFactor",e)},zoomScale:0,centerAtLocation:function(){return this.location&&this.view?this.view.goTo({target:this.location,scale:this.view.scale},this.animationOptions):void 0},clear:function(){this.set({promises:[],features:[],content:null,title:null,location:null})},triggerAction:function(e){var t=this.actions.getItemAt(e);t&&this.emit("trigger-action",{action:t})},next:function(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this},previous:function(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this},zoomToLocation:function(){var e=this.view;if(e){var t,i=this.selectedFeature,n=i&&i.geometry,s=i&&i.symbol&&"3d"===e.type;return n||s?(t={target:i},n&&"point"===n.type&&this._isScreenSize(i)&&(t.scale=this.zoomScale,this.location=n)):t={target:this.location,scale:this.zoomScale},e.goTo(t,this.animationOptions)}return o.resolve()},_isScreenSize:function(e){if("3d"!==this.view.type||"esri.Graphic"!==e.declaredClass)return!0;var t=!0,i=this.view.getViewForGraphic(e);return i&&i.whenGraphicBounds&&i.whenGraphicBounds(e).then(function(e){t=!e||e[0]===e[3]&&e[1]===e[4]&&e[2]===e[5]}),t},_getSelectedFeatureActions:function(){this._originalActions&&(this.actions=this._originalActions,this._originalActions=null);var e=this.actions.filter(function(e){return!e[u]},this),t=e,i=this.selectedFeature.getEffectivePopupTemplate();if(i&&i.actions){for(var n=i.actions,s=0;s<n.length;s++)n.getItemAt(s)[u]=!0;i.overwriteActions?(this._originalActions=e,t=n):t=e.concat(n)}this.actions=t},_scaleWatcher:function(e){this._setZoomScale(e,this.zoomFactor)},_getPointFromGeometry:function(e){var t=e&&e.type;switch(t){case"point":return e;case"extent":return e.center;case"polygon":return e.centroid;case"multipoint":case"polyline":return e.extent.center;default:return null}},_selectedFeatureChange:function(e,t){e&&(t&&(this.location=this._getPointFromGeometry(this.selectedFeature.geometry)),this._getSelectedFeatureActions())},_updateFeatureCount:function(e){var t=0;e&&e.length&&(t=e.length),this._set("featureCount",t)},_setZoomScale:function(e,t){this._set("zoomScale",e/t)},_updateFeatures:function(e,t){if(e&&this.promises){var i=this._validatePromise(e);if(!i||t instanceof Error)return void console.error(this.declaredClass+":: Invalid promise");if(t&&t.length){var n={};if(this.features&&this.features.length){var s=t.filter(function(e){return-1===this.features.indexOf(e)},this);n.features=this.features.concat(s)}else n.features=t,n.selectedFeatureIndex=0;this.set(n)}}},_validatePromise:function(e){return this.promises.indexOf(e)>-1}})});