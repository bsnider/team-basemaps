// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../config","../../core/Accessor","../../core/Error","../../core/Evented","../../core/promiseUtils","../../geometry/Point","../../geometry/support/webMercatorUtils","../../Graphic","../../symbols/PictureMarkerSymbol","../../tasks/GeometryService","../../tasks/support/ProjectParameters","../../portal/Portal","dojo/_base/lang","dojo/Deferred","require"],function(e,t,i,o,r,n,s,a,c,l,h,u,d,g,p){var f={disabled:"disabled",ready:"ready",locating:"locating",unsupported:"feature-unsupported"},_=15e3,v=t.createSubclass([o],{properties:{geolocationOptions:{},goToLocationEnabled:{},graphic:{type:a},state:{dependsOn:["view.ready"],readOnly:!0},view:{}},declaredClass:"esri.widgets.Locate.LocateViewModel",constructor:function(){this.locate=this.locate.bind(this)},getDefaults:function(){return d.mixin(this.inherited(arguments),{geolocationOptions:{maximumAge:0,timeout:15e3,enableHighAccuracy:!0},graphic:{}})},initialize:function(){navigator.geolocation?window.hasOwnProperty("isSecureContext")&&!window.isSecureContext&&(console.log(this.declaredClass,"navigator.geolocation requires a secure origin."),this._geolocationUsable=!1):(console.log(this.declaredClass,"navigator.geolocation unsupported."),this._geolocationUsable=!1)},destroy:function(){this._clear()},_geolocationUsable:!0,geolocationOptions:null,goToLocationEnabled:!0,graphic:null,_graphicSetter:function(e){e&&!e.symbol&&(e.symbol=new c({url:p.toUrl("./images/sdk_gps_location.png"),width:21,height:21})),this._set("graphic",e)},state:f.disabled,_stateGetter:function(){return this._geolocationUsable?this.get("view.ready")?this._locating?f.locating:f.ready:f.disabled:f.unsupported},view:null,locate:function(){if(this.state===f.disabled)return r.reject(new i(this.declaredClass,"Cannot locate when disabled."));this._locating&&(this._locating.cancel(),this._locating=null);var e=this._getCurrentPosition().then(function(e){return this.view.graphics.remove(this.graphic),this.graphic&&(this.graphic=this.graphic.clone(),this.view.graphics.push(this.graphic)),this.emit("locate",{position:e}),e}.bind(this)).otherwise(function(e){return e||(e=new i(this.declaredClass,"Could not get current position.")),this._emitError(e),e}.bind(this));return this._locating=e,this.notifyChange("state"),r.timeout(e,_).always(function(){this._locating=null,this.notifyChange("state")}.bind(this))},_clear:function(){this.view&&this.view.graphics.remove(this.graphic)},_clearCurrentLocationVars:function(){this._graphic=null,this._position=null,this._scale=null},_positionToObject:function(e){return e?{coords:d.mixin({},e.coords),timestamp:e.timestamp}:{}},_getCurrentPosition:function(){var e=new g;return this._clearCurrentLocationVars(),navigator.geolocation.getCurrentPosition(function(t){e.isFulfilled()||(t=this._positionToObject(t),this._setPosition(t).then(function(t){e.resolve(t)}.bind(this),function(t){t||(t=new i(this.declaredClass,"Error setting position.")),e.reject(t)}.bind(this)))}.bind(this),function(t){t||(t=new i(this.declaredClass,"Could not get current position.")),e.reject(t)}.bind(this),this.geolocationOptions),e.promise},_getGeometryServiceUrl:function(){var t=new g,i=e.geometryServiceUrl;if(i)t.resolve(i);else{var o=u.getDefault();o.load().always(function(){i=o.get("helperServices.geometry.url"),t.resolve(i)})}return t.promise},_projectPoint:function(e){var t=new g,o=this.get("view.spatialReference");return o.isWebMercator?t.resolve(s.geographicToWebMercator(e)):o.isWGS84?t.resolve(e):this._getGeometryServiceUrl().then(function(r){if(r){var n=new h({geometries:[e],outSR:o}),s=new l({url:r});s.project(n).then(function(e){e&&e.length?t.resolve(e[0]):t.reject(new i(this.declaredClass,"Point was not projected."))}.bind(this),t.reject)}else t.resolve(new i(this.declaredClass,"please specify a geometry service on esri/config to project."))}),t.promise},_getScale:function(e){var t=5e4,i=e&&e.coords&&e.coords.accuracy,o=this.scale;return o||i||t},_createPoint:function(e){var t=e&&e.coords;if(t)return new n({longitude:t.longitude,latitude:t.latitude,z:t.altitude||null,spatialReference:{wkid:4326}})},_animatePoint:function(e,t,o,n){return n=this._createGraphic(e,t),this._graphic=n,this.goToLocationEnabled?this.view.goTo({target:e,scale:o}).then(function(){return t}.bind(this)).otherwise(function(e){return e||(e=new i(this.declaredClass,"Could not center.")),e}.bind(this)):r.resolve(t)},_setPosition:function(e){var t,o,r=new g;this._clearCurrentLocationVars(),this._position=e;var n=this._createPoint(e);n&&(o=this._createGraphic(n,e),this._graphic=o);var s=this._getScale(e);return this._scale=s,n?this._projectPoint(n).then(function(t){this._animatePoint(t,e,s,o).then(r.resolve,r.reject)}.bind(this),function(e){e||(e=new i(this.declaredClass,"Error projecting point.")),r.reject(e)}.bind(this)):(t=new i(this.declaredClass,"Invalid point"),r.reject(t)),r.promise},_createGraphic:function(e,t){var i=this.graphic;if(e&&t&&i)return i.geometry=e,i},_emitError:function(e){this.emit("locate-error",{error:e})}});return v});