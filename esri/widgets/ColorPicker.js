// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../Color","./ColorPicker/colorUtil","./ColorPicker/HexPalette","./support/_Tooltip","./Widget","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/on","dojo/query","dojo/i18n!./ColorPicker/nls/ColorPicker","dojo/text!./ColorPicker/templates/ColorPicker.html","./HorizontalSlider","dijit/form/RadioButton","dijit/form/TextBox","dijit/form/ToggleButton","dojo/NodeList-dom"],function(e,t,o,s,r,i,a,l,n,h,c,d,_,u){var p="no-color",g=13,C={root:"esri-color-picker",container:"esri-container",header:"esri-header",footer:"esri-footer",middle:"esri-middle",swatch:"esri-swatch",swatchRow:"esri-swatch-row",swatchPreview:"esri-swatch-preview",swatchTransparencyBackground:"esri-swatch-transparency-background",palette:"esri-palette",paletteOptions:"esri-palette-options",paletteToggle:"esri-palette-toggle",label:"esri-label",hexInput:"esri-hex-input",recent:"esri-recent",suggested:"esri-suggested",selected:"esri-selected",disabled:"esri-disabled",section:"esri-section",transparencySlider:"esri-transparency-slider",alt:"esri-alt",hidden:"esri-hidden"},w=r.createSubclass([i,a,s],{declaredClass:"esri.widgets.ColorPicker",templateString:u,labels:_,baseClass:C.root,css:C,constructor:function(e){e=e||{},this._brightsPalette=new o({colors:e.palette}),this._pastelsPalette=new o({colors:this._toPastels(this._brightsPalette.colors)}),this._activePalette=this._brightsPalette,this._swatches={}},buildRendering:function(){this.inherited(arguments),this._createPalettes(),this.required||(this._noColorSwatchNode=n.create("div",{className:C.swatch+" "+C.hidden},this.dap_hexInput.domNode,"after")),l.toggle(this.dap_transparencySection,C.hidden,!this.showTransparencySlider),l.toggle(this.dap_recentColorSection,C.hidden,!this.showRecentColors),l.toggle(this.dap_suggestedColorSection,C.hidden,!this.showSuggestedColors)},postCreate:function(){this.inherited(arguments),this._addListeners(),this._selectColor(),this.dap_hexInput.intermediateChanges=!0,this.dap_transparencySlider.intermediateChanges=!0;var e=this.labels;this.createTooltips([{node:this.dap_paletteContainer,label:e.paletteTooltip},{node:this.dap_hexInput,label:e.hexInputTooltip},{node:this._noColorSwatchNode,label:e.noColorTooltip},{node:this.dap_paletteToggle,label:e.moreColorsTooltip}])},_activePalette:null,_brightsPalette:null,_pastelsPalette:null,_swatches:null,_noColorSwatchNode:null,_previousColor:null,color:null,_getColorAttr:function(){var t=this._get("color");return t===p?p:new e(t)},_setColorAttr:function(o,s){if(o=o||p,s=s||void 0===s,!this.required){if(o===p)return this._set("color",p),this._previousColor=p,this._disableTransparencySlider(),this._clearSelection(),this._silentlyUpdateHexInput(p),this._updatePreviewSwatch(o),l.add(this._noColorSwatchNode,C.selected),void(s&&this.emit("color-change",{color:p}));this._enableTransparencySlider(),l.remove(this._noColorSwatchNode,C.selected)}var r,i=t.normalizeColor(o),a=this._previousColor;if(a){if(t.equal(a,i))return;var n=this._findColorSwatch(a);n&&(l.remove(n,C.selected),h.set(n,"borderColor",""))}r=new e(i),this._set("color",r),this._previousColor=i,this._silentlyUpdateIntermediateChangingValueWidget(this.dap_transparencySlider,1-r.a),this._updatePreviewSwatch(r),this._checkSelection(),this._silentlyUpdateHexInput(r),this.trackColors&&this._addRecentColor(r.toHex()),s&&this.emit("color-change",{color:new e(r)})},colorsPerRow:g,_setColorsPerRowAttr:function(e){var t=e>0?e:g;this._set("colorsPerRow",t)},_setPaletteAttr:function(e){var t=this._activePalette===this._brightsPalette;this._brightsPalette.colors=e,this._pastelsPalette.colors=this._toPastels(this._brightsPalette.colors),this._activePalette=t?this._brightsPalette:this._pastelsPalette,this._createPalettes(),this._togglePalette(!t)},recentColors:[],_getRecentColorsAttr:function(){return this._get("recentColors").map(function(e){return t.normalizeColor(e)})},_setRecentColorsAttr:function(e){var o=e||[];this.showRecentColors&&(o=o.map(function(e){return t.normalizeColor(e).toHex()})),this._set("recentColors",o),0===o.length?this._clearRecentSwatches():this._renderRecentSwatches()},required:!1,showRecentColors:!0,showSuggestedColors:!1,showTransparencySlider:!0,suggestedColors:null,_getSuggestedColorsAttr:function(){return this._get("suggestedColors").map(function(e){return t.normalizeColor(e)})},_setSuggestedColorsAttr:function(e){if(this.showSuggestedColors){this._clearSuggestedSwatches();var o=e||[];o=o.map(function(e){return t.normalizeColor(e).toHex()}),this._set("suggestedColors",o),o.length>0&&this._renderSuggestedSwatches()}},trackColors:!0,addRecentColor:function(e){e&&e!==p&&this._addRecentColor(t.normalizeColor(e).toHex())},saveRecentColors:function(e){localStorage.setItem(e,JSON.stringify(this.get("recentColors")))},loadRecentColors:function(e){this.set("recentColors",JSON.parse(localStorage.getItem(e)))},_toPastels:function(t){var o=new e([238,238,238]);return t.map(function(t){return e.blendColors(new e(t),o,.2)})},_createSwatch:function(e){var t=e.className,o=e.hexColor||"transparent",s=e.paletteNode;return n.create("span",{className:t,style:{background:o}},s)},_createSwatches:function(e,t){var o;t.colors.forEach(function(t,s){var r;s%this.colorsPerRow===0&&(o=n.create("div",{className:C.swatchRow},e)),r=this._createSwatch({className:C.swatch,hexColor:t,paletteNode:o}),this._swatches[t]=r},this)},_selectColor:function(){this.set("color",this.color||this._activePalette.colors[0])},_setColorWithCurrentAlpha:function(e){e!==p&&this.color!==p&&(e=t.normalizeColor(e),e.a=this.color.a),this.set("color",e)},_updatePreviewSwatch:function(e){var o,s=this.dap_previewSwatch,r=!0;return e===p?(l.add(s,C.hidden),void h.set(s,{backgroundColor:"",borderColor:""})):(o=t.getContrastingColor(e),l.remove(s,C.hidden),void h.set(s,{backgroundColor:e.toCss(r),borderColor:o.toCss(r)}))},_showBrights:function(){l.remove(this.dap_paletteContainer,C.alt),this._activePalette=this._brightsPalette},_showPastels:function(){l.add(this.dap_paletteContainer,C.alt),this._activePalette=this._pastelsPalette},_setColorFromSwatch:function(e){var t=h.get(e,"backgroundColor");this._setColorWithCurrentAlpha(t)},_checkSelection:function(){var e=this.get("color");this._activePalette.contains(e)?this._highlightColor(e):this._clearSelection()},_addListeners:function(){var e="."+C.swatch;this.own(c(this.dap_paletteContainer,c.selector(e,"click"),function(e){this._setColorFromSwatch(e.target)}.bind(this)),c(this.dap_recentColorPalette,c.selector(e,"click"),function(e){this._setColorFromSwatch(e.target)}.bind(this)),c(this.dap_suggestedColorPalette,c.selector(e,"click"),function(e){this._setColorFromSwatch(e.target)}.bind(this))),this.required||this.own(c(this._noColorSwatchNode,"click",function(){this.set("color",p)}.bind(this)));var o=this.dap_hexInput;o.on("blur",function(){var e=t.normalizeHex(o.get("value"));return t.isShorthandHex(e)?void this._setColorWithCurrentAlpha(e):void this._silentlyUpdateHexInput(this.color)}.bind(this)),o.on("change",function(){var e=t.normalizeHex(o.get("value"));t.isLonghandHex(e)&&this.color.toHex()!==e&&this._setColorWithCurrentAlpha(e)}.bind(this)),this.dap_transparencySlider.on("change",function(e){var o,s=this.get("color");s!==p&&(o=t.normalizeColor(s),o.a=1-e,this._updatePreviewSwatch(o),this._silentlyUpdateHexInput(o),this.set("color",o))}.bind(this)),this.dap_paletteToggle.on("change",this._togglePalette.bind(this))},_togglePalette:function(e){this.dap_paletteToggle.set("checked",e,!1),e?this._showPastels():this._showBrights(),this._checkSelection()},_createPalettes:function(){this._swatches={},n.empty(this.dap_primaryPalette),n.empty(this.dap_secondaryPalette),this._createSwatches(this.dap_primaryPalette,this._brightsPalette),this._createSwatches(this.dap_secondaryPalette,this._pastelsPalette)},_silentlyUpdateHexInput:function(e){var t=e===p?"":e.toHex();this._silentlyUpdateIntermediateChangingValueWidget(this.dap_hexInput,t)},_silentlyUpdateIntermediateChangingValueWidget:function(e,t){e.intermediateChanges=!1,e.set("value",t,!1),e.intermediateChanges=!0},_addRecentColor:function(e){if(e){var t=this.recentColors,o=t.indexOf(e);o>-1&&t.splice(o,1),t.unshift(e),t.length>this.colorsPerRow&&t.pop(),this._renderRecentSwatches()}},_renderRecentSwatches:function(){if(this.recentColors){var e="."+C.recent+"."+C.swatch,t=d(e,this.dap_recentColorPalette);this.recentColors.forEach(function(e,o){if(o<this.colorsPerRow){if(o+1>t.length){var s=this._createSwatch({hexColor:e,className:C.swatch+" "+C.recent,paletteNode:this.dap_recentColorPalette});t.push(s)}h.set(t[o],"backgroundColor",e)}},this)}},_renderSuggestedSwatches:function(){if(this.suggestedColors){var e="."+C.suggested+"."+C.swatch,t=d(e,this.dap_recentColorPalette);this.suggestedColors.forEach(function(e,o){if(o<this.colorsPerRow){if(o+1>t.length){var s=this._createSwatch({hexColor:e,className:C.swatch+" "+C.suggested,paletteNode:this.dap_suggestedColorPalette});t.push(s)}h.set(t[o],"backgroundColor",e)}},this)}},_clearRecentSwatches:function(){n.empty(this.dap_recentColorPalette)},_clearSuggestedSwatches:function(){n.empty(this.dap_suggestedColorPalette)},_clearSelection:function(){d("."+C.selected,this.dap_paletteContainer).removeClass(C.selected)},_highlightColor:function(e){var o,s=this._findColorSwatch(e);s&&(e=t.normalizeColor(e),o=t.getContrastingColor(e),l.add(s,C.selected),h.set(s,"borderColor",o.toHex()))},_findColorSwatch:function(e){var o,s=this._activePalette.colors,r=t.toHex(e);return s.indexOf(r)>-1&&(o=this._swatches[r]),o},_enableTransparencySlider:function(){l.remove(this.dap_transparencyLabel,C.disabled),this.dap_transparencySlider.set("disabled",!1)},_disableTransparencySlider:function(){l.add(this.dap_transparencyLabel,C.disabled),this.dap_transparencySlider.set("disabled",!0)}});return w.NO_COLOR=p,w});