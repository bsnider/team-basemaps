// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["./support/viewModelWiring","./Widget","./Legend/LegendViewModel","../core/watchUtils","../core/HandleRegistry","../core/lang","../core/screenUtils","../symbols/support/gfxUtils","dojox/gfx","dojox/gfx/matrix","dojo/_base/lang","dojo/dom-construct","dojo/dom-style","dojo/dom-class","dojo/i18n!./Legend/nls/Legend"],function(e,t,a,r,i,l,s,n,o,d,c,y,m,g,h){var _="Aa",p=24,f=25,u=50,v={base:"esri-legend",service:"esri-legend__service",label:"esri-legend__service-label",layer:"esri-legend__layer",layerTable:"esri-legend__layer-table",layerCaption:"esri-legend__layer-caption",layerBody:"esri-legend__layer-body",layerRow:"esri-legend__layer-row",layerCell:"esri-legend__layer-cell",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",symbolContainer:"esri-legend__layer-cell esri-legend__layer-cell--symbols",symbol:"esri-legend__symbol",rampContainer:"esri-legend__ramps",colorRamp:"esri-legend__color-ramp",opacityRamp:"esri-legend__opacity-ramp",borderlessRamp:"esri-legend__borderless-ramp",rampTick:"esri-legend__ramp-tick",rampFirstTick:"esri-legend__ramp-tick-first",rampLastTick:"esri-legend__ramp-tick-last",rampLabelsContainer:"esri-legend__ramp-labels",rampLabel:"esri-legend__ramp-label",message:"esri-legend__message",hidden:"esri-hidden"},b={size:22,maxSize:125,padding:6},L=t.createSubclass({properties:{activeLayerInfos:{dependsOn:["viewModel.activeLayerInfos"]},layerInfos:{dependsOn:["viewModel.layerInfos"]},view:{dependsOn:["viewModel.view"]},viewModel:{type:a}},declaredClass:"esri.widgets.Legend",baseClass:v.base,constructor:function(){this._handles=new i,this._DOMByLayerId={}},postCreate:function(){this.inherited(arguments),this._createLegend()},destroy:function(){this._handles.destroy(),this._handles=null},_getActiveLayerInfosAttr:e.createGetterDelegate("activeLayerInfos"),_setActiveLayerInfosAttr:e.createSetterDelegate("activeLayerInfos"),_getLayerInfosAttr:e.createGetterDelegate("layerInfos"),_setLayerInfosAttr:e.createSetterDelegate("layerInfos"),_getViewAttr:e.createGetterDelegate("view"),_setViewAttr:e.createSetterDelegate("view"),_createLegend:function(){var e=this._buildLegendDOM(),t=this.viewModel.activeLayerInfos;t.length?t.forEach(function(t){this._createLegendForLayer(t,e)},this):e.message.textContent=h.noLegend;var a=t.on("change",function(a){var r,i=a.added,l=a.removed;l.forEach(function(e){r=this._DOMByLayerId[e.layer.uid],r&&this._toggleDisplay(r)},this),i.forEach(function(t){r=this._DOMByLayerId[t.layer.uid],r?this._toggleDisplay(r):this._createLegendForLayer(t,e)},this),0===t.length?(this._toggleDisplay(e.message),e.message.textContent=h.noLegend):g.contains(e.message,v.hidden)||this._toggleDisplay(e.message)}.bind(this));this._handles.add(a,"activeLayerInfos-change")},_buildLegendDOM:function(){var e=this.domNode,t=y.create("div",{id:this.id+"_msg",className:v.message,textContent:h.creatingLegend+"..."},e);return{widget:e,message:t}},_createLegendForLayer:function(e,t){var a=r.init(e,"version",function(){var a,r=e.layer.uid;if(e.ready){a=this._buildLegendDOMForLayer(e,t),this._DOMByLayerId[r]=a.root;var i=this._createLegendElements(e,a.layer);i.length&&-1!==this.viewModel.activeLayerInfos.indexOf(e)&&this._toggleDisplay(a.root)}else a=this._DOMByLayerId[r],a&&(delete this._DOMByLayerId[r],y.destroy(a))}.bind(this)),i=r.init(e,"tearingDown",function(t){var a,r=e.layer.uid;t&&(a=this._DOMByLayerId[r],a&&(this._handles.remove(r),delete this._DOMByLayerId[r],y.destroy(a)))}.bind(this));this._handles.add([a,i],e.layer.uid)},_buildLegendDOMForLayer:function(e,t){var a=t.widget.id+"_"+e.layer.uid,r=y.create("div",{id:a,className:v.service+" "+v.hidden},t.widget),i=y.create("p",{textContent:e.title,className:v.label},r),l=y.create("div",{className:v.layer},r);return c.mixin(t,{root:r,title:i,layer:l})},_createLegendElements:function(e,t){var a=e.legendElements,r=e.layer;return a.forEach(function(e){this._createLegendElement(e,t,r)},this),a},_createLegendElement:function(e,t,a){var r="color-ramp"===e.type,i="opacity-ramp"===e.type,l=this._buildDOMForElement(t,e.title,r||i);"symbol-table"===e.type||"size-ramp"===e.type?e.infos.forEach(function(e){this._buildDOMForElementInfo(e,l,a)},this):(r||i)&&this._buildRampDOM(e.infos,l.body,e.overlayColor,i)},_buildDOMForElement:function(e,t,a){t="string"==typeof t?t:t&&this._getTitle(t,a);var r=y.create("div",{className:v.layerTable},e),i=t?y.create("div",{className:v.layerCaption,textContent:t},r):null,l=y.create("div",{className:v.layerBody},r);return{layer:e,table:r,caption:i,body:l}},_buildDOMForElementInfo:function(e,t,a){var r=y.create("div",{className:v.layerRow},t.body),i=b.size,l=b.size,n=b.maxSize,o=b.padding,d=e.symbol,c=d.type,m=s.pt2px(d.size);d&&("simple-marker-symbol"===c?(i=Math.min(Math.max(i,m+o),n),l=Math.min(Math.max(l,m+o),n)):"picture-marker-symbol"==c&&(i=Math.min(Math.max(i,s.pt2px(d.width)),n),l=Math.min(s.pt2px(d.height)||l,n)));var h=y.create("div",{className:v.symbolContainer},r);this._drawSymbol(h,e.symbol,i,l,a),g.add(h.firstChild,v.symbol);var _=y.create("div",{className:v.layerInfo},r);_.textContent=e.label||""},_drawSymbol:function(e,t,a,r,i){"picture-marker-symbol"===t.type&&(e.style.opacity=i.opacity);var l,y=o.createSurface(e,a,r),m=n.getShapeDescriptors(t),g=m.defaultShape,h=g&&"text"===g.type;try{h&&!g.text&&(g.text=_),l=y.createShape(g).setFill(m.fill).setStroke(m.stroke),h&&l.setFont(m.font)}catch(p){return y.clear(),void y.destroy()}var f=l.getBoundingBox(),u=f.width,v=f.height,b=-(f.x+u/2),L=-(f.y+v/2),w=y.getDimensions(),x={dx:b+w.width/2,dy:L+w.height/2};if("simple-marker-symbol"===t.type&&"path"===t.style){var M=i._getScaleMatrix(f,s.pt2px(t.size));l.applyTransform(d.scaleAt(M.xx,M.yy,{x:w.width/2,y:w.height/2}))}if(u>a||v>r){var D=u/a>v/r,I=D?u:v,F=D?a:r,O=(F-5)/I;c.mixin(x,{xx:O,yy:O})}return l.applyTransform(x),y},_buildRampDOM:function(e,t,a,r){var i,l,s,n,d,c,g,h,_,b,L=e.length-1,w=p,x=f;i=y.create("div",{className:v.layerRow},t),s=y.create("div",{className:v.symbolContainer,style:"width:"+w+"px"},i),n=y.create("div",{className:v.rampContainer},s),d=y.create("div",{className:v.colorRamp+" "+(r?v.opacityRamp:"")},n),l=y.create("div",{className:v.layerInfo},i),_="100%",b=L>2?x*L:u,m.set(d,"height",b+"px"),g=o.createSurface(d,_,b);try{h=g.createRect({x:0,y:0,width:_,height:b}),h.setFill({type:"linear",x1:0,y1:0,x2:0,y2:b,colors:e}).setStroke(null),a&&a.a>0&&g.createRect({width:_,height:b}).setFill(a).setStroke(null)}catch(M){g.clear(),g.destroy()}c=y.create("div",{className:v.rampLabelsContainer,style:{height:b+"px"}},l),e.forEach(function(e){e.label&&y.create("div",{className:v.rampLabel,innerHTML:e.label},c)})},_getTitle:function(e,t){var a;return a=t?e.ratioPercentTotal&&"showRatioPercentTotal"||e.ratioPercent&&"showRatioPercent"||e.ratio&&"showRatio"||e.normField&&"showNormField"||e.field&&"showField"||null:e.normField&&"showNormField"||(e.normByPct?"showNormPct":null)||e.field&&"showField"||null,l.substitute({field:e.field,normField:e.normField},h[a])},_toggleDisplay:function(e){var t=g.contains(e,v.hidden);t?g.remove(e,v.hidden):g.add(e,v.hidden)}});return L});