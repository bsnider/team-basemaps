// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/_base/array","dojo/_base/lang","dojo/_base/Deferred","../../config","../Polyline","../Polygon","./webMercatorUtils","./jsonUtils"],function(e,r,n,t,i,a,o,s){function f(e,r){return Math.ceil((e-r)/(2*r))}function c(e,r){var n,t,i,a=e.paths||e.rings,o=a.length;for(n=0;o>n;n++){var s=a[n];for(i=s.length,t=0;i>t;t++){var f=e.getPoint(n,t);e.setPoint(n,t,f.clone().offset(r,0))}}return e}function u(r,n){if(!(r instanceof i||r instanceof a)){var t="_straightLineDensify: the input geometry is neither polyline nor polygon";throw console.error(t),new Error(t)}var o,s=r instanceof i,f=s?r.paths:r.rings,c=[];return e.forEach(f,function(e){c.push(o=[]),o.push([e[0][0],e[0][1]]);var r,t,i,a,s,f,u,l,h,p,g,v;for(s=0;s<e.length-1;s++){if(r=e[s][0],t=e[s][1],i=e[s+1][0],a=e[s+1][1],u=Math.sqrt((i-r)*(i-r)+(a-t)*(a-t)),l=(a-t)/u,h=(i-r)/u,p=u/n,p>1){for(f=1;p-1>=f;f++){var m=f*n;g=h*m+r,v=l*m+t,o.push([g,v])}var d=(u+Math.floor(p-1)*n)/2;g=h*d+r,v=l*d+t,o.push([g,v])}o.push([i,a])}}),s?new i({paths:c,spatialReference:r.spatialReference}):new a({rings:c,spatialReference:r.spatialReference})}function l(e,r,n){var t=1e6;if(r){var i=u(e,t);e=o.webMercatorToGeographic(i,!0)}return n&&(e=c(e,n)),e}function h(e,r,n){var t,i=e.x||e[0];return i>r?(t=f(i,r),e.x?e=e.clone().offset(-2*t*r,0):e[0]=i+-2*t*r):n>i&&(t=f(i,n),e.x?e=e.clone().offset(-2*t*n,0):e[0]=i+-2*t*n),e}function p(r,n){var t=-1;return e.forEach(n.cutIndexes,function(i,a){var o=n.geometries[a],s=o.rings||o.paths;e.forEach(s,function(r,n){e.some(r,function(e){if(e[0]<180)return!0;var t,i,a=0,s=r.length;for(t=0;s>t;t++)i=r[t][0],a=i>a?i:a;a=Number(a.toFixed(9));var c,u=f(a,180),l=-360*u,h=r.length;for(c=0;h>c;c++){var p=o.getPoint(n,c);o.setPoint(n,c,p.clone().offset(l,0))}return!0})}),i===t?o.rings?e.forEach(o.rings,function(e){r[i]=r[i].addRing(e)}):e.forEach(o.paths,function(e){r[i]=r[i].addPath(e)}):(t=i,r[i]=o)}),r}function g(r,u,g,v){var m=new n;m.then(g,v),u=u||t.geometryService;var d,y,b,x,_,E,w,M,O=[],P=[],j=0;e.forEach(r,function(r){if(!r)return void O.push(r);if(d||(d=r.spatialReference,y=d._getInfo(),b=d.isWebMercator,x=b?20037508.342788905:180,_=b?-20037508.342788905:-180,E=b?102100:4326,w=new i({paths:[[[x,_],[x,x]]],spatialReference:{wkid:E}}),M=new i({paths:[[[_,_],[_,x]]],spatialReference:{wkid:E}})),!y)return void O.push(r);var n=s.fromJSON(r.toJSON()),t=r.getExtent();if("point"===r.type)O.push(h(n,x,_));else if("multipoint"===r.type)n.points=e.map(n.points,function(e){return h(e,x,_)}),O.push(n);else if("extent"===r.type){var o=t.clone()._normalize(null,null,y);O.push(o.rings?new a(o):o)}else if(t){var u=f(t.xmin,_),p=2*u*x;n=0===p?n:c(n,p),t=t.clone().offset(p,0),t.intersects(w)&&t.xmax!==x?(j=t.xmax>j?t.xmax:j,n=l(n,b),P.push(n),O.push("cut")):t.intersects(M)&&t.xmin!==_?(j=2*t.xmax*x>j?2*t.xmax*x:j,n=l(n,b,360),P.push(n),O.push("cut")):O.push(n)}else O.push(n)});for(var k=new i,R=f(j,x),C=-90,T=R;R>0;){var z=-180+360*R;k.addPath([[z,C],[z,-1*C]]),C=-1*C,R--}return P.length>0&&T>0?u?u.cut(P,k,function(n){P=p(P,n);var t=[];e.forEach(O,function(e,n){if("cut"===e){var i=P.shift();r[n].rings&&r[n].rings.length>1&&i.rings.length>=r[n].rings.length?(O[n]="simplify",t.push(i)):O[n]=b===!0?o.geographicToWebMercator(i):i}}),t.length>0?u.simplify(t,function(r){e.forEach(O,function(e,n){"simplify"===e&&(O[n]=b===!0?o.geographicToWebMercator(r.shift()):r.shift())}),m.callback(O)},function(e){m.errback(e)}):m.callback(O)},function(e){m.errback(e)}):m.errback(new Error("esri.geometry.normalizeCentralMeridian: 'geometryService' argument is missing.")):(e.forEach(O,function(e,r){if("cut"===e){var n=P.shift();O[r]=b===!0?o.geographicToWebMercator(n):n}}),m.callback(O)),m.promise}function v(n,t,i,a){var o,s=!1;r.isObject(n)&&n&&(r.isArray(n)?n.length&&(o=n[0]&&n[0].declaredClass,o&&-1!==o.indexOf("Graphic")?(n=e.map(n,function(e){return e.geometry}),s=n.length?!0:!1):o&&-1!==o.indexOf("esri.geometry.")&&(s=!0)):(o=n.declaredClass,o&&-1!==o.indexOf("FeatureSet")?(n=e.map(n.features||[],function(e){return e.geometry}),s=n.length?!0:!1):o&&-1!==o.indexOf("esri.geometry.")&&(s=!0))),s&&t.push({index:i,property:a,value:n})}function m(n,t){var i=[];return e.forEach(t,function(t){var a,o=t.i,s=n[o],f=t.p;if(r.isObject(s)&&s)if(f)if("*"===f[0])for(a in s)s.hasOwnProperty(a)&&v(s[a],i,o,a);else e.forEach(f,function(e){v(r.getObject(e,!1,s),i,o,e)});else v(s,i,o)}),i}function d(n,t){var i=0,a={};return e.forEach(t,function(e){var t=e.index,o=e.property,s=e.value,f=s.length||1,c=n.slice(i,i+f);r.isArray(s)||(c=c[0]),i+=f,delete e.value,o?(a[t]=a[t]||{},a[t][o]=c):a[t]=c}),a}function y(n){var t=r.isObject(n)?n.prototype:r.getObject(n+".prototype");e.forEach(t.__msigns,function(r){var n=t[r.n];t[r.n]=function(){var t,i=this,a=[];for(t=0;t<r.c;t++)a[t]=arguments[t];var o={};a.push(o);var s,f,c=[];return i.normalization&&!i._isTable&&(s=m(a,r.a),e.forEach(s,function(e){c=c.concat(e.value)}),c.length&&(f=g(c))),f?f.then(function(e){return o.assembly=d(e,s),n.apply(i,a)}):n.apply(i,a)}})}var b={normalizeCentralMeridian:g,_foldCutResults:p,_prepareGeometryForCut:l,_offsetMagnitude:f,_pointNormalization:h,_updatePolyGeometry:c,_straightLineDensify:u,_createWrappers:y,_disassemble:m,_addToBucket:v,_reassemble:d};return b});