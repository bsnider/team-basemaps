// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../core/declare","../core/Accessoire","../core/JSONSupporter","../core/jsonDictionary","../core/screenUtils","dojo/_base/lang","dojo/_base/array","../Color","../arcade/arcade"],function(e,t,i,a,r,o,n,s,l){var u="size",c="color",p="opacity",f="rotation",h=a({sizeInfo:u,colorInfo:c,transparencyInfo:p,rotationInfo:f}),y=a({width:"width",depth:"depth",height:"height",widthAndDepth:"width-and-depth",all:"all"}),m=Math.PI,_=e([t,i],{declaredClass:"esri.renderer.Renderer",classMetadata:{properties:{requiredFields:{dependsOn:["visualVariables"]}},reader:{exclude:["rotationType","rotationExpression"]}},constructor:function(){this._ipDataCache={}},getDefaults:function(){return o.mixin(this.inherited(arguments),{authoringInfo:null})},_rotationRE:/^\[([^\]]+)\]$/i,_meterIn:{inches:39.3701,feet:3.28084,yards:1.09361,miles:621371e-9,"nautical-miles":539957e-9,millimeters:1e3,centimeters:100,decimeters:10,meters:1,kilometers:.001,"decimal-degrees":180/20015077},_scaleExpr:"view.scale",_requiredFieldsGetter:function(){var e=Object.create(null);return this.collectRequiredFields(e),Object.keys(e)},collectRequiredFields:function(e){var t=[];this.visualVariables&&(t=t.concat(this.visualVariables)),t.forEach(function(t){t&&t.field&&(e[t.field]=!0),t&&t.normalizationField&&(e[t.normalizationField]=!0)})},_visualVariablesReader:function(e,t){return this._readVariables(e,t)},_visualVariablesSetter:function(e){var t=this._ipDataCache;n.forEach(this.visualVariables,function(e,i){t.hasOwnProperty(i)&&(t[i]=null)},this);var i=n.some(e,function(e){return!!e.target});return i&&e.sort(function(e,t){var i;return i=e.target===t.target?0:e.target?1:-1}),n.forEach(e,function(e,i){e.type===c?t[i]=this._processColorInfo(e):e.type===p?t[i]=this._processOpacityInfo(e):e.type===u&&(t[i]=this._processSizeInfo(e))},this),e},getSymbol:function(){},getVisualVariableValues:function(e,t){var i,a=this.visualVariables;return a&&(i=n.map(a,function(i){var a,r=i.type,n=r+"Info";switch(t=o.mixin({},t),t[n]=i,r){case u:a=this.getSize(e,t);break;case c:a=this.getColor(e,t);break;case p:a=this.getOpacity(e,t);break;case f:a=this.getRotationAngle(e,t)}return{variable:i,value:a}},this)),i},hasVisualVariables:function(e,t){return e?!!this.getVisualVariablesForType(e,t):!!(this.getVisualVariablesForType(u,t)||this.getVisualVariablesForType(c,t)||this.getVisualVariablesForType(p,t)||this.getVisualVariablesForType(f,t))},getVisualVariablesForType:function(e,t){var i,a=this.visualVariables;return a&&(i=n.filter(a,function(i){return i.type===e&&("string"==typeof t?i.target===t:t===!1?!i.target:!0)}),i&&0===i.length&&(i=void 0)),i},getSize:function(e,t){var i=this._getVarInfo(t&&t.sizeInfo,u),a=i.variable,r=this._ipDataCache[i.cacheKey],o=null;if(a){var n=a.minSize,s=a.maxSize,l="object"==typeof n&&n?this._getSize(e,n,r&&r.minSize,t):n,c="object"==typeof s&&s?this._getSize(e,s,r&&r.maxSize,t):s;o=this._getSize(e,a,r&&r.root,t,[l,c])}return o},getSizeRangeAtScale:function(e,t){var i,a=this._getVarInfo(e,u),r=this._ipDataCache[a.cacheKey],o={scale:t};if(e=a.variable,e&&t){var n=e.minSize,s=e.maxSize,l="object"==typeof n&&n?this._getSize({},n,r&&r.minSize,o):n,c="object"==typeof s&&s?this._getSize({},s,r&&r.maxSize,o):s;(null!=l||null!=c)&&(i={minSize:l,maxSize:c})}return i},getColor:function(e,t){var i=this._getVarInfo(t&&t.colorInfo,c);return this._getColorComponent(e,i.variable,this._ipDataCache[i.cacheKey])},getOpacity:function(e,t){var i=this._getVarInfo(t&&t.opacityInfo,p);return this._getColorComponent(e,i.variable,this._ipDataCache[i.cacheKey],!0)},getRotationAngle:function(e,t){var i=this._getVarInfo(t&&t.rotationInfo,f),a=i.variable,r="arithmetic"===a.rotationType,n=a.field,s=e.attributes,l=0;return n&&(o.isFunction(n)?l=n.apply(this,arguments):s&&(l=s[n]||0),l=(l+(r?-90:0))*(r?-1:1)),l},toJSON:function(){var e,t=this.visualVariables,i=o.clone(this.authoringInfo),a=this.getVisualVariablesForType(f,!1),r=a&&a[0],s=r&&r.field,l=s&&(o.isFunction(s)?s:"["+s+"]");return t&&(e=[],n.forEach(t,function(t){t.type===u?e.push(this._writeSizeInfo(t)):t.type===c?e.push(this._writeColorInfo(t)):t.type===p?e.push(this._writeOpacityInfo(t)):t.type!==f||r||e.push(this._writeRotationInfo(t))},this)),i&&n.forEach(i.visualVariables,function(e){e.type===p&&(e.type=h.toJSON(e.type))}),{rotationType:l&&(r.rotationType||"geographic"),rotationExpression:l,visualVariables:e,authoringInfo:i}},_getVarInfo:function(e,t){var i;if(e&&e.type===t)i=n.indexOf(this.visualVariables,e),e=this.visualVariables[i];else{var a=this.getVisualVariablesForType(t);e=a&&a[0],i=n.indexOf(this.visualVariables,e)}return{variable:e,cacheKey:i}},_readSizeInfo:function(e){return e.axis&&(e.axis=y.fromJSON(e.axis)),e},_readColorInfo:function(e){return e&&(n.forEach(e.colors,function(t,i){e.colors[i]=o.isArray(t)?s.fromJSON(t):new s(t)}),n.forEach(e.stops,function(t,i){t.color&&o.isArray(t.color)?e.stops[i].color=s.fromJSON(t.color):t.color&&(e.stops[i].color=new s(t.color))})),e},_readOpacityInfo:function(e){var t;return e&&(t=o.mixin({},e),t.transparencyValues&&(t.opacityValues=n.map(t.transparencyValues,function(e){return 1-e/100}),delete t.transparencyValues),t.stops&&(t.stops=n.map(t.stops,function(e){return e=o.mixin({},e),e.opacity=1-e.transparency/100,delete e.transparency,e}))),t},_readVariables:function(e,t){e&&(e=n.map(e,function(e){return e.type=h.fromJSON(e.type),e.type===u?e=this._readSizeInfo(e):e.type===c?e=this._readColorInfo(e):e.type===p&&(e=this._readOpacityInfo(e)),e},this));var i=t.rotationType,a=t.rotationExpression;if(a){var r={type:f,rotationType:i};if(o.isFunction(a))r.field=a,e.push(r);else{var s=a.match(this._rotationRE);s&&s[1]&&(r.field=s[1],e.push(r))}}return e},_processColorInfo:function(e){return e&&(n.forEach(e.colors,function(t,i){t instanceof s||(e.colors[i]=new s(t))}),n.forEach(e.stops,function(t,i){!t.color||t.color instanceof s||(e.stops[i].color=new s(t.color))})),this._interpolateData(e)},_processOpacityInfo:function(e){return this._interpolateData(e)},_processSizeInfo:function(e){return e.stops&&Array.isArray(e.stops)?e.stops=this._processSizeInfoStops(e.stops):(e.minSize=e.minSize&&this._processSizeInfoSize(e.minSize),e.maxSize=e.maxSize&&this._processSizeInfoSize(e.maxSize)),{root:this._interpolateData(e),minSize:this._interpolateData(e.minSize),maxSize:this._interpolateData(e.maxSize)}},_processSizeInfoSize:function(e){return"object"==typeof e?e.stops=this._processSizeInfoStops(e.stops):e=r.toPt(e),e},_processSizeInfoStops:function(e){return e&&Array.isArray(e)&&e.forEach(function(e){e.size=r.toPt(e.size)}),e},_getSize:function(e,t,i,a,r){var n=e.attributes,s=t.field,l=t.expression,u=t.stops,c=0,p="number"==typeof e,f=p?e:null;if(s||l){var h,y=a&&a.scale,_=r?r[0]:t.minSize,g=r?r[1]:t.maxSize,v=t.minDataValue,d=t.maxDataValue,V=t.valueUnit||"unknown",S=t.valueRepresentation,z=t.scaleBy,b=t.normalizationField,I=n?parseFloat(n[b]):void 0,x=a&&a.shape;if(l&&(f=l.toLowerCase()===this._scaleExpr?null==y?this._getAverageValue(t):y:null),"number"!=typeof f&&(o.isFunction(s)?f=s.apply(this,arguments):n&&(f=n[s])),null==f||b&&!p&&(isNaN(I)||0===I))return null;if(isNaN(I)||p||(f/=I),u){var O,C,w=this._lookupData(f,i),D=w[0],F=w[1];D===F?c=u[D].size:(O=u[D].size,C=u[F].size,c=O+(C-O)*w[2])}else if(null!=_&&null!=g&&null!=v&&null!=d)if(v>=f)c=_;else if(f>=d)c=g;else if(h=(f-v)/(d-v),"area"===z&&x){var N="circle"===x,E=N?m*Math.pow(_/2,2):_*_,j=N?m*Math.pow(g/2,2):g*g,J=E+h*(j-E);c=N?2*Math.sqrt(J/m):Math.sqrt(J)}else c=_+h*(g-_);else if("unknown"===V)null!=_&&null!=v?(_&&v?(h=f/v,c="circle"===x?2*Math.sqrt(h*Math.pow(_/2,2)):"square"===x||"diamond"===x||"image"===x?Math.sqrt(h*Math.pow(_,2)):h*_):c=f+(_||v),c=_>c?_:c,null!=g&&c>g&&(c=g)):c=f;else{var T=(a&&a.resolution?a.resolution:1)*this._meterIn[V];"area"===S?(c=Math.sqrt(f/m)/T,c*=2):(c=f/T,("radius"===S||"distance"===S)&&(c*=2)),null!=_&&_>c&&(c=_),null!=g&&c>g&&(c=g)}}else t&&(c=u&&u[0]&&u[0].size,null==c&&(c=t.minSize));return c=isNaN(c)?0:c},_getAverageValue:function(e){var t,i,a=e.stops;return a?(t=a[0].value,i=a[a.length-1].value):(t=e.minDataValue||0,i=e.maxDataValue||0),(t+i)/2},_getColorComponent:function(e,t,i,a,r){var n,s=e.attributes,l=t&&t.field,u="number"==typeof e?e:null;if(l){var c=t.normalizationField,p=s?parseFloat(s[c]):void 0;"number"!=typeof u&&(o.isFunction(l)?u=l.apply(this,arguments):s&&(u=s[l])),null!=u&&(c&&!isNaN(p)&&0!==p&&(u/=p),n=a?this._getOpacity(u,t,i):this._getColor(u,t,i))}else if(t){var f=t.stops;a?(n=f&&f[0]&&f[0].opacity,null==n&&(n=t.opacityValues&&t.opacityValues[0])):n=f&&f[0]&&f[0].color||t.colors&&t.colors[0]}return r&&(r.data=u,r.value=n),r||n},_interpolateData:function(e){var t;if(e)if(e.colors||e.opacityValues){var i,a=(e.colors||e.opacityValues).length,r=e.minDataValue,o=(e.maxDataValue-r)/(a-1);for(t=[],i=0;a>i;i++)t[i]=r+i*o}else e.stops&&(t=n.map(e.stops,function(e){return e.value}));return t},_getOpacity:function(e,t,i){var a,r=this._lookupData(e,i);if(t=t||this.opacityInfo,r){var o,n,s=r[0],l=r[1];s===l?a=this._getOpacValue(t,s):(o=this._getOpacValue(t,s),n=this._getOpacValue(t,l),a=o+(n-o)*r[2])}return a},_getOpacValue:function(e,t){return e.opacityValues?e.opacityValues[t]:e.stops[t].opacity},_getColor:function(e,t,i){var a,r=this._lookupData(e,i);if(t=t||this.colorInfo,r){var o=r[0],n=r[1];a=o===n?this._getColorObj(t,o):s.blendColors(this._getColorObj(t,o),this._getColorObj(t,n),r[2]),a=new s(a)}return a},_getColorObj:function(e,t){return e.colors?e.colors[t]:e.stops[t].color},_lookupData:function(e,t){var i;if(t){var a=0,r=t.length-1;n.some(t,function(t,i){return t>e?(r=i,!0):(a=i,!1)}),i=[a,r,(e-t[a])/(t[r]-t[a])]}return i},_writeRotationInfo:function(e){return e&&(e=o.mixin({},e),e.type=h.toJSON(e.type)),e},_writeSizeInfo:function(e){if(e){e=o.mixin({},e);var t=e.legendOptions,i=e.type,a=e.axis;e.type=h.toJSON(i),a&&(e.axis=y.toJSON(a)),t&&(e.legendOptions=o.mixin({},t),t=t.customValues,t&&(e.legendOptions.customValues=t.slice(0)))}return e},_writeColorInfo:function(e){return e&&(e=o.mixin({},e),e.type=h.toJSON(e.type),e.colors&&(e.colors=n.map(e.colors,function(e){return s.toJSON(e)})),e.stops&&(e.stops=n.map(e.stops,function(e){return e=o.mixin({},e),e.color&&(e.color=s.toJSON(e.color)),e}))),e},_writeOpacityInfo:function(e){var t;return e&&(t=o.mixin({},e),t.type=h.toJSON(t.type),t.opacityValues&&(t.transparencyValues=n.map(t.opacityValues,function(e){return 100*(1-e)}),delete t.opacityValues),t.stops&&(t.stops=n.map(t.stops,function(e){return e=o.mixin({},e),e.transparency=100*(1-e.opacity),delete e.opacity,e}))),t},_createExprContext:function(e){return{vars:{$feature:l.constructFeature(e)}}},_parseExpr:function(e,t){return l.parseScript(e,t)},_executeExpr:function(e,t){return l.executeScript(e,t,-1)}});return _});