// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","module","dojo/_base/array","dojo/_base/lang","dojo/Deferred","../Color","../core/numberUtils","../styles/type","../styles/size","../styles/choropleth","../styles/heatmap","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","./UniqueValueRenderer","./ClassBreaksRenderer","./HeatmapRenderer","./support/utils","dojo/i18n!./nls/smartMapping"],function(e,a,t,n,r,i,l,o,s,u,c,m,d,f,p,h,g,v,y){function b(t){return e.toAbsMid?e.toAbsMid(t):a.id.replace(/\/[^\/]*$/gi,"/")+t}function w(e,a){e.reject(new Error(a))}function S(e,a,t,n){var r,i;switch(t){case"point":r=new m,r.setColor(a),r.setSize(null!=n?n:e.size),i=new d,i.setColor(e.outline.color),i.setWidth(e.outline.width),r.setOutline(i);break;case"polyline":r=new d,r.setColor(a),r.setWidth(null!=n?n:e.width);break;case"polygon":r=new f,r.setColor(a),i=new d,i.setColor(e.outline.color),i.setWidth(e.outline.width),r.setOutline(i)}return r}function z(e){var a=e.geometryType;return a}function C(e,a){var t=e.scheme;return t?t=o.cloneScheme(t):(t=o.getSchemes({theme:e.theme||Y,basemap:e.basemap,geometryType:a}),t=t&&t.primaryScheme),t}function V(e,a){var t;return t=e.label<a.label?-1:e.label>a.label?1:0}function M(e,a){var t;return t=e.value<a.value?-1:e.value>a.value?1:0}function x(e,a){var t=a.count-e.count;return 0===t&&(t=V(e,a)),t}function R(e,a){var t=a.count-e.count;return 0===t&&(t=M(e,a)),t}function k(e,a,t){var n;"count"===a?(n=R,t&&t.codedValues&&(n=x)):"value"===a&&(n=M,t&&t.codedValues&&(n=V)),n&&e.sort(n)}function F(e,a,n){var r,i,l,o,s=e.uniqueValueInfos,u=a.layer,c=a.field,m=u.getField(c),d=u.getDomain(m.name),f=-1,h=null==a.numTypes?10:-1===a.numTypes?s.length:a.numTypes,g=null==a.showOthers?!0:a.showOthers,y=null==a.sortBy?"count":a.sortBy,b=a&&a.labelCallback,w=z(u),V=C(a,w),M=new p({attributeField:c}),x={domain:d,fieldInfo:m};for(t.forEach(s,function(e,a){x.value=e.value,e.label=v.createUniqueValueLabel(x),b&&(e.label=b(e)),null===e.value&&(f=a)}),f>-1&&(o=s.splice(f,1)[0]),k(s,y,d),x.dateFormatInterval=v.calculateDateFormatInterval(t.map(t.filter(s,function(e,a){return h>a}),function(e){return e.value})),l=N.createColors(V.colors,s.length),t.forEach(s,function(e,a){x.value=e.value,e.label=v.createUniqueValueLabel(x),b&&(e.label=b(e)),e.symbol=S(V,l[a],w)}),l=N.createColors(V.colors,h),r=0;h>r;r++)i=s[r],i&&M.addValue({value:i.value,label:i.label,symbol:S(V,l[r],w)});g&&(M.defaultSymbol=S(V,V.noDataColor,w),M.defaultLabel=X.other),o&&(o.symbol=S(V,V.noDataColor,w),s.push(o)),n.resolve({renderer:M,uniqueValueInfos:s,source:e.source,othersStartIndex:M.infos.length===s.length?-1:M.infos.length,scheme:C(a,w)})}function T(e,a,t){var n=e.scheme;return n?n=u.cloneScheme(n):(n=u.getSchemes({theme:t||e.theme||Z,basemap:e.basemap,geometryType:a}),n=n&&n.primaryScheme),n}function D(e){var a,t=e.avg,n=t-e.stddev,r=t+e.stddev;return n<e.min&&(n=e.min),r>e.max&&(r=e.max),a=l.round([n,r]),n=a[0],r=a[1],a=[n,n+(t-n)/2,t,t+(r-t)/2,r],l.round(a)}function B(e,a,t){var n,r=(a-e)/(t-1),i=[e];for(n=1;t-2>=n;n++)i.push(e+n*r);return i.push(a),l.round(i)}function I(e,a){var t,n;return null==e.min?(t=0,n=100):e.min===e.max?e.min<0?(t=2*e.min,n=0):e.min>0?(t=0,n=2*e.min):(t=0,n=100):!a||null!=e.avg&&null!=e.stddev||(t=e.min,n=e.max),null!=t?[t,n]:null}function O(e,a,n,r,i,o){var s=null==i.useDefaultStatistics?!0:i.useDefaultStatistics;if(e&&!e.count&&!s)return void w(o,"smartMapping.createColorRenderer: cannot create renderer when statistics.count is 0.");var u,c,m=i.layer,d=i.field,f=z(m),p=null==i.showOthers?!0:i.showOthers,g=T(i,f),y=N.createColors(g.colors,g.colors.length),b=new h({attributeField:d});if(p&&(b.defaultSymbol=S(g,g.noDataColor,f),b.defaultLabel=X.other),b.addBreak({minValue:-Q,maxValue:Q,symbol:S(g,g.noDataColor,f)}),a)c=t.map(a.classBreakInfos,function(e){return(e.minValue+e.maxValue)/2}),c=l.round(c),u=[0,1,2,3,4,5];else{var C=s?I(e,!0):null;c=C?B(C[0],C[1],5):D(e),u=[0,2,4]}b.normalizationType=n,b.normalizationField=r,b.visualVariables=[{type:"colorInfo",field:d,normalizationField:r,stops:v.createColorStops({values:c,colors:y,labelIndexes:u})}],o.resolve({renderer:b,statistics:e,classBreaks:a,scheme:T(i,f)})}function P(e,a,t,n){var r=null==t.useDefaultStatistics?!0:t.useDefaultStatistics;if(e&&!e.count&&!r)return void w(n,"smartMapping.createOpacityInfo: cannot create opacityInfo when statistics.count is 0.");var i=t.useStdDev,l=i?D(e):null,o=r?I(e,i):null,s=o||(i?[l[0],l[4]]:[e.min,e.max]),u={type:"opacityInfo",field:t.field,normalizationField:a,stops:[{value:s[0],opacity:.3},{value:s[1],opacity:.7}]};n.resolve({opacityInfo:u,statistics:e,defaultStatistics:!!o})}function q(e,a){var t=e.scheme;return t?t=s.cloneScheme(t):(t=s.getSchemes({theme:e.theme||ea,basemap:e.basemap,geometryType:a}),t=t&&t.primaryScheme),t}function L(e,a){var t;switch(a){case"point":t=[e.minSize,e.maxSize];break;case"polyline":t=[e.minWidth,e.maxWidth];break;case"polygon":t=[e.marker.minSize,e.marker.maxSize]}return t}function H(e,a,t,n,r,i){var l=null==r.useDefaultStatistics?!0:r.useDefaultStatistics;if(e&&!e.count&&!l)return void w(i,"smartMapping.createSizeRenderer: cannot create renderer when statistics.count is 0.");var o=r.layer,s=r.field,u=z(o),c=null==r.showOthers?!0:r.showOthers,m=q(r,u),d=a||L(m,u),f="polygon"===u,p=f?m.marker:m,g=f?m.background:null,v="polyline"===u?p.noDataWidth:p.noDataSize,y=r.useStdDev,b=y?D(e):null,C=l?I(e,y):null,V=C||(y?[b[0],b[4]]:[e.min,e.max]),M=new h({attributeField:s});c&&(M.defaultSymbol=S(p,p.noDataColor,f?"point":u,v),M.defaultLabel=X.other),M.addBreak({minValue:-Q,maxValue:Q,symbol:S(p,p.color,f?"point":u)}),g&&(M.backgroundFillSymbol=S(g,g.color,u)),M.normalizationType=t,M.normalizationField=n,M.visualVariables=[{type:"sizeInfo",field:s,valueUnit:"unknown",normalizationField:n,minSize:d[0],maxSize:d[1],minDataValue:V[0],maxDataValue:V[1]}],i.resolve({renderer:M,statistics:e,defaultStatistics:!!C,scheme:q(r,u)})}function E(e,a,t){var n,r=[],l=1/(t+1);for(n=1;t>=n;n++)r.push(i.blendColors(e,a,l*n));return r}function U(e,a){var t=[];if(1===a)t=[e[0]];else if(2===a)t=[e[0],e[2]];else if(3===a)t=e;else{var n,r,i=a-e.length,l=i/2;i%2===0?(n=E(e[0],e[1],l),r=E(e[1],e[2],l)):(n=E(e[0],e[1],Math.floor(l)),r=E(e[1],e[2],Math.ceil(l))),t=[e[0]].concat(n).concat([e[1]]).concat(r).concat([e[2]])}return t}function W(e,a,n){var r,i=a.length,l=-1;if(n&&t.some(a,function(e,a){return e.hasAvg&&(l=a),l>-1}),l>-1){var o=e.colors,s=l+1,u=i-l,c=o.slice(0,3),m=o.slice(2);c.reverse(),c=U(c,s),m=U(m,u),c.reverse(),r=[].concat(c).concat(m.slice(1))}else{var d=e.colorsForClassBreaks;if(d&&d.length>0&&(t.some(d,function(e){return e.numClasses===i&&(r=e.colors),!!r}),!r)){var f=d[d.length-1],p=i-f.numClasses;if(p>0){var h,g=f.colors[f.numClasses-1];for(r=f.colors.splice(0),h=1;p>=h;h++)r.push(g)}}}return r&&(r=N.createColors(r,r.length)),r}function j(e,a,n){var r,i,l,o=a.layer,s=a.field,u=z(o),c=null==a.showOthers?!0:a.showOthers,m=a.classificationMethod||"equal-interval",d="standard-deviation"===m,f=a.normalizationType,p="high-to-low",g=e.classBreakInfos;return(r=T(a,u,p))?(i=W(r,g),i&&i.length==g.length?(l=new h({attributeField:s}),l.classificationMethod=m,l.normalizationType=f,l.normalizationField="field"===f?a.normalizationField:void 0,l.normalizationTotal="percent-of-total"===f?e.normalizationTotal:void 0,c&&(l.defaultSymbol=S(r,r.noDataColor,u),l.defaultLabel=X.other),t.forEach(g,function(e,a){l.addBreak({minValue:e.minValue,maxValue:e.maxValue,symbol:S(r,i[a],u),label:e.label})}),d||v.setLabelsForClassBreaks({classBreaks:l.infos,classificationMethod:m,normalizationType:f,round:!0}),e.renderer=l,e.scheme=T(a,u,p),void n.resolve(e)):void w(n,"smartMapping.createClassedColorRenderer: unable to find suitable colors for number of classes.")):void w(n,"smartMapping.createClassedColorRenderer: unable to find suitable style scheme.")}function A(e,a,t){a.layer.statisticsPlugin.getClassBreaks(n.mixin(a,{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:e[0],maxValue:e[1],normalizationTotal:e[0]+e[1]})).then(function(e){e.defaultStatistics=!0,t.resolve(e)}).otherwise(function(){w(t,"smartMapping: error when calculating default class breaks.")})}function _(e){var a=new r,t=e.layer,n=null==e.useDefaultBreaks?!0:e.useDefaultBreaks;return t.statisticsPlugin.getClassBreaks(e).then(function(t){var r=n?I({min:t.minValue,max:t.maxValue}):null;r?A(r,e,a):(t.defaultStatistics=!1,a.resolve(t))}).otherwise(function(){t.graphics.length||!n?w(a,"smartMapping: error when calculating class breaks."):A(I({}),e,a)}),a.promise}function $(e,a,t,n){var r,i=n||L(e,a),l=i[0],o=i[1],s=(o-l)/(t>=4?t-1:t),u=[];for(r=0;t>r;r++)u.push(l+s*r);return u}function G(e,a,n,r){var i,l=n.layer,o=n.field,s=z(l),u=null==n.showOthers?!0:n.showOthers,c=n.classificationMethod||"equal-interval",m=n.normalizationType,d=e.classBreakInfos,f=q(n,s),p=$(f,s,d.length,a),g="polygon"===s,y=g?f.marker:f,b=g?f.background:null;i=new h({attributeField:o}),i.classificationMethod=c,i.normalizationType=m,i.normalizationField="field"===m?n.normalizationField:void 0,i.normalizationTotal="percent-of-total"===m?e.normalizationTotal:void 0,u&&(i.defaultSymbol=S(y,y.noDataColor,g?"point":s),i.defaultLabel=X.other),b&&(i.backgroundFillSymbol=S(b,b.color,s)),t.forEach(d,function(e,a){i.addBreak({minValue:e.minValue,maxValue:e.maxValue,symbol:S(y,y.color,g?"point":s,p[a]),label:e.label})}),"standard-deviation"!==c&&v.setLabelsForClassBreaks({classBreaks:i.infos,classificationMethod:c,normalizationType:m,round:!0}),e.renderer=i,e.scheme=q(n,s),r.resolve(e)}function J(e){var a=e.scheme;return a?a=c.cloneScheme(a):(a=c.getSchemes({theme:e.theme||aa,basemap:e.basemap}),a=a&&a.primaryScheme),a}function K(e,a,n){var r=null==a.useDefaultStatistics?!0:a.useDefaultStatistics;if(!e.count&&!r)return void w(n,"smartMapping.createHeatmapRenderer: cannot create renderer when statistics.count is 0.");var l=e.fieldOffset,o=null==a.blurRadius?10:a.blurRadius,s=null==a.minRatio?.01:a.minRatio,u=null==a.maxRatio?1:a.maxRatio,c=null==a.fadeToTransparent?!0:a.fadeToTransparent,m=J(a),d=m.colors,f=d.length,p=!e.count&&r,h=p?[0,100]:[e.min,e.max],v=new g;v.setBlurRadius(o),v.setField(a.field),null!=l&&v.setFieldOffset(l),v.setMinPixelIntensity(h[0]),v.setMaxPixelIntensity(h[1]);var y=d[0],b=[{ratio:0,color:new i([y.r,y.g,y.b,0])},{ratio:ta,color:new i([y.r,y.g,y.b,0])},{ratio:c?s:ta,color:y}],S=(u-s)/(f-1);d=N.createColors(d,f),t.forEach(d,function(e,a){b.push({ratio:s+S*a,color:e})}),v.setColorStops(b),n.resolve({renderer:v,statistics:e,defaultStatistics:p,scheme:J(a)})}var N={},Q=Math.pow(2,53)-1,X=y,Y="default",Z="high-to-low",ea="default",aa="default",ta=.01,na=b("../plugins/FeatureLayerStatistics");return n.mixin(N,{createColors:function(e,a){var t,n=[],r=e.length;for(t=0;a>t;t++)n.push(new i(e[t%r]));return n},createTypeRenderer:function(e){var a=new r;if(!(e&&e.layer&&e.field&&(e.scheme||e.basemap)))return w(a,"smartMapping.createTypeRenderer: missing parameters."),a.promise;var t=e.layer;return t.addPlugin(na).then(function(){t.statisticsPlugin.getUniqueValues({field:e.field,includeAllCodedValues:e.includeAllCodedValues}).then(function(t){F(t,e,a)}).otherwise(function(){w(a,"smartMapping.createTypeRenderer: error when calculating unique values.")})}).otherwise(function(){w(a,"smartMapping.createTypeRenderer: error when adding feature layer statistics plugin.")}),a.promise},createColorRenderer:function(e){var a=new r;if(!(e&&e.layer&&e.field))return w(a,"smartMapping.createColorRenderer: missing parameters."),a.promise;var t=e.layer,n=e.normalizationField,i=n?"field":void 0;return e.statistics?O(e.statistics,null,i,n,e,a):t.addPlugin(na).then(function(){"group-similar"===e.theme||e.scheme&&0===e.scheme.id.indexOf("group-similar/")?t.statisticsPlugin.getClassBreaks({field:e.field,classificationMethod:"natural-breaks",numClasses:6,normalizationType:i,normalizationField:n,minValue:e.minValue,maxValue:e.maxValue}).then(function(t){O(null,t,i,n,e,a)}).otherwise(function(){w(a,"smartMapping.createColorRenderer: error when calculating class breaks.")}):t.statisticsPlugin.getFieldStatistics({field:e.field,normalizationType:i,normalizationField:n,minValue:e.minValue,maxValue:e.maxValue}).then(function(t){O(t,null,i,n,e,a)}).otherwise(function(){w(a,"smartMapping.createColorRenderer: error when calculating field statistics.")})}).otherwise(function(){w(a,"smartMapping.createColorRenderer: error when adding feature layer statistics plugin.")}),a.promise},createOpacityInfo:function(e){var a=new r;if(!(e&&e.layer&&e.field))return w(a,"smartMapping.createOpacityInfo: missing parameters."),a.promise;var t=e.layer,n=e.normalizationField,i=n?"field":void 0;return e.statistics?P(e.statistics,n,e,a):t.addPlugin(na).then(function(){t.statisticsPlugin.getFieldStatistics({field:e.field,normalizationType:i,normalizationField:n,minValue:e.minValue,maxValue:e.maxValue}).then(function(t){P(t,n,e,a)}).otherwise(function(){w(a,"smartMapping.createOpacityInfo: error when calculating field statistics.")})}).otherwise(function(){w(a,"smartMapping.createOpacityInfo: error when adding feature layer statistics plugin.")}),a.promise},createSizeRenderer:function(e){var a=new r;if(!(e&&e.layer&&e.field))return w(a,"smartMapping.createSizeRenderer: missing parameters."),a.promise;var t=e.layer,n=e.normalizationField,i=n?"field":void 0;return e.statistics?H(e.statistics,null,i,n,e,a):t.addPlugin(na).then(function(){t.statisticsPlugin.getFieldStatistics({field:e.field,normalizationType:i,normalizationField:n,minValue:e.minValue,maxValue:e.maxValue}).then(function(r){e.optimizeForScale?t.statisticsPlugin.getSuggestedSizeRange().then(function(t){var l=[t.minSize,t.maxSize];H(r,l,i,n,e,a)}).otherwise(function(){H(r,null,i,n,e,a)}):H(r,null,i,n,e,a)}).otherwise(function(){w(a,"smartMapping.createSizeRenderer: error when calculating field statistics.")})}).otherwise(function(){w(a,"smartMapping.createSizeRenderer: error when adding feature layer statistics plugin.")}),a.promise},createClassedColorRenderer:function(e){var a,t=new r,i=e.minValue,l=e.maxValue;if(!(e&&e.layer&&e.field))return w(t,"smartMapping.createClassedColorRenderer: missing parameters."),t.promise;if(a=null!=i&&null!=l,!a&&(null!=i||null!=l))return w(t,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),t.promise;e=n.mixin({analyzeData:!a},e);var o=e.layer;return o.addPlugin(na).then(function(){_(e).then(function(a){j(a,e,t)}).otherwise(function(){w(t,"smartMapping.createClassedColorRenderer: error when calculating class breaks.")})}).otherwise(function(){w(t,"smartMapping.createClassedColorRenderer: error when adding feature layer statistics plugin.")}),t.promise},createClassedSizeRenderer:function(e){var a,t=new r,i=e.minValue,l=e.maxValue;if(!(e&&e.layer&&e.field))return w(t,"smartMapping.createClassedSizeRenderer: missing parameters."),t.promise;if(a=null!=i&&null!=l,!a&&(null!=i||null!=l))return w(t,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),t.promise;e=n.mixin({analyzeData:!a},e);var o=e.layer;return o.addPlugin(na).then(function(){_(e).then(function(a){e.optimizeForScale?o.statisticsPlugin.getSuggestedSizeRange().then(function(n){var r=[n.minSize,n.maxSize];G(a,r,e,t)}).otherwise(function(){G(a,null,e,t)}):G(a,null,e,t)}).otherwise(function(){w(t,"smartMapping.createClassedSizeRenderer: error when calculating class breaks.")})}).otherwise(function(){w(t,"smartMapping.createClassedSizeRenderer: error when adding feature layer statistics plugin.")}),t.promise},createHeatmapRenderer:function(e){var a=new r;if(!e||!e.layer)return w(a,"smartMapping.createHeatmapRenderer: missing parameters."),a.promise;var t=e.layer;return e.statistics?K(e.statistics,e,a):t.addPlugin(na).then(function(){t.statisticsPlugin.getHeatmapStatistics(e).then(function(t){K(t,e,a)}).otherwise(function(){w(a,"smartMapping.createHeatmapRenderer: error when calculating heatmap statistics.")})}).otherwise(function(){w(a,"smartMapping.createHeatmapRenderer: error when adding feature layer statistics plugin.")}),a.promise},applyHeatmapScheme:function(e){if(!(e&&e.renderer&&e.scheme))return void console.log("smartMapping.applyHeatmapScheme: missing parameters.");var a=J({scheme:e.scheme}),r=e.renderer,l=r.colorStops,o=a.colors;if(l.length!==o.length+3)return void console.log("smartMapping.applyHeatmapScheme: incompatible number of colors in 'colors' and 'renderer.colorStops'.");var s,u=new i(o[0]),c=t.map(l,function(e){return n.mixin({},e)});for(c[0].color=new i([u.r,u.g,u.b,0]),c[1].color=new i([u.r,u.g,u.b,0]),c[2].color=u,s=3;s<c.length;s++)c[s].color=o[s-3];r.setColorStops(c)}}),N});