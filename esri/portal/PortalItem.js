// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/extendsHelper","../core/tsSupport/decorateHelper","../core/accessoireSupport/typescript","../core/Error","../core/lang","../geometry/Extent","../core/JSONSupporter","../core/LoadableAccessoire","./Portal","../core/promiseUtils"],function(t,e,r,o,i,p,n,l,s,a,u,d){function y(){return s}var h=function(t){function e(){t.call(this),this.created=null,this.description=null,this.extent=null,this.id=null,this.isLayer=null,this.itemControl=null,this.itemUrl=null,this.modified=null,this.name=null,this.ownerFolder=null,this.portal=null,this.snippet=null,this.tags=null,this.thumbnailUrl=null,this.title=null,this.type=null,this.typeKeywords=null,this.url=null}return r(e,t),e.prototype._isLayerGetter=function(){var t=["Map Service","Feature Service","Feature Collection","Scene Service","Image Service","Stream Service","Vector Tile Service"];return t.indexOf(this.type)>-1},e.prototype._itemUrlGetter=function(){var t=this.get("portal.restUrl");return t?t+"/content/items/"+this.id:null},e.prototype._thumbnailUrlGetter=function(){var t=this.itemUrl,e=this.thumbnail;return t&&e?this.portal._normalizeUrl(t+"/info/"+e):null},e.prototype.load=function(){var t=this;this.portal||(this.portal=u.getDefault());var e=this.portal.load().then(function(){return t.resourceInfo?t.resourceInfo:t.id&&t.itemUrl?t.portal._request(t.itemUrl):{}}).then(function(e){t.resourceInfo=e,t.read(e)});return this.addResolvingPromise(e),this},e.prototype.fetchData=function(t){return void 0===t&&(t="json"),this.portal._request(this.itemUrl+"/data",{responseType:t})},e.prototype.fetchRelatedItems=function(t){return this.portal._requestToTypedArray(this.itemUrl+"/relatedItems",{query:t},"PortalItem")},e.prototype.update=function(t){var e=this,r=t&&t.data,o={method:"post"};o.query=this.toJSON();for(var i in o.query)null===o.query[i]&&(o.query[i]="");o.query.clearEmptyFields=!0,"string"==typeof r?o.query.text=r:r&&"function"==typeof r.toJSON&&(o.query.text=JSON.stringify(r));var n=this.portal&&this.portal.user&&this.portal.user.userContentUrl;return n?(this.ownerFolder&&(n+="/"+this.ownerFolder),this.portal._request(n+("/items/"+this.id+"/update"),o).then(function(){return e.loaded?e._reload():e.load()})):d.reject(new p("portal:not-signed-in","Not signed in"))},e.prototype.toJSON=function(){var t=this.extent,e={created:this.created&&this.created.getTime(),description:this.description,extent:t&&[[t.xmin,t.ymin],[t.xmax,t.ymax]],id:this.id,modified:this.modified&&this.modified.getTime(),name:this.name,ownerFolder:this.ownerFolder,thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:this.typeKeywords,url:this.url};return n.fixJson(e)},e.fromJSON=function(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");return new e({resourceInfo:t})},e.prototype._reload=function(){var t=this;return this.portal._request(this.itemUrl,{query:{_ts:(new Date).getTime()}}).then(function(e){return t.resourceInfo=e,t.read(e),t})},o([i.shared("esri.portal.PortalItem")],e.prototype,"declaredClass",void 0),o([i.property({type:Date})],e.prototype,"created",void 0),o([i.property()],e.prototype,"description",void 0),o([i.property({type:l,reader:function(t){return t&&t.length?new l(t[0][0],t[0][1],t[1][0],t[1][1]):null}})],e.prototype,"extent",void 0),o([i.property()],e.prototype,"id",void 0),o([i.property({dependsOn:["type"],readOnly:!0})],e.prototype,"isLayer",void 0),o([i.property()],e.prototype,"itemControl",void 0),o([i.property({dependsOn:["portal.restUrl"],readOnly:!0})],e.prototype,"itemUrl",void 0),o([i.property({type:Date})],e.prototype,"modified",void 0),o([i.property()],e.prototype,"name",void 0),o([i.property()],e.prototype,"ownerFolder",void 0),o([i.property({type:u})],e.prototype,"portal",void 0),o([i.property()],e.prototype,"resourceInfo",void 0),o([i.property()],e.prototype,"snippet",void 0),o([i.property()],e.prototype,"tags",void 0),o([i.property()],e.prototype,"thumbnail",void 0),o([i.property({dependsOn:["itemUrl","thumbnail","portal.credential.token"],readOnly:!0})],e.prototype,"thumbnailUrl",void 0),o([i.property()],e.prototype,"title",void 0),o([i.property()],e.prototype,"type",void 0),o([i.property()],e.prototype,"typeKeywords",void 0),o([i.property()],e.prototype,"url",void 0),e=o([i.subclass([a])],e)}(y());return h});