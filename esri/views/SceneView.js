// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../core/declare","dojo/_base/lang","dojo/_base/kernel","dojo/dom","dojo/Deferred","dojo/when","./View","./ViewAnimation","../geometry/SpatialReference","../geometry/support/webMercatorUtils","../geometry/support/scaleUtils","../Camera","../geometry/Point","../geometry/Extent","../geometry/ScreenPoint","../Viewpoint","../core/Scheduler","../core/sniff","../core/watchUtils","../core/promiseUtils","../core/Error","../core/Logger","../webscene/Environment","./3d/environment/SceneViewEnvironment","./3d/environment/SceneViewEnvironmentManager","./3d/constraints/SceneViewConstraints","./3d/lib/glMatrix","./3d/support/cameraUtils","./3d/support/viewpointUtils","./3d/support/eventUtils","./3d/support/projectionUtils","./3d/webgl-engine/Stage","./3d/webgl-engine/lib/Selector","./3d/support/RenderCoordsHelper","./3d/support/MapCoordsHelper","./3d/support/ResourceController","./3d/support/DisplayQualityProfile","./3d/support/QualitySettings","./3d/terrain/TerrainSurface","./3d/layers/graphics/LabelManager","./3d/layers/GraphicsView3D","./3d/navigation/spherical/NavigationSpherical","./3d/navigation/planar/NavigationPlanar","./3d/navigation/EventController","./3d/support/Frustum","./ui/3d/DefaultUI3D"],function(e,t,i,n,a,r,s,o,h,l,d,c,p,g,u,f,m,v,_,w,y,S,C,b,R,x,T,V,M,P,H,I,E,A,G,z,U,O,k,D,W,F,q,L,j,N){function B(e,t){return function(){return this._internallyReady?t.apply(this,arguments):this._initialProps&&this._initialProps[e]}}function Q(e,t){return function(i){return this._internallyReady?t.apply(this,arguments):(this._initialProps[e]=i,void(tt[e]&&this.notifyChange("initialExtentRequired")))}}var Z=S.getLogger("esri.views.SceneView"),J=T.vec3d,K=J.create(),X=new p(0,0,0),Y=new c(new p(0,0,0)),$={point:X,retval:null},et={heading:0,tilt:0},tt={camera:["viewpoint"],viewpoint:["extent"],extent:["center","scale"],scale:["zoom"],center:[],zoom:[]},it=Object.keys(tt),nt=e(s,{declaredClass:"esri.views.SceneView",classMetadata:{properties:{camera:{copy:function(e,t){e.position.x=t.position.x,e.position.y=t.position.y,e.position.z=t.position.z,e.position.spatialReference=t.position.spatialReference,e.heading=t.heading,e.tilt=t.tilt},type:c},center:{copy:function(e,t){return e?(e.x=t.x,e.y=t.y,e.z=t.z,e.spatialReference=t.spatialReference,e):t.clone()},type:p},extent:{copy:function(e,t){e.xmin=t.xmin,e.ymin=t.ymin,e.zmin=t.zmin,e.xmax=t.xmax,e.ymax=t.ymax,e.zmax=t.zmax,e.spatialReference=t.spatialReference},type:g},ui:{type:N},viewpoint:{copy:function(e,t){e.rotation=t.rotation,e.scale=t.scale,e.targetGeometry=t.targetGeometry,e.camera=t.camera},dependsOn:["camera"],type:f},viewingMode:{dependsOn:["map.initialViewProperties.viewingMode","spatialReference"],getter:function(){var e=this._viewingMode||this.get("map.initialViewProperties.viewingMode"),t=this.spatialReference;return e||(e=!t||t.isWebMercator||t.isWGS84?"global":"local"),e},setter:function(e){var t=["local","global"];return-1!==t.indexOf(e)&&this._viewingMode!==e&&(this._viewingMode=e,this.get("map.initialViewProperties.viewingMode")||this._internallyReady&&this._initGlobe(this.viewingMode)),this.viewingMode}},globeMode:{dependsOn:["viewingMode"]},groundExtent:{dependsOn:["basemapTerrain.extent"],readOnly:!0,getter:function(){if(this._basemapTerrain&&this._basemapTerrain.spatialReference){var e=this._basemapTerrain.extent;return new g({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this._basemapTerrain.spatialReference})}var t=this.spatialReference||h.WGS84;return new g({spatialReference:t})}},dataExtent:{dependsOn:["basemapTerrain.extent"],readOnly:!0,getter:function(){if(this._basemapTerrain&&this._basemapTerrain.spatialReference){var e=this._basemapTerrain.extent,t=Math.max(e[2]-e[0],e[3]-e[1]);return new g({xmin:e[0],ymin:e[1],zmin:4*-t,xmax:e[2],ymax:e[3],zmax:4*t,spatialReference:this._basemapTerrain.spatialReference})}var i=this.spatialReference||h.WGS84;return new g({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:i})}},clippingArea:{type:g,dependsOn:["map.clippingArea","map.clippingEnabled","viewingMode"],getter:function(){if("global"===this.viewingMode)return null;if(this._userClippingArea)return this._userClippingArea;var e=this.get("map.clippingEnabled"),t=this.get("map.clippingArea");return e&&t?t instanceof g?l.canProject(t.spatialReference,this.spatialReference)?(t=l.project(t,this.spatialReference),this._clippingArea&&t&&this._clippingArea.equals(t)?this._clippingArea:(this._clippingArea=t,t)):(console.error("Setting clippingArea with incompatible SpatialReference."),this._clippingArea):(console.error("Only clippingArea geometries of type Extent are supported"),this._clippingArea):(this._clippingArea=null,null)},setter:function(e){return this._userClippingArea=e,e}},interacting:{dependsOn:["navigation.interacting"],getter:function(){return this.navigation&&this.navigation.interacting}},ready:{dependsOn:["viewingMode"]},basemapTerrain:{readOnly:!0},canvas:{readOnly:!0},environment:{setter:function(e){return e!==this._defaults.environment&&(this._externallySet.environment=!0),e?e instanceof b?e:e instanceof C?(this.environment.lighting=e.lighting,this.environment):e.declaredClass?e:new b(e):new b}},constraints:{type:x},animation:{type:o},navigation:{readOnly:!0},scale:{},zoom:{dependsOn:["scale"]},spatialReference:{dependsOn:["map.initialViewProperties.spatialReference"]},mapCoordsHelper:{},renderCoordsHelper:{},initialExtentRequired:{dependsOn:["map.initialViewProperties.viewpoint"],getter:function(){if(this.get("map.initialViewProperties.viewpoint"))return!1;for(var e=0;e<it.length;e++)if(this._initialProps&&void 0!==this._initialProps[it[e]])return!1;return!0}},qualityProfile:{setter:function(e){return U.isValidProfile(e)?(U.apply(e,this),e):this.qualityProfile}},qualitySettings:{type:O},updating:{},updatingPercentage:{}}},getDefaults:function(e){var t=this.inherited(arguments);return t.constraints||e.constraints||(this._defaults.constraints=new x,t.constraints=this._defaults.constraints),t.environment||e.environment||(this._defaults.environment=new b,t.environment=this._defaults.environment),t.popup.autoPanEnabled=!1,t.qualitySettings=new O,t.qualityProfile=U.getDefaultProfile(),t},constructor:function(){_.when(this,"ready",this._viewReadyHandler.bind(this)),this._internallyReady=!1,this._initialProps={},this._canvas=null,this._basemapTerrain=null,this._userClippingArea=null,this._gotoTask=null,this._viewingMode=null,this._initCoordinateSystem(),this._frustum=new j,this._animation=null,this._animationStateWatcher=null,this._constraints=null,this._clippingArea=null,this._navigation=null,this.navigationController=null,this.navigationControls=L.PAN,this._defaults={},this._externallySet={},this.resourceController=new z(this),this.labelManager=new D(this),this._evaluateUpdating=this._evaluateUpdating.bind(this),this._layerViewsUpdatingHandles={},this._navigationHandles=P.on(this,{navigation:{currentViewChanged:this._navigationCurrentViewChanged,targetViewChanged:{handler:this._navigationTargetViewChanged,pausable:!0},currentViewReachedTarget:this._navigationCurrentViewReachedTarget,animationStarted:{handler:this._navigationAnimationStarted,pausable:!0}}},this),this.watch("map",function(e){e&&e.load&&e.load()})},initialize:function(){this.environmentManager=new R({view:this}),this._updateUpdatingMonitorsHandle=this.allLayerViews.on("change",this._updateUpdatingMonitors.bind(this)),this._updateUpdatingMonitors({added:this.allLayerViews.toArray(),removed:[],moved:[]}),_.whenNot(this,"ready",this._viewUnreadyHandler.bind(this))},destroy:function(){this._accessorProps.dispatch(),this.environmentManager.destroy(),this._disposeGraphicsView(),this._updateUpdatingMonitorsHandle.remove(),this._updateUpdatingMonitorsHandle=null,this._navigationHandles.remove(),this._navigationHandles=null},destroyLayerViews:function(){for(var e in this._layerViewsUpdatingHandles)this._layerViewsUpdatingHandles[e].remove();this._layerViewsUpdatingHandles={},this._disposeSurface(),this.inherited(arguments),this._stage&&(this._stage.dispose(),this._stage=null),this._setCanvas(null),this.labelManager.destroy(),this.labelManager=null,this.resourceController.destroy(),this.resourceController=null},type:"3d",updatingPercentage:0,viewingMode:"global",environment:null,constraints:null,animation:null,camera:null,viewpoint:null,extent:null,clippingArea:null,map:null,scale:0,zoom:0,center:null,qualityProfile:null,toMap:function(e,t,i){if(!this._internallyReady)return Z.error("#toMap()","Scene view cannot be used before it is ready"),null;var n=this._normalizePointArgs(e,t,void 0,i),a=[n.point.x,this.height-n.point.y],r=this._stage.pick(a).getMinResult();return this._computeMapPointFromIntersectionResult(r,n.retval)},toScreen:function(e,t,i,n){if(!this._internallyReady)return Z.error("#toScreen()","Scene view cannot be used before it is ready"),null;var a=this._normalizePointArgs(e,t,i,n);return H.pointToVector(a.point,K,this.renderSpatialReference),this.engineToScreen(K,a.retval)},pixelSizeAt:function(e,t,i){if(!this._internallyReady)return Z.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if("esri.geometry.ScreenPoint"===e.declaredClass){var n=this._stage.pick([e.x,this.height-e.y]).getMinResult();if(!n.getIntersectionPoint(K))return 0}else{var a=this._normalizePointArgs(e,t,i,void 0);H.pointToVector(a.point,K,this.renderSpatialReference)}var r=this.navigation.currentCamera;return r.computePixelSizeAt(K)},hitTest:function(e,t){if(!this._internallyReady)return Z.error("#hitTest()","Scene view cannot be used before it is ready"),null;var i=this._normalizePointArgs(e,t,void 0,void 0),n=[i.point.x,this.height-i.point.y],a=this._stage.pick(n,null,!0).getMinResult(),s=this._computeMapPointFromIntersectionResult(a);return r(this._getGraphicFromStageObject(a.object,a.triangleNr)).otherwise(function(){return null}).then(function(e){var t=[];return(e||s)&&t.push({mapPoint:s,graphic:e}),{screenPoint:n,results:t}})},goTo:function(e,i){if(!this._internallyReady)return void Z.error("#goTo()","Scene view cannot be used before it is ready");i=t.mixin({animate:!0},i);var n=M.create(this,e,i);return this._gotoTask={},i.animate?this._gotoAnimated(n,i):this._gotoImmediate(n,i)},animateTo:function(e,t){return i.deprecated(this.declaredClass+".animateTo is deprecated. Use .goTo instead.","","4.0"),this.goTo(e,t)},takeScreenshot:function(e){if(!this._internallyReady)return void Z.error("#takeScreenshot()","Scene view cannot be used before it is ready");e=t.mixin({format:"png",quality:100},e||{});var i,n,r=new a;e.includePadding||(i=this.width-this.padding.left-this.padding.right,n=this.height-this.padding.top-this.padding.bottom);var s=i/n;return void 0!==e.width&&void 0===e.height?e.height=e.width/s:void 0!==e.height&&void 0===e.width&&(e.width=s*e.height),void 0!==e.height&&(e.height=Math.floor(e.height)),void 0!==e.width&&(e.width=Math.floor(e.width)),e.area||e.includePadding||(e.area={x:this.padding.left,y:this.padding.top,width:i,height:n}),this._stage.requestScreenCapture(e,function(e){m.schedule(function(){r.resolve(e)})}),r.promise},engineToScreen:function(e,t){var i=J.create();this._stage.getCamera().projectPoint(e,i);var n=i[0],a=this.height-i[1],r=i[2];return t?(t.x=n,t.y=a,t.z=r,t):new u({x:n,y:a,z:r})},getDefaultSpatialReference:function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")},validate:function(){var e;return v("esri-webgl")?v("safari")&&v("safari")<7.1&&(e=new y("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 7.1)",{type:"safari",requiredVersion:7.1,detectedVersion:v("safari")})):e=new y("sceneview:webgl-required","WebGL is required but not supported"),e?w.reject(e):w.resolve()},isSpatialReferenceSupported:function(e){var t=null==d.getUnitValue(e),i=e.isWebMercator,n=e.isWGS84,a="local"===this.viewingMode;return a&&t?!1:a||i||n?!0:!1},has:function(e){return this._stage.has(e)},flushDisplayModifications:function(){this._stage.processDirty()},getFrustum:function(){return this._frustum.dirty&&this._frustum.update(this.navigation.currentCamera),this._frustum},getDrawingOrder:function(e){return this.allLayerViews.findIndex(function(t){return t.layer&&t.layer.uid===e})},getViewForGraphic:function(e){return e.layer?this.allLayerViews.find(function(t){return t.layer===e.layer}):this._graphicsView},whenViewForGraphic:function(e){return e.layer?this.whenLayerView(e.layer):w.resolve(this._graphicsView)},renderSpatialReference:null,_graphicsView:null,_surfaceReadyWatchHandle:null,_gotoImmediate:function(e){var t=this._gotoTask;return e.then(function(e){t===this._gotoTask&&(this.viewpoint=e)}.bind(this))},_gotoAnimated:function(e){!this.animation||"running"!==this.animation.state&&"waiting-for-target"!==this.animation.state?this.animation=new o({target:e}):this.animation.target=e;var t=this.animation;return t.state="waiting-for-target",e.then(function(i){if(t.target===e&&this.animation===t){t.target=i,t.state="running";var n=M.toCamera(this,i);if(!n)throw Z.error("#goTo()","Invalid target specified for animateTo"),new y("goto:invalid-camera","Invalid camera in conversion from viewpoint");var a=V.externalToInternal(this,n);if(a.almostEquals(this.navigation.targetCamera,5e-4/this.renderCoordsHelper.unitInMeters))return void t.finish();this._navigationHandles.byId("navigation.targetViewChanged").pause(),this._navigationHandles.byId("navigation.animationStarted").pause(),this._setInternalCamera(a,{animate:!0}),t.state===o.State.STOPPED&&t.stop(),this._navigationHandles.byId("navigation.targetViewChanged").resume(),this._navigationHandles.byId("navigation.animationStarted").resume()}}.bind(this)).otherwise(function(){t.target===e&&this.animation===t&&(this.animation=null,t.finish())}),t},_trackCanvasSize:function(){this.on("resize",function(e){if(this.canvas){this.canvas.width=e.width,this.canvas.height=e.height;var t=this._stage.getCamera();t.width=e.width,t.height=e.height,this._stage.setCamera(t),this.navigation&&(this.navigation.windowSize=[e.width,e.height])}}.bind(this)),this.canvas.width=this.width,this.canvas.height=this.height},_computeMapPointFromIntersectionResult:function(e,t){if(e.getIntersectionPoint(K)){var i=this.spatialReference||h.WGS84;if(H.vectorToVector(K,this.renderSpatialReference,K,i)||(i=h.WGS84,H.vectorToVector(K,this.renderSpatialReference,K,i)),t?(t.x=K[0],t.y=K[1],t.z=K[2],t.spatialReference=i):t=new p(K,i),"terrain"===e.intersector&&this.basemapTerrain){var n=this.basemapTerrain.getElevation(t);null!==n&&(t.z=n)}return t}return null},_onGeometryPicked:function(e,t,i){var n={screenPoint:{x:t[0],y:this.height-t[1]}},a=this._computeMapPointFromIntersectionResult(i);a&&(n.mapPoint=a),this.emit("click",n)},_getGraphicFromStageObject:function(e,t){if(!e)return null;var i=e.getMetadata();if(null!=i&&null!=i.layerId){if(i.layerId===this._graphicsView.mockLayerId)return this._graphicsView.getGraphicsFromStageObject(e,t);var n=this.map.findLayerById(i.layerId);if(n)return this.whenLayerView(n).then(function(i){return i&&null!=i.getGraphicsFromStageObject&&!i.suspended?i.getGraphicsFromStageObject(e,t):void 0})}return null},_viewingModeToManifold:function(e){return{local:"planar",global:"spherical"}[e]},_initBasemapTerrain:function(e){this._disposeBasemapTerrain(),this._basemapTerrain=new k(this,this._viewingModeToManifold(e)),this.notifyChange("basemapTerrain"),this.navigation.elevationProvider=this._basemapTerrain},_initGlobe:function(e){this._initCoordinateSystem(),this._initNavigation(e),this._stage.setViewParams({backgroundColor:[0,0,0,0],maxFarNearRatio:0,frustumCullingEnabled:!1}),this._initBasemapTerrain(e),this._navigationCurrentViewChanged({camera:this.navigation.currentCamera})},_initCoordinateSystem:function(){if(this.spatialReference){var e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||(this.mapCoordsHelper=new G(this.map,e));var t=this.renderCoordsHelper?this.renderCoordsHelper.unitInMeters:1,i="global"===this.viewingMode,n=i?H.SphericalRenderSpatialReference:e;if(n!==this.renderSpatialReference){this.renderSpatialReference=n;var a=i?A.Spherical:A.Planar;if(this.renderCoordsHelper=new a(n),this._stage&&this._stage.setIntersectTolerance(E.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._constraints){var r=t/this.renderCoordsHelper.unitInMeters;this._constraints.scale(r)}}}else this.mapCoordsHelper=null,this.renderCoordsHelper=null,this.renderSpatialReference=null},_paddingEqualsArray:function(e){var t=this.padding;return t?t.top===e[0]&&t.right===e[1]&&t.bottom===e[2]&&t.left===e[3]:!0},_navigationCurrentViewChanged:function(e){this._frustum.dirty=!0;var t=e.camera,i=t.padding;if(!this._paddingEqualsArray(i)){var n=this._padding,a={top:i[0],right:i[1],bottom:i[2],left:i[3]};this._internallyReady?(this._padding=a,this.notifyChange("padding",n,a)):this.padding=a}this._stage.setCamera(t),this.notifyChange("center"),this.notifyChange("extent"),this.notifyChange("scale");var r=this.camera,s=V.internalToExternal(this,t,Y);r&&this._cameraAlmostEquals(r,s)||this.notifyChange("camera")},_cameraAlmostEquals:function(e,t){return Math.abs(e.tilt-t.tilt)<1e-5&&Math.abs(e.heading-t.heading)<1e-5&&Math.abs(e.fov-t.fov)<1e-5&&e.position.equals(t.position)},_navigationAnimationStarted:function(){var e=M.fromInternalCamera(this,this.navigation.targetCamera);this.animation?this.animation.target=e:this.animation=new o({target:e})},_navigationTargetViewChanged:function(e){if(this.animation&&"waiting-for-target"!==this.animation.state){var t=e.camera,i=this.spatialReference||h.WGS84,n=V.internalToExternal(this,t),a=new f({camera:n,targetGeometry:H.vectorToPoint(t.center,i,this.renderSpatialReference),scale:V.computeScale(this,t),rotation:M.headingToRotation(n.heading)});this.animation.target=a}},_navigationCurrentViewReachedTarget:function(e){if((e.interruptedAnimation||e.finishedAnimation)&&(this._gotoTask=null),this.animation&&(e.interruptedAnimation||e.finishedAnimation)){this._animationStateWatcher&&(this._animationStateWatcher.remove(),this._animationStateWatcher=null);var t=this.animation;this.animation=null,e.finishedAnimation?t.finish():t.stop(),this.notifyChange("animation")}},_setInternalCamera:function(e,t){return e&&(this.navigation.setCamera(e,t),this._externallySet.camera=!0),!!e},_setCamera:function(e,t){return this._setInternalCamera(V.externalToInternal(this,e),t)},_evaluateUpdating:function(){var e=0,t=0,i=!1;this.allLayerViews.forEach(function(n){if(n.updating){i=!0;var a=n.updatingPercentage;null!=a&&(++t,e+=a)}}),this._graphicsView&&this._graphicsView.updating&&(i=!0),i!==this.updating&&(this.updating=i),0!==t?e/=t:e=i?100:0,this.updatingPercentage!==e&&(this.updatingPercentage=e)},_updateUpdatingMonitors:function(e){for(var t=0;t<e.removed.length;t++){var i=e.removed[t],n=this._layerViewsUpdatingHandles[i.id];n&&(delete this._layerViewsUpdatingHandles[i.id],n.remove())}for(t=0;t<e.added.length;t++)i=e.added[t],i.layer&&null!=i.updating&&(n=i.watch(["updating","updatingPercentage"],this._evaluateUpdating),this._layerViewsUpdatingHandles[i.id]=n);this._evaluateUpdating()},_spatialReferenceSetter:function(){this.inherited(arguments),this._initCoordinateSystem()},_setInitialView:function(e){if(e&&!this._externallySet.camera)if(e instanceof f)this.viewpoint=e;else if(e instanceof c)this.camera=e;else{var t=this._getDesiredHeadingTilt();M.create(this,{target:e,heading:t.heading,tilt:t.tilt}).then(function(e){this.navigation._dataExtentChanged(),this.viewpoint=e}.bind(this))}},_pickRay:function(){return this._stage?this._stage.pickRay.apply(this._stage,arguments):null},_pickRayWithBeginPoint:function(){return this._stage?this._stage.pickRayWithBeginPoint.apply(this._stage,arguments):null},_removeHandles:function(e){for(var t=0;t<e.length;t++){var i=e[t];this[i]&&(this[i].remove(),this[i]=null)}},_setCanvas:function(e){if(e!==this._canvas){var t=this._canvas;this._canvas=e,this.notifyChange("canvas",t,e)}},_disposeSurface:function(){this._removeHandles(["_stageFrameTask","_updateDrawingOrderHandle","onViewExtentUpdateHandle"]),this._disposeBasemapTerrain(),this._setNavigation(null),this.environmentManager&&this.environmentManager.disposeRendering()},_disposeBasemapTerrain:function(){this._basemapTerrain&&(this._basemapTerrain.destroy(),this._basemapTerrain=null)},_disposeNavigation:function(){this._navigation&&(this._navigation.destroy(),this._navigation.elevationProvider=null,this._navigation=null),this.navigationController&&(this.navigationControls=this.navigationController.getControls(),this.navigationController.destroy(),this.navigationController=null)},_setNavigation:function(e){this._navigation!==e&&(this._disposeNavigation(),this._navigation=e,e&&(e.windowSize=[this.width,this.height],e.userConstraints=this.constraints),this.notifyChange("navigation"),this._accessorProps.dispatch())},_initNavigation:function(e){e=e||this.viewingMode;var t={view:this};this._setNavigation("global"===e?new F(t):new q(t)),this.navigationController=new L(this,this.navigationControls)},_initSurface:function(){var e={};e.antialias=this.qualitySettings.antialiasingEnabled,this.renderCanvas&&(e.canvas=this.renderCanvas),this._stage=new I(n.byId(this.surface),e),this._stage.selectionState=!1,this._stage.onGeometryPicked=this._onGeometryPicked.bind(this),this.renderCoordsHelper&&this._stage.setIntersectTolerance(E.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._setCanvas(this._stage.getCanvas()),this._stageFrameTask=m.addFrameTask(this._stage.getFrameTask()),this._trackCanvasSize(),this._initGlobe(this.viewingMode)},_initGraphicsView:function(){this._surfaceReadyWatchHandle=_.whenTrueOnce(this,"basemapTerrain.ready",function(){this._graphicsView=new W({view:this,graphics:this.graphics}),this._surfaceReadyWatchHandle=null,this._layerViewsUpdatingHandles[this._graphicsView.mockLayerId]=this._graphicsView.watch("updating",this._evaluateUpdating)}.bind(this))},_disposeGraphicsView:function(){if(this._surfaceReadyWatchHandle&&(this._surfaceReadyWatchHandle.remove(),this._surfaceReadyWatchHandle=null),this._graphicsView){var e=this._graphicsView.mockLayerId;this._layerViewsUpdatingHandles[e].remove(),delete this._layerViewsUpdatingHandles[e],this._graphicsView.destroy(),this._graphicsView=null}},_normalizePointArgs:function(e,t,i,n,a){a=a||$;var r=a.point;return r.spatialReference=void 0,"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z,e.spatialReference&&(r.spatialReference=e.spatialReference),a.retval=t):(r.x=e,r.y=t,"number"!=typeof i&&void 0!==i?(r.z=void 0,a.retval=i):(r.z=i,a.retval=n)),r.spatialReference||(r.spatialReference=this.spatialReference||h.WGS84),a},_separateInitialProperties:function(){var e,t={},i={},n={},a=function(e){var t=tt[e];if(t)for(var i=0;i<t.length;i++)n[t[i]]=!0,a(t[i])};for(e in this._initialProps){var r=tt[e],s=this._initialProps[e];r?(a(e),t[e]=s):i[e]=s}for(e in n)delete t[e];return{view:t,other:i}},_viewReadyHandler:function(e,t){if(!t){"global"===this.viewingMode&&(this._clippingArea=null),this._internallyReady=!0,this._initSurface(),this._initGraphicsView();var i,n=this._separateInitialProperties();for(i in n.other)this.set(i,n.other[i]);for(i in n.view)this.set(i,n.view[i]);var a=this.get("map.initialViewProperties.viewpoint"),r=this.get("initialExtent");if(a?this._setInitialView(a):r&&r.spatialReference.equals(this.spatialReference)?this._setInitialView(r):_.once(this._basemapTerrain,"extent",function(){this._setInitialView(this.groundExtent)}.bind(this)),!this._externallySet.environment){var s=this.get("map.initialViewProperties.environment");s&&(this.environment=s)}this._initialProps={},this.notifyChange("initialExtentRequired"),this._updateDrawingOrderHandle=this.allLayerViews.on("change",this._updateDrawingOrder.bind(this)),this._updateDrawingOrder({added:this.allLayerViews.toArray(),removed:[],moved:[]}),this.environmentManager.updateReadyChange(!0)}},_viewUnreadyHandler:function(e,t){t&&(this.environmentManager.updateReadyChange(!1),this._disposeGraphicsView(),this._internallyReady=!1,this._disposeSurface(),this._stage&&(this._stage.dispose(),this._stage=null),this._setCanvas(null))},_getDesiredHeadingTilt:function(){if(this._externallySet.camera){var e=this.camera;et.heading=e.heading,et.tilt=e.tilt}else et.heading=0,et.tilt=.5;return et},_cameraSetter:Q("camera",function(e){this._setCamera(e,{animate:!1})||Z.error("#camera=","Invalid camera",e)}),_cameraGetter:B("camera",function(e){return V.internalToExternal(this,this.navigation.currentCamera,e)}),_externalExtent:function(){return this._cachedExtentDirty&&(V.toExtent(this,null,null,this._cachedExtent,Y),this._cachedExtentDirty=!1),this._cachedExtent},_extentGetter:B("extent",function(e){return V.toExtent(this,null,null,e,Y)}),_extentSetter:Q("extent",function(e){var t=V.fromExtent(this,e,this._getDesiredHeadingTilt(),Y);t?this.camera=t:this._isIncompatibleSpatialReference(e.spatialReference)?Z.error("#extent=","Extent has an incompatible spatial reference (extent: "+e.spatialReference.wkid+", view: "+this.spatialReference.wkid+")",e):Z.error("#extent=","Invalid extent",e)}),_isIncompatibleSpatialReference:function(e){return e&&!e.equals(this.spatialReference)&&!l.canProject(e,this.spatialReference)},_scaleGetter:B("scale",function(){return null!=this.navigation?V.computeScale(this,this.navigation.currentCamera):0}),_scaleSetter:Q("scale",function(e){var t=this._getDesiredHeadingTilt(),i=this.navigation.currentCamera.center,n=J.create();H.vectorToVector(i,this.renderSpatialReference,n,h.WGS84);var a=V.scaleToDistance(this,e,n[1]),r=V.eyeHeadingTiltForCenterPointAtDistance(this,t.heading,t.tilt,i,a);this._externallySet.camera=!0,this.navigation.setCameraFromEyeCenterAndUp(r.eye,r.center,r.up,{animate:!1})}),_zoomGetter:B("zoom",function(){return V.scaleToZoom(this,this.scale)}),_zoomSetter:Q("zoom",function(e){this.scale=V.zoomToScale(this,e)}),_centerGetter:B("center",function(e){var t=this.navigation.currentCamera,i=this.spatialReference||h.WGS84;return H.vectorToPoint(t.center,this.renderSpatialReference,e||i,i)}),_centerSetter:Q("center",function(e){if(this._isIncompatibleSpatialReference(e&&e.spatialReference))return void Z.error("#center=","Center has an incompatible spatial reference (center: "+e.spatialReference.wkid+", view: "+this.spatialReference.wkid+")",e);var t=this._getDesiredHeadingTilt(),i=V.eyeHeadingTiltForCenterPointAtDistance(this,t.heading,t.tilt,e,this.navigation.currentCamera.distance);i||Z.error("#center=","Invalid center",e),this._externallySet.camera=!0,this.navigation.setCameraFromEyeCenterAndUp(i.eye,i.center,i.up,{animate:!1})}),_viewpointGetter:B("viewpoint",function(){return M.fromCamera(this,this.camera)}),_viewpointSetter:Q("viewpoint",function(e){var t=M.toCamera(this,e);t?this._setCamera(t,{animate:!1}):Z.error("#viewpoint=","Invalid viewpoint",e)}),_globeModeSetter:function(e){i.deprecated(this.declaredClass+"::globeMode is deprecated. Use viewingMode instead.","","4.0"),this.viewingMode={planar:"local",spherical:"global"}[e]},_globeModeGetter:function(){return i.deprecated(this.declaredClass+"::globeMode is deprecated. Use viewingMode instead.","","4.0"),this._viewingModeToManifold(this.viewingMode)},_screenCenterGetter:function(){var e=this.padding;return new u((this.size[0]-(e.left+e.right))/2+e.left,(this.size[1]-(e.top+e.bottom))/2+e.top)},_updateDrawingOrder:function(){var e=this.allLayerViews.length-1;this.allLayerViews.forEach(function(t,i){null!=t.drawingOrder&&(t.drawingOrder=e-i)},this)},_paddingGetter:B("padding",function(){return this._padding}),_paddingSetter:Q("padding",function(e){this._padding={top:e&&e.top||0,right:e&&e.right||0,bottom:e&&e.bottom||0,left:e&&e.left||0},this.navigation&&(this.navigation.padding=this._padding)}),_constraintsGetter:B("constraints",function(){return this._constraints}),_constraintsSetter:Q("constraints",function(e){this._constraints=e,this._constraints===this._defaults.constraints&&(this._defaults.constraints=null,this._constraints.scale(1/this.renderCoordsHelper.unitInMeters)),this.navigation.userConstraints=e}),_animationSetter:function(e){if(e!==this._animation){if(!this._internallyReady)return void Z.error("#animation=","Scene view cannot be used before it is ready");this._animationStateWatcher&&(this._animationStateWatcher.remove(),this._animationStateWatcher=null),this._animation=e,e&&(this._animationStateWatcher=e.watch("state",function(e){(e===o.State.FINISHED||e===o.State.STOPPED)&&(this.animation=null,e===o.State.FINISHED?this.navigation.setCurrentToTarget():this.navigation.setCamera(this.navigation.currentCamera,{animate:!1}))}.bind(this)))}},_animationGetter:function(){return this._animation},_canvasGetter:function(){return this._canvas},_basemapTerrainGetter:function(){return this._basemapTerrain},_navigationGetter:function(){return this._navigation},_mapSetter:function(e){return e===this.map?e:(delete this._externallySet.camera,this.inherited(arguments))}});return nt});