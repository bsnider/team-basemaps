// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../core/declare","dojo/_base/lang","dojo/_base/kernel","dojo/promise/all","../core/Collection","../core/Scheduler","../geometry/Point","../geometry/Extent","../geometry/ScreenPoint","./View","./ViewAnimation","./inputs/GestureManager","./2d/AnimationManager","./2d/PaddedViewState","./2d/viewpointUtils","./2d/MapViewConstraints","./2d/layers/GraphicsView2D","./2d/handlers/Navigation","./ui/2d/DefaultUI2D","./ui/ZoomBox","./2d/engine/Stage","../core/accessorSupport/get","../core/watchUtils"],function(t,e,i,n,s,r,o,a,h,p,l,c,d,u,f,y,x,_,w,m,v,g,P){g=g.get;var z=t([p],{declaredClass:"esri.views.MapView",classMetadata:{properties:{constraints:{type:y},center:{type:o,copy:function(t,e){t.x=e.x,t.y=e.y,t.spatialReference=e.spatialReference},dependsOn:["content.center"]},extent:{type:a,copy:function(t,e){t.xmin=e.xmin,t.ymin=e.ymin,t.xmax=e.xmax,t.ymax=e.ymax,t.spatialReference=e.spatialReference},dependsOn:["content.extent"]},initialExtentRequired:{dependsOn:["map.initialViewProperties.viewpoint"],getter:function(){return this.get("map.initialViewProperties.viewpoint")?!(!this._proxyProps||!this._proxyProps.center||void 0!==this._proxyProps.scale||this.initialExtent):this._proxyProps?!(this._proxyProps.extent||this._proxyProps.viewpoint||this._proxyProps.center&&this._proxyProps.scale||this._proxyProps.zoom):!this.initialExtent}},rotation:{dependsOn:["content.rotation"]},scale:{dependsOn:["content.scale"]},spatialReference:{dependsOn:["map.initialViewProperties.spatialReference"]},state:{},tileInfo:{dependsOn:["map.initialViewProperties.viewpoint","map.layers","map.basemap"]},ui:{type:w},viewpoint:{copy:f.copy,dependsOn:["content.viewpoint"]},zoom:{dependsOn:["content.scale"]}}},constructor:function(){this._proxyProps={},this._pendingUpdates=new s,this._updateTask=r.addFrameTask({update:function(){this._pendingUpdates.drain(function(t){t._commitUpdate()}),this._pendingUpdates.length||this._updateTask.pause()}.bind(this)}),this._updateTask.pause(),this._handles.add([this.on("resize",this._resizeHandler.bind(this))]);var t=this.notifyChange.bind(this,"tileInfo");P.on(this,"map.basemap.baseLayers","change",t,t,t),P.on(this,"map.layers","change",t,t,t),P.whenFalse(this,"ready",function(){this.stage&&this.stage.removeAllChildren()}.bind(this))},getDefaults:function(){return e.mixin(this.inherited(arguments),{constraints:{},padding:{top:0,right:0,bottom:0,left:0}})},initialize:function(){this._graphicsView=new x({view:this,graphics:this.graphics})},destroy:function(){this._graphicsView.destroy()},_pendingUpdates:null,_graphicsView:null,_zoomBox:null,className:"esriMapView",resizeAlign:"center",animation:null,_animationSetter:function(t,e){return e&&e.stop(),t&&!t.isFulfilled()?(t.then(function(){this.animation=null}.bind(this),function(){this.animation=null}.bind(this),function(t){this.state.viewpoint=t}.bind(this)),t):null},center:null,_centerGetter:function(t){if(this._proxyProps)return this._proxyProps.center;t||(t=new o);var e=this.content.center,i=this.content.spatialReference;return t.x=e[0],t.y=e[1],t.spatialReference=i,t},_centerSetter:function(t){if(null!=t){if(this._proxyProps)return this._proxyProps.center=t,void(null!=this._proxyProps.center&&null!=this._proxyProps.scale&&(this.initialExtentRequired=!1));var e=this.viewpoint;f.centerAt(e,e,t),this.viewpoint=e}},constraints:null,_constraintsSetter:function(t,e){return e&&(this._handles.remove("constraints"),e.view=null),t&&(this._ready&&(t.view=this,this.state.viewpoint=t.constrain(this.content.viewpoint,null,this)),this._handles.add(t.on("update",function(){this._ready&&this.state&&(this.state.viewpoint=t.constrain(this.content.viewpoint,null,this))}.bind(this)),"constraints")),t},extent:null,_extentGetter:function(t){if(this._proxyProps)return this._proxyProps.extent;t||(t=new a);var e=this.content.extent;return t.xmin=e.xmin,t.ymin=e.ymin,t.xmax=e.xmax,t.ymax=e.ymax,t.spatialReference=e.spatialReference,t},_extentSetter:function(t){if(null!=t){if(this._proxyProps)return this._proxyProps.extent=t,void(this.initialExtentRequired=!1);var e=this.viewpoint;f.setExtent(e,e,t,this.size,{constraints:this.constraints}),this.viewpoint=e}},_paddingGetter:function(){return this._proxyProps?this._proxyProps.padding:this.state.padding},_paddingSetter:function(t){return t=e.mixin({top:0,right:0,bottom:0,left:0},t),this._proxyProps?(this._proxyProps.padding=t,t):(this.state.padding=t,this.state.padding)},rotation:0,_rotationGetter:function(){return this._proxyProps?this._proxyProps.rotation:this.content.rotation},_rotationSetter:function(t){if(null!=t){if(this._proxyProps)return void(this._proxyProps.rotation=t);var e=this.viewpoint;f.rotateTo(e,e,t),this.viewpoint=e}},scale:0,_scaleGetter:function(){return this._proxyProps?this._proxyProps.scale:this.content.scale},_scaleSetter:function(t){if(null!=t){if(this._proxyProps)return this._proxyProps.scale=t,void(null!=this._proxyProps.center&&null!=this._proxyProps.scale&&(this.initialExtentRequired=!1));var e=this.viewpoint;f.scaleTo(e,e,t),this.viewpoint=e}},_surfaceSetter:function(t,e){if(e===t)return e;if(e&&(this.stage.destroy(),this._zoomBox.destroy(),this._zoomBox=null,this.gestureManager.destroy(),this.gestureManager=null),t){this.stage=new v({container:t,scheduler:r.instance}),this.gestureManager=new c({view:this,surface:t,inputOptions:{mouseModifiers:!0}});var i=new _({view:this});this.addHandler(i),this._zoomBox=new m({view:this})}return t},_tileInfoGetter:function(){return g(this,"map.basemap.baseLayers.0.tileInfo")||g(this,"map.layers.0.tileInfo")},type:"2d",viewpoint:null,_viewpointGetter:function(t){var e=this._proxyProps?this._proxyProps.viewpoint:this.content.viewpoint;return e?t?f.copy(t,e):e.clone():e},_viewpointSetter:function(t){if(null!=t){if(this._proxyProps)return this._proxyProps.viewpoint=t,void(this.initialExtentRequired=!1);this.constraints.constrain(t,this.content.viewpoint,this),this.state.viewpoint=t}},zoom:-1,_zoomGetter:function(){return this._proxyProps?this._proxyProps.zoom:this.constraints.scaleToZoom(this.scale)},_zoomSetter:function(t){if(null!=t){if(this._proxyProps)return this._proxyProps.zoom=t,this.initialExtentRequired=!1,t;if(!this.constraints.effectiveLODs)return null;var e=this.viewpoint;f.scaleTo(e,e,this.constraints.zoomToScale(t)),this.viewpoint=e}},goTo:function(t,i){var n=this.content,s=n?n.size:this.size,r=n?n.viewpoint:this.viewpoint,o=this.spatialReference||null,a=this.constraints.snapToZoom;i=e.mixin({animate:!0},i,{spatialReference:o,size:s,currentViewpoint:r,constraints:this.constraints,snapToZoom:a});var h=f.createAsync(t,i);return h.then(function(t){if(i.animate){var e=null;return this.ready&&this.animationManager?(this.constraints.constrain(t,this.viewpoint,this),e=this.animation=this.animationManager.animateTo(t,this.viewpoint,i)):(this.viewpoint=t,e=new l({target:t}),e.finish(),e)}this.viewpoint=t}.bind(this))},animateTo:function(t,e){return i.deprecated(this.declaredClass+".animateTo is deprecated. Use .goTo instead.","","4.0"),this.goTo(t,e)},hitTest:function(t,e){if(!this.ready)return null;var i;i=null!=t&&t.x?t:{x:t,y:e};var s=this.toMap(i),r=[this._graphicsView].concat(this.allLayerViews.toArray());return n(r.map(function(i){return i.hitTest?i.hitTest(t,e):null})).then(function(t){return{screenPoint:i,results:t.filter(function(t){return t}).map(function(t){return{mapPoint:s,graphic:t}})}})},toMap:function(t,e,i){if(!this.ready)return null;t&&null!=t.x&&(i=e,e=t.y,t=t.x);var n=[0,0];return this.state.toMap(n,[t,e]),i=i||new o,i.x=n[0],i.y=n[1],i.spatialReference=this.spatialReference,i},toScreen:function(t,e,i,n){if(!this.ready)return null;t&&null!=t.x&&(n=e,e=t.y,t=t.x),n=i||n||new h;var s=[t,e];return this.state.toScreen(s,s),n.x=s[0],n.y=s[1],n},pixelSizeAt:function(t,e){return this.ready?(t&&null!=t.x&&(e=t.y,t=t.x),this.content.pixelSizeAt([t,e])):0/0},scheduleLayerViewUpdate:function(t){this._pendingUpdates.add(t),this.ready&&this._updateTask.resume()},getDefaultSpatialReference:function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")},_readyGetter:function(t){var e=this.inherited(arguments);if(!!e==!!t)return t;if(this._ready=e,!e&&t)return this._proxyProps={viewpoint:this.viewpoint,padding:this.padding},e;this.constraints.view=this;var i=this._proxyProps,n=(this.map,this.get("map.initialViewProperties.viewpoint")),s=!n||i.center||i.extent?i:{viewpoint:n},r=f.create(s,{spatialReference:this.spatialReference,size:this.size,constraints:this.constraints,extent:this.initialExtent}),o=new u({padding:i.padding,size:this.size,viewpoint:r});return this._proxyProps=null,this.initialExtentRequired=!0,this.animationManager=new d,this.state=o,this.content=o.content,this._handles.remove("allLayerViews"),this._viewsChangeHandler({added:this.allLayerViews.toArray(),removed:[],moved:[]}),this._handles.add(this.allLayerViews.on("change",this._viewsChangeHandler.bind(this)),"allLayerViews"),this.stage.state=o,this.stage.run(),this._pendingUpdates.length&&this._updateTask.resume(),e},_viewsChangeHandler:function(t){var e,i,n=this.allLayerViews.filter(function(t){return!t.layerViews}),s=t.added,r=t.removed,o=t.moved;for(e=0,i=r.length;i>e;e++)this.stage.removeChild(r[e].container);for(e=0,i=s.length;i>e;e++)s[e].container&&this.stage.addChildAt(s[e].container,n.indexOf(s[e]));for(e=0,i=o.length;i>e;e++)this.stage.setChildIndex(o[e].container,n.indexOf(o[e]));var a=function(){this.updating=n.some(function(t){return t.updating})}.bind(this);this._handles.remove("layerViewsUpdating"),this._handles.add(n.map(function(t){return t.watch("updating",a)}),"layerViewsUpdating")},_resizeHandler:function(t){var e=this.state;if(e){var i=this.content.viewpoint,n=this.content.size.concat();e.size=[t.width,t.height],f.resize(i,i,n,this.content.size,this.resizeAlign),i=this.constraints.constrain(i,null,this),this.state.viewpoint=i}}});return z});