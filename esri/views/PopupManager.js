// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","../core/declare","../core/promiseUtils","dojo/_base/array","dojo/on","dojo/Deferred","dojo/promise/all","../layers/support/layerUtils","../geometry/support/scaleUtils","../geometry/Extent","../tasks/support/Query","../layers/GroupLayer","../core/Accessoire"],function(e,r,a,t,i,n,s,l,o,u,c,f,p){var d,h=r(p,{declaredClass:"esri.views.PopupManager",classMetadata:{properties:{map:{dependsOn:["view.map"],readOnly:!0}}},constructor:function(){this._featureLayersCache={}},destroy:function(){this._featureLayersCache={},this.view=null},_clickHandle:null,_featureLayersCache:null,enabled:!1,_enabledSetter:function(e){return this._clickHandle&&(e?this._clickHandle.resume():this._clickHandle.pause()),e},_mapGetter:function(){return this.get("view.map")||null},view:null,_viewSetter:function(e){return this._clickHandle&&(this._clickHandle.remove(),this._clickHandle=null),e&&(this._clickHandle=i.pausable(e,"click",this._clickHandler.bind(this)),this.enabled||this._clickHandle.pause()),e},getMapLayer:function(e){var r;if(e&&(r=e.findLayerById())){var a=r.id;if(this._featureLayersCache[a]){var t=a.lastIndexOf("_");t>-1&&(a=a.substring(0,t),r=this.map.findLayerById(a))}}return r},_showPopup:function(e){function r(){h.clear(),h.close()}function i(e){if(null==e)return!1;var r=d.allLayerViews.find(function(r){return r.layer===e});return null==r?!1:e.loaded&&!r.suspended&&(e.popupEnabled&&e.popupTemplate||"esri.layers.GraphicsLayer"===e.declaredClass)}function l(e){return!e.elevationInfo||"on-the-ground"===e.elevationInfo.mode}var p=this.map,d=this.view,h=d.popup,y=this,v=[];t.forEach(p.layers.toArray(),function(e){e.isInstanceOf(f)?t.forEach(e.layers.toArray(),function(e){i(e)&&l(e)&&v.push(e)}):i(e)&&l(e)&&v.push(e)}),d.graphics.length>0&&v.push(d.graphics);var m=null;if(e.graphic&&(e.graphic.popupTemplate||i(e.graphic.layer))&&(m=e.graphic),!v.length&&!m)return void r();var g=[],_=!!m;if(m)if(m.layer&&"esri.layers.SceneLayer"===m.layer.declaredClass){var w=d.whenLayerView(m.layer).then(function(e){return e.whenGraphicAttributes(m,["*"])});g.unshift(s([w]))}else{var L=new n;g.unshift(L.resolve([m]))}else{var b=y._calculateClickTolerance(v),x=e.mapPoint;if(!x)return void r();var C=1;d.state&&(C=d.state.resolution);var M=d.basemapTerrain;M&&M.overlayManager&&(C=M.overlayManager.overlayPixelSizeInMapUnits(x));var k=b*C;M&&!M.spatialReference.equals(d.spatialReference)&&(k*=o.getUnitValueForSR(M.spatialReference)/o.getUnitValueForSR(d.spatialReference));var O=x.clone().offset(-k,-k),T=x.clone().offset(k,k),I=new u(Math.min(O.x,T.x),Math.min(O.y,T.y),Math.max(O.x,T.x),Math.max(O.y,T.y),d.spatialReference);g=t.map(v,function(r){var t;if("esri.layers.ImageryLayer"===r.declaredClass){var i=new c;i.geometry=e.mapPoint;var n=d.allLayerViews.find(function(e){return e.layer===r}),s={};s.rasterAttributeTableFieldPrefix="Raster.",s.returnDomainValues=!0,s.layerView=n,t=r.queryVisibleRasters(i,s).then(function(e){return _=_||e.length>0,e})}else if("esri.layers.SceneLayer"===r.declaredClass)t=a.resolve();else if(y._featureLayersCache[r.id]||"function"==typeof r.queryFeatures&&(0===r.mode||1===r.mode)){var l=r.createQueryParameters();l.geometry=I,t=r.queryFeatures(l).then(function(e){var r=e.features;return _=_||r.length>0,r})}else{var o,u=[];if("esri.core.Collection<esri.Graphic>"===r.declaredClass)o=r;else{var n=d.allLayerViews.find(function(e){return e.layer===r});n&&(n.loadedGraphics||n._graphicsCollection)&&(o=n.loadedGraphics||n._graphicsCollection)}o&&(u=o.filter(function(e){return e&&e.popupTemplate&&e.visible&&I.intersects(e.geometry)}).toArray()),_=_||u.length>0,t=a.resolve(u)}return t})}var V=t.some(g,function(e){return!e.isFulfilled()});return V||_?void h.open({promises:g,location:e.mapPoint}):void r()},_getSubLayerFeatureLayers:function(r,a){var o=a||new n,u=[],c=r.length,f=Math.floor(this.view.extent.width/this.view.width),p=this.view.scale,h=!1,y=this;e:for(var v=0;c>v;v++){var m=r[v],g=m.dynamicLayerInfos||m.layerInfos;if(g){var _=null;m._params&&(m._params.layers||m._params.dynamicLayers)&&(_=m.visibleLayers),_=l._getVisibleLayers(g,_);for(var w=l._getLayersForScale(p,g),L=g.length,b=0;L>b;b++){var x=g[b],C=x.id,M=m.popupTemplates[C];if(!x.subLayerIds&&M&&M.popupTemplate&&t.indexOf(_,C)>-1&&t.indexOf(w,C)>-1){if(!d){h=!0;break e}var k=m.id+"_"+C,O=this._featureLayersCache[k];if(O&&O.loadError)continue;if(!O){var T=M.layerUrl;T||(T=x.source?this._getLayerUrl(m.url,"/dynamicLayer"):this._getLayerUrl(m.url,C)),O=new d(T,{id:k,drawMode:!1,mode:d.MODE_SELECTION,outFields:this._getOutFields(M.popupTemplate),resourceInfo:M.resourceInfo,source:x.source}),this._featureLayersCache[k]=O}O.setDefinitionExpression(m.layerDefinitions&&m.layerDefinitions[C]),O.setGDBVersion(m.gdbVersion),O.popupTemplate=M.popupTemplate,O.setMaxAllowableOffset(f),O.setUseMapTime(!!m.useMapTime),m.layerDrawingOptions&&m.layerDrawingOptions[C]&&m.layerDrawingOptions[C].renderer&&O.setRenderer(m.layerDrawingOptions[C].renderer),u.push(O)}}}}if(h){var I=new n;e(["../layers/FeatureLayer"],function(e){d=e,I.resolve()}),I.then(function(){y._getSubLayerFeatureLayers(r,o)})}else{var V=[];t.forEach(u,function(e){if(!e.loaded){var r=new n;i.once(e,"load, error",function(){r.resolve()}),V.push(r.promise)}}),V.length?s(V).then(function(){u=t.filter(u,function(e){return!e.loadError&&e.isVisibleAtScale(p)}),o.resolve(u)}):(u=t.filter(u,function(e){return e.isVisibleAtScale(p)}),o.resolve(u))}return o.promise},_getLayerUrl:function(e,r){var a,t=e.indexOf("?");return a=-1===t?e+"/"+r:e.substring(0,t)+"/"+r+e.substring(t)},_getOutFields:function(e){var r;return e.info&&"esri.widgets.PopupTemplate"===e.declaredClass?(r=[],t.forEach(e.info.fieldInfos,function(e){var a=e.fieldName&&e.fieldName.toLowerCase();a&&"shape"!==a&&0!==a.indexOf("relationships/")&&r.push(e.fieldName)})):r=["*"],r},_calculateClickTolerance:function(e){var r=6;return t.forEach(e,function(e){var a=e.renderer;if(a)if("esri.renderer.SimpleRenderer"===a.declaredClass){var i=a.symbol;i&&i.xoffset&&(r=Math.max(r,Math.abs(i.xoffset))),i&&i.yoffset&&(r=Math.max(r,Math.abs(i.yoffset)))}else("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)&&t.forEach(a.infos,function(e){var a=e.symbol;a&&a.xoffset&&(r=Math.max(r,Math.abs(a.xoffset))),a&&a.yoffset&&(r=Math.max(r,Math.abs(a.yoffset)))})}),r},_clickHandler:function(e){var r=this.view.popup,a=this;if(r&&this.view.ready){var t=e.screenPoint;null!=t?this.view.hitTest(t.x,t.y).then(function(e){e.results.length>0&&a._showPopup(e.results[0])}):this._showPopup(e)}}});return h});