// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/dom","dojo/dom-construct","dojo/dom-class","../Graphic","../core/Accessoire","../core/Collection","../core/Evented","../core/HandleRegistry","../core/AccessoirePromise","../core/watchUtils","../core/promiseUtils","../core/Scheduler","../geometry/SpatialReference","../geometry/Extent","./BreakpointsOwner","./DOMContainer","./LayerViewManager","./BasemapView","./GroundView","./PopupManager","./ui/DefaultUI","./support/DefaultsFromMap","../widgets/Popup"],function(e,t,i,a,n,r,s,o,l,d,u,h,p,c,f,y,w,g,m,v,_,R,M,V){var F=r.createSubclass([d,w,o,y],{declaredClass:"esri.views.View",classMetadata:{properties:{allLayerViews:{type:s},basemapView:{},container:{},animation:{},resizing:{},interacting:{},graphics:{type:s.ofType(n)},groundView:{},initialExtent:{readOnly:!0,type:f,dependsOn:["defaultsFromMap.extent"]},initialExtentRequired:{},layerViews:{type:s},map:{},popup:{type:V},ready:{readOnly:!0,dependsOn:["map","spatialReference","surface","width","height","suspended","initialExtentRequired","initialExtent","defaultsFromMap.isDone","map.loaded"]},defaultsFromMapCollectionPaths:{},root:{},spatialReference:{type:c,dependsOn:["defaultsFromMap.spatialReference"]},stationary:{dependsOn:["animation","interacting","resizing"]},surface:{},type:{},ui:{type:R},updating:{},width:{},height:{},suspended:{}}},constructor:function(){this._viewHandles=new l,this._viewHandles.add(this.watch("ready",function(e,t){this._currentSpatialReference=e?this.spatialReference:null,this.notifyChange("spatialReference"),!e&&t&&this.layerViewManager.empty()}.bind(this))),this.defaultsFromMap=new M({view:this})},getDefaults:function(){return e.mixin(this.inherited(arguments),{layerViews:[],allLayerViews:[],graphics:[],padding:{left:0,top:0,right:0,bottom:0},popup:{},ui:{}})},initialize:function(){var e=this.validate().then(function(){return this._isValid=!0,this.notifyChange("ready"),u.whenOnce(this,"ready")}.bind(this));this.addResolvingPromise(e),this.basemapView=new m({view:this}),this.groundView=new v({view:this}),this.layerViewManager=new g({view:this,allLayerViews:this.allLayerViews}),this._resetInitialViewPropertiesFromContent()},destroy:function(){this.basemapView.destroy(),this.groundView.destroy(),this.destroyLayerViews(),this.ui.destroy(),this.popup&&this.popup.destroy(),this.defaultsFromMap.destroy(),this.defaultsFromMap=null,this._viewHandles.destroy(),this.map=null,this.container=null},destroyLayerViews:function(){this.layerViewManager.destroy()},_viewHandles:null,_isValid:!1,_readyCycleForced:!1,_userSpatialReference:null,_currentSpatialReference:null,activeTool:"navigation",animation:null,basemapView:null,groundView:null,container:null,_containerSetter:function(e,n){return e=t.byId(e),n===e?n:(n&&(a.remove(n,"esri-view"),this.popupManager.destroy(),this.popupManager=null,i.destroy(this.root),this.root=null),e?(a.add(e,"esri-view"),this.root=i.create("div",{className:"esri-view-root"},e,"first"),this.surface=i.create("div",{className:"esri-view-surface"},this.root),t.setSelectable(this.surface,!1),this._forceReadyCycle(),this.popupManager=new _({enabled:!0,view:this})):this.surface=null,e)},graphics:null,_graphicsSetter:function(e){return this._graphicsView&&(this._graphicsView.graphics=e),e},interacting:!1,_interactingSetter:function(e){var t=this.surface;return t&&t.setAttribute("data-interacting",e),e},layerViews:null,map:null,_mapSetter:function(e,t){return e===t?e:(e&&e.load&&e.load(),this._forceReadyCycle(),this._resetInitialViewPropertiesFromContent(),e)},padding:null,_popupSetter:function(e,i){return e===i?i:(this._viewHandles.remove("view-popup"),i&&i.destroy(),e&&(e.viewModel.view=this,e._started||e.startup(),this._viewHandles.add([u.init(this,"root",function(i,a){var n=e.domNode;t.isDescendant(n.parentNode,a)&&n.parentNode.removeChild(n),i&&!n.parentNode&&e.placeAt(i)})],"view-popup")),e)},_readyGetter:function(){return!(!this._isValid||this._readyCycleForced||!this.map||null==this.surface||0===this.width||0===this.height||!this.spatialReference||this.map.load&&!this.map.loaded||!(this._currentSpatialReference||!this.initialExtentRequired||this.initialExtent||this.defaultsFromMap&&this.defaultsFromMap.isDone)||!this.isSpatialReferenceSupported(this.spatialReference))},spatialReference:null,_spatialReferenceGetter:function(){return this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null},_spatialReferenceSetter:function(e){return this._userSpatialReference=e,e},stationary:!0,_stationaryGetter:function(){return!this.animation&&!this.interacting&&!this.resizing},surface:null,type:null,_uiSetter:function(e,t){return e===t?t:(this._viewHandles.remove("ui"),t&&t.destroy(),e&&(e.view=this,this._viewHandles.add([u.init(this,"root",function(t){e.container=t?i.create("div",null,t):null})],"ui")),e)},updating:!1,initialExtentRequired:!0,initialExtent:null,_initialExtentGetter:function(){return this.defaultsFromMap&&this.defaultsFromMap.extent},whenLayerView:function(e){return this.layerViewManager.whenLayerView(e)},addHandler:function(e){return this.gestureManager&&this.gestureManager.addHandler(e),this},removeHandler:function(e){return this.gestureManager&&this.gestureManager.removeHandler(e),this},pageToContent:function(e,t,i){var a=this.padding;return i=this.pageToContainer(e,t,i),a&&(i[0]=i[0]-a.left,i[1]=i[1]-a.top),i},getDefaultSpatialReference:function(){return this.get("defaultsFromMap.spatialReference")},validate:function(){return h.resolve()},isSpatialReferenceSupported:function(){return!0},_resetInitialViewPropertiesFromContent:function(){if(this.defaultsFromMap){var e=this.defaultsFromMap.start.bind(this.defaultsFromMap);this.defaultsFromMap.reset(),this._currentSpatialReference=null,this.notifyChange("spatialReference"),this._viewHandles.remove("defaultsFromMap"),this._viewHandles.add([u.watch(this,"spatialReference",e),u.watch(this,"initialExtentRequired",e),p.schedule(e)],"defaultsFromMap")}},_forceReadyCycle:function(){this.ready&&(this._readyCycleForced=!0,this.notifyChange("ready"),u.whenFalseOnce(this,"ready",function(){this._readyCycleForced=!1,this.notifyChange("ready")}.bind(this)))}});return F});