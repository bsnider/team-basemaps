// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["./math/common","./math/mat2d","./math/vec2","../../Viewpoint","../../core/promiseUtils","../../geometry/SpatialReference","../../geometry/Geometry","../../geometry/Point","../../geometry/Extent","../../geometry/support/webMercatorUtils","../../geometry/support/scaleUtils"],function(e,t,r,n,a,o,c,i,u,s,f){var l=39.37,m=6370997*Math.PI/180,y=6378137,g=180/Math.PI,p=function(t,n,a){var o=e.toDegree(n[0]/y);return r.set(t,a?o:o-360*Math.floor((o+180)/360),e.toDegree(.5*Math.PI-2*Math.atan(Math.exp(-1*n[1]/y))))},v=function(t,n){var a=n[1];return a>89.99999?a=89.99999:-89.99999>a&&(a=-89.99999),a=Math.sin(e.toRadian(a)),r.set(t,e.toRadian(n[0])*y,.5*y*Math.log((1+a)/(1-a)))},h=function(e,t,n,a){return a&&n&&!a.equals(n)&&a._canProject(n)&&a.isWebMercator?a.isWebMercator?v(e,t):p(e,t):r.copy(e,t)},x=function(e){return e.wkid?e:e.spatialReference||o.WGS84},d=function(e,t){return t.type?r.set(e,t.x,t.y):r.copy(e,t)},M=function(e){return f.getUnitValueForSR(e)||m},b=function(e,t){var r=e.width,n=e.height;return Math.max(r/t[0],n/t[1])*U(e.spatialReference)},R=function(e,t,r){var n;if(!e)return null;if(Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])return new i(e);if(e.forEach)return e.reduce(function(e,r){return R(r,t,e)},r);if(Array.isArray(e)){for(var a=0;a<e.length;a++)if(r=R(e[a],t,r),!r)return null;return r}if(e instanceof c?n=e:e.geometry&&(n=e.geometry),!n)return null;var o;if(o="point"===n.type?new u({xmin:n.x,ymin:n.y,xmax:n.x,ymax:n.y,spatialReference:n.spatialReference}):n.extent,!o||!s.canProject(o.spatialReference,t))return null;var f=s.project(o,t);return r=r?r.union(f):f.clone()},w=function(e,t){if(!e)return new n({targetGeometry:new i,scale:0,rotation:0});var a=t.spatialReference,o=t.size,u=t.currentViewpoint,s=t.constraints,f=null;"esri.Viewpoint"===e.declaredClass?f=e:e.viewpoint?f=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(f=e.target);var l=null,m=null;f&&f.targetGeometry?m=f.targetGeometry:e instanceof c?m=e:(e||e&&(e.hasOwnProperty("center")||e.hasOwnProperty("extent")||e.hasOwnProperty("target")))&&(m=R(e.center,a)||R(e.extent,a)||R(e.target,a)||R(e,a)),!m&&u&&u.targetGeometry?m=u.targetGeometry:!m&&t.extent&&(m=t.extent);var y=x(m);a||(a=x(t.spatialReference||t.extent||m)),l=m.center?m.center:m,l=d(r.create(),l),l=new i(h(l,l,y,a),a);var g=null;g=f&&f.targetGeometry&&"point"===f.targetGeometry.type?f.scale:e.hasOwnProperty("scale")?e.scale:e.hasOwnProperty("zoom")&&s&&s.effectiveLODs?s.zoomToScale(e.zoom):Array.isArray(m)||"point"===m.type||"extent"===m.type&&0===m.width&&0===m.height?t.extent?b(t.extent,o):u.scale:b(m.extent,o);var p=0;return f?p=f.rotation:e.hasOwnProperty("rotation")?p=e.rotation:u&&(p=u.rotation),s&&(s.rotationEnabled||(p=0),s.snapToZoom&&(g=s.snapScale(g)),0!==s.effectiveMinScale&&(g=Math.min(s.effectiveMinScale,g)),0!==s.effectiveMaxScale&&(g=Math.max(s.effectiveMaxScale,g))),new n({targetGeometry:l,scale:g,rotation:p})},G=function(e,t){var r=e.targetGeometry,n=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e},S=function(e,t,n){return n?(r.set(e,.5*(t[0]-n.right+n.left),.5*(t[1]-n.bottom+n.top)),e):r.scale(e,t,.5)},P=function(){var e=r.create();return function(t,r,n){var a=r.targetGeometry;d(e,a);var o=.5*V(r);return t.xmin=e[0]-o*n[0],t.ymin=e[1]-o*n[1],t.xmax=e[0]+o*n[0],t.ymax=e[1]+o*n[1],t.spatialReference=a.spatialReference,t}}(),A=function(e,t,r,n,a){return _(e,t,r.center),e.scale=b(r,n),a&&a.constraints&&a.constraints.constrain(e),e},T=function(e,r,n){return e=F(e,r,n),t.invert(e,e)},k=function(){var e=r.create(),t=r.create();return function(r,n,a){d(e,n.targetGeometry),z(t,n,a);var o=.5*V(n),c=e[0]-o*t[0],i=e[1]-o*t[1],u=e[0]+o*t[0],s=e[1]+o*t[1],f=n.targetGeometry.spatialReference;return r.set({xmin:c,ymin:i,xmax:u,ymax:s,spatialReference:f}),r}}(),z=function(e,t,n){var a=I(t),o=Math.abs(Math.cos(a)),c=Math.abs(Math.sin(a));return r.set(e,Math.round(n[1]*c+n[0]*o),Math.round(n[1]*o+n[0]*c))},O=function(){var e=r.create();return function(t,n,a){return r.sub(t,j(t,n),S(e,n,a))}}(),E=function(){var e=t.create(),n=r.create();return function(a,o,c,i){var u=V(o),s=I(o);return r.set(n,u,u),t.fromScaling(e,n),t.rotate(e,e,s),t.translate(e,e,O(n,c,i)),t.translate(e,e,[0,i.top-i.bottom]),r.set(a,e[4],e[5]),a}}(),V=function(e){return e.scale*B(e.targetGeometry.spatialReference)},B=function(e){return 1/(M(e)*l*C())},I=function(t){return e.toRadian(t.rotation)||0},U=function(e){return M(e)*l*C()},j=function(e,t){return r.scale(e,t,.5)},C=function(){return 96},D=function(){var e=r.create(),n=r.create(),a=r.create();return function(o,c,i,u,s){return r.negate(e,c),r.scale(n,i,.5),r.set(a,1/u,-1/u),t.identity(o),t.translate(o,o,n),s&&t.rotate(o,o,s),t.scale(o,o,a),t.translate(o,o,e),o}}(),F=function(){var e=r.create();return function(t,r,n){var a=V(r),o=I(r);return d(e,r.targetGeometry),D(t,e,n,a,o)}}(),N=function(){var e=r.create();return function(t,r,n){var a=V(r);return d(e,r.targetGeometry),D(t,e,n,a,0)}}(),W=function(e,t){return a.resolve(w(e,t))},q=function(){var e=r.create(),t=r.create(),n=r.create();return function(a,o,c){r.subtract(e,a,o),r.normalize(e,e),r.subtract(t,a,c),r.normalize(t,t),r.cross(n,e,t);var i=Math.acos(r.dot(e,t)/(r.length(e)*r.length(t)))*g;return n[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),L=function(){var e=r.create();return function(t,r,n,a){var o=t.targetGeometry;return G(t,r),E(e,r,n,a),o.x+=e[0],o.y+=e[1],t}}(),Z=function(){var e=r.create();return function(t,r,n,a){var o=t.targetGeometry;return G(t,r),E(e,r,n,a),o.x-=e[0],o.y-=e[1],t}}(),_=function(){var e=r.create();return function(t,r,n){G(t,r);var a=t.targetGeometry,o=x(n),c=x(a);return d(e,n),h(e,e,o,c),a.x=e[0],a.y=e[1],t}}(),H=function(e,t){return V(t)},J=function(){var e=r.create();return function(t,n,a,o,c){c||(c="center"),r.sub(e,a,o),r.scale(e,e,.5);var i=e[0],u=e[1];switch(c){case"center":r.set(e,0,0);break;case"left":r.set(e,-i,0);break;case"top":r.set(e,0,u);break;case"right":r.set(e,i,0);break;case"bottom":r.set(e,0,-u);break;case"top-left":r.set(e,-i,u);break;case"bottom-left":r.set(e,-i,-u);break;case"top-right":r.set(e,i,u);break;case"bottom-right":r.set(e,i,-u)}return rt(t,n,e),t}}(),K=function(e,t,r){return G(e,t),e.rotation+=r,e},Q=function(e,t,r){return G(e,t),e.rotation=r,e},X=function(){var e=r.create();return function(t,n,a,o,c){return G(t,n),0!==a&&(et(e,o,n,c),t.scale=n.scale/a,tt(e,e,t,c),rt(t,t,r.set(e,e[0]-o[0],o[1]-e[1]))),t}}(),Y=function(e,t,r){return G(e,t),e.scale=r,e},$=function(){var e=r.create();return function(t,n,a,o,c,i){return G(t,n),0!==a&&(et(e,c,n,i),t.scale=n.scale/a,t.rotation+=o,tt(e,e,t,i),rt(t,t,r.set(e,e[0]-c[0],c[1]-e[1]))),t}}(),et=function(){var e=t.create();return function(t,n,a,o){return r.transformMat2d(t,n,T(e,a,o))}}(),tt=function(){var e=t.create();return function(t,n,a,o){return r.transformMat2d(t,n,F(e,a,o))}}(),rt=function(){var e=r.create(),n=t.create();return function(a,o,c){G(a,o);var i=V(o),u=a.targetGeometry;return t.fromRotation(n,I(o)),t.scale(n,n,r.fromValues(i,i)),r.transformMat2d(e,c,n),u.x+=e[0],u.y+=e[1],a}}();return{create:w,createAsync:W,copy:G,getAnchor:S,getExtent:P,setExtent:A,getPaddingMapTranslation:E,getPaddingScreenTranslation:O,getResolution:V,getScreenCenter:j,getTransform:F,getTransformNoRotation:N,getInverseTransform:T,getOuterExtent:k,getOuterSize:z,getResolutionToScaleFactor:U,getScaleToResolutionFactor:B,angleBetween:q,addPadding:L,centerAt:_,pixelSizeAt:H,removePadding:Z,resize:J,rotateBy:K,rotateTo:Q,scaleBy:X,scaleTo:Y,scaleAndRotateBy:$,toMap:et,toScreen:tt,translateBy:rt}});