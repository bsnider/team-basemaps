// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/on","dojo/has","../../../core/Collection","../ResourceLoader","../TileInfoView","../Tile","../math/vec2","../collections/ReferenceMap","../collections/Set","../engine/Container","../engine/Bitmap","./LayerView2D","./TileQueue"],function(e,t,i,s,l,n,o,h,a,d,r,c,u){var _=t("esri-mobile"),g=c.createSubclass({declaredClass:"esri.views.2d.layers.TiledLayerView2D",constructor:function(){this.container=new v,this._viewHdl=e.pausable(this,"view-change",function(){this.needUpdate()}.bind(this)),this._viewWtch=this.watch("suspended, view.stationary",function(){!this.suspended&&(!_||_&&this.view.stationary)?(this.needUpdate(),this._viewHdl.resume()):this._viewHdl.pause()}.bind(this))},initialize:function(){this.then(this.setup.bind(this))},destroy:function(){this._viewWtch.remove(),this._viewWtch=null,this._viewHdl.remove(),this._viewHdl=null,this._updatingDependenciesWatcher.forEach(function(e){e.remove()})},_tCol:null,_rtCol:null,setup:function(){var e=this.layer;this.tileInfoView=new l({tileInfo:e.tileInfo,fullExtent:e.fullExtent}),this._rtCol=this._tCol=new f;var t=[];e.tileMap&&(this._rtCol=new p({tileInfoView:this.tileInfoView,tileMap:e.tileMap,tiles:this._tCol}),t.push(this._rtCol)),this._loadingCol=new m({loader:this.createLoader(),tileInfoView:this.tileInfoView,layer:this.layer,tiles:this._rtCol,view:this.view}),t.push(this._loadingCol),this.container.set({tileInfoView:this.tileInfoView,tiles:this._loadingCol,state:this.view.state});var i=function(){this.updating=this._rtCol.updating||this._loadingCol.updating}.bind(this);this._updatingDependenciesWatcher=t.map(function(e){return e.watch("updating",i,!0)})},update:function(){if(!this.suspended){var e=this.tileInfoView,t=this.view.state,i=e.getTileSpans(t);this._tCol.tileSpans=i}},createLoader:function(){return new s({queue:new u({tileInfo:this.layer.tileInfo,state:this.view.state})})}}),v=d.createSubclass({declaredClass:"TileContainer",properties:{tileInfoView:{},tiles:{},state:{}},constructor:function(){this.levels={}},_hdl:null,_tilesSetter:function(e){var t=this._hdl,i=this._get("tiles");i!==e&&(t&&(this.removeAllChildren(),t.remove(),t=null),e&&(t=e.on("change",this._colChange.bind(this)),this._tilesAdded(e.toArray())),this._hld=t,this._set("tiles",e))},_tilesAdded:function(e){var t,i;for(t=0,i=e.length;i>t;t++){var s=e[t].tile,l=e[t].data,n=s.coords[2],h=this.levels[n],a=this.tileInfoView.getTileOrigin(o.create(),s.coords);h||(this.levels[n]=h=new d,h.coords=this.state.center,h.resolution=s.lodInfo.resolution,this.addChild(h)),s.bitmap=new r({coords:a,source:l}),h.addChild(s.bitmap)}},_tilesRemoved:function(e){var t,i,s,l;for(t=0,i=e.length;i>t;t++)s=e[t].tile,l=this.levels[s.coords[2]],l&&s.bitmap&&(l.removeChild(s.bitmap),0===l.numChildren&&(this.removeChild(l),delete this.levels[s.level]))},_colChange:function(e){e.added.length>0&&this._tilesAdded(e.added),e.removed.length>0&&this._tilesRemoved(e.removed)}}),f=a.createSubclass({declaredClass:"TileSet",_tileSpansSetter:function(e){e&&0!==e.length||this.removeAll();var t,i,s,l,o,h,a,d,r,c,u,_=this.keys(),g={},v=[],f=[];for(l=0,u=e.length;u>l;l++)for(t=e[l],i=t.lodInfo,a=t.row,d=i.z,o=t.colFrom,c=t.colTo;c>=o;o++)r=i.getWorldForX(o),h=i.normalizeX(o),s=n.getId(h,a,d,r),this.contains(s)?g[s]=this.getItem(s):(g[s]=new n([h,a,d,r],i),v.push(g[s]));for(l=0,u=_.length;u>l;l++)g[_[l]]||f.push(_[l]);this.addMany(v),this.removeMany(f)}}),p=h.createSubclass({declaredClass:"TileMapTilesCollection",properties:{updating:!1,tileInfoView:{},tileMap:{},tiles:{}},constructor:function(){this._loading=new a,this._tileMapCallback=this._tileMapCallback.bind(this)},_hdl:null,_tilesSetter:function(e){var t=this._hdl,i=this._get("tiles");i!==e&&(t&&(this.removeAll(),t.remove(),t=null),e&&(t=e.on("change",this._colChange.bind(this)),this._tilesAdded(e.toArray())),this._hld=t,this._set("tiles",e))},_tileMapCallback:function(e,t){this._loading.contains(t)&&(this._loading.remove(t),this.updating=this._loading.length,e===t?this.add(e.id,e):(e=new n([e.col,e.row,e.level,0],this.tileInfoView.getInfoForZoom(e.level)),e.world=t.world,this.add(e.id,e)))},_tilesAdded:function(e){var t,i,s;for(t=0,i=e.length;i>t;t++)s=e[t],this._loading.contains(s)||this.contains(s)||(this._loading.add(s),this.updating=this._loading.length,this.tileMap.getTile(s,this._tileMapCallback))},_tilesRemoved:function(e){this._loading.removeMany(e),this.removeMany(e)},_colChange:function(e){e.added.length>0&&this._tilesAdded(e.added),e.removed.length>0&&this._tilesRemoved(e.removed)}}),m=i.createSubclass({declaredClass:"TileLoader",properties:{updating:!1,loader:{},tileInfoView:{},layer:{},tiles:{},view:{}},constructor:function(){this._tileLoadHandler=this._tileLoadHandler.bind(this),this._tileErrorHandler=this._tileErrorHandler.bind(this),this._loadingList=[],this._removingList=[]},destroy:function(){this._viewHdl.remove(),this._viewHdl=null},initialize:function(){this._viewHdl=this.view.watch("stationary",function(e){if(!(!e||this._loadingList.length||this.tiles._loading&&this.tiles._loading.length)){var t=this._removingList.map(function(e){return this.find(function(t){return e===t.tile})}.bind(this));this.removeMany(t),this._removingList.length=0,this.updating=this._loadingList.length}}.bind(this))},_hdl:null,_tilesSetter:function(e){var t=this._hdl,i=this._get("tiles");i!==e&&(t&&(this.removeAll(),t.remove(),t=null),e&&(this._tilesAdded(e.toArray()),t=e.on("change",this._colChange.bind(this))),this._hld=t,this._set("tiles",e))},_tilesAdded:function(e){var t,i,s;for(t=0,i=e.length;i>t;t++)s=e[t],this._loadingList.push(s),this.updating=!0,this.loader.load({id:s.id,url:this.layer.getTileUrl(s.level,s.row,s.col),tile:s,loadCallback:this._tileLoadHandler,errorCallback:this._tileErrorHandler})},_tilesRemoved:function(e){var t,i,s,l,n,o=this._loadingList;for(t=0,i=e.length;i>t;t++)if(n=e[t],n.bitmap)this._removingList.push(n);else{for(s=0,l=o.length;l>s;s++)if(o[s]===n){o.splice(s,1);break}this.loader.cancel(n.id),this._removeIntersectingTiles(n)}this.updating=o.length},_colChange:function(e){e.added.length>0&&this._tilesAdded(e.added),e.removed.length>0&&this._tilesRemoved(e.removed)},_tileLoadHandler:function(e){var t,i,s=e.request.tile,l=e.data,n=this._loadingList;for(this.add({tile:s,data:l}),t=0,i=n.length;i>t;t++)if(n[t]===s){n.splice(t,1);break}if(!this.view.stationary||n.length||this.tiles._loading&&this.tiles._loading.length)this._removeIntersectingTiles(s);else{var o=this._removingList.map(function(e){return this.find(function(t){return e===t.tile})}.bind(this));this.removeMany(o),this._removingList.length=0}this.updating=n.length},_removeIntersectingTiles:function(e){var t,i,s,l=this._loadingList,n=this._removingList,o=!1;for(i=n.length-1;i>=0;i--)if(t=n[i],e.intersects(t)){for(s=l.length-1;s>=0;s--)t.intersects(l[s])&&(o=!0);o||(n.splice(i,1),this.removeAt(this.findIndex(function(e){return e.tile===t})))}},_tileErrorHandler:function(){}});return g});