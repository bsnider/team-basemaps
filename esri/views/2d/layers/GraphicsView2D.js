// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojox/gfx","dojo/dom-style","../engine/Container","../../layers/GraphicsView","./LayerView2D","../../../geometry/support/webMercatorUtils","../VectorGroup","../Vector"],function(e,t,i,r,o,s,n,a){var h=r.createSubclass({declaredClass:"esri.views.2d.layers.GraphicsView2D",classMetadata:{properties:{needsRedraw:{dependsOn:["gfx","mapView.stationary"]},renderer:{},view:{}}},constructor:function(){this.mapView=null},initialize:function(){var e=this.view;if(!e||!this.graphics)throw new Error("view and graphics are required parameter options");e.then(function(){this.container=new i({visible:!1}),this._vectors={},this._bgVectors={},this._prevScale=null;var t=this.container.render;this.container.render=function(e){t.call(this.container,e),this.render()}.bind(this),this.container.watch("surface",this._surfaceCreateHandler.bind(this)),this.watch("needsRedraw, graphics, mapView.state.version, view.suspended",this.redraw.bind(this)),this.watch("renderer",this._resymbolizeGraphics.bind(this)),e.isInstanceOf(o)?(this.mapView=this.view.view,this.container.visible=e.layer.visible,e.container.addChild(this.container)):(this.mapView=this.view,this.container.visible=!0,e.stage.addChild(this.container))}.bind(this))},destroy:function(){this._colChgHandle&&(this._colChgHandle.remove(),this._colChgHandle=null),this._vectors=this._bgVectors=this.container=this.group=this.bgGroup=null},_graphicsSetter:function(e){var t=this.graphics;return e===t?e:(t&&(this._colChgHandle.remove(),this._colChgHandle=null,this.removeAll()),e&&(this.addMany(e.toArray()),this._colChgHandle=e.on("change",function(e){this.addMany(e.added),this.remove(e.removed)}.bind(this))),e)},_needsRedrawGetter:function(){return(this.group||this.bgGroup)&&this.mapView.stationary},hitTest:function(e,i){null!=e&&"object"==typeof e&&(i=e.y,e=e.x);var r,s,n,a,h=this.mapView,c=this.view.isInstanceOf(o)?this.view.container.surface:this.container.surface,l=null,u=[e,i];return h.containerToPage(e,i,u),c&&(s=c.style.zIndex,c.style.zIndex="10000",t.getComputedStyle(c),r=document.elementFromPoint(u[0],u[1]),n=r&&r.vector,a=n&&(n.parent===this.group||n.parent===this.bgGroup),l=a&&n.graphic||null,c.style.zIndex=s),l},redraw:function(){if(this.needsRedraw&&!this.view.suspended&&this.mapView.stationary){var e=this.mapView.state,t={},i=!1;e.resolution!==this.group.resolution&&(t.x=e.x,t.y=e.y,t.resolution=e.resolution,i=!0,this._prevScale!==this.mapView.scale&&(this._prevScale=this.mapView.scale,this._resizeGraphics())),e.rotation!==this.group.rotation&&(t.rotation=e.rotation,i=!0),i&&(this.group.set(t),this.bgGroup.set(t),this.group._updateTransform(),this.bgGroup._updateTransform(),this.group.draw(),this.bgGroup.draw(),this.render())}},render:function(){if(!this.view.suspended&&this.group){var e=this.mapView.state;this.gfx.setDimensions(e.width,e.height),this.group.applyState(e),this.bgGroup.applyState(e)}},add:function(e){this.addMany([e])},addMany:function(e){if(e&&this.group){e.hasOwnProperty("length")||(e=[e]);var t,i,r,o=e.length,s=this.mapView.extent.spatialReference;for(t=0;o>t;t++)if(i=e[t],r=this.getRenderingInfo(i)){var n=r.renderer&&r.renderer.backgroundFillSymbol,h=i.id,c=i.geometry,l=this._projectGeometry(c,s),u=this._isPolygonMarkerSymbol(r.symbol.type,c),p=r.outlineSize;null==p&&(p=r.size),this._vectors[h]=new a({graphic:i,symbol:r.symbol,color:r.color,size:r.size,opacity:r.opacity,rotationAngle:r.rotationAngle,outlineSize:p,geometry:u?c&&c.centroid:c,projectedGeometry:l&&(u?l.centroid:l)}),this.group.addVector(this._vectors[h]),u&&n&&(this._bgVectors[h]=new a({graphic:i,symbol:n,outlineSize:r.outlineSize,geometry:c,projectedGeometry:l}),this.bgGroup.addVector(this._bgVectors[h]))}this.group.draw(),this.bgGroup.draw(),this.render()}},remove:function(e){if(e){e.hasOwnProperty("length")||(e=[e]);var t,i,r,o=e.length;for(t=0;o>t;t++)i=e[t],r=this._vectors[i.id],this.group.removeVector(r),delete this._vectors[i.id],r=this._bgVectors[i.id],r&&(this.bgGroup.removeVector(r),delete this._bgVectors[i.id])}},removeAll:function(){this._clear(this.group,this._vectors),this._vectors={},this._clear(this.bgGroup,this._bgVectors),this._bgVectors={}},_isPolygonMarkerSymbol:function(e,t){var i="simple-marker-symbol"===e||"picture-marker-symbol"===e||"text-symbol"===e,r=t&&"polygon"===t.type;return r&&i},_clear:function(e,t){Object.getOwnPropertyNames(t).forEach(function(i){e.removeVector(t[i])}.bind(this))},_projectGeometry:function(e,t){var i,r=e&&e.spatialReference;return r&&t&&!r.equals(t)&&s.canProject(r,t)&&(i=t.isWebMercator?s.geographicToWebMercator(e):s.webMercatorToGeographic(e,!0)),i},_resymbolizeGraphics:function(){if(this.group){var e=this._vectors,t=this.mapView.extent.spatialReference;Object.getOwnPropertyNames(e).forEach(function(i){var r=e[i],o=r.graphic,s=this.getRenderingInfo(o);if(s){var n=s.renderer&&s.renderer.backgroundFillSymbol,h=o.geometry,c=this._projectGeometry(h,t),l=this._isPolygonMarkerSymbol(s.symbol.type,h),u=l&&!!n,p=s.outlineSize;null==p&&(p=s.size),r.symbol=s.symbol,r.color=s.color,r.size=s.size,r.opacity=s.opacity,r.rotationAngle=s.rotationAngle,r.outlineSize=p,r.geometry=l?h&&h.centroid:h,r.projectedGeometry=c&&(l?c.centroid:c),r.offsets=null,r=this._bgVectors[i],u?r?(r.symbol=n,r.outlineSize=s.outlineSize,r.geometry=h,r.projectedGeometry=c,r.offsets=null):(this._bgVectors[i]=new a({graphic:o,symbol:n,outlineSize:s.outlineSize,geometry:h,projectedGeometry:c}),this.bgGroup.addVector(this._bgVectors[i])):r&&(this.bgGroup.removeVector(r),delete this._bgVectors[i])}}.bind(this)),this.group.draw(),this.bgGroup.draw(),this.render()}},_resizeGraphics:function(){if(this.group){var e=this._vectors;Object.getOwnPropertyNames(e).forEach(function(t){var i=e[t],r=i.graphic,o=this.getRenderingInfo(r);if(o){var s=o.outlineSize;null==s&&(s=o.size),i.size=o.size,i.outlineSize=s,i.offsets=null,i=this._bgVectors[t],i&&(i.outlineSize=o.outlineSize,i.offsets=null)}}.bind(this))}},_createVectorGroup:function(){var e=this.mapView.state;return new n({view:this.mapView,x:e.x,y:e.y,resolution:e.resolution,rotation:e.rotation,surface:this.gfx.createGroup(),layer:this.view.layer})},_surfaceCreateHandler:function(){var t=this.mapView.state;this.gfx=e.createSurface(this.container.surface,t.width,t.height),this.bgGroup=this._createVectorGroup(),this.group=this._createVectorGroup(),this.addMany(this.graphics.toArray())}});return h});