// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../core/declare","dojo/_base/lang","dojox/gfx","dojox/gfx/matrix","./math/common","./math/mat2d","./math/vec2","./Projector","../../geometry/Polygon","../../symbols/SimpleMarkerSymbol","../../symbols/support/gfxUtils","../../core/screenUtils","../../core/Accessoire"],function(t,e,r,i,s,a,o,n,l,h,c,p,u){function f(){return"vecgp"+d++}var d=0,y=function(t){return{xx:t[0],yx:t[1],xy:t[2],yy:t[3],dx:t[4],dy:t[5]}},m=-1!==r.renderer.toLowerCase().indexOf("svg"),g={type:"simple-fill-symbol",style:"square",size:15,xoffset:0,yoffset:0,angle:0},_={"picture-marker-symbol":"image","picture-fill-symbol":"path","simple-fill-symbol":"path","simple-line-symbol":"path","cartographic-line-symbol":"path","text-symbol":"text"},x={square:1,cross:1,x:1,diamond:1,target:1},v=t(u,{declaredClass:"esri.views.2d.VectorGroup",constructor:function(){this.id=f(),this._transform=a.create(),this._projector=new n,this.vectors=[],this.adding=[],this.removing=[],this.updating=[]},applyState:function(t){if(this.transform){var e=a.invert(this._transform,this.transform);a.multiply(e,t.transformNoRotation,e),this.surface.setTransform(y(e))}},requestVectorDraw:function(){},addVector:function(t){return this.addVectorAt(t,this.vectors.length)},addVectorAt:function(t,e){return e=Math.min(this.vectors.length,e),this.vectors.splice(e,0,t),t.set({parent:this,view:this.view}),t},removeVector:function(t){if(!this.vectors)return t;var e=this.vectors.indexOf(t);return e>-1&&(t=this.vectors.splice(e,1)[0],t.set({parent:null,view:null}),this._removeShape(t)),t},draw:function(){this.transform||this._updateTransform(),this.surface.openBatch();var t,e,r;for(e=0,r=this.vectors.length;r>e;e++)t=this.vectors[e],t&&this.drawVector(t);this.surface.closeBatch()},drawVector:function(t,e){var r,i,s,a=t.graphic,o=t.extent,n=t.shape,l=!0,h=t.geometry,c=t.projectedGeometry;if(a.visible&&o&&(r=this._intersects(this._map,o,h._originOnly))&&(i=l?t.symbol:g)){if(t.resolution===this.resolution&&t.rotation===this.rotation&&t.offsets&&t.offsets.join(",")===r.join(",")?s=!0:t.offsets=r,!n||e||!s){var p=h.type;if(t.resolution=this.resolution,t.rotation=this.rotation,"point"===p)this._isInvalidShape(i,n)&&this._removeShape(t),n=t.shape=this._drawPoint(this.surface,c||h,i,t,r),l&&this._stylePoint(t,i);else if("multipoint"===p)n=t.shape=this._drawMarkers(this.surface,c||h,i,t,r),l&&this._styleMarkers(t,i);else{var u=l?i:null;u&&(this._isInvalidShape(u,n)&&this._removeShape(t,!1),n=t.shape=this._drawShape(this.surface,c||h,t,r),this._styleShape(t,u))}n.getNode().vector=t}}else n&&this._removeShape(t)},_intersects:function(){return[0]},_isInvalidShape:function(t,e){var r=e&&e.shape&&e.shape.type,i=t&&t.type,s=t&&t.style;return i&&(s=_[i]||s),x[s]&&(s="path"),!(!r||!s||r===s)},_removeShape:function(t,e){var r=t.shape,i=r&&r.getNode();r&&(r.removeShape(),r.destroy()),t.shape=t.offsets=null,e!==!1&&this._removeBgShape(t),i&&(i.e_graphic=null)},_removeBgShape:function(t){var e=t.bgShape,r=e&&e.getNode();e&&(e.removeShape(),e.destroy()),t.bgShape=null,r&&(r.e_graphic=null)},_drawPoint:function(t,e,r,a,n,l){var u,f,d=r.type,y=o.fromValues(e.x,e.y),g=o.transformMat2d(y,y,this.transform),_=Math.round(g[0]),x=Math.round(g[1]),v=null!=l?a.shape&&a.shape.children[l]:a.shape,S=[],w=a.rotationAngle,b=a.size;if(b&&(b=isFinite(b[0])&&b[0],f=!!b),b=f?p.pt2px(b):null,g={x:g[0],y:g[1]},null==w){var T=s.toRadian(360-this.view.rotation);S.push(i.rotateAt(T,g))}w&&S.push(i.rotategAt(w,g));var M=p.pt2px(r.xoffset),k=p.pt2px(r.yoffset);if((0!==M||0!==k)&&S.push(i.translate(M,-k)),0!==r.angle&&S.push(i.rotategAt(r.angle,g)),"simple-marker-symbol"===d){var A,P=r.style,E=Math.round;b=f?b:p.pt2px(r.size);var L,V;switch(P){case h.STYLE_SQUARE:case h.STYLE_CROSS:case h.STYLE_X:case h.STYLE_DIAMOND:A=isNaN(b)?16:b/2,u=this._drawPath(t,v,this._smsToPath(h,P,_,x,E(_-A),E(_+A),E(x-A),E(x+A)));break;case h.STYLE_TARGET:var N=p.pt2px(r._targetWidth)/2,O=p.pt2px(r._targetHeight)/2;u=this._drawPath(t,v,this._smsToPath(h,P,_,x,E(_-N),E(_+N),E(x-O),E(x+O),p.pt2px(r._spikeSize)));break;case h.STYLE_PATH:u=this._drawPath(t,v,r.path,!0);var R=u.getBoundingBox(),Y=this._getScaleMatrix(R,b);(1!==Y.xx||1!==Y.yy)&&S.push(i.scaleAt(Y.xx,Y.yy,g)),S.push(i.translate(-(R.x+R.width/2)+_,-(R.y+R.height/2)+x));break;default:A=isNaN(b)?16:b/2,u=this._drawCircle(t,v,{cx:_,cy:x,r:A})}}else if("shield-label-symbol"===d){L=p.pt2px(r.width),V=p.pt2px(r.height);var j=t.createGroup(),F=t.createImage({x:_-L/2,y:x-V/2,width:L,height:V,src:r.url});if(j.add(F),null!=r.font){var I=_,z=x+.2*p.pt2px(r.getHeight()),C=t.createText({type:"text",text:r.text,x:I,y:z,align:"middle",decoration:r.decoration,rotated:r.rotated,kerning:r.kerning}),G=r.font.clone();G.size=p.pt2px(G.size),C.setFont(G),C.setFill(r.color),j.add(C)}u=j}else if("picture-marker-symbol"===d)L=f?b:p.pt2px(r.width),V=f?b:p.pt2px(r.height),u=this._drawImage(t,v,{x:_-L/2,y:x-V/2,width:L,height:V,src:r.url});else if("text-symbol"===d){var G=r.font;if(G&&(G=G.clone(),G.size=null!=b?b:p.pt2px(G.size)),u=this._drawText(t,v,{type:"text",text:r.text,x:_,y:x,align:c.getSVGAlign(r),decoration:r.decoration||G&&G.decoration,rotated:r.rotated,kerning:r.kerning}),G&&u.setFont(G),m){var B=u.getNode(),D=c.getSVGBaseline(r),U=c.getSVGBaselineShift(r);B&&(B.setAttribute("dominant-baseline",D),U&&B.setAttribute("baseline-shift",U))}}return u.setTransform(i.multiply(S)),u._wrapOffsets=n,u},_getScaleMatrix:function(t,e){var r=t.width/t.height,i=1,s=1;return isNaN(e)||(r>1?(i=e/t.width,s=e/r/t.height):(s=e/t.height,i=e*r/t.width)),{xx:i,yy:s}},_drawMarkers:function(t,e,r,i,s){var a,o,n,l=e.points,h=i.shape||t.createGroup(),c=l.length,p=[],u=0,f=s?s.length:0;for(h.children[0]&&this._isInvalidShape(r,h.children[0])&&h.clear(),o=0;c>o;o++)for(a=l[o],n=0;f>n;n++)p[0]=s[n],h.add(this._drawPoint(h,{x:a[0],y:a[1],spatialReference:e.spatialReference},r,i,p,u++));var d=h.children.length;if(c*s.length<d)for(o=d-1;o>=c*s.length;o--)h.children[o].removeShape();return h},_drawShape:function(t,e,r,i){var s,a,o=e.type,n=r.shape,h=this._projector,c=[];if("extent"===o&&(e=l.fromExtent(e),o=e.type),"polyline"===o||"polygon"===o){for(s=0,a=i.length;a>s;s++)c=c.concat(h.toScreenPath(e,i[s]));n=this._drawPath(t,n,c),this._rendererLimits&&("polyline"===o?this._clipPolyline(n,e):this._clipPolygon(n,e))}return n},_drawRect:function(t,e,r){return e?e.setShape(r):t.createRect(r)},_drawImage:function(t,e,r){return e?e.setShape(r):t.createImage(r)},_drawCircle:function(t,e,r){return e?e.setShape(r):t.createCircle(r)},_drawPath:function(t,e,r,i){return r=i?r:r.join(" "),e?e.setShape(r):t.createPath(r)},_drawText:function(t,e,r){return e?e.setShape(r):t.createText(r)},_smsToPath:function(t,e,r,i,s,a,o,n,l){switch(e){case t.STYLE_SQUARE:return["M",s+","+o,a+","+o,a+","+n,s+","+n,"Z"];case t.STYLE_CROSS:return["M",r+","+o,r+","+n,"M",s+","+i,a+","+i];case t.STYLE_X:return["M",s+","+o,a+","+n,"M",s+","+n,a+","+o];case t.STYLE_DIAMOND:return["M",r+","+o,a+","+i,r+","+n,s+","+i,"Z"];case t.STYLE_TARGET:return["M",s+","+o,a+","+o,a+","+n,s+","+n,s+","+o,"M",s-l+","+i,s+","+i,"M",r+","+(o-l),r+","+o,"M",a+l+","+i,a+","+i,"M",r+","+(n+l),r+","+n]}},_stylePoint:function(t,r,i){var s=r.type,a=r.style,o=null!=i?t.shape&&t.shape.children[i]:t.shape;if("shield-label-symbol"!==s&&"picture-marker-symbol"!==s){var n=c.getStroke(r),l=c.getFill(r),p=a===h.STYLE_X||a===h.STYLE_CROSS,u=n&&n.color,f=t.color||(p?u:l),d=t.opacity;f&&null!=d&&(f=this._applyOpacity(f,d)),f&&(p?f!==u&&(n=n?e.mixin({},n):{},n.color=f):f!==l&&(l=f)),"text-symbol"===s?o.setFill(l):"simple-marker-symbol"===s&&o.setFill(l).setStroke(n)}},_styleMarkers:function(t,e){var r,i=t.shape.children,s=i.length;for(r=0;s>r;r++)this._stylePoint(t,e,r)},_styleShape:function(t,r){var i,s,a,o,n=c.getStroke(r),l=c.getFill(r),h=r.type,u=t.shape,f=t.outlineSize,d=-1!==h.indexOf("line-symbol"),y=d?"none"!==r.style:r.outline&&"none"!==r.outline.style;f&&Array.isArray(f)&&(f=isFinite(f[0])&&f[0]),f=null!=f?p.pt2px(f):null,!t.color&&null==t.opacity||"picture-fill-symbol"===h||(i=t.color,s=t.opacity,d?(a=i||n&&n.color,a&&null!=s&&(a=this._applyOpacity(a,s))):l&&l.toCss&&(o=i||l,o&&null!=s&&(o=this._applyOpacity(o,s)))),u.setStroke(!y||null==f&&!a?n:e.mixin({},n,null!=f?{width:f}:null,a&&{color:a})).setFill(o||l),m&&u.rawNode.setAttribute("vector-effect","non-scaling-stroke")},_applyOpacity:function(t,e){return null!=e&&(t=t.clone(),t.a=e),t},_updateTransform:function(){var t=this.transform=this.transform||a.create(),e=this.resolution,r=o.fromValues(.5*this.view.width,.5*this.view.height),i=o.fromValues(1/e,-1/e),s=o.fromValues(-this.x,-this.y);a.identity(t),a.translate(t,t,r),a.scale(t,t,i),a.translate(t,t,s),t[4]=Math.round(t[4]),t[5]=Math.round(t[5]),this._projector.set({resolution:e,transform:t})}});return v});