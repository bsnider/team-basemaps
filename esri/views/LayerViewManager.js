// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../core/Accessor","../core/Collection","../core/Error","../core/HandleRegistry","../core/Scheduler","../core/promiseUtils","../core/watchUtils","./LayerViewFactory"],function(e,i,r,s,t,a,l,n){var o=function(e,i){var r=function(s){return s&&s.forEach(function(s){i.push(s),r(s[e])}),i};return r},h=e.createSubclass({constructor:function(){this._handles=new s,this._layerViewPromises={},this._layerViewBylayerUID={},this._doWork=this._doWork.bind(this),this.refresh=this.refresh.bind(this),this.factory=new n,this._handles.add(l.init(this,"view.ready",function(e){this.ready=e}.bind(this))),this._handles.add(this.watch(["view.map.basemap","view.map.ground","view.map.layers","ready"],this.refresh),"watcher")},destroy:function(){this.view=null,this.empty(),this.factory.destroy(),this.factory=null,this._handles.destroy(),this._handles=null,this._layerViewPromises=null,this._layerViewBylayerUID=null,this._map=null},_map:null,properties:{allLayerViews:{type:i},ready:{value:!1},view:null},layersToLayerViews:{"view.map.basemap.baseLayers":"view.basemapView.baseLayerViews","view.map.ground.layers":"view.groundView.layerViews","view.map.layers":"view.layerViews","view.map.basemap.referenceLayers":"view.basemapView.referenceLayerViews"},empty:function(){Object.keys(this._layerViewBylayerUID).forEach(this._disposeLayerView,this),Object.keys(this._layerViewPromises).forEach(function(e){this._layerViewPromises[e].cancel()},this),this._layerViewBylayerUID={},this._layerViewPromises={},this._refreshCollections()},refresh:function(){var e=this._handles;e.remove("refresh"),e.add(t.schedule(this._doWork),"refresh")},getAllLayerCollections:function(){return Object.keys(this.layersToLayerViews).map(this.get,this).filter(function(e){return null!=e})},getAllLayers:function(){var e=[];return this.getAllLayerCollections().forEach(o("layers",e)),e},getAllLayerViewsCollections:function(){return Object.keys(this.layersToLayerViews).map(function(e){return this.layersToLayerViews[e]},this).map(this.get,this).filter(function(e){return null!=e})},getAllLayerViews:function(){var e=[];return this.getAllLayerViewsCollections().forEach(o("layerViews",e)),e},whenLayerView:function(e){return this.refresh(),this._doWork(),this._layerViewPromises[e.uid]?this._layerViewPromises[e.uid]:a.reject(new r("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e}))},_doWork:function(){var e=this._handles,i=this.get("view.map");if(this._map!==i&&(this.empty(),this._map=i),e.has("refresh")){e.remove("refresh"),e.remove("collection-change"),this.factory.paused=!this.ready;var r=this.getAllLayers(),s=r.map(function(e){return e.uid});r.forEach(this._createLayerView,this),this._refreshCollections(),Object.keys(this._layerViewPromises).filter(function(e){return-1===s.indexOf(e)}).forEach(this._disposeLayerView,this),e.add(this.getAllLayerCollections().map(function(e){return e.on("change",this.refresh)},this),"collection-change")}},_refreshCollections:function(){Object.keys(this.layersToLayerViews).forEach(function(e){this._populateLayerViewsOwners(this.get(e),this.get(this.layersToLayerViews[e]),this.view)},this);var e=this.getAllLayers();this.allLayerViews.removeAll(),this.allLayerViews.addMany(e.map(function(e){return this._layerViewBylayerUID[e.uid]},this).filter(function(e){return null!=e}))},_populateLayerViewsOwners:function(e,i,r){e&&i&&(i.removeAll(),e.forEach(function(e){var s=this._layerViewBylayerUID[e.uid];s&&(s.layer=e,s.parent=r,i.push(s),e.layers&&this._populateLayerViewsOwners(e.layers,s.layerViews,s))},this))},_createLayerView:function(e){var i=this.view,s=this.factory,t=this._layerViewBylayerUID,l=this._layerViewPromises;return t[e.uid]?void e.load():void(l[e.uid]||(l[e.uid]=s.create(i,e).then(function(s){var l=this.getAllLayers().some(function(i){return e===i});if(!l)throw new r("view:no-layerview-for-layer","The layer has been removed from the map",{layer:e});return t[e.uid]=s,this._refreshCollections(),e.emit("layerview-create",{view:i,layerView:s}),i.emit("layerview-create",{layer:e,layerView:s}),a.resolve(s)}.bind(this)),l[e.uid].always(this.refresh)))},_disposeLayerView:function(e){if(this._layerViewPromises[e]){this._layerViewPromises[e].cancel(),delete this._layerViewPromises[e];var i=this._layerViewBylayerUID[e];if(i){var r=i.layer,s=i.view,t=this.factory;t.dispose(i),i.layer=i.parent=i.view=null,delete this._layerViewBylayerUID[e],r.emit("layerview-destroy",{view:s,layerView:i}),s.emit("layerview-destroy",{layer:r,layerView:i})}}}});return h});