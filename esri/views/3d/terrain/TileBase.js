// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["./terrainUtils","./TileUtils","./TerrainConst","./TileGeometryFactory","./UpsampleInfo","./ElevationData","../support/mathUtils","../lib/glMatrix","../../../core/arrayUtils"],function(e,t,i,n,a,r,s,l,o){function h(e){this.waitingAgents=[],this.init(e)}var p=l.vec3d,d=l.vec2d,u=l.vec4d,g=l.mat4d,f=e.weakAssert,c=p.create(),v=u.create(),y=u.create(),A=.15,m=p.create(),T={},E=i.LayerClass.LAYER_CLASS_COUNT,L=i.LayerClass.MAP,I=i.LayerClass.ELEVATION,U=i.TileUpdateTypes,D=function(){this.lij=[0,0,0],this.extent=u.create(),this.extentWGS84Rad=u.create(),this.centerAtSeaLevel=p.create(),this.center=p.create(),this.tileUp=m,this.elevationBounds=d.create(),this.children=[null,null,null,null],this.layerInfo=new Array(E),this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this._maxTesselation=0};D.prototype.init=function(e,t,n,a){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],u.set4(0,0,0,0,this.extent),u.set4(0,0,0,0,this.extentWGS84Rad),this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this.edgeLen=0,this.radius=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?d.set(t.elevationBounds,this.elevationBounds):d.set2(0,0,this.elevationBounds),this.parent=t;for(var r=0;4>r;r++)this.children[r]=null;this.pendingUpdates=0,this.renderData=null,this.screenDepth=0,this.renderOrder=0,this.visible=!1,this.parentSurface=n;for(var s=0;E>s;s++)if(n){var l,o=n.numLayers(s);this.layerInfo[s]?(l=this.layerInfo[s],l.length=o):(l=new Array(o),this.layerInfo[s]=l);for(var h=0;o>h;h++)l[h]=S(s,l[h]),t&&s==I&&(l[h].elevationBounds=t.layerInfo[s][h].elevationBounds)}else this.layerInfo[s]=null;this._maxTesselation=Math.min(a.pixelSize[0],i.MAX_TILE_TESSELATION)},D.prototype.dispose=function(){for(var e=0;E>e;e++)for(var t=this.layerInfo[e],i=0;i<t.length;i++){var n=t[i];n.upsampleFromTile&&(a.Pool.release(n.upsampleFromTile),n.upsampleFromTile=null)}},D.prototype.updateScreenDepth=function(e){p.set(this.center,y),y[3]=1,g.multiplyVec4(e,y,y),this.screenDepth=y[2]/y[3]},D.prototype.shouldSplit=function(e,t){var i=this.lij[0];if(1>i)return U.SPLIT;p.subtract(this.center,t,c);var n=p.length(c),a=this.edgeLen/(e[0]*n*2);if(a<e[1])return this.vlevel!==this.lij[0]?(this.vlevel=this.lij[0],U.VSPLITMERGE):U.NONE;if(i>=e[4]){var r=i+Math.ceil(-s.log2(e[1]/a));return r!==this.vlevel?(this.vlevel=r,U.VSPLITMERGE):U.NONE}if(i>10&&(p.scale(this.tileUp,p.dot(this.tileUp,c),v),p.subtract(v,c),p.length2(v)>this.radius*this.radius)){p.scale(v,this.radius/p.length(v)),p.add(v,this.centerAtSeaLevel),p.subtract(t,v,v);var l=Math.abs(p.dot(v,this.tileUp)/p.length(v));if(l*a<A*e[1])return U.NONE}return U.SPLIT},D.prototype.createElevationDataFromLERC=function(e){var t;try{t=r.createFromLERC(this.lij,this.extent,e,{noDataValue:i.ELEVATION_NODATA_VALUE})}catch(n){console.warn("Error decoding %s: %s",e.url,n.message)}return t},D.prototype.getWGS84Extent=function(){return this.extentWGS84Rad.map(s.rad2deg)},D.prototype.load=function(e){for(var t=0;E>t;t++)this.layerInfo[t]&&this._createOrUpdateAgents(0,t);e.loadTile(this)},D.prototype.unload=function(e){this.renderData&&e.unloadTile(this);for(var t=0;E>t;t++)for(var n=this.layerInfo[t],a=0;a<n.length;a++){var r=n[a];if(r.loadingAgent&&r.loadingAgent!==T){r.loadingAgent.dispose();var s=this.parentSurface.agentTypeByLayerIndex(a,t);s.Pool.release(r.loadingAgent),r.loadingAgent=null}r.pendingUpdates=0}this.pendingUpdates&=~i.TileUpdateTypes.UPDATE_GEOMETRY,this.pendingUpdates&=~i.TileUpdateTypes.UPDATE_TEXTURE},D.prototype.updateClippingStatus=function(e){o.equals(e,this.clippingArea)||(e?(this.intersectsClippingArea=this._intersectsExtent(e),this.isWithinClippingArea=this._isWithinExtent(e)):(this.intersectsClippingArea=!0,this.isWithinClippingArea=!0),this.clippingArea=e,this.renderData&&this.updateGeometry())},D.prototype.updateVisibility=function(e,t,i){var n=i||this.isVisible(e,t)&&this.intersectsClippingArea;if(n!==this.visible){this.visible=n;for(var a=0,r=this.layerInfo[a],s=0;s<r.length;s++){var l=r[s];l.loadingAgent&&l.loadingAgent!==T&&l.loadingAgent.setSuspension(!n)}}return n},D.prototype.getLayerInfo=function(e,t){return this.layerInfo[t][e]},D.prototype.hasLayerData=function(e,t){var i=this.layerInfo[t][e];return i&&i.data},D.prototype.tileDataAvailable=function(e,t,i){var n=this.layerInfo[i][t].tilemapData;return n?null!=n.dataValue?n.dataValue:n.isTileAvailable(e.lij[1],e.lij[2]):!0},D.prototype.requestLayerData=function(e,t,n){i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",this.lij.toString(),t,e,n.tile.lij.toString());var a=this.layerInfo[t][e];if(a.waitingAgents.indexOf(n)>-1)return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),n.tile.lij.toString(),t,e),!0;if(a.data)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),n.tile.lij.toString(),t,e),a.waitingAgents.push(n),setTimeout(n.dataArrived.bind(n,this),0),!0;if(a.pendingUpdates&U.DECODE_LERC)return a.waitingAgents.push(n),!0;if(a.waitingAgents.push(n),!a.requestPromise){var r=this.parentSurface.requestTileData(this,e,t),s=function(){a.requestPromise===r&&(a.requestPromise=null)};a.requestPromise=r,r.then(s,s)}return a.requestPromise?!0:!1},D.prototype.descendants=function(e){e||(e=[]);for(var t=0;4>t;t++){var i=this.children[t];i&&(i.descendants(e),e.unshift(this.children[t]))}return e},D.prototype.isLij=function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]==e[2]},D.prototype.findByLij=function(e){if(this.isLij(e))return this;for(var t=0;4>t;t++){var i=this.children[t];if(i){var n=i.findByLij(e);if(n)return n}}return null},D.prototype.unrequestLayerData=function(e,t,n){i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",this.lij.toString(),t,e,n.tile.lij.toString());var a=this.layerInfo[t][e],r=a.waitingAgents,s=r.indexOf(n);f(s>-1,"agent has not requested this piece of map data"),r[s]=r[r.length-1],r.length--,r.length<1&&(f(a.requestPromise||a.rawData,"no pending operations on layerInfo that agents were waiting for"),a.requestPromise&&(this.parentSurface.cancelRequest(a.requestPromise),a.requestPromise=null),i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),t,e))},D.prototype.dataArrived=function(e,t,i){var n=this.layerInfo[t][e];n.data=i;for(var a=0;a<n.waitingAgents.length;a++)n.waitingAgents[a].dataArrived(this);n.waitingAgents.length=0},D.prototype.dataMissing=function(e,t,i){i.notInTilemap||console.error("Tile %s layer %d/%d error",this.lij.toString(),t,e);for(var n=this.layerInfo[t][e],a=0;a<n.waitingAgents.length;a++)n.waitingAgents[a].dataMissing(this);n.waitingAgents.length=0},D.prototype.updateTexture=function(e){this.renderData&&(e?this.parentSurface._renderer.updateTileTexture(this):(this.pendingUpdates=this.pendingUpdates|i.TileUpdateTypes.UPDATE_TEXTURE,this.parentSurface._pendingUpdates=!0))},D.prototype.updateElevationBounds=function(){d.set2(Number.MAX_VALUE,-Number.MAX_VALUE,this.elevationBounds);for(var e=this.layerInfo[I],i=!1,n=0;n<e.length;n++){var a=e[n];if(a.elevationBounds){var r=this.parentSurface.layerViewByIndex(n,I);t.fallsWithinLayer(this,r,!1)&&(this.elevationBounds[0]=Math.min(this.elevationBounds[0],a.elevationBounds[0]),this.elevationBounds[1]=Math.max(this.elevationBounds[1],a.elevationBounds[1]),i=!0)}}i||d.set2(0,0,this.elevationBounds),this.updateRadiusAndCenter()},D.prototype.updateRadiusAndCenter=function(){var e=.5*(this.elevationBounds[0]+this.elevationBounds[1]);p.scale(this.tileUp,e,v),p.add(this.centerAtSeaLevel,v,this.center)},D.prototype.setLayerElevationBounds=function(e,t){var i=this.layerInfo[I][e];(!i.elevationBounds||i.elevationBounds[2]<t[2])&&(i.elevationBounds=t,this.updateElevationBounds())},D.prototype.updateGeometry=function(){this.pendingUpdates=this.pendingUpdates|i.TileUpdateTypes.UPDATE_GEOMETRY,this.parentSurface._pendingUpdates=!0},D.prototype.modifyLayers=function(e,t,i){for(var n=t.length,a=this.layerInfo[i],r=new Array(n),s=0;s<a.length;s++){var l=a[s];if(l.loadingAgent&&l.loadingAgent!==T){l.loadingAgent.dispose();var o=this.parentSurface.agentTypeByLayerIndex(s,i);o.Pool.release(l.loadingAgent),l.loadingAgent=null}l.waitingAgents.length=0}if(i===L)for(var h=0;h<a.length;h++)if(void 0===e[h]){var p=a[h];p.data instanceof WebGLTexture&&this.parentSurface._renderer.releaseTileTexture(p.data)}for(s=0;n>s;s++){var d=t[s];r[s]=d>-1?a[d]:S(i)}this.layerInfo[i]=r},D.prototype.restartAgents=function(e){if(this.renderData)if(this._createOrUpdateAgents(0,e),e===I){this.updateGeometry();for(var t=this.layerInfo[e],n=0;n<t.length;n++)t[n].pendingUpdates|=i.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface._pendingUpdates=!0}else this.updateTexture(!0)},D.prototype.updateAgents=function(e){if(this.renderData){for(var t=this.layerInfo[e],i=0;i<t.length;i++){var n=t[i];n.loadingAgent===T&&(n.loadingAgent=null)}this._createOrUpdateAgents(0,e)}},D.prototype.agentDone=function(e,t){var i=this.layerInfo[t],n=i[e];n.loadingAgent=T,n.data||n.upsampleFromTile||e<i.length-1&&this._createOrUpdateAgents(e+1,t)},D.prototype._createOrUpdateAgents=function(e,n){var a;a=n===I?!1:!this.visible;var r=e,s=this.layerInfo[n];for(n===i.LayerClass.ELEVATION;r<s.length;){var l=s[r],o=!1,h=this.parentSurface.layerViewByIndex(r,n);if(null!==l.loadingAgent&&l.loadingAgent!==T)o=l.loadingAgent.update();else if(l.loadingAgent!==T&&t.fallsWithinLayer(this,h,!1)){var p=this.parentSurface.agentTypeByLayerIndex(r,n),d=p.Pool.acquire();o=d.init(this,r,n,a),o?l.loadingAgent=d:(p.Pool.release(d),l.loadingAgent=T)}if(o&&!h.isTransparent())break;r++}},D.prototype.geometryState=function(e){var t,a,r,l=this._getElevationInfo(e?e.samplerData:null),h=this.lij[0],p=!1;if(l.samplerData){t=this.vlevel-h,a=Math.max(h-l.maxTileLevel,i.ELEVATION_DESIRED_RESOLUTION_LEVEL-t);var d=this._maxTesselation;r=s.clamp((d>>a)+1,2,d+1)}else r=8>h?this._numSubdivisionsAtLevel[h]+1:2;r=n.supportedNumVertsPerRow(r);var u=this.clippingArea;return(!this.intersectsClippingArea||this.isWithinClippingArea)&&(u=null),e?(e.numVertsPerRow!==r&&(e.numVertsPerRow=r,p=!0),l.changed&&(e.samplerData=l.samplerData,p=!0),o.equals(e.clippingArea,u)||(e.clippingArea=u,p=!0),e.needsUpdate=p):e={numVertsPerRow:r,samplerData:l.samplerData,needsUpdate:!0,clippingArea:u},e},D.prototype._getElevationInfo=function(e){for(var i=this.layerInfo[I],n=i.length,a=new Array(n),r=0,s=0,l=!1,o=0;n>o;o++){var h=i[o];if(h.upsampleFromTile){var p=h.upsampleFromTile.tile,d=p.layerInfo[I][o].data;e&&e[r]===d.samplerData||(l=!0),a[r++]=d.samplerData,s=Math.max(s,p.lij[0])}else if(h.data){var u=this.parentSurface.layerViewByIndex(o,I);t.fallsWithinLayer(this,u,!1)&&(e&&e[r]===h.data.samplerData||(l=!0),a[r++]=h.data.samplerData,s=this.lij[0])}}return e&&e.length!==r&&(l=!0),r>0?a.length=r:a=null,{changed:l,samplerData:a,maxTileLevel:s}},D.prototype._isWithinExtent=function(e){var t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]},D.prototype._intersectsExtent=function(e){var t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]},h.prototype.init=function(e){this.waitingAgents.length=0,this.data=null,this.tilemapData=null,this.tilemapRequest=null,this.upsampleFromTile=null,this.loadingAgent=null,this.requestPromise=null,this.rawData=null,this.pendingUpdates=0,e===I&&(this.elevationBounds=null)};var S=function(e,t){return t?(t.init(e),t):new h(e)};return D});