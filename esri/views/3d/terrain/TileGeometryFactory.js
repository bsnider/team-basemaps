// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../webgl-engine/lib/Geometry","../webgl-engine/lib/GeometryData","../lib/glMatrix","../support/earthUtils","../support/mathUtils","./TerrainConst"],function(t,e,r,n,a,i){function u(t,e,r,n,a){t<n[0]&&(n[0]=t),t>a[0]&&(a[0]=t),e<n[1]&&(n[1]=e),e>a[1]&&(a[1]=e),r<n[2]&&(n[2]=r),r>a[2]&&(a[2]=r)}function s(t,e,r){for(var n=0;n<r.length;n++){var u=r[n];if(u){var s=u.safeWidth,o=u.width,c=u.pixelData,v=a.clamp(u.dy*(u.y1-e),0,s),l=a.clamp(u.dx*(t-u.x0),0,s),f=Math.floor(v),g=Math.floor(l),d=f*o+g,h=d+o,A=c[d],m=c[h],y=c[d+1],p=c[h+1];if(A+m+y+p<.5*i.ELEVATION_NODATA_VALUE){v-=f,l-=g;var I=A+(y-A)*l,M=m+(p-m)*l;return I+(M-I)*v}}}return null}function o(t){g=t}function c(t){if(!g){var e=t*t+4*(t-1);e>T&&(t=1<<Math.floor(a.log2(.5*(-4+Math.sqrt(16+4*(4+T))))))}return t}var v=n.earthRadius,l=r.vec3d,f=a.lerp,g=!1,d=function(){var t,e,r,n=l.create(),a=l.create(),i=l.create();this.init=function(u,s){e=u,r=s,l.subtract(i,a,n),t=.5*l.length(n),l.lerp(a,i,.5,n)},this.getCenter=function(){return n},this.getBSRadius=function(){return t},this.getBBMin=function(){return a},this.getBBMax=function(){return i},this.getPosition=function(){return e},this.getIndices=function(){return r},this.getPrimitiveIndices=function(){return void 0},this.getChildren=function(){return void 0}},h=function(t,e,r,n){for(var a=t*v,i=0;e>=i;i++)r[5*n]=0,r[5*n+1]=0,r[5*n+2]=a,n++},A=50,m=50,y=function(){var r=new Array(A),n=0,a={};this.get=function(u){var s=a[u];s||(s={ptr:0,data:new Array(m)},a[u]=s);var o;if(s.ptr>0?(i.vertexArrayHits++,o=s.data[--s.ptr],s.data[s.ptr]=null):(i.vertexArrayMisses++,o=new Float32Array(u)),n>0){i.geometryHits++;var c=r[--n];return r[n]=null,c.getData().getVertexAttr().terrain.data=o,c}i.geometryMisses++;var v={terrain:null},l={};l.terrain={size:5,data:o};var f=[{type:"triangle",indices:v,positionKey:"terrain"}],g=new d;return new t(new e(f,l),"tile",[g])},this.put=function(t){var e=t.getData(),i=e.getVertexAttr(),u=i.terrain.data,s=a[u.length];s.ptr<m&&(s.data[s.ptr++]=u),i.terrain.data=null,e.getFaces()[0].indices.terrain=null,A>n&&(r[n++]=t)};var i={geometryHits:0,geometryMisses:0,vertexArrayHits:0,vertexArrayMisses:0};this.stats=i,this._pools={geometry:r,vertexArray:a}},p=new y,I=[],M=new Array(i.MAX_TILE_TESSELATION+1),S=new Array(i.MAX_TILE_TESSELATION+1),w=new Array(i.MAX_TILE_TESSELATION+1),x=new Array(i.MAX_TILE_TESSELATION+1),T=65536,B=function(t,e,r,n,a,i,o,g,d){var A=v,m=r[0],y=r[1],I=r[2],T=r[3],B=Math.max(.9,1-.5*(I-m));t=c(t);var E=t-1,_=t-1,L=t*t,V=2*E+2*_,D=p.get(5*(L+V)),N=D.getData().getVertexAttr().terrain.data,O=e[2]-e[0],P=e[3]-e[1],U=I-m,k=i[0],G=i[1],H=i[2],R=D.getBoundingInfo(0),X=R.getBBMin(),C=R.getBBMax();l.set3(1e7,1e7,1e7,X),l.set3(-1e7,-1e7,-1e7,C);var F,W;for(F=0;E>=F;F++){var j=F/E,q=m+j*U;M[F]=Math.sin(q),S[F]=Math.cos(q),w[F]=j,x[F]=e[0]+j*O}var z=0;for(W=0;_>=W;W++){var K,J=W/_,Q=f(y,T,J),Y=Math.cos(Q),Z=Math.sin(Q);for(n?(K=v/2*Math.log((1+Z)/(1-Z)),J=(K-e[1])/P):K=180*Q/Math.PI,F=0;E>=F;F++){j=w[F];var $=M[F],te=S[F],ee=A;a&&(ee+=s(x[F],K,a)||0);var re=te*Y*ee,ne=$*Y*ee,ae=Z*ee,ie=re-k,ue=ne-G,se=ae-H;u(ie,ue,se,X,C);var oe=5*z;N[oe+0]=ie,N[oe+1]=ue,N[oe+2]=se,N[oe+3]=j,N[oe+4]=J;var ce=-1;if(0===W&&(ce=L+F),F===E&&(ce=L+E+W),W===_&&(ce=L+E+_+(E-F)),0===F&&W>0&&(ce=L+2*E+_+(_-W)),ce>-1){var ve=re*B-k,le=ne*B-G,fe=ae*B-H;u(ve,le,fe,X,C),oe=5*ce,N[oe+0]=ve,N[oe+1]=le,N[oe+2]=fe,N[oe+3]=j,N[oe+4]=J}++z}}if(n){var ge=!!(1&o),de=!!(2&o);ge&&h(-1,E,N,L),de&&h(1,E,N,L+E+_)}return b(D,t,n?o:0,g,d)},E=function(t,e,r,n,a,i,o){var v=e[0],f=e[1],g=e[2]-v,d=e[3]-f,h=.1*g;t=c(t);var A,m,y=t-1,I=t-1,M=t*t,S=2*y+2*I,w=p.get(5*(M+S)),x=w.getData().getVertexAttr().terrain.data,T=0,B=w.getBoundingInfo(0),E=B.getBBMin(),_=B.getBBMax();for(l.set3(1e7,1e7,1e7,E),l.set3(-1e7,-1e7,-1e7,_),m=0;I>=m;m++){var L=m/I,V=f+L*d;for(i&&(V<i[1]?(V=i[1],L=(V-f)/d):V>i[3]&&(V=i[3],L=(V-f)/d)),A=0;y>=A;A++){var D=A/y,N=v+D*g;i&&(N<i[0]?(N=i[0],D=(N-v)/g):N>i[2]&&(N=i[2],D=(N-v)/g));var O=r?s(N,V,r)||0:0,P=N-n[0],U=V-n[1],k=O-n[2];u(P,U,k,E,_),x[5*T]=P,x[5*T+1]=U,x[5*T+2]=k,x[5*T+3]=D,x[5*T+4]=L;var G=-1;0===m&&(G=M+A),A===y&&(G=M+y+m),m===I&&(G=M+y+I+(y-A)),0===A&&m>0&&(G=M+2*y+I+(I-m)),G>-1&&(x[5*G]=P,x[5*G+1]=U,x[5*G+2]=k-h,x[5*G+3]=D,x[5*G+4]=L,u(P,U-h,k,E,_)),++T}}return b(w,t,0,a,o)},_={values:null,numSurfaceIndices:0,numSkirtIndices:0},L=function(t,e,r){return r||(t.values=e.values),t.numSurfaceIndices=e.numSurfaceIndices,t.numSkirtIndices=e.numSkirtIndices,t},b=function(t,e,r,n,a){var i=V(e,r,n,_),u=t.getData(),s=u.getVertexAttr();return u.getFaces()[0].indices.terrain=i.values,t.getBoundingInfo(0).init(s.terrain,i.values),a||(a={}),a.geometry=t,a.numWithoutSkirtIndices=i.numSurfaceIndices+(r?6*(e-1)*(n?2:1):0),a.numVertsPerRow=e,L(a,i,!0)},V=function(t,e,r,n){var a=2&e,i=t+(r?1024:0)+(a?2048:0),u=I[i];if(n||(n={}),u)return L(n,u),n;var s,o=t-1,c=t-1,v=t*t,l=2*o+2*c,f=o*c*2*3,d=6*l,h=6*(2*o+c-1);r&&(f*=2,d*=2,h*=2),s=g&&v+l>T?new Uint32Array(f+d):new Uint16Array(f+d);for(var A,m,y,p,M=0,S=0,w=f,x=0,B=0;c>=B;B++){a&&(x=0===B?h:B===c?-h:0),w+=x;for(var E=0;o>=E;E++){var _=-1,b=-1;if(0===B&&(_=v+E,E!==o&&(b=M+1)),E===o&&(_=v+o+B,c>B&&(b=M+o+1)),B===c&&(_=v+o+c+(o-E),E>0&&(b=M-1)),0===E&&B>0&&(_=v+2*o+c+(c-B),b=M-(o+1)),_>-1){var V=0===E&&1===B?v:_+1;b>-1&&(A=M,m=_,y=V,p=b,r?(s[w+0]=A,s[w+1]=m,s[w+2]=m,s[w+3]=y,s[w+4]=y,s[w+5]=A,s[w+6]=y,s[w+7]=p,s[w+8]=p,s[w+9]=A,s[w+10]=A,s[w+11]=y,w+=12):(s[w+0]=A,s[w+1]=m,s[w+2]=y,s[w+3]=y,s[w+4]=p,s[w+5]=A,w+=6))}++M,o>E&&c>B&&(A=B*(o+1)+E,m=A+1,y=m+(o+1),p=y-1,r?(s[S+0]=A,s[S+1]=m,s[S+2]=m,s[S+3]=y,s[S+4]=y,s[S+5]=A,s[S+6]=y,s[S+7]=p,s[S+8]=p,s[S+9]=A,s[S+10]=A,s[S+11]=y,S+=12):(s[S+0]=A,s[S+1]=m,s[S+2]=y,s[S+3]=y,s[S+4]=p,s[S+5]=A,S+=6))}w-=x}return n.values=s,n.numSurfaceIndices=f,n.numSkirtIndices=d,I[i]=L({},n),n};return{createPlanarGlobeTile:E,createSphericalGlobeTile:B,releaseGeometry:p.put,elevationSampler:s,_geometryObjectPool:p,supportedNumVertsPerRow:c,setSupportsUintIndices:o}});