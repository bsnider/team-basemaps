// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../support/ExternalRenderer","./MixedPanoramicAtmosphere","./PanoramicAtmosphere","./RealisticAtmosphere","./SimpleAtmosphere","./Stars","../webgl-engine/lib/RenderSlot"],function(e,t,s,i,r,n,h){var a=e.createSubclass({declaredClass:"esri.views.3d.environment.EnvironmentRenderer",classMetadata:{properties:{view:{},viewingMode:{dependsOn:["view.viewingMode"],getter:function(){return this.get("view.viewingMode")||"global"}},atmosphereQuality:{dependsOn:["view.environment.atmosphereEnabled","view.environment.atmosphere.quality"],getter:function(){return this.get("view.environment.atmosphereEnabled")?this.get("view.environment.atmosphere.quality")||"none":"none"}},starsEnabled:{dependsOn:["view.environment.starsEnabled"],getter:function(){return this.get("view.environment.starsEnabled")||!1}},transparent:{dependsOn:["view.basemapTerrain.opacity","view.basemapTerrain.wireframe"],getter:function(){var e=this.get("view.basemapTerrain");return e&&e._renderer.isTransparent()}},needsDepthMap:{dependsOn:["_stars.needsDepthMap","_atmosphere.needsDepthMap"],getter:function(){return this._atmosphere&&this._atmosphere.needsDepthMap||this._stars&&this._stars.needsDepthMap}},needsRender:{dependsOn:["_stars.needsRender","_atmosphere.needsRender"],getter:function(){return!!(this._needsRender||this._atmosphere&&this._atmosphere.needsRender||this._stars&&this._stars.needsRender)}}}},constructor:function(){this._STANDARD_SLOT=h.BACKGROUND,this._SPECIAL_SLOT=h.POSTPROCESSING_ATMOSPHERE,this._slots=[this._STANDARD_SLOT,this._SPECIAL_SLOT],this._AtmosphereClass=null,this._atmosphereReadyPromise=null,this._atmosphere=null,this._stars=null,this._needsRender=!0,this.notifyChange("needsRender")},initialize:function(){this.view._stage.addExternalRenderer(this._slots,this)},destroy:function(){this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=null),this._stars&&(this._stars.destroy(),this._stars=null),this.view&&(this.view._stage.removeExternalRenderer(this),this.view=null)},setup:function(){this.watch("viewingMode,atmosphereQuality,transparent,visible",this._updateAtmosphere.bind(this)),this._updateAtmosphere(),this.watch("starsEnabled,transparent,visible",this._updateStars.bind(this)),this._updateStars(),this.watch("view.basemapTerrain.loaded",function(){this._needsRender=!0,this.notifyChange("needsRender")}.bind(this))},resetNeedsRender:function(){this._atmosphere&&(this._atmosphere.resetNeedsRender?this._atmosphere.resetNeedsRender():this._atmosphere.didRender&&(this._atmosphere.needsRender=!1,this._atmosphere.didRender=!1)),this._stars&&(this._stars.resetNeedsRender?this._stars.resetNeedsRender():this._stars.didRender&&(this._stars.needsRender=!1,this._stars.didRender=!1)),this.didRender&&(this._needsRender=!1,this.didRender=!1,this.notifyChange("needsRender"))},render:function(e){return this.get("view.basemapTerrain.loaded")||"global"!==this.viewingMode?this._stars||this._atmosphere?(this._stars&&this._stars.render(e),this._atmosphere&&this._atmosphere.render(e),this._stars&&this._stars.didRender||this._atmosphere&&this._atmosphere.didRender):!0:!1},_updateStars:function(){var e=this._getAtmosphereSlot();this.starsEnabled&&!this._stars?(this._stars=new n({view:this.view,slot:e}),this._stars.initializeRenderContext(this.renderContext)):!this.starsEnabled&&this._stars?(this._stars.destroy(),this._stars=null):this._stars&&(this._stars.slot=e),this._needsRender=!0,this.notifyChange("needsRender")},_updateAtmosphere:function(){var e=this._getAtmosphereSlot();if(this._atmosphere&&(this._atmosphere.slot=e),this._updateAtmosphereClass()){this._needsRender=!0,this.notifyChange("needsRender");var t=function(){this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=null)}.bind(this);if(!this._AtmosphereClass)return void t();this._atmosphereReadyPromise&&(this._atmosphereReadyPromise.cancel(),this._atmosphereReadyPromise=null);var s=new this._AtmosphereClass({view:this.view,slot:e});s.initializeRenderContext(this.renderContext),this._atmosphere?this._atmosphereReadyPromise=s.then(function(){t(),this._atmosphereReadyPromise=null,this._atmosphere=s}.bind(this)):this._atmosphere=s}},_updateAtmosphereClass:function(){var e=this._AtmosphereClass;return this._AtmosphereClass="none"===this.atmosphereQuality?null:"high"!==this.atmosphereQuality||this.transparent?"local"===this.viewingMode?s:r:"local"===this.viewingMode?t:i,this._AtmosphereClass!==e},_getAtmosphereSlot:function(){return this.transparent&&"global"===this.viewingMode?this._SPECIAL_SLOT:this._STANDARD_SLOT}});return a});