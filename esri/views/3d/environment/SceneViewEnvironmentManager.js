// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../../core/declare","../../../core/Accessoire","../../../core/Evented","../../../core/watchUtils","../../../core/HandleRegistry","../../../geometry/Point","../../../geometry/support/webMercatorUtils","../../../geometry/SpatialReference","../support/sunUtils","../support/earthUtils","./EnvironmentRenderer"],function(e,i,t,n,s,r,o,a,c,h,d){var l=new Date,u={hours:0,minutes:0,seconds:0},f=[.5773502691896258,-.5773502691896258,.5773502691896258],_=e([i,t],{declaredClass:"esri.views.3d.environment.SceneViewEnvironmentManager",referencePointUpdateInterval:3e3,referencePointUpdateDistThreshold:1e6,classMetadata:{properties:{updating:{dependsOn:["noReferencePositionQueries"],readOnly:!0,getter:function(){return!(this.noReferencePositionQueries||!this._referencePosUpdateQuery&&null==this._referencePosUpdateTimer)}},noReferencePositionQueries:{},view:{}}},constructor:function(){this._viewHandles=new s,this._environmentRenderer=null,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._viewConnected=!1,this._referencePosResetPreserveAbsoluteTime=null,this._resetReferencePosition()},destroy:function(){this._viewHandles.destroy(),this.disposeRendering()},disposeRendering:function(){this._environmentRenderer&&(this._environmentRenderer.destroy(),this._environmentRenderer=null),this._resetReferencePosition()},updateReadyChange:function(e){e&&!this._viewConnected?(this._viewConnected=!0,this.connectView(this.view)):!e&&this._viewConnected&&(this._viewConnected=!1,this.disconnectView(this.view))},connectView:function(e){this._environmentRenderer=new d({view:e}),this._viewHandles.add([n.on(this.view,"environment.lighting","date-will-change",this._lightingDateHandler.bind(this)),this.view.watch("interacting,stationary",this._interactingStationaryHandler.bind(this)),this.view.watch("environment.lighting.directShadowsEnabled,environment.lighting.ambientOcclusionEnabled",this._updateRenderParamsHandler.bind(this)),this.view.watch("spatialReference",this._spatialReferenceHandler.bind(this)),n.init(this.view,"viewingMode",this._viewingModeHandler.bind(this)),n.init(this.view,"environment.lighting.cameraTrackingEnabled",this._updateCameraTracking.bind(this)),this.watch("noReferencePositionQueries",this._cameraHandler.bind(this,null))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler()},_updateCameraTracking:function(e){if(this._trackingEnabled=e,e){var i=n.on(this,"view.navigation","currentViewChanged",this._cameraHandler.bind(this,null),this._cameraHandler.bind(this,null));this._viewHandles.add(i,"camera")}else{var t=this.get("view.environment.lighting");t&&(t.positionTimezoneInfo.autoUpdated=!1),this._viewHandles.remove("camera")}},disconnectView:function(){this.disposeRendering(),this._viewHandles.removeAll()},_lightingDateHandler:function(e){var i=e.date;if(i){var t=this.view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){if(this._preserveAbsoluteDateTime=!0,"local"===this.view.viewingMode){var n=this.view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(n))return void this._requestReferencePositionUpdate(n)}if(this._preupdateTracking(i),this._referencePosWGS84){var s=h.positionToTimezone(this._referencePosWGS84,u);t.autoUpdate(null,s)}}this._updateLightParams(i)}},_preupdateTracking:function(e){!this._trackingEnabled&&this.get("view.environment.lighting.cameraTrackingEnabled")&&this._cameraHandler(e)},_cameraHandler:function(e){var i=this.view.camera;i&&("global"===this.view.viewingMode?this._cameraHandlerGlobal(i,e):this._cameraHandlerLocal(i,e))},_cameraHandlerGlobal:function(e,i){var t=e.position;this._referencePosWGS84||(this._referencePosWGS84=new r({spatialReference:a.WGS84})),t.spatialReference.isWebMercator?o.webMercatorToGeographic(t,!1,this._referencePosWGS84):(this._referencePosWGS84.x=t.x,this._referencePosWGS84.y=t.y),this._referencePosWGS84.z=t.z,this._autoUpdateTimezone(t,i)||this._updateLightParams(i)},_cameraHandlerLocal:function(e){var i=e.position;(!this._referencePosMapCoords||this._exceedsReferencePosDistThreshold(i))&&this._requestReferencePositionUpdate(i,!0)},_interactingStationaryHandler:function(){!this.view.interacting&&this.view.stationary&&this._executePendingReferencePositionUpdate()},_updateLightParams:function(e){var i=this.view.environment.lighting;e=e||i.date;var t,n=this.view._stage;this._referencePosWGS84?(t=c.computeColorAndIntensity(e,this._referencePosWGS84),c.computeDirection(e,this._referencePosWGS84,this.view.viewingMode,t.diffuse.direction)):t={diffuse:{color:[1,1,1],intensity:.5,direction:f},ambient:{color:[1,1,1],intensity:.5}},n.setDirectionalLight(t.diffuse),n.setAmbientLight(t.ambient)},_autoUpdateTimezone:function(e,i){if(!this.view.get("environment.lighting.cameraTrackingEnabled"))return!1;var t=l;t.setTime((i||this.view.environment.lighting.date).getTime());var n=h.positionToTimezone(e,u),s=this.view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===n.hours&&s.minutes===n.minutes&&s.seconds===n.seconds)return!1}else s.hours=n.hours,s.minutes=n.minutes,s.seconds=n.seconds;var r=t.getUTCHours()-(n.hours-s.hours),o=t.getUTCMinutes()-(n.minutes-s.minutes),a=t.getUTCSeconds()-(n.seconds-s.seconds);return t.setUTCHours(r),t.setUTCMinutes(o),t.setUTCSeconds(a),i?!1:this.view.environment.lighting.autoUpdate(t,n)},_updateRenderParamsHandler:function(){var e=this.get("view._stage");e&&e.setRenderParams({shadowMap:this.view.environment.lighting.directShadowsEnabled,ssao:this.view.environment.lighting.ambientOcclusionEnabled})},_spatialReferenceHandler:function(){this._resetReferencePosition()},_viewingModeHandler:function(){this._resetReferencePosition()},_resetReferencePosition:function(){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsDesired=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84=null},_requestReferencePositionUpdate:function(e,i){this.view.mapCoordsHelper.canProject()&&!this.noReferencePositionQueries&&(this._referencePosUpdateQuery||null!=this._referencePosUpdateTimer||this.view.interacting||!this.view.stationary?(this._referencePosMapCoordsDesired?this._referencePosMapCoordsDesired.copy(e):this._referencePosMapCoordsDesired=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!i):(i&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(e):this._referencePosMapCoords=e.clone(),this._referencePosUpdateQuery=this.view.mapCoordsHelper.toGeographic(this._referencePosMapCoords).then(function(e){if(this._referencePosUpdateQuery=null,!isNaN(e[0])&&!isNaN(e[1])){var i=this._referencePosMapCoords.z*this.view.mapCoordsHelper.unitInMeters;this._referencePosWGS84?(this._referencePosWGS84.x=e[0],this._referencePosWGS84.y=e[1],this._referencePosWGS84.z=i):this._referencePosWGS84=new r({x:e[0],y:e[1],z:i,spatialReference:a.WGS84}),this._referencePosChanged(),null==this._referencePosUpdateTimer&&this._executePendingReferencePositionUpdate()}this.notifyChange("updating")}.bind(this),function(){this._referencePosUpdateQuery=null,this.notifyChange("updating")}.bind(this)),this._referencePosUpdateTimer=window.setTimeout(function(){this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate(),this.notifyChange("updating")}.bind(this),this.referencePointUpdateInterval),this.notifyChange("updating")))},_executePendingReferencePositionUpdate:function(){var e=this._referencePosMapCoordsDesired,i=this._referencePosResetPreserveAbsoluteTime;e&&this._exceedsReferencePosDistThreshold(e)&&(this._referencePosMapCoordsDesired=null,this._referencePosResetPreserveAbsoluteTime=null,this._requestReferencePositionUpdate(e,i))},_referencePosChanged:function(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84)||this._updateLightParams()},_exceedsReferencePosDistThreshold:function(e){if(this._referencePosMapCoords){var i=this._referencePosMapCoords.distance(e);return this.view.mapCoordsHelper&&(i*=this.view.mapCoordsHelper.unitInMeters),i>this.referencePointUpdateDistThreshold}return!0},_cancelReferencePosUpdates:function(){this._referencePosUpdateQuery&&(this._referencePosUpdateQuery.cancel(),this._referencePosUpdateQuery=null),null!=this._referencePosUpdateTimer&&(window.clearTimeout(this._referencePosUpdateTimer),this._referencePosUpdateTimer=null)}});return _.FIXED_LIGHT_DIRECTION=f,_});