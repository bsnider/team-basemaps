// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/text!./materials/StarMaterial.xml","require","../../../request","../../../core/watchUtils","../../../core/promiseUtils","../lib/glMatrix","../support/ExternalRenderer","../webgl-engine/lib/GeometryRenderer","../webgl-engine/lib/Util","../webgl-engine/lib/VertexBufferLayout","../webgl-engine/materials/internal/MaterialUtil","../webgl-engine/lib/GLSLProgram","../webgl-engine/lib/webglConstants","../webgl-engine/lib/RenderPass","../webgl-engine/lib/RenderSlot"],function(e,t,r,a,i,n,s,o,f,l,u,d,h,c,m){var b=n.mat4d,_=n.mat3d,g=f.VertexAttrConstants,p=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],v=_.toMat4(_.createFrom(1,0,0,0,.9174771405229186,.39778850739794974,0,-.39778850739794974,.9174771405229186)),S=_.toMat4(_.createFrom(1,0,0,0,.9174771405229186,-.39778850739794974,0,.39778850739794974,.9174771405229186)),w=null,O=s.createSubclass({classMetadata:{properties:{view:{},numBinaryFloats:{value:2},numBinaryUInt8:{value:1},bytesPerStar:{value:9},slot:{value:m.BACKGROUND,setter:function(e){return this.needsRender=!0,e}}}},constructor:function(){this._renderData={model:b.identity()},this.slot=m.BACKGROUND,this._vertexBufferLayout=new l([g.POSITION,g.COLOR,g.SIZE],[3,4,1],[h.FLOAT,h.UNSIGNED_BYTE,h.FLOAT])},initialize:function(){this._loadDataPromise=this._loadBrightStarCatalogue(),this.addResolvingPromise(this._loadDataPromise)},destroy:function(){this._loadDataPromise.isFulfilled()||this._loadDataPromise.cancel("Atmosphere has been removed."),this._dateHandle&&(this._dateHandle.remove(),this._dateHandle=null),this._program&&this._program.dispose()},setup:function(t){this._numStars=this._starData.byteLength/this.bytesPerStar;var r=new Float32Array(this._starData,0,this._numStars*this.numBinaryFloats),i=new Uint8Array(this._starData,this._numStars*this.numBinaryFloats*4,this._numStars*this.numBinaryUInt8),n=this._createStarGeometryData(r,i);this._renderer=new o(n,this._vertexBufferLayout,this._fillInterleaved,t.gl),this._renderer.enablePointRendering(!0),this._dateHandle=a.init(this,"view.environment.lighting.date",this._update.bind(this)),t.shaderSnippets.vertexShaderStar||t.shaderSnippets._parse(e),this._program=d.fromSnippets("vertexShaderStar","fragmentShaderStar",t.shaderSnippets,t.gl)},render:function(e){if(e.slot!==this.slot||e.pass!==c.MATERIAL)return!1;var t=this.renderContext.gl,r=this._program;return r.use(),r.uniformMatrix4fv("view",e.camera.viewMatrix),r.uniformMatrix4fv("proj",e.camera.projectionMatrix),r.uniform4fv("viewport",e.camera.fullViewport),r.uniformMatrix4fv("model",this._renderData.model),t.web3DDefaultState.depthFunc!==t.LEQUAL&&t.depthFunc(t.LEQUAL),t.enable(t.BLEND),t.depthMask(!1),this._renderer.render(this._program),d.unuse(t),t.depthMask(!0),t.disable(t.BLEND),t.web3DDefaultState.depthFunc!==t.LEQUAL&&t.depthFunc(t.web3DDefaultState.depthFunc),!0},_fillInterleaved:function(e,t,r,a,i,n,s){for(var o=i.getStride(),f=4*o,l=u.fill,d=i.getAttributes(),h=e.faces.indices[g.POSITION],c=e.vertexAttr[g.POSITION].data,m=s+d[g.POSITION].offset,b=0;b<h.length;++b){var _=3*h[b];l(c,_,n,m,t,3),m+=o}var p=e.faces.indices[g.COLOR],v=e.vertexAttr[g.COLOR].data;m=4*(s+d[g.COLOR].offset);var S=new Uint8Array(n.buffer);for(b=0;b<p.length;++b)_=4*p[b],l(v,_,S,m,null,4),m+=f;var w=e.faces.indices[g.SIZE],O=e.vertexAttr[g.SIZE].data;for(m=s+d[g.SIZE].offset,b=0;b<w.length;++b){var D=O[w[b]];n[m]=D,m+=o}},_computeDayDuration:function(e){var t=e,r=new Date(e.getFullYear(),0,1,11,58,56),a=new Date(e.getFullYear()+1,0,1,11,58,55);return(t-r)/(a-r)},_update:function(e){if(e){var t=e.getHours()/12,r=e.getMinutes()/60*(2/24),a=e.getSeconds()/60*(2/1440),i=.9972222,n=(t+r+a-i)%2,s=2*this._computeDayDuration(e),o=b.create(S);b.rotateZ(o,-s*Math.PI),b.multiply(v,o,o),b.rotateZ(o,-n*Math.PI),this._renderData.model=o,this.needsRender=!0}},_hexToRGB:function(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]},_unpackUint8Attributes:function(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]},_createStarGeometryData:function(e,t){for(var r=new Float32Array(3*this._numStars),a=new Uint8Array(4*this._numStars),i=new Float32Array(this._numStars),n=new Uint32Array(this._numStars),s=0;s<this._numStars;s++){var o=2*s,f=3*s,l=4*s,u=e[o+0],d=e[o+1];r[f+0]=-Math.cos(u)*Math.sin(d),r[f+1]=-Math.sin(u)*Math.sin(d),r[f+2]=-Math.cos(d);var h=this._unpackUint8Attributes(t[s]),c=this._hexToRGB(p[h[1]]);a[l+0]=255*c[0],a[l+1]=255*c[1],a[l+2]=255*c[2],a[l+3]=255,i[s]=h[0],n[s]=s}var m={};m[g.POSITION]=n,m[g.NORMAL]=n,m[g.UV0]=n,m[g.COLOR]=n,m[g.SIZE]=n;var b={};b[g.POSITION]={size:3,data:r},b[g.COLOR]={size:4,data:a},b[g.SIZE]={size:1,data:i};var _={type:"point",indices:m,positionKey:g.POSITION};return{faces:_,vertexAttr:b}},_loadBrightStarCatalogue:function(){return w?(this._starData=w,i.resolve()):r(t.toUrl("./resources/stars.wsv"),{responseType:"array-buffer",failOk:!0}).then(function(e){var t=e.data;if(!t)throw new Error("no data received");w=t,this._starData=t}.bind(this)).otherwise(function(e){throw console.error("Failed to load star data:",e),e})}});return O});