// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/text!./materials/RealisticAtmosphereMaterial.xml","../../../core/watchUtils","../support/ExternalRenderer","../lib/glMatrix","../webgl-engine/lib/GeometryRenderer","../webgl-engine/lib/VertexBufferLayout","../webgl-engine/lib/GLSLProgram","../webgl-engine/lib/GeometryUtil","../webgl-engine/lib/RenderPass","../webgl-engine/lib/RenderSlot","../support/earthUtils"],function(e,a,r,t,i,s,n,h,l,o,m){var d=m.earthRadius,v=t.vec3d,f=t.vec2d,_=t.vec4d,p=r.createSubclass({declaredClass:"esri.views.3d.environment.RealisticAtmosphere",classMetadata:{properties:{view:{},planar:{value:!1,setter:function(e){return e=!!e,e!==this.planar&&this._update(this.get("view.navigation.currentCamera")),e}},needsDepthMap:{value:!0}}},constructor:function(){this._currentViewChangedHandle=null,this._hazeProgram=null,this._hazePlanarProgram=null,this._skyProgram=null,this._skyPlanarProgram=null,this._renderer=null;var e=.005,a=.001,r=4*e*Math.PI,t=4*a*Math.PI,i=v.createFrom(1/Math.pow(.65,4),1/Math.pow(.57,4),1/Math.pow(.475,4)),s=v.create(i);v.scale(s,r),v.add(s,v.createFrom(t,t,t));var n=d,h=n*n,l=n/10*10.25,m=l*l,p=1/(l-n),u=.25,g=.05,c=p/u,D=p/g,C=1/u,P=1/g,S=-.99999,R=S*S,A=1.5*((1-R)/(2+R)),w=.3*(l-n)+n,T=1/(l-w);this._renderData={texDepth:f.create(),v3CameraPos:v.create(),v3CameraUp:v.create(),v3CameraRight:v.create(),v3CameraDir:v.create(),v3CameraCenter:v.create(),halfSizeNearPlane:f.create(),v2CameraCenterOffset:f.create(),v4Viewport:_.create(),v4SphereComp:_.create(),v4AtmosParams1:_.createFrom(p,u,c,C),v4AtmosParams2:_.createFrom(S,g,D,P),v4AtmosParams3:_.createFrom(R,A,w,T),v3InvWavelength:i,v3InvWavelengthScaled:s,v4Radii:_.createFrom(n,h,l,m),fScale:p,fScaleDepth:u,fLowerAlphaBlendBound:w,fScaleOverScaleDepth:c,fOneOverScaleDepth:C,fScaleDepthBlue:g,fOneOverScaleDepthBlue:P,fScaleOverScaleDepthBlue:D,g:S,g2:R,fMiePhaseCoefficients:A,showTest:0,nearFar:f.create()},this._hazeSlot=o.POSTPROCESSING_ATMOSPHERE,this._skySlot=o.BACKGROUND},destroy:function(){this._currentViewChangedHandle&&(this._currentViewChangedHandle.remove(),this._currentViewChangedHandle=null),this._hazeProgram&&(this._hazeProgram.dispose(),this._hazeProgram=null),this._hazePlanarProgram&&(this._hazePlanarProgram.dispose(),this._hazePlanarProgram=null),this._skyProgram&&(this._skyProgram.dispose(),this._skyProgram=null),this._skyPlanarProgram&&(this._skyPlanarProgram.dispose(),this._skyPlanarProgram=null)},setup:function(r){var t=h.createSquareGeometry(),l={faces:t.getFaces()[0],vertexAttr:t.getVertexAttr()};this._renderer=new i(l,s.Defaults.PosTex,null,r.gl),this._currentViewChangedHandle=a.on(this,"view.navigation","currentViewChanged",function(e){this._update(e.camera)}.bind(this),function(){this._update(this.get("view.navigation.currentCamera"))}.bind(this)),r.shaderSnippets.fsRealisticAtmosphere||r.shaderSnippets._parse(e),this._hazeProgram=n.fromSnippets("vsRealisticAtmosphere","fsRealisticAtmosphere",r.shaderSnippets,r.gl,["HAZE"]),this._skyProgram=n.fromSnippets("vsRealisticAtmosphere","fsRealisticAtmosphere",r.shaderSnippets,r.gl),this._hazePlanarProgram=n.fromSnippets("vsRealisticAtmosphere","fsRealisticAtmosphere",r.shaderSnippets,r.gl,["HAZE","PLANAR"]),this._skyPlanarProgram=n.fromSnippets("vsRealisticAtmosphere","fsRealisticAtmosphere",r.shaderSnippets,r.gl,["PLANAR"])},render:function(e){if((e.slot==this._hazeSlot||e.slot==this._skySlot)&&e.pass==l.MATERIAL){var a,r=this.renderContext.gl;if(e.slot==this._hazeSlot){if(a=this.planar?this._hazePlanarProgram:this._hazeProgram,a.use(),a.uniform1i("tColor",1),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,e.framebufferTex),void 0!==e.depth)r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e.depth.getTexture()),a.uniform4fv("v4SphereComp",this._renderData.v4SphereComp);else{var t=new Float32Array(4);t[2]=0,a.uniform4fv("v4SphereComp",t)}a.uniform1i("tDepth",0),a.uniform4fv("v4Viewport",this._renderData.v4Viewport)}return e.slot==this._skySlot&&(a=this.planar?this._skyPlanarProgram:this._skyProgram,a.use(),a.uniform4fv("v4SphereComp",this._renderData.v4SphereComp),a.uniform4fv("v4AtmosParams3",this._renderData.v4AtmosParams3)),a.uniform3fv("v3InvWavelength",this._renderData.v3InvWavelength),a.uniform3fv("v3InvWavelengthScaled",this._renderData.v3InvWavelengthScaled),a.uniform3fv("v3LightDir",e.lightingData.direction),a.uniform3fv("v3CameraPos",this._renderData.v3CameraPos),a.uniform3fv("v3CameraUp",this._renderData.v3CameraUp),a.uniform3fv("v3CameraRight",this._renderData.v3CameraRight),a.uniform3fv("v3CameraDir",this._renderData.v3CameraDir),a.uniform2fv("nearFar",this._renderData.nearFar),a.uniform2fv("halfSizeNearPlane",this._renderData.halfSizeNearPlane),a.uniform2fv("v2CameraCenterOffset",this._renderData.v2CameraCenterOffset),a.uniform4fv("v4Radii",this._renderData.v4Radii),a.uniform4fv("v4AtmosParams1",this._renderData.v4AtmosParams1),a.uniform4fv("v4AtmosParams2",this._renderData.v4AtmosParams2),a.uniform1f("showTest",this._renderData.showTest),r.disable(r.DEPTH_TEST),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),this._renderer.render(a),n.unuse(r),r.disable(r.BLEND),r.enable(r.DEPTH_TEST),!0}},_setEnableTestImage:function(e){this._renderData.showTest=e?1:0,this.needsRender=!0},_update:function(e){if(e&&(this.planar||!(v.length(e.eye)<=d))){var a=e.viewMatrix;if(v.set3(a[2],a[6],a[10],this._renderData.v3CameraDir),v.normalize(this._renderData.v3CameraDir),this.planar){var r=this.view.renderCoordsHelper;this._renderData.fCameraHeight=r.getAltitude(e.eye)/r.unitInMeters+d}else this._renderData.fCameraHeight=v.length(e.eye);this._renderData.fCameraHeight2=this._renderData.fCameraHeight*this._renderData.fCameraHeight,this._renderData.fC=this._renderData.fCameraHeight2-this._renderData.v4Radii[3],this._renderData.fCSur=this._renderData.fCameraHeight2-this._renderData.v4Radii[1],this._renderData.v4SphereComp=_.createFrom(this._renderData.fCameraHeight,this._renderData.fCameraHeight2,this._renderData.fC,this._renderData.fCSur),v.set(e.eye,this._renderData.v3CameraPos),v.set(e.center,this._renderData.v3CameraCenter),v.set(e.up,this._renderData.v3CameraUp),v.normalize(this._renderData.v3CameraUp),v.cross(e.up,this._renderData.v3CameraDir,this._renderData.v3CameraRight),v.normalize(this._renderData.v3CameraRight),f.set2(Math.tan(e.fovX/2)/(e.width/e.fullWidth),Math.tan(e.fovY/2)/(e.height/e.fullHeight),this._renderData.halfSizeNearPlane),_.set(e.fullViewport,this._renderData.v4Viewport);var t=(e.padding[3]+e.width/2)/e.fullWidth,i=(e.padding[2]+e.height/2)/e.fullHeight;f.set2(t-.5,i-.5,this._renderData.v2CameraCenterOffset),f.set2(e.near,e.far,this._renderData.nearFar),this.needsRender=!0}}});return p});