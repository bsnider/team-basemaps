// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["./ActionSpherical","../../mixins/PanMixin","../../../lib/glMatrix","../../../support/earthUtils","../../../support/mathUtils","../../../webgl-engine/lib/Util","../../ContinuousAction","../../NavigationConstants"],function(t,i,e,n,a,s,r,o){var h=e.vec2d,c=e.vec3d,u=e.vec4d,P=e.mat4d,d=c.create(),_=c.create(),l=c.create(),m=c.create(),g=c.create(),p=c.create(),A=P.create(),v=o.Pan.Mode,C=o.Pan.Direction,R=o.Pan.Vertical,S=o.Pan.Momentum,y=t.createSubclass([i],{declaredClass:"esri.views.3d.navigation.spherical.actions.PanSpherical",constructor:function(){this._panMode=0,this._lastPanActionPtr=0,this._lastPanActions=[],this._plane=u.create(),this._isMomentumPanning=!1,this.continuous=new r;for(var t=0;t<S.BUFFER_SIZE;t++)this._lastPanActions[t]={point:c.create(),pointScreen:h.create(),time:0}},begin:function(t,i){this.inherited(arguments),this.pickPointInScreen(t,this._navPickPoint)?this._navSphereRadius=c.length(this._navPickPoint):(this._navSphereRadius=c.length(this.targetCamera.center),this._navSphereRadius<.9*n.earthRadius&&(this._navSphereRadius=n.earthRadius),this.createPickRay(t,t,this.currentCamera.viewMatrix,d,_),c.subtract(_,this.currentCamera.eye),this.intersectManifold(this.currentCamera.eye,_,this._navSphereRadius-n.earthRadius,this._navPickPoint)||this.closestPointOnSphereSilhouette(this.currentCamera.eye,d,this._navSphereRadius,this._navPickPoint));var e=!1,a=this.renderCoordsHelper.getAltitude(this.currentCamera.eye);if(a<R.ELEVATION_THRESHOLD)if(this._navSphereRadius>c.length(this.currentCamera.eye))e=!0;else{c.normalize(c.subtract(this.targetCamera.eye,this._navPickPoint,l));var r=Math.abs(.5*Math.PI-Math.acos(c.dot(this._navPickPoint,l)/c.length(this._navPickPoint)));e=r<R.ANGLE_THRESHOLD}e?(this._panMode=v.VERTICAL,c.normalize(c.subtract(this.targetCamera.eye,this.targetCamera.center,l)),this.updatePlane(this._navPickPoint,l)):(this._panMode=v.HORIZONTAL,this._addToLastPanActions(void 0===i?s.performance.now():i,this._navPickPoint,t)),h.set(t,this._dragLastPoint),h.set(t,this._dragBeginPoint),this._mouseDownCamera.copyFrom(this.targetCamera)},update:function(t,i){if(this._panMode===v.HORIZONTAL){if(this._navSphereRadius<=0)return;this.createPickRay(t,this._dragBeginPoint,this._mouseDownCamera.viewMatrix,d,_),c.subtract(_,this._mouseDownCamera.eye),this.intersectManifold(this._mouseDownCamera.eye,_,this._navSphereRadius-n.earthRadius,this._targetOnSphere)||this.closestPointOnSphereSilhouette(this._mouseDownCamera.eye,d,this._navSphereRadius,this._targetOnSphere),this.rotateCameraWithPointsOnSphere(this._navPickPoint,this._targetOnSphere,this._mouseDownCamera,this.targetCamera,this._navSphereRadius),this._addToLastPanActions(void 0===i?s.performance.now():i,this._targetOnSphere,t)}else{if(this.createPickRay(this._dragLastPoint,this._dragBeginPoint,this.currentCamera.viewMatrix,d,_),c.subtract(_,d),!s.rayPlane(d,_,this._plane,m))return;if(this.createPickRay(t,this._dragBeginPoint,this.currentCamera.viewMatrix,d,_),c.subtract(_,d),!s.rayPlane(d,_,this._plane,g))return;c.subtract(g,m),c.subtract(this.targetCamera.eye,g),c.subtract(this.targetCamera.center,g),h.set(t,this._dragLastPoint)}this.constrainTargetEyeByElevationAndMoveLookAt(),h.set(t,this._dragLastPoint),this.fixTargetUpVector(),this.targetAndCurrentChanged(),this.inherited(arguments)},end:function(t,i){this._panMode===v.HORIZONTAL&&this._initiateMomentumPanning(t,i),this._navSphereRadius=0,this.inherited(arguments)},_initiateMomentumPanning:function(t,i){var e=h.dist(this._dragLastPoint,t);if(e>0&&this._navSphereRadius>0){this.update(t,i);var n=this._lastPanActionPtr;do if(n=(n-1+S.BUFFER_SIZE)%S.BUFFER_SIZE,this._lastPanActions[this._lastPanActionPtr].time-this._lastPanActions[n].time>1e3*S.INPUT_FILTER)break;while(this._lastPanActionPtr!==n);n++,n%=S.BUFFER_SIZE,n===this._lastPanActionPtr&&(n=(this._lastPanActionPtr-1+S.BUFFER_SIZE)%S.BUFFER_SIZE);var a=.001*(this._lastPanActions[this._lastPanActionPtr].time-this._lastPanActions[n].time);if(a>0){var s=this.rotationFromPointsOnSphere(this._lastPanActions[n].point,this._lastPanActions[this._lastPanActionPtr].point,this._navSphereRadius,this.continuous.direction);this.continuous.velocity=s/a;var r=h.create(),o=h.create();this.normalizeCoordinate(this._lastPanActions[n].pointScreen,r),this.normalizeCoordinate(this._lastPanActions[this._lastPanActionPtr].pointScreen,o);var c=Math.min(h.dist(r,o)/a/S.DURATION_LONG_VEL,1);return this.continuous.timer=S.DURATION_SHORT+c*(S.DURATION_LONG-S.DURATION_SHORT),this._isMomentumPanning=!0,this.animationStarted(),!0}this.currentReachedTarget()}else this.setPoiAuto(t,!0);return!1},beginContinuous:function(t){if(this.inherited(arguments),this.setCurrentToTarget(),0===this.continuous.status&&c.set3(0,0,0,this.continuous.direction),!(this.continuous.status&t)){if(this.continuous.status|=t,t&(C.LEFT|C.RIGHT|C.FORWARD|C.BACKWARD))this._computePanAxis(t,p),c.add(this.continuous.direction,p);else{var i=this.continuous.status&(C.UP|C.DOWN);this.continuous.radiusChange=i===C.UP?1:i===C.DOWN?-1:0}this.continuous.velocity=this._computePanVelocity()}this.continuous.timer=0},updateContinuous:function(t){if(this.continuous){if(!this.continuous.active)return void(this._isMomentumPanning&&(this._isMomentumPanning=!1,this.targetAndCurrentChanged(!0)));var i=this.continuous.step(t),e=c.dot(this.continuous.direction,this.continuous.direction)>.01;if(Math.abs(this.continuous.radiusChange)>0){var n=1+i*this.continuous.radiusChange;c.scale(this.targetCamera.center,n),c.scale(this.targetCamera.eye,n),this.continuous.velocity=this._computePanVelocity(),e||(this.constrainTargetEyeByElevationAndMoveLookAt(),this.targetAndCurrentChanged(!0))}e&&(P.identity(A),P.rotate(A,i,this.continuous.direction),P.multiplyVec3(A,this.targetCamera.eye),P.multiplyVec3(A,this.targetCamera.center),P.multiplyVec3(A,this.targetCamera.up),this.constrainTargetEyeByElevationAndMoveLookAt(),this.fixTargetUpVector(),this.targetAndCurrentChanged())}},endContinuous:function(t){if(this.continuous.status&=~t,0===this.continuous.status)this.continuous.stop(),this.continuous.radiusChange=0;else if(t&(C.LEFT|C.RIGHT|C.FORWARD|C.BACKWARD))this._computePanAxis(t,p),c.subtract(this.continuous.direction,p),c.length(this.continuous.direction)<.01&&c.set3(0,0,0,this.continuous.direction);else{var i=this.continuous.status&(C.UP|C.DOWN);this.continuous.radiusChange=i==C.UP?1:i==C.DOWN?-1:0}this.inherited(arguments)},_computePanAxis:function(t,i){c.subtract(this.targetCamera.center,this.targetCamera.eye,i),c.cross(i,this.targetCamera.up),(t===C.LEFT||t===C.RIGHT)&&(c.normalize(i),c.cross(i,this.targetCamera.center)),(t===C.RIGHT||t===C.FORWARD)&&c.negate(i),c.normalize(i)},_computePanVelocity:function(){var t=.5*Math.abs(c.length(this.targetCamera.eye)-n.earthRadius);return t=a.clamp(t,1,2*n.earthRadius),a.acos(1-t*t/(2*n.earthRadius*n.earthRadius))},_addToLastPanActions:function(t,i,e){this._lastPanActionPtr=(this._lastPanActionPtr+1)%5,this._lastPanActions[this._lastPanActionPtr].time=t,c.set(i,this._lastPanActions[this._lastPanActionPtr].point),h.set(e,this._lastPanActions[this._lastPanActionPtr].pointScreen)},updatePlane:function(t,i){u.set4(i[0],i[1],i[2],-c.dot(i,t),this._plane)}});return y});