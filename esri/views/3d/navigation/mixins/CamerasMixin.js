// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../../../core/declare","../../../../core/Evented","../../webgl-engine/lib/Camera","../../support/earthUtils","../../support/mathUtils","../../lib/glMatrix","dojo/on"],function(t,e,a,r,i,n,s){var c=n.vec3d,h=n.vec4d,m=h.create(),g=t([e],{declaredClass:"esri.views.3d.navigation.mixins.CamerasMixin",classMetadata:{properties:{targetCamera:{getter:function(){return this.cameras.target}},currentCamera:{getter:function(){return this.cameras.current}},windowSize:{setter:function(t){var e=t[0],a=t[1],r=!1,i=this.cameras.target.x-this.cameras.target.padding[3],n=this.cameras.target.y-this.cameras.target.padding[2];(this.cameras.target.width+i!==e||this.cameras.target.height+n!==a)&&(this.cameras.target.width=e-i,this.cameras.target.height=a-n,this.targetChanged(),r=!0);var s=this.cameras.current.x-this.cameras.current.padding[3],c=this.cameras.current.y-this.cameras.current.padding[2];return(this.cameras.current.width+s!==e||this.cameras.current.height+c!==a)&&(this.cameras.current.width=e-s,this.cameras.current.height=a-c,this.currentChanged(),r=!0),r&&this.currentHasReachedTarget()&&this.currentReachedTarget(),t}},padding:{setter:function(t){var e=!1,a=!1;m[0]=t.top,m[1]=t.right,m[2]=t.bottom,m[3]=t.left,i.vectorEquals(this.cameras.current.padding,m)||(this.cameras.current.padding=m,a=!0),i.vectorEquals(this.cameras.target.padding,m)||(this.cameras.target.padding=m,e=!0),e&&this.targetChanged(),a&&this.currentChanged(),this.currentHasReachedTarget()&&(e||a)&&this.currentReachedTarget()}}}},initialize:function(){var t=new a(c.createFrom(4*r.earthRadius,0,0),c.createFrom(r.earthRadius,0,0),c.createFrom(0,0,1));this.cameras={current:t,target:t.copy()}},currentHasReachedTarget:function(){return this.cameras.current.equals(this.cameras.target)},currentHasAlmostReachedTarget:function(){return this.cameras.current.almostEquals(this.cameras.target,5e-4/this.renderUnitInMeters)},setCamera:function(t,e){this.pan&&this.pan.continuous&&this.pan.continuous.stop(),this.cameras.target.copyFrom(t);var a=e&&e.internalUpdate,r=!a||!this._targetCameraChangedByElevationUpdate,i=this.constrainTargetEyeByElevation(r);return i=this.applyConstraints(this.cameras.target,!0)||i,this.fixTargetUpVector(),this.currentHasReachedTarget()?(this.targetChanged(),i&&r&&(this._targetCameraChangedByElevationUpdate=!0),void this.currentReachedTarget()):(void 0===e||void 0===e.animate||e.animate?this.targetAnimatedChanged():this.targetAndCurrentChanged(!0),i&&r&&(this._targetCameraChangedByElevationUpdate=!0),void this._autoUpdateTiltConstraint())},getTargetCamera:function(){return console.warn("[Navigation.getTargetCamera()] deprecated; use .targetCamera instead"),this.targetCamera},getCurrentCamera:function(){return console.warn("[Navigation.getCurrentCamera()] deprecated; use .currentCamera instead"),this.currentCamera},_cameraFromEyeCenterUp:function(t,e,a){var r=this.cameras.target.copy();return r.eye=t,r.center=e,r.up=a,r},setCameraFromEyeAndCenter:function(t,e,a){this.setCamera(this._cameraFromEyeCenterUp(t,e,this.cameras.target.up),a)},setCameraFromEyeCenterAndUp:function(t,e,a,r){this.setCamera(this._cameraFromEyeCenterUp(t,e,a),r)},_cameraEvents:{},_prepareCameraEvent:function(t,e){var r=this._cameraEvents[t];return r||(r={camera:new a},this._cameraEvents[t]=r),r.camera.copyFrom(e),r},emitWithCamera:function(t,e){s.emit(this,t,this._prepareCameraEvent(t,e))},targetChanged:function(t){this.inherited(arguments),this.cameras.target.markViewDirty();var e=this._prepareCameraEvent("targetViewChanged",this.cameras.target);e.interruptedAnimation=!!t,e.finishedAnimation=!1,s.emit(this,"targetViewChanged",e)},targetAnimatedChanged:function(t){this.targetChanged(t),this.animationStarted()},targetAndCurrentChanged:function(t){this.targetChanged(t),this.setCurrentToTarget(!1,t)},currentChanged:function(){this.inherited(arguments),this.cameras.current.markViewDirty(),this.emitWithCamera("currentViewChanged",this.cameras.current)},currentReachedTarget:function(t,e){if(this.currentChanged(),!(this.pan&&this.pan.continuous&&this.pan.continuous.active)){var a=this._prepareCameraEvent("currentViewReachedTarget",this.cameras.current);a.finishedAnimation=!!t,a.interruptedAnimation=!!e,s.emit(this,"currentViewReachedTarget",a)}},setCurrentToTarget:function(t,e){this.cameras.current.copyFrom(this.cameras.target),this.currentReachedTarget(t,e)}});return g});