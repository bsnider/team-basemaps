// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../../../core/declare","../../../../core/watchUtils","../../../../geometry/Point","../../support/mathUtils","../../lib/glMatrix","../../constraints/SceneViewAltitudeConstraint","../../webgl-engine/lib/Camera","../../webgl-engine/lib/IntervalUtilities"],function(t,e,i,n,a,s,r,o){function l(t){return new D.Tilt({min:function(){return.01},max:function(){return n.deg2rad(t.tilt.max)}})}function h(t){return new D.Altitude({min:function(){return t.altitude.min},max:function(){return t.altitude.max}})}function d(t){return new D.Collision(t.collision.enabled)}var c=2,u=4,m=5,_=.02,C=a.vec3d,g=a.mat4d,p=new i,v=C.create(),f=C.create(),E=g.create(),y=C.create(),H=C.create(),M=C.create(),x=new r,T=new r,U=C.create(),A={tilt:0,distance:0},b={distance:0,maxFarNearRatio:0},D=t([],{declaredClass:"esri.views.3d.navigation.mixins.ConstraintsMixin",classMetadata:{properties:{userConstraints:{setter:function(t){return this._disconnectUserConstraints(),this._connectUserConstraints(t),t}},elevationProvider:{value:null,setter:function(t){return null!==this._elevationChangeHandle&&(this._elevationChangeHandle.remove(),this._elevationChangeHandle=null),null!==this._elevationChangeTileHandle&&(this._elevationChangeTileHandle.remove(),this._elevationChangeTileHandle=null),null!==t&&(this._elevationChangeHandle=t.on("elevation-change",this._elevationChangeHandler.bind(this)),this._elevationChangeTileHandle=t.on("elevation-change-tile",this._elevationChangeTileHandler.bind(this))),t}},minPoiDist:{getter:function(){return this._minPoiDistInMeters/this.renderUnitInMeters},dependsOn:["renderUnitInMeters"]},cameraElevationMargin:{getter:function(){return this._cameraElevationMarginInMeters/this.renderUnitInMeters},dependsOn:["renderUnitInMeters"]},minNearDistance:{getter:function(){return this._minNearDistanceInMeters/this.renderUnitInMeters},dependsOn:["renderUnitInMeters"]},constraintsEnabled:{value:!0}}},constructor:function(){this._userConstraints=null,this._userConstraintsHandles=[],this._clipDistanceHandles=[],this._tiltHandles=[],this._altitudeHandles=[],this.constraints={tilt:this.defaultConstraints.tilt,altitude:this.defaultConstraints.altitude,collision:this.defaultConstraints.collision},this._tiltModeHandler=this._tiltModeHandler.bind(this),this._tiltMaxHandler=this._tiltMaxHandler.bind(this),this._altitudeModeHandler=this._altitudeModeHandler.bind(this),this._altitudeMinMaxHandler=this._altitudeMinMaxHandler.bind(this),this._clipDistanceModeHandler=this._clipDistanceModeHandler.bind(this),this._clipDistanceNearFarHandler=this._clipDistanceNearFarHandler.bind(this),this._collisionEnabledHandler=this._collisionEnabledHandler.bind(this),this.enableElevationUpdates=!0,this.updateTargetByElevationUpdates=D.UPDATE_TARGET_BY_ELEVATION_UPDATES_DEFAULT,this._recomputeTargetCenterForElevationChange=!1,this._elevationChangeHandle=null,this._elevationChangeTileHandle=null,this._terrainElevationBelowCamera=null,this._terrainElevationAtCameraEye=null,this._autoAltitudeConstraints={min:s.MIN_DEFAULT,max:s.MAX_DEFAULT},this.maxFarNearRatio=2e4,this._minNearDistanceInMeters=c,this._minPoiDistInMeters=u,this._cameraElevationMarginInMeters=m},initialize:function(){this._targetCameraBeforeElevationUpdate=this.cameras.current.copy(),this._sceneExtentChangeHandle=this.view.watch("dataExtent",function(){this._dataExtentChanged()}.bind(this))},_dataExtentChanged:function(){this._updateAltitudeConstraintFromExtent(this.view.dataExtent),this._reapplyConstraints(),this._camerasChanged()},_updateAutoAltitudeConstraints:function(){},updateRenderCoordsHelper:function(t){this.inherited(arguments),this._userConstraints&&"auto"!==this._userConstraints.altitude.mode||(this.constraints.altitude=D.Altitude.scale(this.defaultConstraints.altitude,t.unitInMeters)),this._userConstraints&&"auto"!==this._userConstraints.tilt.mode||(this.constraints.tilt=D.Tilt.scale(this.defaultConstraints.tilt,t.unitInMeters)),this._updateAltitudeConstraintFromExtent(this.view.dataExtent),this._reapplyConstraints(),this._camerasChanged()},_updateAltitudeConstraintFromExtent:function(t){t.xmax-t.xmin>0&&(this._updateAutoAltitudeConstraints(t),this._userConstraints&&"auto"!==this._userConstraints.altitude.mode||this._autoUpdateAltitudeConstraint())},destroy:function(){this._disconnectUserConstraints(),this._sceneExtentChangeHandle.remove()},_updateTargetCenterForElevation:function(t){if(t||this.enableElevationUpdates&&this.updateTargetByElevationUpdates){var e=this.getCameraIntersectTerrain(this.cameras.target.eye,this.cameras.target.center,this.cameras.target.up,_);e&&!e.equals(this.cameras.target)&&this.setCamera(e,{internalUpdate:!0})}},step:function(){var t=this.pan&&this.pan.continuous&&this.pan.continuous.active,e=t||this.pan.active||this.zoom.active||this.rotate.active;if(!e&&this._recomputeTargetCenterForElevationChange){var i=this._targetCameraChangedByElevationUpdate;this._updateTargetCenterForElevation(),i&&(this._targetCameraChangedByElevationUpdate=!0),this._recomputeTargetCenterForElevationChange=!1}this.inherited(arguments)},applyConstraints:function(t,e){if(!this.constraintsEnabled)return!1;var i=this._cameraElevationAngle(t,A),n=this.constraints.tilt.min(i.distance),a=this.constraints.tilt.max(i.distance),s=0;!e&&i.tilt>a?s=i.tilt-a:i.tilt<n&&(s=i.tilt-n);var r=!1;Math.abs(s)>.01&&(C.cross(v,t.up,f),g.identity(E),g.rotate(E,s,f),g.multiplyVec3(E,v),C.add(t.center,v,t.eye),g.multiplyVec3(E,t.up),r=!0),C.subtract(t.center,t.eye,y);var o=t.distance,l=this.limitAltitude(o,t.center,y,o);return o!==l&&(C.scale(y,-l/o),C.add(t.center,y,t.eye),r=!0),this._autoUpdateTiltConstraint(a),r},limitTiltByConstraints:function(t,e,i,n){if(!this.constraintsEnabled)return t;var a=this.constraints.tilt.min(i),s=this.constraints.tilt.max(i);return(void 0===n||n>0)&&t>=s?t=s:(void 0===n||0>n)&&a>=t&&(t=a),t=this.limitTiltByAltitudeConstraints(t,e,i,n),this._autoUpdateTiltConstraint(s),t},_autoUpdateAltitudeConstraint:function(){var t=this._userConstraints&&this._userConstraints.altitude;t&&"auto"===t.mode&&t.autoUpdate(this.constraints.altitude.min(this),this.constraints.altitude.max(this))},_autoUpdateTiltConstraint:function(t){var e=this._userConstraints&&this._userConstraints.tilt;void 0===t&&(t=this.constraints.tilt.max(this.cameras.target.distance)),e&&"auto"===e.mode&&e.autoUpdate(n.rad2deg(t))},_disconnectUserConstraints:function(){if(this._userConstraints){this._userConstraintsHandles.forEach(function(t){t.remove()}),this._userConstraints=null,this._userConstraintsHandles.length=0;var t=this.renderUnitInMeters;this.constraints.tilt=D.Tilt.scale(this.defaultConstraints.tilt,t),this.constraints.altitude=D.Altitude.scale(this.defaultConstraints.altitude,t)}},_connectUserConstraints:function(t){t&&(this._userConstraints=t,this._userConstraintsHandles.push(e.init(t,"tilt.mode",this._tiltModeHandler),e.init(t,"clipDistance.mode",this._clipDistanceModeHandler),e.init(t,"altitude.mode",this._altitudeModeHandler),e.init(t,"collision.enabled",this._collisionEnabledHandler)))},_camerasChanged:function(){this.targetChanged(),this.currentChanged(),this.currentHasReachedTarget()&&this.currentReachedTarget()},_reapplyConstraints:function(){var t=!1;this.applyConstraints(this.cameras.current)&&(t=!0),this.applyConstraints(this.cameras.target)&&(t=!0),t&&this._camerasChanged()},_userConstraintsChanged:function(){this._reapplyConstraints()},_altitudeMinMaxHandler:function(){this._userConstraintsChanged()},_tiltMaxHandler:function(){this._userConstraintsChanged()},_tiltModeHandler:function(t){this._tiltHandles.forEach(function(t){t.remove()}),this._tiltHandles.length=0,"auto"===t?this.constraints.tilt=D.Tilt.scale(this.defaultConstraints.tilt,this.renderUnitInMeters):(this._tiltHandles.push(this._userConstraints.watch("tilt.max",this._tiltMaxHandler)),this.constraints.tilt=l(this._userConstraints)),this._tiltMaxHandler()},_altitudeModeHandler:function(t){this._altitudeHandles.forEach(function(t){t.remove()}),this._altitudeHandles.length=0,"auto"===t?(this.constraints.altitude=D.Altitude.scale(this.defaultConstraints.altitude,this.renderUnitInMeters),this._autoUpdateAltitudeConstraint()):(this._altitudeHandles.push(this._userConstraints.watch("altitude.min",this._altitudeMinMaxHandler),this._userConstraints.watch("altitude.max",this._altitudeMinMaxHandler)),this.constraints.altitude=h(this._userConstraints)),this._altitudeMinMaxHandler()},_collisionEnabledHandler:function(){this.constraints.collision=d(this._userConstraints),this._userConstraintsChanged()},_clipDistanceNearFarHandler:function(){"auto"!==this._userConstraints.clipDistance.mode&&(this.cameras.target.near=this._userConstraints.clipDistance.near,this.cameras.target.far=this._userConstraints.clipDistance.far,this.cameras.current.near=this._userConstraints.clipDistance.near,this.cameras.current.far=this._userConstraints.clipDistance.far),this._camerasChanged()},_clipDistanceModeHandler:function(t){this._clipDistanceHandles.forEach(function(t){t.remove()}),this._clipDistanceHandles.length=0,"auto"!==t&&this._clipDistanceHandles.push(this._userConstraints.watch(["clipDistance.near","clipDistance.far"],this._clipDistanceNearFarHandler)),this._clipDistanceNearFarHandler()},_updateAutoNearFar:function(t){var e=this._userConstraints&&this._userConstraints.clipDistance;if(!e||"auto"===e.mode){var i=this.renderUnitInMeters,n=this.distanceToSilhouette(t,this.view.dataExtent,i,this._getTerrainElevationBelowCamera(t),b);t.far=n.distance/i,t.far/n.maxFarNearRatio>this.minNearDistance?t.near=t.far/n.maxFarNearRatio:(t.near=this.minNearDistance,t.far=t.near*n.maxFarNearRatio),e&&t===this.cameras.current&&e.autoUpdate(t.near,t.far)}},constrainTargetEyeByElevation:function(t){if(!this.elevationProvider||!this.elevationProvider.spatialReference)return!1;var e=this.cameras.target;t&&this._targetCameraBeforeElevationUpdate.copyFrom(e);var i=this._applyTargetEyeElevationConstraint(e.eye,this._getTerrainElevationBelowCamera(e));return i},constrainTargetEyeByElevationAndMoveLookAt:function(){C.set(this.cameras.target.eye,M),this.constrainTargetEyeByElevation()&&(C.subtract(M,this.cameras.target.eye),C.subtract(this.cameras.target.center,M))},targetChanged:function(){this.inherited(arguments),this._targetCameraChangedByElevationUpdate=!1,this._updateAutoNearFar(this.cameras.target)},currentChanged:function(){this._updateAutoNearFar(this.cameras.current),this.inherited(arguments)},_applyTargetEyeElevationConstraint:function(t,e){if(!this.constraintsEnabled)return!1;var i=this.renderCoordsHelper,n=i.getAltitude(t),a=this.constraints.collision.enabled;return a&&n-e<this.cameraElevationMargin?(i.setAltitude(e+this.cameraElevationMargin,t,0),!0):!1},_cameraElevationAngle:function(t,e){e=e||{tilt:0,distance:0},this.renderCoordsHelper.worldUpAtPosition(t.center,H),C.subtract(t.eye,t.center,v);var i=C.length(v),n=Math.acos(C.dot(v,H)/i/C.length(H));return e.tilt=n,e.distance=i,e},_elevationChangeTileHandler:function(t){if(this.enableElevationUpdates&&this._targetCameraChangedByElevationUpdate&&this.constraintsEnabled){var e=this.renderCoordsHelper,i=this.mapCoordsHelper.spatialReference,n=!1,a=t.tile.extent,s=this._targetCameraBeforeElevationUpdate.eye,r=e.fromRenderCoords(s,p,i);a[0]<r.x&&a[1]<r.y&&a[2]>r.x&&a[3]>r.y&&(x.copyFrom(this.cameras.target),this.cameras.target.copyFrom(this._targetCameraBeforeElevationUpdate),this.constrainTargetEyeByElevation(),n=!T.equals(this.cameras.target),n=this.applyConstraints(this.cameras.target)||n),n&&(this.targetChanged(),this._targetCameraChangedByElevationUpdate=!0)}},_elevationChangeHandler:function(t){if(this.enableElevationUpdates&&this.constraintsEnabled){var e=this.renderCoordsHelper,i=this.mapCoordsHelper.spatialReference,n=this.cameras.target.eye,a=!1,s=t.extent,r=e.fromRenderCoords(n,i);if(s[0]<r.x&&s[1]<r.y&&s[2]>r.x&&s[3]>r.y&&(this._targetCameraChangedByElevationUpdate||this._targetCameraBeforeElevationUpdate.copyFrom(this.cameras.target),a=this._applyTargetEyeElevationConstraint(n,this._getTerrainElevationBelowCamera(this.cameras.target))),a&&(this.targetChanged(),this._targetCameraChangedByElevationUpdate=!0),!this._recomputeTargetCenterForElevationChange){var l=e.fromRenderCoords(this.cameras.target.center,i),h=Math.max(l.x,r.x),d=Math.min(l.x,r.x),c=Math.max(l.y,r.y),u=Math.min(l.y,r.y),m=o.intersectIntervals([[d,h]],[[s[0],s[2]]]),_=o.intersectIntervals([[u,c]],[[s[1],s[3]]]);m.length>0&&_.length>0&&(this._recomputeTargetCenterForElevationChange=!0)}}},_getTerrainElevationBelowCamera:function(t){if(this.elevationProvider&&this.elevationProvider.spatialReference){if(null===this._terrainElevationBelowCamera||this._terrainElevationAtCameraEye!==t.eye){var e=this.elevationProvider.spatialReference,i=this.renderCoordsHelper.fromRenderCoords(t.eye,e);this._terrainElevationBelowCamera=this.elevationProvider.getElevation(i)||0,this._terrainElevationAtCameraEye=t.eye}}else this._terrainElevationBelowCamera=0;return this._terrainElevationBelowCamera},getCenterIntersectTerrain:function(t,e,i){i||(i=C.create()),C.set(e,i);var n=this.picker.pickAlongRay(t,i);return this.picker.pickedIntersectionPoint(n,i)||this.getCenterIntersectManifold(t,e,i)||this.getCenterIntersectTerrainFallback(t,e,i),i},getCenterIntersectManifold:function(t,e,i){return C.subtract(e,t,i),this.intersectManifold(t,i,0,i)},getCameraIntersectTerrain:function(t,e,i,n){var a=this.cameras.current.copy();if(t&&(a.eye=t),e&&(a.center=e),i&&(a.up=i),this.getCenterIntersectTerrain(a.eye,a.center,U),C.dist2(a.eye,U)<this.minPoiDist&&this.constraintsEnabled){var s=this.constraints.collision.enabled;C.scale(a.computeDirection(v),this.minPoiDist),s?C.subtract(U,v,a.eye):C.add(a.eye,v,U);var r=this.renderCoordsHelper,o=r.getAltitude(a.eye);s&&o<this.cameraElevationMargin&&(C.subtract(U,a.eye,v),r.setAltitude(this.cameraElevationMargin,a.eye),C.add(a.eye,v,U)),a.markViewDirty()}if(n>0){var l=C.dist(a.eye,a.center),h=C.dist(U,a.center);h>l*n&&(a.center=U)}else a.center=U;return a}});return D.UPDATE_TARGET_BY_ELEVATION_UPDATES_DEFAULT=!0,D.Tilt=function(t){this.min=t.min,this.max=t.max},D.Tilt.scale=function(t,e){return 1===e?t:new D.Tilt({min:function(i){return t.min(i*e)},max:function(i){return t.max(i*e)}})},D.Tilt.prototype.apply=function(t,e){return n.clamp(t,this.min(e),this.max(e))},D.Altitude=function(t){this.min=t.min,this.max=t.max},D.Altitude.scale=function(t,e){return 1===e?t:new D.Altitude({min:function(i){return t.min(i)/e},max:function(i){return t.max(i)/e}})},D.Altitude.prototype.apply=function(t,e){return n.clamp(e,this.min(t),this.max(t))},D.Collision=function(t){this.enabled=null!=t?t:!0},D});