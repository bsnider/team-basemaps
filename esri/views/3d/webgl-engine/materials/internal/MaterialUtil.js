// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../lib/IdGen","../../lib/gl-matrix","../../parts/Model","../../lib/VertexBufferLayout","../../lib/Util"],function(e,t,r,i,n){var a=t.vec3d,o=t.mat4d,u=t.mat4,f=n.VertexAttrConstants,s={};s.__Material_idGen=new e,s.__GLMaterial_id=0,s.IDENTITY=o.identity(),s.Layouts=i.Defaults;var c=function(e,t,r,i,n){var a=e[t],o=e[t+1],u=e[t+2];r[i]=n[0]*a+n[4]*o+n[8]*u+n[12],r[i+1]=n[1]*a+n[5]*o+n[9]*u+n[13],r[i+2]=n[2]*a+n[6]*o+n[10]*u+n[14]};s.fill=function(e,t,r,i,n,a){if(void 0===n||3!==a)for(var o=0;a>o;++o)r[i+o]=e[t+o];else c(e,t,r,i,n);return a};var d=function(e,t,r,i,n,a){for(var o=e.length,u=0;o>u;++u){var f=3*e[u],s=t[f],c=t[f+1],d=t[f+2];i[n]=r[0]*s+r[4]*c+r[8]*d+r[12],i[n+1]=r[1]*s+r[5]*c+r[9]*d+r[13],i[n+2]=r[2]*s+r[6]*c+r[10]*d+r[14],n+=a}},l=function(e,t,r,i,n,a){for(var o=e.length,u=0;o>u;++u){for(var f=r*e[u],s=0;r>s;++s)i[n+s]=t[f+s];n+=a}},v=function(e,t,r,i,n,a){i=new Uint8Array(i.buffer),n*=4,a*=4;for(var o=e.length,u=0;o>u;++u){var f,s=r*e[u];for(f=0;r>f;++f)i[n+f]=t[s+f];4>f&&(i[n+3]=255),n+=a}},g=function(e,t,r,i,n,a,o){n=new Uint8Array(n.buffer),a*=4,o*=4;for(var u=e.length,f=0;u>f;++f){var s,c=i*e[f];for(s=0;i>s;++s)n[a+s]=t[c+s]*r[s];4>s&&(n[a+3]=255*r[3]),a+=o}},T=function(e,t,r,i,n,a){i=new Uint16Array(i.buffer),n*=2,a*=2;for(var o=e.length,u=0;o>u;++u){var f,s=r*e[u];for(f=0;r>f;++f)i[n+f]=t[s+f];n+=a}};s.fillInterleaved=function(e,t,r,i,n,a,o,u){var s=n.getAttributes(),c=n.getStride();for(var x in s){var b=o+s[x].offset;if(null==u||null!=u[x]){var y;switch(x){case f.UV0:y=e.vertexAttr[x],null!=y&&l(e.faces.indices[x],y.data,y.size,a,b,c);break;case f.REGION:y=e.vertexAttr[x],T(e.faces.indices[x],y.data,y.size,a,b,c);break;case f.COLOR:y=e.vertexAttr[x],i&&i.color?g(e.faces.indices[x],y.data,i.color,y.size,a,b,c):v(e.faces.indices[x],y.data,y.size,a,b,c);break;default:y=e.vertexAttr[x];var I=x===f.POSITION?t:x===f.NORMAL?r:void 0;void 0!==I&&3===y.size?d(e.faces.indices[x],y.data,I,a,b,c):l(e.faces.indices[x],y.data,y.size,a,b,c)}}}},s.triangleVertexArrayToWireframeLines=function(e,t,r,i){for(var n=Math.floor(r/3),a=n-1;a>=0;a--){var o=t+3*a*i,u=t+3*a*2*i+5*i;this.fill(e,o,e,u,null,i),u-=i,this.fill(e,o+i,e,u,null,i),u-=i,this.fill(e,o+i,e,u,null,i),u-=i,this.fill(e,o+2*i,e,u,null,i),u-=i,this.fill(e,o+2*i,e,u,null,i),u-=i,this.fill(e,o,e,u,null,i)}};var x=a.create(),b=a.create(),y=a.create(),I=a.create(),h=function(e,t,r,i,n){var o=x,u=e.getCenter();a.project(u,t,r,o);var f=a.dist2(o,u),s=e.getBSRadius();if(s*s>f){var c=e.getPrimitiveIndices(),d=e.getIndices(),l=e.getPosition(),v=c?c.length:d.length/3;if(v>1e4){var g=e.getChildren();if(void 0!==g){for(var T=0;8>T;++T)void 0!==g[T]&&h(g[T],t,r,i,n);return}}for(var m=l.size,E=l.data,R=t[0],M=t[1],_=t[2],A=r[0],U=r[1],C=r[2],G=A-R,P=U-M,L=C-_,D=0;v>D;++D){var V=c?c[D]:D,p=m*d[3*V],w=m*d[3*V+1],z=m*d[3*V+2],O=E[p],S=E[p+1],X=E[p+2],N=E[w],k=E[w+1],B=E[w+2],q=E[z],j=E[z+1],F=E[z+2],W=N-O,Y=k-S,H=B-X,J=q-O,K=j-S,Q=F-X,Z=P*Q-K*L,$=L*J-Q*G,et=G*K-J*P,tt=W*Z+Y*$+H*et;if(!(tt>-i&&i>tt)){var rt=1/tt,it=R-O,nt=M-S,at=_-X,ot=rt*(it*Z+nt*$+at*et);if(!(0>ot||ot>1)){var ut=nt*H-Y*at,ft=at*W-H*it,st=it*Y-W*nt,ct=rt*(G*ut+P*ft+L*st);if(!(0>ct||ot+ct>1)){var dt=rt*(J*ut+K*ft+Q*st);if(dt>=0){var lt=b,vt=y,gt=I;a.set3(O,S,X,lt),a.set3(N,k,B,vt),a.set3(q,j,F,gt),a.subtract(vt,lt,vt),a.subtract(gt,lt,gt),a.normalize(a.cross(vt,gt,lt)),n(dt,lt,V)}}}}}}};s.intersectTriangleGeometry=function(e,t,r,i,a,o,u,f,s,c,d){n.assert("triangle"===e.getData().getFaces()[t].type),h(e.getBoundingInfo(t),u,f,c,d)},s.basicMaterialConstructor=function(e,t){var i=!0,a=0,o=s.__Material_idGen.gen(t);e.getId=function(){return o};var u;e.getParentStage=function(){return u},e.addParentStage=function(e){n.assert(void 0===u,"Material can only be added to a single Stage"),u=e},e.removeParentStage=function(){u=void 0},e.setVisible=function(t){i!==t&&(i=t,e.notifyDirty("matChanged"))},e.isVisible=function(){return i},e.notifyDirty=function(t){u&&u.notifyDirty(r.ContentType.MATERIAL,e,t)},e.setRenderPriority=function(e){a=e,this.notifyDirty("matChanged")},e.getRenderPriority=function(){return a}};var m=s.aquireIfNotUndefined=function(e,t,r,i){return void 0===e?void 0:r.aquire(e,t,i)},E=s.releaseIfNotUndefined=function(e,t){void 0!==e&&t.release(e)},R=u.create();return s.bindView=function(e,t,r){u.translate(t,e,R),r.uniformMatrix4fv("view",R)},s.bindCamPos=function(e,t,r){r.uniform3f("camPos",t[3]-e[0],t[7]-e[1],t[11]-e[2])},s.basicGLMaterialConstructor=function(e,t){var r=s.__GLMaterial_id++;e.getId=function(){return r},e.getMaterialId=function(){return t.getId()};var i=!0;e.isVisible=function(){return i},e.updateVisibility=function(){i=t.isVisible()},e.getRenderPriority=function(){return t.getRenderPriority()}},s.singleTextureGLMaterialConstructor=function(e,t,r,i){var n=m(r.textureId,r.initTexture,t,i);e.updateTexture=function(e){r.textureId!==e&&(E(r.textureId,t),r.textureId=e,n=m(r.textureId,r.initTexture,t,i))},e.renderTexture=function(e){var i=t.getTexture(r.textureId);i&&i.renderGl&&i.renderGl(n,e)},e.bindTexture=function(e,t){void 0!==n&&(t.uniform1i("tex",0),e.bindTexture(e.TEXTURE_2D,n))},e.dispose=function(){E(r.textureId,t)}},s.multiTextureGLMaterialConstructor=function(e,t,r,i){for(var n=i.length,a=new Array(n),o=0;n>o;o++)a[o]=m(r[i[o][0]],r[i[o][1]],t);e.updateTextures=function(e){for(var o=0;n>o;o++){var u=r[i[o][0]],f=e[i[o][0]];u!==f&&(E(u,t),r[i[o][0]]=f,a[o]=m(f,r[i[o][1]],t))}},e.bindTextures=function(e,t){for(var r=0;n>r;r++)void 0!==a[r]&&(t.uniform1i(i[r][2],r),e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,a[r]));e.activeTexture(e.TEXTURE0)},e.bindOneTexture=function(e,t,r){t.uniform1i(i[r][2],r),e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,a[r]),e.activeTexture(e.TEXTURE0)},e.disposeTextures=function(){for(var e=0;n>e;e++)E(r[i[e][0]],t)}},s});