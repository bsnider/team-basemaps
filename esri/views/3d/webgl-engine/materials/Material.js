// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/text!./Material.xml","./internal/MaterialUtil","../lib/GLSLProgram","../lib/GLSLShader","../lib/ShaderVariations","../lib/Util","../lib/gl-matrix","../lib/RenderSlot"],function(e,t,n,r,i,a,s,o,u){var d,l=s.assert,f=o.vec3,c=f.create(),h=function(e,t){n.basicMaterialConstructor(this,t),e=e||{},e.ambient=e.ambient||[.2,.2,.2],e.diffuse=e.diffuse||[.8,.8,.8],e.specular=e.specular||[0,0,0],e.shininess=e.shininess||10,e.opacity=void 0!==e.opacity?e.opacity:1,e.blendModeOneOne=e.blendModeOneOne||!1,e.inverseWindingOrder=e.inverseWindingOrder||!1,e.vertexColors=e.vertexColors||!1,e.flipV=e.flipV||!1,e.doubleSided=e.doubleSided||!1,e.cullFace=e.cullFace||void 0,e.instanced=e.instanced||!1,this.instanced=!!e.instanced,e.textureId||(e.reflTextureId=void 0);var r;r=e.textureId?e.atlasRegions?"PosNormTexRegion":"PosNormTex":"PosNorm",e.vertexColors&&(r+="Col");var i=n.Layouts[r],a=e.instanced?n.Layouts.ModelCol:null;e.instanced&&(a=e.instanced.indexOf("color")>-1?n.Layouts.ModelCol:n.Layouts.Model),this.dispose=function(){},this.getParams=function(){return e},this.getParameterValues=function(){var t={ambient:e.ambient,diffuse:e.diffuse,specular:e.specular,shininess:e.shininess,opacity:e.opacity,transparent:e.transparent,polygonOffset:e.polygonOffset,reflectivity:e.reflectivity,atlasRegions:e.atlasRegions,flipV:e.flipV,doubleSided:e.doubleSided,cullFace:e.cullFace};return e.textureId&&(t.textureId=e.textureId,t.initTexture=e.initTexture),t},this.setParameterValues=function(t){for(var n in t)"textureId"===n&&l(e.textureId,"Can only change texture of material that already has a texture"),e[n]=t[n];this.notifyDirty("matChanged")},this.getOutputAmount=function(e){return e*i.getStride()},this.getVertexBufferLayout=function(){return i},this.getInstanceBufferLayout=function(){return a},this.fillInterleaved=function(e,t,r,a,s,o,u){n.fillInterleaved(e,t,r,a,i,s,o,u)},this.intersect=n.intersectTriangleGeometry,this.getGLMaterials=function(){return{color:b,depthShadowMap:v,normal:m,depth:T,highlight:A}},this.getAllTextureIds=function(){var t=[];return e.textureId&&t.push(e.textureId),e.reflTextureId&&t.push(e.reflTextureId),t}};h.paramsFromOldConstructor=function(e,t,n,r,i,a,s,o,u,d,l,f,c){return{textureId:e,transparent:t,ambient:n,diffuse:r,specular:i,shininess:a,opacity:s,polygonOffset:o,initTexture:u,reflTextureId:d,reflectivity:l,flipV:f,doubleSided:c,cullFace:void 0}};var x=function(e){return e.cullFace?"none"!==e.cullFace:e.transparent?!1:!0},g=function(e,t){var n=x(t);e.web3DDefaultState.cullEnabled!==n&&(n?(e.enable(e.CULL_FACE),"front"===t.cullFace&&e.cullFace(e.FRONT)):e.disable(e.CULL_FACE))},p=function(e,t){var n=x(t);e.web3DDefaultState.cullEnabled!==n&&(n?(e.disable(e.CULL_FACE),"front"===t.cullFace&&e.cullFace(e.BACK)):e.enable(e.CULL_FACE))},b=function(t,r,i){function a(e){return e?u.TRANSPARENT_MATERIAL:u.OPAQUE_MATERIAL}n.basicGLMaterialConstructor(this,t);var s=e.clone(t.getParams()),o=a(s.transparent);n.singleTextureGLMaterialConstructor(this,i,s);var h=n.aquireIfNotUndefined(s.reflTextureId,s.reflInitTexture,i);l(!(s.atlasRegions&&s.reflTextureId),"Atlas texture with reflection is not yet supported");var x=s.textureId?s.atlasRegions?"AtlasTextured":"Textured":"none";this.instanced=d&&s.instanced;var b=!!this.instanced&&this.instanced.indexOf("color")>-1,T=r.shaderVariators.Material.getProgram([x,!!s.reflTextureId,s.vertexColors,s.flipV,s.doubleSided,!!this.instanced,b]),v=this.dispose;this.dispose=function(){v(),n.releaseIfNotUndefined(s.reflTextureId,i)},this.beginSlot=function(e){return o===e},this.getProgram=function(){return T},this.updateParameters=function(){var e=t.getParams();s.ambient=e.ambient,s.diffuse=e.diffuse,s.specular=e.specular,s.shininess=e.shininess,s.opacity=e.opacity,s.polygonOffset=e.polygonOffset,s.reflectivity=e.reflectivity,s.flipV=e.flipV,s.doubleSided=e.doubleSided,s.cullFace=e.cullFace,s.transparent!=e.transparent&&(o=a(e.transparent),s.transparent=e.transparent),s.initTexture=e.initTexture,this.updateTexture(e.textureId),e.atlasRegions&&(s.atlasRegions=e.atlasRegions),s.blendModeOneOne=e.blendModeOneOne,s.inverseWindingOrder=e.inverseWindingOrder},this.bind=function(e,n){T.use(),T.uniform3fv("ambient",s.ambient),T.uniform3fv("diffuse",s.diffuse),T.uniform3fv("specular",s.specular),T.uniform1f("shininess",s.shininess),T.uniform1f("opacity",s.opacity),n.shadowMap||T.uniform1f("depthHalfPixelSz",-1),this.bindTexture(e,T),void 0!==h&&(T.uniform1i("reflTex",1),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,h),e.activeTexture(e.TEXTURE0),T.uniform1f("reflectivity",s.reflectivity)),t.getVertexBufferLayout().enableVertexAttribArrays(e,T,!1),this.instanced&&t.getInstanceBufferLayout().enableVertexAttribArrays(e,T,n.extensions.angleInstancedArrays),s.inverseWindingOrder&&e.frontFace(e.CW),s.transparent&&(e.enable(e.BLEND),s.blendModeOneOne&&(e.blendFunc(e.ONE,e.ONE),e.depthMask(!1))),s.polygonOffset&&(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(2,2)),g(e,s)},this.release=function(e,n){s.polygonOffset&&e.disable(e.POLYGON_OFFSET_FILL),p(e,s),s.transparent&&(e.disable(e.BLEND),s.blendModeOneOne&&(e.blendFunc(e.web3DDefaultState.blendFuncSrc,e.web3DDefaultState.blendFuncDst),e.depthMask(!0))),s.inverseWindingOrder&&e.frontFace(e.CCW),t.getVertexBufferLayout().disableVertexAttribArrays(e,T,!1),this.instanced&&t.getInstanceBufferLayout().disableVertexAttribArrays(e,T,n.extensions.angleInstancedArrays)},this.bindView=function(e,t){var r=t.origin;n.bindView(r,t.view,T),n.bindCamPos(r,t.viewInvTransp,T),t.shadowMap&&t.shadowMap.bindView(T,r)},this.bindInstance=function(e,t){if(T.uniformMatrix4fv("model",t.transformation),T.uniformMatrix4fv("modelNormal",t.transformationNormal),b&&t.instanceParameters){var n=t.instanceParameters.color;n&&(f.multiply(s.ambient,n,c),T.uniform3fv("ambient",c),f.multiply(s.diffuse,n,c),T.uniform3fv("diffuse",c),T.uniform1f("opacity",s.opacity*n[3]))}},this.getDrawMode=function(e){return e.TRIANGLES}},T=function(t,r,i,a){n.basicGLMaterialConstructor(this,t);var s=e.clone(t.getParams()),o=r.get(null!=a?t.getVertexBufferLayout().hasAttribute("uv0")?"depthTexturedShadowMap":"depthShadowMap":t.getVertexBufferLayout().hasAttribute("uv0")?"depthTextured":"depth"),d=s.transparent?u.TRANSPARENT_MATERIAL:u.OPAQUE_MATERIAL;n.singleTextureGLMaterialConstructor(this,i,s),this.beginSlot=function(e){return d===e},this.getProgram=function(){return o},this.updateParameters=function(){var e=t.getParams();s.initTexture=e.initTexture,s.cullFace=e.cullFace,s.inverseWindingOrder=e.inverseWindingOrder,this.updateTexture(e.textureId)},this.bind=function(e,n){o.use(),o.uniform2fv("nearFar",n.nearFar),s.inverseWindingOrder&&e.frontFace(e.CW),this.bindTexture(e,o),t.getVertexBufferLayout().enableVertexAttribArrays(e,o),g(e,s)},this.release=function(e){p(e,s),s.inverseWindingOrder&&e.frontFace(e.CCW),t.getVertexBufferLayout().disableVertexAttribArrays(e,o)},this.bindView=function(e,t){n.bindView(t.origin,t.view,o)},this.bindInstance=function(e,t){o.uniformMatrix4fv("model",t.transformation)},this.getDrawMode=function(e){return e.TRIANGLES}},v=function(e,t,n){T.call(this,e,t,n,!0)},m=function(t,r,i){n.basicGLMaterialConstructor(this,t);var a=e.clone(t.getParams()),s=r.get(t.getVertexBufferLayout().hasAttribute("uv0")?"normalTextured":"normal"),o=a.transparent?u.TRANSPARENT_MATERIAL:u.OPAQUE_MATERIAL;n.singleTextureGLMaterialConstructor(this,i,a),this.beginSlot=function(e){return o===e},this.getProgram=function(){return s},this.updateParameters=function(){var e=t.getParams();a.initTexture=e.initTexture,a.cullFace=e.cullFace,a.inverseWindingOrder=e.inverseWindingOrder,this.updateTexture(e.textureId)},this.bind=function(e,n){s.use(),this.bindTexture(e,s),s.uniformMatrix4fv("viewNormal",n.viewInvTransp),t.getVertexBufferLayout().enableVertexAttribArrays(e,s),g(e,a),a.inverseWindingOrder&&e.frontFace(e.CW)},this.release=function(e){p(e,a),a.inverseWindingOrder&&e.frontFace(e.CCW),t.getVertexBufferLayout().disableVertexAttribArrays(e,s)},this.bindView=function(e,t){n.bindView(t.origin,t.view,s)},this.bindInstance=function(e,t){s.uniformMatrix4fv("model",t.transformation),s.uniformMatrix4fv("modelNormal",t.transformationNormal)},this.getDrawMode=function(e){return e.TRIANGLES}},A=function(t,r,i){n.basicGLMaterialConstructor(this,t);var a=e.clone(t.getParams()),s=r.get(t.getVertexBufferLayout().hasAttribute("uv0")?"highlightTextured":"highlight"),o=u.OPAQUE_MATERIAL;n.singleTextureGLMaterialConstructor(this,i,a),this.beginSlot=function(e){return o===e},this.getProgram=function(){return s},this.updateParameters=function(){var e=t.getParams();a.initTexture=e.initTexture,a.cullFace=e.cullFace,a.inverseWindingOrder=e.inverseWindingOrder,this.updateTexture(e.textureId)},this.bind=function(e){s.use(),this.bindTexture(e,s),t.getVertexBufferLayout().enableVertexAttribArrays(e,s),g(e,a),a.inverseWindingOrder&&e.frontFace(e.CW)},this.release=function(e){p(e,a),a.inverseWindingOrder&&e.frontFace(e.CCW),t.getVertexBufferLayout().disableVertexAttribArrays(e,s)},this.bindView=function(e,t){n.bindView(t.origin,t.view,s)},this.bindInstance=function(e,t){s.uniformMatrix4fv("model",t.transformation),s.uniformMatrix4fv("modelNormal",t.transformationNormal)},this.getDrawMode=function(e){return e.TRIANGLES}};return h.loadShaders=function(e,n,s,o){e._parse(t),o.getExtension("OES_standard_derivatives"),d=o.getExtension("ANGLE_instanced_arrays");var u=new a("phong",["vsPhong","fsPhong"],null,s,n,e,o);u.addNaryShaderSnippetSuffix([{value:"none",programNameSuffix:"",shaderSnippetSuffix:""},{value:"Textured"},{value:"AtlasTextured"}]),u.addBinaryShaderSnippetSuffix("Refl","Refl",[!1,!0]),u.addDefine("Color","VERTEXCOLORS"),u.addDefine("FlipV","FLIPV"),u.addDefine("DoubleSided","DOUBLESIDED"),u.addDefine("Instanced","INSTANCED"),u.addDefine("InstColor","INSTANCEDCOLOR"),s.shaderVariators.Material=u;var l=new i(o.VERTEX_SHADER,e.vsDepth,o),f=new i(o.VERTEX_SHADER,e.vsDepthTextured,o),c=new i(o.VERTEX_SHADER,e.vsNormal,o),h=new i(o.VERTEX_SHADER,e.vsNormalTextured,o),x=new i(o.VERTEX_SHADER,e.vsHighlight,o),g=new i(o.VERTEX_SHADER,e.vsHighlightTextured,o),p=new i(o.FRAGMENT_SHADER,e.fsDepth,o,["BIAS_SHADOWMAP 1"]),b=new i(o.FRAGMENT_SHADER,e.fsDepthTextured,o,["BIAS_SHADOWMAP 1"]),T=new i(o.FRAGMENT_SHADER,e.fsDepth,o),v=new i(o.FRAGMENT_SHADER,e.fsDepthTextured,o),m=new i(o.FRAGMENT_SHADER,e.fsNormal,o),A=new i(o.FRAGMENT_SHADER,e.fsNormalTextured,o),E=new i(o.FRAGMENT_SHADER,e.fsHighlight,o),S=new i(o.FRAGMENT_SHADER,e.fsHighlightTextured,o),y=new r([l,p],o),L=new r([f,b],o),M=new r([l,T],o),R=new r([f,v],o),O=new r([c,m],o),I=new r([h,A],o),w=new r([x,E],o),D=new r([g,S],o);s.add("depthShadowMap",y),s.add("depthTexturedShadowMap",L),s.add("depth",M),s.add("depthTextured",R),s.add("normal",O),s.add("normalTextured",I),s.add("highlight",w),s.add("highlightTextured",D),n.add("fsDepth",T),n.add("fsDepthTextured",v),n.add("fsDepthShadowMap",p),n.add("fsDepthTexturedShadowMap",b),n.add("vsDepth",l),n.add("fsNormal",m)},h});