// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/text!./RibbonLineMaterial.xml","./internal/MaterialUtil","../lib/VertexBufferLayout","../lib/GLSLProgram","../lib/GLSLShader","../lib/Util","../lib/gl-matrix","../lib/webglConstants","../lib/RenderSlot"],function(t,e,i,r,n,a,o,s,l,c){function f(t,e,i,r,n,a){var o=t.length/3,s=t[0],l=t[1],c=t[2],f=0;r&&(s=r[0]*s+r[4]*l+r[8]*c+r[12],l=r[1]*s+r[5]*l+r[9]*c+r[13],c=r[2]*s+r[6]*l+r[10]*c+r[14]);var u=s,d=l,L=c,b=t[3],m=t[4],h=t[5];r&&(b=r[0]*b+r[4]*m+r[8]*h+r[12],m=r[1]*b+r[5]*m+r[9]*h+r[13],h=r[2]*b+r[6]*m+r[10]*h+r[14]);for(var p=0;o>p;p++){var v=3*p;o-1>p&&(b=t[v+3],m=t[v+4],h=t[v+5],r&&(b=r[0]*b+r[4]*m+r[8]*h+r[12],m=r[1]*b+r[5]*m+r[9]*h+r[13],h=r[2]*b+r[6]*m+r[10]*h+r[14])),f+=Math.sqrt((u-s)*(u-s)+(d-l)*(d-l)+(L-c)*(L-c)),n[a++]=u,n[a++]=d,n[a++]=L,n[a++]=f,n[a++]=0===p?-1.2:-1,n[a++]=s,n[a++]=l,n[a++]=c,n[a++]=b,n[a++]=m,n[a++]=h,n[a++]=e[0],n[a++]=e[1],n[a++]=e[2],n[a++]=e[3],n[a++]=i[0],n[a++]=u,n[a++]=d,n[a++]=L,n[a++]=f,n[a++]=0===p?1.2:1,n[a++]=s,n[a++]=l,n[a++]=c,n[a++]=b,n[a++]=m,n[a++]=h,n[a++]=e[0],n[a++]=e[1],n[a++]=e[2],n[a++]=e[3],n[a++]=i[0],p>0&&o-1>p&&(n[a++]=u,n[a++]=d,n[a++]=L,n[a++]=f,n[a++]=-1.2,n[a++]=s,n[a++]=l,n[a++]=c,n[a++]=b,n[a++]=m,n[a++]=h,n[a++]=e[0],n[a++]=e[1],n[a++]=e[2],n[a++]=e[3],n[a++]=i[0],n[a++]=u,n[a++]=d,n[a++]=L,n[a++]=f,n[a++]=1.2,n[a++]=s,n[a++]=l,n[a++]=c,n[a++]=b,n[a++]=m,n[a++]=h,n[a++]=e[0],n[a++]=e[1],n[a++]=e[2],n[a++]=e[3],n[a++]=i[0]),s=u,l=d,c=L,u=b,d=m,L=h}}function u(t,e,i,r){for(var n,a,o,s=t.length/3,l=0,c=t[0],f=t[1],u=t[2],d=0;s>d;d++){var L=3*d;n=c,a=f,o=u,c=t[L],f=t[L+1],u=t[L+2],e&&(c=e[0]*c+e[4]*f+e[8]*u+e[12],f=e[1]*c+e[5]*f+e[9]*u+e[13],u=e[2]*c+e[6]*f+e[10]*u+e[14]),l+=Math.sqrt((c-n)*(c-n)+(f-a)*(f-a)+(u-o)*(u-o)),i[r++]=c,i[r++]=f,i[r++]=u,i[r++]=l,i[r++]=-1,i[r++]=c,i[r++]=f,i[r++]=u,i[r++]=l,i[r++]=1}}var d=[255,255,255,255],L=[0,0,0,0],b=s.vec3d,m=s.vec2d,h=s.mat4d,p=b.create(),v=b.create(),g=b.create(),A=b.create(),O=m.create(),w=m.create(),E=b.create(),S=b.create(),y=function(t,e){i.basicMaterialConstructor(this,e);var n=o.VertexAttrConstants;t=t||{},t.color=t.color||[1,1,1,1],t.width=t.width||0,t.type=t.type||"screen",t.join=t.join||"miter",t.miterLimit="miter"===t.join?t.miterLimit||5:t.miterLimit;var a="wall"===t.type?2:4,s=2,c="wall"===t.type?new r([n.POSITION,n.UV0],[3,2]):new r([n.POSITION,n.UV0,n.AUXPOS1,n.AUXPOS2,n.COLOR,n.SIZE],[3,2,3,3,4,1],[l.FLOAT,l.FLOAT,l.FLOAT,l.FLOAT,l.FLOAT,l.FLOAT]);this.canBeMerged=!1,this.getParams=function(){return t},this.getParameterValues=function(){var e={color:t.color,width:t.width,type:t.type,join:t.join,polygonOffset:t.polygonOffset};return"miter"===t.join&&(e.miterLimit=t.miterLimit),e},this.setParameterValues=function(e){for(var i in e)e.hasOwnProperty(i)&&(o.assert("type"!==i,"RibbonLineMaterial: type cannot be changed after creation"),t[i]=e[i]);this.notifyDirty("matChanged")},this.dispose=function(){},this.getOutputAmount=function(t){var e=t/2+1,i=(e-2)*a+2*s;return i*c.getStride()},this.getVertexBufferLayout=function(){return c},this.fillInterleaved=function(e,i,r,a,o,s){var l=e.vertexAttr[n.POSITION].data,c=e.vertexAttr[n.COLOR]?e.vertexAttr[n.COLOR].data:d,b=e.vertexAttr[n.SIZE]?e.vertexAttr[n.SIZE].data:L,m=e.faces&&e.faces.indices&&e.faces.indices.position;m&&m.length!=2*(l.length/3-1)&&console.warn("RibbonLineMaterial does not support indices"),"wall"===t.type?u(l,i,o,s):f(l,c,b,i,o,s)},this.intersect=function(e,i,r,a,s,l,c,f,u,d,L,m){if(m){for(var y,R,P,V,x=e.getData().getVertexAttr(n.position).position.data,T=e.getData().getVertexAttr(n.SIZE).size,_=T&&T.data[0],M=_+t.width,I=Number.MAX_VALUE,D=0;D<x.length-5;D+=3){if(p[0]=x[D],p[1]=x[D+1],p[2]=x[D+2],h.multiplyVec3(r,p),v[0]=x[D+3],v[1]=x[D+4],v[2]=x[D+5],h.multiplyVec3(r,v),u.projectPoint(p,O),u.projectPoint(v,w),O[2]<0&&w[2]>0)b.subtract(p,v,g),R=u.frustumPlanes,P=-(b.dot(R[4],p)+R[4][3]),V=P/b.dot(g,R[4]),b.scale(g,V,g),b.add(p,g,p),u.projectPoint(p,O);else if(O[2]>0&&w[2]<0)b.subtract(v,p,g),R=u.frustumPlanes,P=-(b.dot(R[4],v)+R[4][3]),V=P/b.dot(g,R[4]),b.scale(g,V,g),b.add(v,g,v),u.projectPoint(v,w);else if(O[2]<0&&w[2]<0)continue;var j=o.projectVectorVector2D(O,w,a);I>j&&(I=j,y=D,b.set(p,E),b.set(v,S))}var F=4;if(M/2+F>I){var C=o.linelineDistance3D(E,S,s,l),N=Number.MAX_VALUE;if(C[0]){var U=C[2];b.subtract(U,s,A);var G=b.length(A);N=.98*G/b.dist(s,l)}L(N,A)}}},this.getGLMaterials=function(){return{color:R,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:void 0}},this.getAllTextureIds=function(){return[]}},R=function(e,r){i.basicGLMaterialConstructor(this,e);var n=t.clone(e.getParams());n.miterLimit="miter"===n.join?n.miterLimit:0,delete n.join;var a=r.get("ribbonLine_"+n.type);this.updateParameters=function(){var t=e.getParams();n.polygonOffset=t.polygonOffset,n.color=t.color,n.width=t.width,n.miterLimit="miter"===t.join?t.miterLimit:0},this.beginSlot=function(t){return t===c.TRANSPARENT_MATERIAL},this.getProgram=function(){return a},this.bind=function(t,i){a.use(),a.uniform4fv("eColor",n.color),a.uniform1f("miterLimit",n.miterLimit),a.uniform1f("nearPlane",i.nearFar[0]),"screen"===n.type?(a.uniform2fv("screenSize",[i.viewport[2],i.viewport[3]]),a.uniform1f("extLineWidth",n.width*i.pixelRatio)):a.uniform1f("extLineWidth",n.width),e.getVertexBufferLayout().enableVertexAttribArrays(t,a),n.polygonOffset&&(t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,-4)),t.enable(t.BLEND),t.web3DDefaultState.cullEnabled&&t.disable(t.CULL_FACE),n.color[3]<1&&t.depthMask(!1)},this.release=function(t){e.getVertexBufferLayout().disableVertexAttribArrays(t,a),n.polygonOffset&&t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.BLEND),t.web3DDefaultState.cullEnabled&&t.enable(t.CULL_FACE),t.depthMask(!0)},this.bindView=function(t,e){i.bindView(e.origin,e.view,a)},this.bindInstance=function(t,e){a.uniformMatrix4fv("model",e.transformation)},this.getDrawMode=function(t){return t.TRIANGLE_STRIP}};return y.loadShaders=function(t,i,r,o){t._parse(e);var s=new a(o.VERTEX_SHADER,t.vsRibbonLine,o,["SCREENSCALE"]),l=new a(o.VERTEX_SHADER,t.vsRibbonLine,o),c=new a(o.VERTEX_SHADER,t.vsRibbonLine,o,["WALL"]),f=new a(o.FRAGMENT_SHADER,t.fsRibbonLine,o),u=new n([s,f],o),d=new n([l,f],o),L=new n([c,f],o);r.add("ribbonLine_screen",u),r.add("ribbonLine_strip",d),r.add("ribbonLine_wall",L)},y});