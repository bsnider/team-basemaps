// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/text!./HUDMaterial.xml","./internal/MaterialUtil","../lib/GLSLProgram","../lib/GLSLShader","../lib/ShaderVariations","../lib/VertexBufferLayout","../lib/Util","../lib/gl-matrix","../lib/webglConstants","../lib/RenderSlot"],function(e,t,r,i,n,o,a,l,s,f,u){var c=s.vec2d,d=s.vec3d,h=s.mat4d,x=l.assert,S=l.VertexAttrConstants,g={"bottom-left":[0,0],bottom:[.5,0],"bottom-right":[1,0],left:[0,.5],center:[.5,.5],right:[1,.5],"top-left":[0,1],top:[.5,1],"top-right":[1,1]},v=function(e,t){r.basicMaterialConstructor(this,t),e=e||null,e.texCoordScale=e.texCoordScale||[1,1],e.occlusionTest=void 0!==e.occlusionTest?e.occlusionTest:!0,e.color=e.color||[1,1,1,1],e.screenMinMaxSize=e.screenMinMaxSize||[0,1e5],e.outlineColor=e.outlineColor||[1,1,1,1],e.outlineSize=e.outlineSize||0,e.textureIsSignedDistanceField=e.textureIsSignedDistanceField?1:0,e.distanceFieldBoundingBox=e.distanceFieldBoundingBox||[.25,.25,.75,.75],e.screenOffset?e.screenOffset.forEach(function(t,r){e.screenOffset[r]=2*t}):e.screenOffset=[0,0],"string"==typeof e.anchorPos?(x(g[e.anchorPos],"HUDMaterial: invalid anchorPos specified"),e.anchorPos=g[e.anchorPos]):e.anchorPos||(e.anchorPos=g.center),null==e.shaderPolygonOffset&&(e.shaderPolygonOffset=1e-5);var i=new a([S.POSITION,S.NORMAL,S.UV0,S.COLOR,S.SIZE,S.AUXPOS1],[3,3,2,4,2,4],[f.FLOAT,f.FLOAT,f.FLOAT,f.UNSIGNED_BYTE,f.FLOAT,f.FLOAT]),n=i.getStride(),o=4*n;this.dispose=function(){},this.getParameterValues=function(){var t={color:e.color,texCoordScale:e.texCoordScale,polygonOffset:e.polygonOffset,anchorPos:e.anchorPos,screenOffset:e.screenOffset,screenMinMaxSize:e.screenMinMaxSize,shaderPolygonOffset:e.shaderPolygonOffset,textureIsSignedDistanceField:e.textureIsSignedDistanceField,outlineColor:e.outlineColor,outlineSize:e.outlineSize,distanceFieldBoundingBox:e.distanceFieldBoundingBox};return e.textureId&&(t.textureId=e.textureId),e.direction&&(t.direction=e.direction),t},this.setParameterValues=function(t){for(var r in t)"textureId"===r&&x(e.textureId,"Can only change texture of material that already has a texture"),"direction"===r&&x(e.direction,"Can only change direction of HUDMaterial which was initialized with a direction"),e[r]=t[r];this.notifyDirty("matChanged")},this.getParams=function(){return e},this.getOutputAmount=function(e){return e*n*6},this.getVertexBufferLayout=function(){return i},this.fillInterleaved=function(t,a,l,s,f,u){for(var c=r.fill,d=i.getAttributes(),h=t.faces.indices[S.POSITION],x=t.vertexAttr[S.POSITION].data,g=u+d[S.POSITION].offset,v=0;v<h.length;++v){var O=3*h[v];c(x,O,f,g,a,3),g+=n,c(x,O,f,g,a,3),g+=n,c(x,O,f,g,a,3),g+=n,c(x,O,f,g,a,3),g+=n,c(x,O,f,g,a,3),g+=n,c(x,O,f,g,a,3),g+=n}var m=t.faces.indices[S.NORMAL],T=t.vertexAttr[S.NORMAL].data;for(g=u+d[S.NORMAL].offset,v=0;v<m.length;++v)O=3*m[v],c(T,O,f,g,l,3),g+=n,c(T,O,f,g,l,3),g+=n,c(T,O,f,g,l,3),g+=n,c(T,O,f,g,l,3),g+=n,c(T,O,f,g,l,3),g+=n,c(T,O,f,g,l,3),g+=n;g=u+d[S.UV0].offset;var b=t.vertexAttr[S.UV0].data;if(null==b||b.length<=3)var P=0,D=0,L=e.texCoordScale[0],A=e.texCoordScale[1];else P=t.vertexAttr[S.UV0].data[0],D=t.vertexAttr[S.UV0].data[1],L=t.vertexAttr[S.UV0].data[2],A=t.vertexAttr[S.UV0].data[3];for(L=Math.min(1.99999,L+1),A=Math.min(1.99999,A+1),v=0;v<h.length;++v)f[g]=P,f[g+1]=D,g+=n,f[g]=L,f[g+1]=D,g+=n,f[g]=L,f[g+1]=A,g+=n,f[g]=L,f[g+1]=A,g+=n,f[g]=P,f[g+1]=A,g+=n,f[g]=P,f[g+1]=D,g+=n;var E=t.faces.indices[S.COLOR],p=t.vertexAttr[S.COLOR].data;g=4*(u+d[S.COLOR].offset);var C=new Uint8Array(f.buffer);for(v=0;v<E.length;++v)O=4*E[v],c(p,O,C,g,null,4),g+=o,c(p,O,C,g,null,4),g+=o,c(p,O,C,g,null,4),g+=o,c(p,O,C,g,null,4),g+=o,c(p,O,C,g,null,4),g+=o,c(p,O,C,g,null,4),g+=o;var I=t.faces.indices[S.SIZE],y=t.vertexAttr[S.SIZE].data;for(g=u+d[S.SIZE].offset,v=0;v<I.length;++v){var M=y[2*I[v]],F=y[2*I[v]+1];f[g]=M,f[g+1]=F,g+=n,f[g]=M,f[g+1]=F,g+=n,f[g]=M,f[g+1]=F,g+=n,f[g]=M,f[g+1]=F,g+=n,f[g]=M,f[g+1]=F,g+=n,f[g]=M,f[g+1]=F,g+=n}if(null!=t.faces.indices[S.AUXPOS1]&&null!=t.vertexAttr[S.AUXPOS1]){var w=t.faces.indices[S.AUXPOS1],V=t.vertexAttr[S.AUXPOS1].data;for(g=u+d.auxpos1.offset,v=0;v<w.length;++v)O=4*w[v],c(V,O,f,g,null,4),g+=n,c(V,O,f,g,null,4),g+=n,c(V,O,f,g,null,4),g+=n,c(V,O,f,g,null,4),g+=n,c(V,O,f,g,null,4),g+=n,c(V,O,f,g,null,4),g+=n}};var l=d.create(),s=d.create(),u=1,c=[0,0];this.intersect=function(t,r,i,n,o,a,f,g,v,O,m,T){if(T){var b=t.getData().getVertexAttr()[S.POSITION],P=t.getData().getVertexAttr()[S.SIZE];x(b.size>=3);for(var D=0;D<b.data.length/b.size;D++){var L=D*b.size;d.set3(b.data[L],b.data[L+1],b.data[L+2],l),h.multiplyVec3(i,l,l);var A=D*P.size;if(c[0]=P.data[A],c[1]=P.data[A+1],v.projectPoint(l,s),s[0]>-1){var E=s[0],p=s[1],C=e.anchorPos,I=E-u-(C[0]>0?c[0]*C[0]:0),y=I+c[0],M=p-u-(C[1]>0?c[1]*C[1]:0),F=M+c[1];if(e.textureIsSignedDistanceField){var w=e.distanceFieldBoundingBox,V=e.outlineSize/2;I+=c[0]*w[0]-V,y-=c[0]*(1-w[2])-V,M+=c[1]*w[1]-V,F-=c[1]*(1-w[3])-V}if(n[0]>I&&n[0]<y&&n[1]>M&&n[1]<F){var U=d.subtract(o,l,d.create()),_=d.length(U);d.scale(U,1/_);var R=.98*_/d.dist(o,a);m(R,U,-1,1,!0)}}}}},this.getGLMaterials=function(){return{color:O,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:m}},this.getAllTextureIds=function(){return[e.textureId]},this._textureDirty=!1,this.setTextureDirty=function(){this._textureDirty=!0}},O=function(t,i,n){function o(){return i.shaderVariators.HUDMaterial.getProgram([!!f.direction,!!f.worldScale,f.occlusionTest,f.textureIsSignedDistanceField])}r.basicGLMaterialConstructor(this,t);var a=u.TRANSPARENT_MATERIAL,l=u.OVERLAY,s=0,f=e.clone(t.getParams()),d=i.get("hudOcclusionTestPixel"),h=o();r.singleTextureGLMaterialConstructor(this,n,f);var x=[254/255,253/255,252/255];this.beginSlot=function(e){return s=e,f.occlusionTest?e===a||e==l:e===a},this.getProgram=function(){return s===a&&f.occlusionTest?d:h},this.getAllPrograms=function(){return[d,h]},this.updateParameters=function(){var e=t.getParams();f.color=e.color,f.texCoordScale=e.texCoordScale,f.polygonOffset=e.polygonOffset,f.anchorPos=e.anchorPos,f.screenOffset=e.screenOffset,f.screenMinMaxSize=e.screenMinMaxSize,f.direction=e.direction,f.shaderPolygonOffset=e.shaderPolygonOffset,f.textureIsSignedDistanceField=e.textureIsSignedDistanceField,f.outlineColor=e.outlineColor,f.outlineSize=e.outlineSize,this.updateTexture(e.textureId),h=o()},this.bind=function(e,r){if(t._textureDirty&&(this.renderTexture(e),t._textureDirty=!1),s===a&&f.occlusionTest)d.use(),d.uniform1f("polygonOffset",f.shaderPolygonOffset),d.uniform4fv("viewport",r.viewport),d.uniform4f("color",x[0],x[1],x[2],1),t.getVertexBufferLayout().enableVertexAttribArrays(e,d),e.depthFunc(e.LEQUAL);else{if(h.use(),this.bindTexture(e,h),h.uniform1i("framebufferTex",1),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,r.framebufferTex),e.activeTexture(e.TEXTURE0),h.uniform3fv("markerColor",x),h.uniform4fv("viewport",r.viewport),h.uniform4fv("overrideColor",f.color),h.uniform1f("pixelRatio",r.pixelRatio),h.uniform1f("polygonOffset",f.shaderPolygonOffset),f.textureIsSignedDistanceField&&(h.uniform4fv("outlineColor",f.outlineColor),h.uniform1f("outlineSize",f.outlineSize)),f.worldScale){var i=[-1,-1],n=f.screenMinMaxSize,o=r.proj,l=r.viewport[2]/r.pixelRatio;if(n)if(0!==o[11]){var u=2*Math.atan(1/o[0]),S=Math.tan(u/2)/l*2;i[0]=n[0]*S,i[1]=n[1]*S}else{var g=2/(o[0]*l);c.scale(n,g,i)}h.uniform2fv("minMaxWorldSizeFactor",i)}f.direction&&h.uniform3fv("direction",f.direction),h.uniform2fv("texScale",f.texCoordScale),h.uniform2fv("screenOffset",f.screenOffset),h.uniform2fv("anchorPos",f.anchorPos),t.getVertexBufferLayout().enableVertexAttribArrays(e,h),f.polygonOffset&&(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,-4)),e.web3DDefaultState.cullEnabled&&e.disable(e.CULL_FACE),e.enable(e.BLEND)}},this.release=function(e){s===a&&f.occlusionTest?(e.depthFunc(e.LESS),t.getVertexBufferLayout().disableVertexAttribArrays(e,d)):(f.polygonOffset&&e.disable(e.POLYGON_OFFSET_FILL),e.web3DDefaultState.cullEnabled&&e.enable(e.CULL_FACE),e.disable(e.BLEND),t.getVertexBufferLayout().disableVertexAttribArrays(e,h))},this.bindView=function(e,t){var i=t.origin;s===a&&f.occlusionTest?(r.bindView(i,t.view,d),r.bindCamPos(i,t.viewInvTransp,d)):(r.bindView(i,t.view,h),r.bindCamPos(i,t.viewInvTransp,h))},this.bindInstance=function(e,t){s===a&&f.occlusionTest?(d.uniformMatrix4fv("model",t.transformation),d.uniformMatrix4fv("modelNormal",t.transformationNormal)):h.uniformMatrix4fv("model",t.transformation)},this.getDrawMode=function(e){return s===a&&f.occlusionTest?e.POINTS:e.TRIANGLES}},m=function(t,i,n){function o(){return i.shaderVariators.HUDMaterialHighlight.getProgram([!!a.direction,!!a.worldScale,a.occlusionTest,a.textureIsSignedDistanceField])}r.basicGLMaterialConstructor(this,t);var a=e.clone(t.getParams()),l=i.get("hudOcclusionTestPixel"),s=o();r.singleTextureGLMaterialConstructor(this,n,a);var f=[254/255,253/255,252/255];this.beginSlot=function(e){return e===u.OVERLAY},this.getProgram=function(){return s},this.getAllPrograms=function(){return[l,s]},this.updateParameters=function(){var e=t.getParams();a.color=e.color,a.texCoordScale=e.texCoordScale,a.polygonOffset=e.polygonOffset,a.anchorPos=e.anchorPos,a.screenOffset=e.screenOffset,a.screenMinMaxSize=e.screenMinMaxSize,a.direction=e.direction,a.shaderPolygonOffset=e.shaderPolygonOffset,a.textureIsSignedDistanceField=e.textureIsSignedDistanceField,a.outlineColor=e.outlineColor,a.outlineSize=e.outlineSize,this.updateTexture(e.textureId),s=o()},this.bind=function(e,r){if(t._textureDirty&&(this.renderTexture(e),t._textureDirty=!1),s.use(),this.bindTexture(e,s),s.uniform1i("framebufferTex",1),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,r.framebufferTex),e.activeTexture(e.TEXTURE0),s.uniform3fv("markerColor",f),s.uniform4fv("viewport",r.viewport),s.uniform4fv("overrideColor",a.color),s.uniform1f("pixelRatio",r.pixelRatio),s.uniform1f("polygonOffset",a.shaderPolygonOffset),a.textureIsSignedDistanceField&&(s.uniform4fv("outlineColor",a.outlineColor),s.uniform1f("outlineSize",a.outlineSize)),a.worldScale){var i=[-1,-1],n=a.screenMinMaxSize,o=r.proj,l=r.viewport[2]/r.pixelRatio;if(n)if(0!==o[11]){var u=2*Math.atan(1/o[0]),d=Math.tan(u/2)/l*2;i[0]=n[0]*d,i[1]=n[1]*d}else{var h=2/(o[0]*l);c.scale(n,h,i)}s.uniform2fv("minMaxWorldSizeFactor",i)}a.direction&&s.uniform3fv("direction",a.direction),s.uniform2fv("texScale",a.texCoordScale),s.uniform2fv("screenOffset",a.screenOffset),s.uniform2fv("anchorPos",a.anchorPos),t.getVertexBufferLayout().enableVertexAttribArrays(e,s),a.polygonOffset&&(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,-4)),e.web3DDefaultState.cullEnabled&&e.disable(e.CULL_FACE),e.enable(e.BLEND)},this.release=function(e){a.polygonOffset&&e.disable(e.POLYGON_OFFSET_FILL),e.web3DDefaultState.cullEnabled&&e.enable(e.CULL_FACE),e.disable(e.BLEND),t.getVertexBufferLayout().disableVertexAttribArrays(e,s)},this.bindView=function(e,t){var i=t.origin;r.bindView(i,t.view,s),r.bindCamPos(i,t.viewInvTransp,s)},this.bindInstance=function(e,t){s.uniformMatrix4fv("model",t.transformation)},this.getDrawMode=function(e){return e.TRIANGLES}};return v.loadShaders=function(e,r,a,l){e._parse(t);var s=l.getParameter(l.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0,f=new o("hud",["vertexShaderHUD","fragmentShaderHUD"],null,a,r,e,l);f.addBinaryShaderSnippetSuffix("Direction","Direction",[!0,!1]),f.addBinaryShaderSnippetSuffix("WorldScale","WorldScale",[!0,!1]),f.addDefine("OcclTest",s?"OCCL_TEST":"OCCL_PIXELSHADER"),f.addDefine("SDF","SIGNED_DISTANCE_FIELD"),a.shaderVariators.HUDMaterial=f;var u=new o("hudHighlight",["vertexShaderHUD","fragmentShaderHUDHighlight"],null,a,r,e,l);u.addBinaryShaderSnippetSuffix("Direction","Direction",[!0,!1]),u.addBinaryShaderSnippetSuffix("WorldScale","WorldScale",[!0,!1]),u.addDefine("OcclTest",s?"OCCL_TEST":"OCCL_PIXELSHADER"),u.addDefine("SDF","SIGNED_DISTANCE_FIELD"),a.shaderVariators.HUDMaterialHighlight=u;var c=new n(l.VERTEX_SHADER,e.vertexShaderOcclusionTestPixel,l),d=new n(l.FRAGMENT_SHADER,e.fragmentShaderSimple,l),h=new i([c,d],l);a.add("hudOcclusionTestPixel",h)},v});