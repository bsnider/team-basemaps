// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/text!./LeafCardMaterial.xml","./internal/MaterialUtil","../lib/VertexBufferLayout","../lib/GLSLProgram","../lib/GLSLShader","../lib/Util","../lib/gl-matrix","../lib/RenderSlot"],function(t,e,r,a,i,n,o,s){var u=o.vec3,f=o.mat4,d=o.mat4d,c=n.VertexAttrConstants,h=function(t,a,i,o,s,h){function b(){return 2*Math.random()-1}e.basicMaterialConstructor(this,h);var M=new r([c.POSITION,c.NORMAL,c.UV0],[3,4,4]),g=M.getStride(),A=1,x=1,p=!0,L=!0,S=.8,V=.2,T=!0,w=.1;this.getAmbient=function(){return a},this.getDiffuse=function(){return i},this.getSpecular=function(){return o},this.getShininess=function(){return s},this.dispose=function(){},this.getTextureId=function(){return t},this.getOutputAmount=function(t){var e,r=0;for(e=0;t/6>e;e++)e%A===0&&(r+=6);for(t=r,r=0,e=0;t/6>e;e++)e%x===0&&(r+=6);return r*g},this.getVertexBufferLayout=function(){return M},this.reduce=function(t,e){for(var r=t.position,a=t.normal,i=t.uv0,n=[],o=[],s=[],u=0,f=0;f<r.length/6;f++)if(f%e===0)for(var d=0;6>d;d++)n[u]=r[6*f+d],o[u]=a[6*f+d],s[u]=i[6*f+d],u++;return{position:n,normal:o,uv0:s}},this.fillInterleaved=function(t,r,a,i,o,s){var c=e.fill,h=this.reduce(t.faces.indices,A);h=this.reduce(h,x);var l=this.getOutputAmount(t.faces.indices.position.length);n.assert(l===h.position.length*g);for(var v=h.position,m=h.normal,M=h.uv0,E=t.vertexAttr.position.data,C=t.vertexAttr.normal.data,I=t.vertexAttr.uv0.data,N=0,R=u.create(),y=v.length/6,D=s,_=u.createFrom(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),G=u.createFrom(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),U=0;y>U;++U){for(var P=u.create(),X=u.create(),q=[100,100,-100,-100],B=u.create(),k=0;6>k;++k){var F=6*U+k,O=3*v[F],H=3*m[F],z=2*M[F];P[0]+=E[O+0],P[1]+=E[O+1],P[2]+=E[O+2],X[0]+=C[H+0],X[1]+=C[H+1],X[2]+=C[H+2];var j=I[z+0],J=I[z+1];q[0]=Math.min(q[0],j),q[1]=Math.min(q[1],J),q[2]=Math.max(q[2],j),q[3]=Math.max(q[3],J),0===k&&u.set3(E[O+0],E[O+1],E[O+2],B)}P[0]/=6,P[1]/=6,P[2]/=6,X[0]/=6,X[1]/=6,X[2]/=6,T&&(P[0]+=b()*w,P[1]+=b()*w,P[2]+=b()*w),void 0!==r&&(d.multiplyVec3(r,B,B),d.multiplyVec3(r,P,P),d.multiplyVec3(a,X,X)),u.add(P,R,R),u.max(_,P,_),u.min(G,P,G);var K=.01;q[0]+=K,q[1]+=K,q[2]-=K,q[3]-=K;for(var Q=0;4>Q;Q++)q[Q]=Math.min(q[Q],.99999);var W=p?2*Math.random()*Math.PI:0,Y=1.41*u.dist(B,P);N+=Y,s+=c(P,0,o,s,void 0,3),s+=c(X,0,o,s,void 0,3),o[s++]=0,o[s++]=q[0],o[s++]=q[1],o[s++]=W,o[s++]=Y,s+=c(P,0,o,s,void 0,3),s+=c(X,0,o,s,void 0,3),o[s++]=0,o[s++]=q[2]+1,o[s++]=q[1],o[s++]=W,o[s++]=Y,s+=c(P,0,o,s,void 0,3),s+=c(X,0,o,s,void 0,3),o[s++]=0,o[s++]=q[2]+1,o[s++]=q[3]+1,o[s++]=W,o[s++]=Y,s+=c(P,0,o,s,void 0,3),s+=c(X,0,o,s,void 0,3),o[s++]=0,o[s++]=q[2]+1,o[s++]=q[3]+1,o[s++]=W,o[s++]=Y,s+=c(P,0,o,s,void 0,3),s+=c(X,0,o,s,void 0,3),o[s++]=0,o[s++]=q[0],o[s++]=q[3]+1,o[s++]=W,o[s++]=Y,s+=c(P,0,o,s,void 0,3),s+=c(X,0,o,s,void 0,3),o[s++]=0,o[s++]=q[0],o[s++]=q[1],o[s++]=W,o[s++]=Y}R[0]/=y,R[1]/=y,R[2]/=y;var Z=u.create();u.add(_,G,Z),u.scale(Z,.5,Z);var $=u.create();u.subtract(_,G,$),$[0]=Math.abs($[0])/2,$[1]=Math.abs($[1])/2,$[2]=Math.abs($[2])/2;var te=u.create(R),ee=_[1]-G[1];te[1]-=ee/3;var re=u.create(),ae=u.create();E=u.create();var ie=[u.create(),u.create(),u.create(),u.create()],ne=[0,0,0,0],oe=f.create();for(U=0;y>U;++U){u.set3(o[D],o[D+1],o[D+2],E),u.subtract(E,te,re),u.normalize(re,re),ae=u.subtract(E,Z,ae),u.normalize(ae,ae);var se=Math.abs(u.dot(ae,[1,0,0])),ue=Math.abs(u.dot(ae,[0,1,0])),fe=Math.abs(u.dot(ae,[0,0,1])),de=se*Math.abs(Z[0]-E[0])/$[0];for(de+=ue*Math.abs(Z[1]-E[1])/$[1],de+=fe*Math.abs(Z[2]-E[2])/$[2],k=0;4>k;k++)L?(f.identity(oe),f.rotate(oe,b()*S,[0,1,0],oe),f.rotate(oe,b()*S,[1,0,0],oe),f.multiplyVec3(oe,re,ie[k])):ie[k]=re,ne[k]=.5+.5*de-b()*V;var ce=.8+.3*b();for(k=0;6>k;++k){var he;switch(k){case 0:he=0;break;case 1:he=1;break;case 2:he=2;break;case 3:he=2;break;case 4:he=3;break;case 5:he=0}D+=3,D+=c(ie[he],0,o,D,a,3),o[D++]=ne[he],D+=3,o[D++]*=ce}}},this.intersect=function(){},this.getGLMaterials=function(){return{color:l,depthShadowMap:m,normal:void 0,depth:v,highlight:void 0}},this.getAllTextureIds=function(){return[t]}},l=function(t,r,a){e.basicGLMaterialConstructor(this,t);var i=s.TRANSPARENT_MATERIAL,n=r.get("leafCard");e.singleTextureGLMaterialConstructor(this,a,{textureId:t.getTextureId()}),this.beginSlot=function(t){return i===t},this.getProgram=function(){return n};var o=t.getAmbient(),u=t.getDiffuse(),f=t.getSpecular(),d=t.getShininess();this.bind=function(e){n.use(),this.bindTexture(e,n),n.uniform3fv("ambient",o),n.uniform3fv("diffuse",u),n.uniform3fv("specular",f),n.uniform1f("shininess",d),n.uniform1f("trafoScale",1),t.getVertexBufferLayout().enableVertexAttribArrays(e,n)},this.release=function(e){t.getVertexBufferLayout().disableVertexAttribArrays(e,n)},this.bindView=function(t,r){e.bindView(r.origin,r.view,n),e.bindCamPos(r.origin,r.viewInvTransp,n)},this.bindInstance=function(t,e){n.uniformMatrix4fv("model",e.transformation),n.uniformMatrix4fv("modelNormal",e.transformationNormal);var r=e.transformation,a=Math.sqrt(r[0]*r[0]+r[4]*r[4]+r[8]*r[8]),i=Math.sqrt(r[1]*r[1]+r[5]*r[5]+r[9]*r[9]),o=Math.sqrt(r[2]*r[2]+r[6]*r[6]+r[10]*r[10]);n.uniform1f("trafoScale",(a+i+o)/3)},this.getDrawMode=function(t){return t.TRIANGLES}},v=function(t,r,a,i){e.basicGLMaterialConstructor(this,t);var n=s.TRANSPARENT_MATERIAL,o=r.get(null==i?"leafCardDepth":"leafCardDepthShadowMap");e.singleTextureGLMaterialConstructor(this,a,{textureId:t.getTextureId()}),this.beginSlot=function(t){return n===t},this.getProgram=function(){return o},this.bind=function(e,r){o.use(),this.bindTexture(e,o),o.uniform2fv("nearFar",r.nearFar),t.getVertexBufferLayout().enableVertexAttribArrays(e,o)},this.release=function(e){t.getVertexBufferLayout().disableVertexAttribArrays(e,o)},this.bindView=function(t,r){e.bindView(r.origin,r.view,o)},this.bindInstance=function(t,e){o.uniformMatrix4fv("model",e.transformation);var r=e.transformation,a=Math.sqrt(r[0]*r[0]+r[4]*r[4]+r[8]*r[8]),i=Math.sqrt(r[1]*r[1]+r[5]*r[5]+r[9]*r[9]),n=Math.sqrt(r[2]*r[2]+r[6]*r[6]+r[10]*r[10]);o.uniform1f("trafoScale",(a+i+n)/3)},this.getDrawMode=function(t){return t.TRIANGLES}},m=function(t,e,r){v.call(this,t,e,r,!0)};return h.loadShaders=function(e,r,n,o){e._parse(t);var s=new i(o.VERTEX_SHADER,e.vertexShaderLeafCard,o),u=new i(o.FRAGMENT_SHADER,e.fragmentShaderLeafCard,o),f=new a([s,u],o),d=new i(o.VERTEX_SHADER,e.vertexShaderLeafCardDepth,o),c=r.get("fsDepthTextured"),h=r.get("fsDepthTexturedShadowMap"),l=new a([d,c],o),v=new a([d,h],o);n.add("leafCard",f),n.add("leafCardDepth",l),n.add("leafCardDepthShadowMap",v)},h});