// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","./Util","./GLUtil"],function(e,t,i,r){var s=function(){function e(e){this.glName=e.createTexture(),this.refCount=0}return e.prototype.incRefCnt=function(){++this.refCount},e.prototype.decRefCnt=function(){--this.refCount,i.assert(this.refCount>=0)},e.prototype.getRefCnt=function(){return this.refCount},e.prototype.getGLName=function(){return this.glName},e}(),n=function(){function e(e,t,i,r){this.NUM_PARALLEL=8,this.textures=e,this.programRep=t,this.getViewportToRestore=i,this.gl=r,this.NUM_PARALLEL=8,this.id2textureRef={},this.loading={},this.queue=[],this.listeners=[],this.afExt=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.maxMaxAnisotropy=this.afExt?r.getParameter(this.afExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.maxAnisotropy=Math.min(8,this.maxMaxAnisotropy),this._needsRender=!0,this.initBuffer=new Uint8Array(256),this.initBufferTransparent=new Uint8Array(256);for(var s=0,n=this.initBuffer.length;n>s;++s)this.initBuffer[s]=255,this.initBufferTransparent[s]=(s+1)%4!==0?255:0}return e.prototype.unload=function(e){var t=this.id2textureRef[e];void 0!==t&&(this.gl.deleteTexture(t.getGLName()),delete this.id2textureRef[e])},e.prototype.resetNeedsRender=function(){this._needsRender=!1},e.prototype.needsRender=function(){return this._needsRender},e.prototype.aquire=function(e,t,r,n){var o=this,a=this.id2textureRef[e];if(null==a){a=new s(this.gl),i.assert(null==this.id2textureRef[e]),this.id2textureRef[e]=a;var u=this.textures[e];i.assert(void 0!==u),u.setUnloadFunc(this.unload.bind(this));var h=a.getGLName();this.initializeTexture(h,u,t,r),u.renderGl?(u.renderGl(h,this.gl),n&&n(a)):u.deferredLoading()?this.getLoadingCount()<this.NUM_PARALLEL?this.loadImage(e,h,n):this.queue.push([e,h,n]):u.loadGl(function(){o._needsRender=!0,n&&n(a)},h,this.gl,this.programRep,this.getViewportToRestore()),this._needsRender=!0}return a.incRefCnt(),a.getGLName()},e.prototype.release=function(e){var t=this.id2textureRef[e];void 0!==t&&(t.decRefCnt(),i.assert(t.getRefCnt()>=0))},e.prototype.getLoadingCount=function(){return Object.keys(this.loading).length},e.prototype.getIsLoaded=function(e){if(null==this.id2textureRef[e])return!1;if(void 0!==this.loading[e])return!1;for(var t=0,i=this.queue.length;i>t;++t)if(this.queue[t][0]===e)return!1;return!0},e.prototype.addTextureListener=function(e){i.assert(-1===this.listeners.indexOf(e)),this.listeners.push(e)},e.prototype.removeTextureListener=function(e){var t=this.listeners.indexOf(e);i.assert(-1!==t),this.listeners.splice(t,1)},e.prototype.getTexture=function(e){return this.textures[e]},e.prototype.setMaxAnisotropy=function(e){if(this.afExt&&(e=i.clamp(e,1,this.maxMaxAnisotropy),e!==this.maxAnisotropy)){this.maxAnisotropy=e;for(var t in this.id2textureRef){var r=this.id2textureRef[t].getGLName();this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.texParameterf(this.gl.TEXTURE_2D,this.afExt.TEXTURE_MAX_ANISOTROPY_EXT,this.maxAnisotropy)}}},e.prototype.getMaxAnisotropy=function(){return this.maxAnisotropy},e.prototype.initializeTexture=function(e,t,s,n){var o=this.gl;if(o.bindTexture(o.TEXTURE_2D,e),t.params&&t.params.wrapClamp&&(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE)),void 0!==s)if(Array.isArray(s.id)){var a=s.num;i.assert(s.id.length===a*a),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,256*a,256*a,0,o.RGBA,o.UNSIGNED_BYTE,null);var u=o.createFramebuffer();o.bindFramebuffer(o.FRAMEBUFFER,u);for(var h=0;a>h;h++)for(var f=0;a>f;f++)o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,this.id2textureRef[s.id[h*a+f]].getGLName(),0),r.checkFramebufferStatus(o.FRAMEBUFFER,o),o.copyTexSubImage2D(o.TEXTURE_2D,0,256*f,256*h,0,0,256,256);o.generateMipmap(o.TEXTURE_2D),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR),o.bindFramebuffer(o.FRAMEBUFFER,null),o.deleteFramebuffer(u)}else o.texImage2D(o.TEXTURE_2D,0,o.RGBA,s.width,s.height,0,o.RGBA,o.UNSIGNED_BYTE,null),r.copyTextureToTexture(this.id2textureRef[s.id].getGLName(),e,s.x,s.y,0,0,s.width,s.height,o);else o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),void 0!==n&&n?o.texImage2D(o.TEXTURE_2D,0,o.RGBA,8,8,0,o.RGBA,o.UNSIGNED_BYTE,this.initBufferTransparent):o.texImage2D(o.TEXTURE_2D,0,o.RGBA,8,8,0,o.RGBA,o.UNSIGNED_BYTE,this.initBuffer);this.afExt&&t.params&&t.params.mipmap&&o.texParameterf(o.TEXTURE_2D,this.afExt.TEXTURE_MAX_ANISOTROPY_EXT,this.maxAnisotropy)},e.prototype.next=function(e){if(e in this.loading){delete this.loading[e];var t=Object.keys(this.id2textureRef),i=Object.keys(this.loading);this.listeners.forEach(function(r){r(e,t,i)}),this.processQueue()}},e.prototype.loadImage=function(e,t,r){var s=this;i.assert(null==this.loading[e]),this.loading[e]=!0;var n=this.textures[e];i.assert(void 0!==n),setTimeout(function(){var i=s.id2textureRef[e];i&&i.getRefCnt()&&n.loadGl(function(){s.next(e),s._needsRender=!0;var t=s.id2textureRef[e];t&&t.getRefCnt()&&r&&r(t)},t,s.gl,s.programRep,s.getViewportToRestore())},0)},e.prototype.processQueue=function(){for(var e=[],t=0,i=this.queue.length;i>t;++t){var r=this.queue[t][0],s=this.id2textureRef[r];if(void 0!==s){var n=s.getRefCnt();0===n?(this.gl.deleteTexture(s.getGLName()),delete this.id2textureRef[r]):e.push(this.queue[t])}}this.queue=e;for(var o=Math.min(this.NUM_PARALLEL-Object.keys(this.loading).length,this.queue.length),t=0;o>t;++t)this.loadImage(this.queue[t][0],this.queue[t][1],this.queue[t][2]);this.queue.splice(0,o)},e}();return n});