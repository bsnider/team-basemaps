// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","./IdGen","./Util","./gl-matrix","./ModelContentType","./IntervalUtilities","./GeometryRecord"],function(e,t,r,i,n,o,a,s){var c=i.assert,d=n.mat4d,h=n.vec3d,l=i.VertexAttrConstants,g=function(){function e(t){this.hiddenIndexRanges={},this.visibleIndexRanges={},this._bvObjectSpace=new u,this._bvWorldSpace=new u,this._bvDirty=!0,this.id=e._idGen.gen(t.idHint),this.name=t.name,this.castShadow=null!=t.castShadow?t.castShadow:!0,this.metadata=t.metadata,this.objectTransformation=d.identity(),this._initializeGeometryRecords(t.geometries,t.materials,t.transformations,t.instanceParameters)}return e.prototype._initializeGeometryRecords=function(e,t,r,i){if(!Array.isArray(e))return this.geometryRecords=[],void(this.geometries=[]);c(t.length===e.length,"Object3D: materials don't match geometries"),c(r.length===e.length,"Object3D: transformations don't match geometries"),this.geometryRecords=new Array(e.length),this.geometries=e.slice();for(var n=0;n<e.length;n++)c(Array.isArray(t[n]),"Object3D: materials parameter must be array of array"),this.geometryRecords[n]=new s(e[n],t[n].slice(),d.create(r[n]),i?i.slice():null)},e.prototype.getId=function(){return this.id},Object.defineProperty(e.prototype,"parentLayer",{get:function(){return this._parentLayer},set:function(e){c(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e},enumerable:!0,configurable:!0}),e.prototype.getParentLayer=function(){return this.parentLayer},e.prototype.addParentLayer=function(e){this.parentLayer=e},e.prototype.removeParentLayer=function(){this.parentLayer=null},e.prototype.getNumGeometryRecords=function(){return this.geometryRecords.length},e.prototype.getFirstGeometryIndex=function(e){var t=this.geometries.indexOf(e);return c(t>-1,"Object3D.getFirstGeometryIndex: geometry not found"),t},e.prototype.findGeometryRecords=function(e){for(var t=[],r=0;r<this.geometries.length;r++)this.geometries[r]===e&&t.push(this.geometryRecords[r]);return t},e.prototype.getGeometryRecord=function(e){return c(e>=0&&e<this.geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range"),this.geometryRecords[e]},e.prototype.getGeometryRecords=function(){return this.geometryRecords},e.prototype.addGeometry=function(e,t,r,i,n){c(Array.isArray(t),"Object3D.addGeometry: materials must be array"),this.geometries.push(e);var o=new s(e,t.slice(),d.create(r),i,n);return this.geometryRecords.push(o),this._notifyDirty("objGeometryAdded",o),this._invalidateBoundingVolume(),o},e.prototype.hasGeometry=function(e){return this.geometries.indexOf(e)>-1},e.prototype.removeGeometry=function(e){var t=this.geometryRecords.splice(e,1)[0];return this.geometries.splice(e,1),this._notifyDirty("objGeometryRemoved",t),this._invalidateBoundingVolume(),t},e.prototype.replaceGeometry=function(e,t){c(e>=0&&e<this.geometryRecords.length,"Object3d.replaceGeometry: index out of range");var r=this.geometryRecords[e],i=new s(t,r.materials,r.transformation);return this.geometryRecords[e]=i,this.geometries[e]=t,this._notifyDirty("objGeometryReplaced",[r,i]),this._invalidateBoundingVolume(),r.geometry},e.prototype.replaceGeometryMaterials=function(e,t){c(e>=0&&e<this.geometryRecords.length,"Object3d.replaceGeometryMaterials: index out of range");var r=this.geometryRecords[e],i=r.materials,n=new s(r.geometry,t.slice(),r.transformation);return this.geometryRecords[e]=n,this._notifyDirty("objGeometryReplaced",[r,n]),i},e.prototype.geometryVertexAttrsUpdated=function(e){this._notifyDirty("vertexAttrsUpdated",this.geometryRecords[e]),this._invalidateBoundingVolume()},e.prototype.geometryColorAttrsUpdated=function(e){this._notifyDirty("colorAttrsUpdated",this.geometryRecords[e])},e.prototype.getHiddenIndexRanges=function(e){return this.hiddenIndexRanges[e.getId()]},e.prototype.getVisibleIndexRanges=function(e){return this.visibleIndexRanges[e.getId()]},e.prototype.isAllHidden=function(){for(var e=0;e<this.geometryRecords.length;e++){var t=this.geometryRecords[e],r=t.geometry.data.faces.length,i=this.getVisibleIndexRanges(t);if(!i)return!1;for(var n=0;r>n;n++){var o=i[n];if(!o)return!1;if(o.length>0)return!1}}return!0},e.prototype.setFacerangeColors=function(e,t){var r=this.geometryRecords;if(1!==r.length)return void console.warn("face range colors currently support only one geometry record");if(!e.every(function(e){return null==e.color})){var i=r[0].geometry,n=i.data.vertexAttributes;if(null===i.originalColors){i.originalColors=n[l.COLOR].data;var o=i.originalColors.constructor;n[l.COLOR].data=new o(i.originalColors)}var a=n[l.COLOR].data;if(null!=a){for(var s=0;s<e.length;s++){var c=e[s],d=null==c.faceRanges?0:4*c.faceRanges[0]*3,h=null==c.faceRanges?a.length:4*(c.faceRanges[1]+1)*3;if(null!=c.color)if("blend"===t)for(var g=c.color[0],u=c.color[1],y=c.color[2],m=c.color[3],p=d;h>p;p+=4)a[p+0]=i.originalColors[p+0]*g,a[p+1]=i.originalColors[p+1]*u,a[p+2]=i.originalColors[p+2]*y,a[p+3]=i.originalColors[p+3]*m;else for(var g=255*c.color[0],u=255*c.color[1],y=255*c.color[2],m=255*c.color[3],p=d;h>p;p+=4)a[p+0]=g,a[p+1]=u,a[p+2]=y,a[p+3]=m;else for(var p=d;h>p;p++)a[p]=i.originalColors[p]}this.geometryColorAttrsUpdated(0)}}},e.prototype.isPartiallyHidden=function(){for(var e=0;e<this.geometryRecords.length;e++){var t=this.geometryRecords[e],r=t.geometry.data.faces.length,i=this.getHiddenIndexRanges(t);if(i)for(var n=0;r>n;n++){var o=i[n];if(o&&o.length>0)return!0}}return!1},e.prototype.hideFaceRange=function(e,t){var r=e.id;null==this.hiddenIndexRanges[r]&&(this.hiddenIndexRanges[r]=[],this.visibleIndexRanges[r]=[]);for(var i=0;i<e.geometry.data.faces.length;i++){null==this.hiddenIndexRanges[r][i]&&(this.hiddenIndexRanges[r][i]=[],this.visibleIndexRanges[r][i]=[]);var n=a.copyIntervals(t);a.convertFaceToIndexRange(n,3);var o=e.geometry.data.faces[i].componentRange;if(n=a.intersectIntervals(n,o),n=a.offsetIntervals(n,-o[0]),this.hiddenIndexRanges[r][i]=this.hiddenIndexRanges[r][i].concat(n),this.hiddenIndexRanges[r][i]=a.mergeIntervals(this.hiddenIndexRanges[r][i]),0===this.hiddenIndexRanges[r].length)delete this.visibleIndexRanges[r],delete this.hiddenIndexRanges[r];else{var s=e.geometry.data.faces[i].indices.position.length;this.visibleIndexRanges[r][i]=a.invertIntervals(this.hiddenIndexRanges[r][i],s-1)}}this._notifyDirty("hideFaceRange",e)},e.prototype.hideAllFaceRanges=function(){this.hiddenIndexRanges={},this.visibleIndexRanges={};for(var e=0;e<this.geometryRecords.length;e++){var t=this.geometryRecords[e],r=t.getId();this.hiddenIndexRanges[r]=[],this.visibleIndexRanges[r]=[];for(var i=t.geometry.data.faces.length,n=0;i>n;n++){var o=t.geometry.data.faces[n].indices.position.length;this.hiddenIndexRanges[r][n]=[[0,o-1]],this.visibleIndexRanges[r][n]=[]}this._notifyDirty("hideFaceRange",t)}return!0},e.prototype.unhideAllFaceRange=function(){this.hiddenIndexRanges={},this.visibleIndexRanges={},this._notifyDirty("unhideAllFaceRange")},e.prototype.getFaceRangeIndexFromTriangleNr=function(e){var t=this.metadata.faceRanges;if(null!=t)for(var r=0;r<t.length;r++)if(t[r][0]<=e&&t[r][1]>=e)return r},e.prototype.getFaceRangeFromTriangleNr=function(e){var t=this.getFaceRangeIndexFromTriangleNr(e),r=this.metadata.faceRanges;return t?[r[t]]:null},e.prototype.setGeometryTransformation=function(e,t){c(e>=0&&e<this.geometryRecords.length,"Object3d.setGeometryTransformation: index out of range");var r=this.geometryRecords[e],i=new s(r.geometry,r.materials,d.create(t));this.geometryRecords[e]=i,this._notifyDirty("objGeometryReplaced",[r,i]),this._invalidateBoundingVolume()},e.prototype.getObjectTransformation=function(){return d.create(this.objectTransformation)},e.prototype.setObjectTransformation=function(e){d.set(e,this.objectTransformation),this._invalidateBoundingVolume(),this._notifyDirty("objTransformation")},e.prototype.getCombinedTransformation=function(e,t){return t=t||d.create(),d.multiply(this.objectTransformation,e.transformation,t),t},e.prototype.getCastShadow=function(){return this.castShadow},e.prototype.setCastShadow=function(e){this.castShadow=e},e.prototype.getMetadata=function(){return this.metadata},e.prototype.getName=function(){return this.name},e.prototype.getBBMin=function(e){return this._validateBoundingVolume(),e?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin},e.prototype.getBBMax=function(e){return this._validateBoundingVolume(),e?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax},e.prototype.getCenter=function(e){return this._validateBoundingVolume(),e?this._bvObjectSpace.center:this._bvWorldSpace.center},e.prototype.getBSRadius=function(e){return this._validateBoundingVolume(),e?this._bvObjectSpace.bsRadius:this._bvWorldSpace.bsRadius},e.prototype.calcFacerangeBoundingSphere=function(e){var t=null;if(null!=e&&1===this.geometries.length&&1===this.geometries[0].numGroups&&(t=this.getFaceRangeFromTriangleNr(e)),null==t||1!==t.length)return{center:this.getCenter(),radius:this.getBSRadius()};var r=this.geometries[0].calculateBoundingInfo(0,t[0]),i=r.getCenter();return d.multiplyVec3(this.geometryRecords[0].transformation,i),d.multiplyVec3(this.objectTransformation,i),{center:i,radius:r.getBSRadius()*this._getScaleFactor(this.geometryRecords[0].transformation)*this._getScaleFactor(this.objectTransformation)}},e.prototype._validateBoundingVolume=function(){if(this._bvDirty){this._bvObjectSpace.init(),this._bvWorldSpace.init();for(var e=h.create(),t=h.create(),r=0;r<this.geometryRecords.length;++r)for(var i=this.geometries[r],n=this.geometryRecords[r].transformation,o=0,a=i.getNumGroups();a>o;++o){var s=i.getBoundingInfo(o);d.multiplyVec3(n,s.getBBMin(),e),d.multiplyVec3(n,s.getBBMax(),t);for(var c=0;3>c;++c)this._bvObjectSpace.bbMin[c]=Math.min(this._bvObjectSpace.bbMin[c],e[c],t[c]),this._bvObjectSpace.bbMax[c]=Math.max(this._bvObjectSpace.bbMax[c],e[c],t[c]);d.multiplyVec3(this.objectTransformation,e),d.multiplyVec3(this.objectTransformation,t);for(var c=0;3>c;++c)this._bvWorldSpace.bbMin[c]=Math.min(this._bvWorldSpace.bbMin[c],e[c],t[c]),this._bvWorldSpace.bbMax[c]=Math.max(this._bvWorldSpace.bbMax[c],e[c],t[c])}h.lerp(this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5,this._bvObjectSpace.center),h.lerp(this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5,this._bvWorldSpace.center);for(var l=e,g=t,u=this._getScaleFactor(this.objectTransformation),r=0;r<this.geometryRecords.length;++r)for(var i=this.geometries[r],n=this.geometryRecords[r].transformation,y=this._getScaleFactor(n),o=0,a=i.getNumGroups();a>o;++o){var s=i.getBoundingInfo(o);d.multiplyVec3(n,s.getCenter(),l);var m=h.dist(l,this._bvObjectSpace.center),p=s.getBSRadius()*y;this._bvObjectSpace.bsRadius=Math.max(this._bvObjectSpace.bsRadius,m+p),d.multiplyVec3(this.objectTransformation,l,g);var f=h.dist(g,this._bvWorldSpace.center),b=p*u;this._bvWorldSpace.bsRadius=Math.max(this._bvWorldSpace.bsRadius,f+b)}this._bvDirty=!1}},e.prototype._getScaleFactor=function(e){var t=Math.sqrt(e[0]*e[0]+e[4]*e[4]+e[8]*e[8]),r=Math.sqrt(e[1]*e[1]+e[5]*e[5]+e[9]*e[9]),i=Math.sqrt(e[2]*e[2]+e[6]*e[6]+e[10]*e[10]);return Math.max(Math.max(t,r),i)},e.prototype._invalidateBoundingVolume=function(){this._bvDirty=!0,this._parentLayer&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace)},e.prototype._notifyDirty=function(e,t,r,i){if(this._parentLayer){r=r||o.OBJECT;var n=i||this;this._parentLayer.notifyDirty(e,t,r,n)}},e._idGen=new r,e}(),u=function(){function e(){this.bbMin=h.create(),this.bbMax=h.create(),this.center=h.create(),this.bsRadius=0}return e.prototype.init=function(){h.set3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.bbMin),h.set3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.bbMax),h.set3(0,0,0,this.center),this.bsRadius=0},e.prototype.getCenter=function(){return this.center},e.prototype.getBSRadius=function(){return this.bsRadius},e}();return g});