// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","./IntervalUtilities","./ModelDirtyTypesTs","./Float32ArrayList","./InstanceBufferData","./VertexBufferLayout","./Lighting","../materials/internal/SimpleGLMaterial","../materials/internal/TexOnlyGLMaterial","./GLVBO","./GLSLProgram","./LinearDepthTextureHelper","./NormalTextureHelper","./HighlightTextureHelper","./RenderPass","./RenderSlot","./RenderContext","./ExternalRendererContainer","./BitSet","./Util","./gl-matrix"],function(e,t,r,a,i,n,s,o,d,l,h,f,u,m,p,g,_,c,v,R,x,y){var I=x.assert,b=x.array2object,A=x.objectEmpty,T=x.getFirstObjectValue,C=x.setMatrixTranslation3,M=y.vec2d,D=y.vec3d,O=y.vec4d,E=y.mat4d,P=x.VertexAttrConstants,S=E.identity(),B=D.create(),w=1535,F={proj:S,view:S,nearFar:[-1,1],origin:B},H=!1,N=function(){function e(e,t,r,a,i,n){this._lighting=new o,this._mat2dataMerged={},this._mat2dataInstanced={},this._renderOrder=[],this._externalRenderers=new v,this._renderContext=new c,this._framesRendered=0,this._isRendering=!1,this._pixelRatio=1,this._threshold=w,this._needsRender=!0,this._stats=new L,this.ssaoEnabled=!1,this.offscreenRenderingEnabled=!1,this._programRep=e,this._vboRep=t,this._materialRep=r,this._textureRep=a,this._orderedRendering=n,this._gl=i,this._selectionMaterial=new d(e,O.createFrom(.1,.2,.9,.4),i.EQUAL),this._selectionMaterialLines=new d(e,O.createFrom(.1,.2,.9,.4),i.EQUAL,i.LINES),this._renderContext.lightingData=this._lighting.get(),i.enable(i.DEPTH_TEST),i.enable(i.CULL_FACE),i.disable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this._bindParameters={view:null,proj:null,viewInvTransp:null,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMap:null,origin:null,pixelRatio:null,instanceParameters:null,depthFBO:null,normalFBO:null,extensions:{angleInstancedArrays:i.getExtension("ANGLE_instanced_arrays")}},this._linearDepthTextureHelper=new u(i),this._normalTextureHelper=new m(i),this._highlightTextureHelper=new p(i),this._initializeFramebufferTexture(),this._initializeQuadVBO(),this._initializeIeTextureFix()}return e.prototype._initializeQuadVBO=function(){this._quadVBO=new h(new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,-1,1,0,0,1,1,1,0,1,1]),s.Defaults.PosTex,this._gl)},e.prototype._initializeFramebufferTexture=function(){var e=this._gl,t=e.getContextAttributes(),r=t.alpha?e.RGBA:e.RGB,a=e.createTexture();e.bindTexture(3553,a),e.texParameteri(3553,10241,9728),e.texParameteri(3553,10240,9728),e.texParameteri(3553,10242,33071),e.texParameteri(3553,10243,33071),e.texImage2D(3553,0,6408,4,4,0,6408,5121,null),this._framebuffer={format:r,texture:a,copied:!1}},e.prototype._initializeIeTextureFix=function(){if(6408===this._framebuffer.format){for(var e=this._gl,t=new Uint8Array(64),r=0;64>r;r++)t[r]=255;this._ieFixTexture=e.createTexture(),e.bindTexture(3553,this._ieFixTexture),e.texParameteri(3553,10241,9728),e.texImage2D(3553,0,6408,4,4,0,6408,5121,t),this._ieFixMaterial=new l(this._programRep,this._ieFixTexture,O.createFrom(1,1,1,1),!0,519)}},e.prototype.dispose=function(){for(var e in this._mat2dataMerged){this._releaseMaterials(e);var t=this._mat2dataMerged[e];for(var r in t.origin2data)t.origin2data[r].vbo.dispose()}this._mat2dataMerged=null;for(var e in this._mat2dataInstanced){this._releaseMaterials(e);var t=this._mat2dataInstanced[e];for(var r in t.origin2data)t.origin2data[r].vbo.dispose()}this._mat2dataInstanced=null,this._quadVBO.dispose(),this._ieFixTexture&&(this._gl.deleteTexture(this._ieFixTexture),this._ieFixTexture=null),this._gl.deleteTexture(this._framebuffer.texture),this._framebuffer.texture=null,this._linearDepthTextureHelper.getEnableState()&&this._linearDepthTextureHelper.disable(),this._normalTextureHelper.getEnableState()&&this._normalTextureHelper.disable(),this._highlightTextureHelper.getEnableState()&&this._highlightTextureHelper.setEnableState(!1)},e.prototype.setLightingData=function(e){this._lighting.set(e),this._needsRender=!0},e.prototype.getLightingData=function(){return this._lighting.get()},e.prototype.setPixelRatio=function(e){this._pixelRatio=e,this._needsRender=!0},e.prototype.getPixelRatio=function(){return this._pixelRatio},e.prototype.addExternalRenderer=function(e,t){return this._externalRenderers.addRenderer(e,t),!0},e.prototype.removeExternalRenderer=function(e){return this._externalRenderers.removeRenderer(e),!0},e.prototype.getExternalRenderers=function(){return this._externalRenderers},e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._externalRenderers.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()},e.prototype.getCombinedStats=function(){this._stats.VBOallocatedSize=0,this._stats.VBOoptimalSize=0,this._stats.VBOusedSize=0;for(var e in this._mat2dataInstanced){var t=this._mat2dataInstanced[e];for(var r in t.origin2data){var a=t.origin2data[r];this._stats.VBOallocatedSize+=a.buffer.getArray().length,this._stats.VBOusedSize+=a.buffer.getSize(),this._stats.VBOoptimalSize+=a.optimalCount}}for(var e in this._mat2dataMerged){var t=this._mat2dataMerged[e];for(var r in t.origin2data){var a=t.origin2data[r];this._stats.VBOallocatedSize+=a.buffer.getArray().length,this._stats.VBOusedSize+=a.buffer.getSize(),this._stats.VBOoptimalSize+=a.optimalCount}}return this._stats.VBOallocatedSize*=4/1024,this._stats.VBOusedSize*=4/1024,this._stats.VBOoptimalSize*=4/1024,this._stats},e.prototype.setSelectionObject=function(e,t){e?(this._selectionIndices=this._name2indices(Array.isArray(e)?b(e):b([e])),this._selectionFaceIndexRange=void 0,null!=t&&1===t.length&&(this._selectionFaceIndexRange=[[3*t[0][0],3*t[0][1]]])):(this._selectionIndices=void 0,this._selectionFaceIndexRange=void 0),this._needsRender=!0},e.prototype.renderGeometrySlots=function(e){this._externalRenderers.render(_.INTERNAL_MATERIAL,e),this._externalRenderers.render(_.OPAQUE_TERRAIN,e),this._renderInternalSlot(_.OPAQUE_MATERIAL,e),this._externalRenderers.render(_.OPAQUE_EXTERNAL,e),this._renderInternalSlot(_.TRANSPARENT_MATERIAL,e),this._externalRenderers.render(_.TRANSPARENT_EXTERNAL,e),this._externalRenderers.render(_.TRANSPARENT_TERRAIN,e)},e.prototype._renderHighlights=function(e,t,r,a){var i=!!a&&a.getEnableState(),n=i&&void 0!==this._selectionIndices;if(this._highlightTextureHelper.setEnableState(n),n){this._highlightTextureHelper.setupFBOs(e),this._highlightTextureHelper.prepareHighlightPass(),this.renderGeometryPass(g.MATERIAL_HIGHLIGHT,e,t,this._selectionIndices,this._selectionFaceIndexRange),this._gl.clear(this._gl.DEPTH_BUFFER_BIT),this._renderInternalSlot(_.OVERLAY,this._renderContext),this._highlightTextureHelper.finish(r);var s=this._highlightTextureHelper.getHighlightFBO();a.render(e,r,s)}},e.prototype._renderUnordered=function(e,t,r,a,i,n,s){var o=this._gl;if(this._isRendering=!0,this._stats.reset(),this._framebuffer.copied=!1,this._updateGlobalUniforms(e.projectionMatrix),this._renderContext.pass=g.MATERIAL,this._renderContext.camera=e,this._renderContext.shadowMap=r,this._renderContext.ssaoHelper=a,this._renderContext.offscreenRenderingHelper=n,this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO(),this._renderContext.normals=this._normalTextureHelper.getNormalFBO(),this._renderContext.highlight=this._highlightTextureHelper.getHighlightFBO(),this._renderContext.visibleContent=t,this._renderContext.filterContent=null,this._renderContext.filterFaceRange=null,this.offscreenRenderingEnabled&&n.prepareRenderPass(e),this._externalRenderers.render(_.BACKGROUND,this._renderContext),this.renderGeometrySlots(this._renderContext),this.offscreenRenderingEnabled?(this._renderContext.framebufferTex=n.getColorTexture(),this._framebuffer.copied=!0):this._copyFramebufferToTexture(e.fullViewport),this._externalRenderers.render(_.POSTPROCESSING_ATMOSPHERE,this._renderContext),this.offscreenRenderingEnabled){var d=e.viewport,l=E.ortho(d[0],d[2],d[1],d[3],-1,1);n.drawQuad(l)}if(o.clear(o.DEPTH_BUFFER_BIT),this._renderInternalSlot(_.OVERLAY,this._renderContext),this._renderHighlights(e,t,i,s),o.bindBuffer(o.ARRAY_BUFFER,null),f.unuse(o),H){var h=this._stats;window.FPSCounterDebugString="dc: "+(h.drawCallsInstanced+h.drawCallsMerged)+" instanced: "+h.drawCallsInstanced+" merged: (dc: "+(h.drawCallsInstanced+h.drawCallsMerged)+" instanced: "+h.drawCallsInstanced+" merged: "+h.drawCallsMerged+")"}this._ieFixMaterial&&!i&&(o.blendFuncSeparate(o.ZERO,o.ONE,o.ONE,o.ZERO),this._ieFixMaterial.bind(o,F),this._ieFixMaterial.bindView(o,F),this._quadVBO.bind(),this._quadVBO.setPointers(this._ieFixMaterial.getProgram()),o.drawArrays(o.TRIANGLE_STRIP,0,this._quadVBO.getNum()),this._ieFixMaterial.release(o),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)),this._framesRendered++,this._isRendering=!1},e.prototype._renderOrdered=function(e,t){this._isRendering=!0,this._stats.reset(),this._framebuffer.copied=!1,this._updateGlobalUniforms(e.projectionMatrix),this._bindParameters.view=e.viewMatrix,this._bindParameters.proj=e.projectionMatrix,this._bindParameters.viewInvTransp=e.viewInverseTransposeMatrix,V[0]=e.near,V[1]=e.far,this._bindParameters.nearFar=V,this._bindParameters.lightingData=this._lighting.get(),this._bindParameters.viewport=e.fullViewport,this._bindParameters.framebufferTex=this._framebuffer.texture,this._bindParameters.pixelRatio=this._pixelRatio,this._bindParameters.instanceParameters=void 0,this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO(),this._bindParameters.normalFBO=this._normalTextureHelper.getNormalFBO();for(var r=!0,a=0;a<this._renderOrder.length;a++){var i=this._renderOrder[a][1];if(i.instanced){var n=i.instanced,s=n[g.MATERIAL];!s||s.isVisible&&!s.isVisible()||(this._renderInternalInstanced(n,s,this._bindParameters,1/0,t,null,null,!1),r=!0)}if(i.merged){var n=i.merged,s=n[g.MATERIAL];if(s&&(!s.isVisible||s.isVisible())){if(r){var o=s.getProgram();o.use(),o.uniformMatrix4fv("model",S),o.hasUniform("modelNormal")&&o.uniformMatrix4fv("modelNormal",S),r=!1}this._renderInternalMerged(n,s,this._bindParameters,1/0)}}}var d=this._gl;d.bindBuffer(d.ARRAY_BUFFER,null),f.unuse(d),this._framesRendered++,this._isRendering=!1},e.prototype.render=function(e,t,r,a,i,n,s){this._orderedRendering?this._renderOrdered(e,t):this._renderUnordered(e,t,r,a,i,s,n)},e.prototype.renderAuxiliaryBuffers=function(e,t,r,a,i,n){var s=this.ssaoEnabled||this._externalRenderers.needsDepthMap();this._linearDepthTextureHelper.setEnableState(s),s&&(this._linearDepthTextureHelper.setupFBOs(e),this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(g.MATERIAL_DEPTH,e,t,void 0,void 0,r,a),this._linearDepthTextureHelper.finish(n)),this._normalTextureHelper.setEnableState(this.ssaoEnabled),this.ssaoEnabled&&(this._normalTextureHelper.setupFBOs(e),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(g.MATERIAL_NORMAL,e,t,void 0,void 0,r,a),this._normalTextureHelper.finish(n)),this.ssaoEnabled&&a.computeSSAO(e,n,i,this._linearDepthTextureHelper.getDepthFBO(),this._normalTextureHelper.getNormalFBO()),a.bindAll(this._programRep)},e.prototype.renderGeometryPass=function(e,t,r,a,i,n,s){this._isRendering=!0,this._updateGlobalUniforms(t.projectionMatrix),this._renderContext.pass=e,this._renderContext.camera=t,this._renderContext.shadowMap=n,this._renderContext.ssaoHelper=s,this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO(),this._renderContext.normals=this._normalTextureHelper.getNormalFBO(),this._renderContext.visibleContent=r,this._renderContext.filterContent=a,this._renderContext.filterFaceRange=i,this.renderGeometrySlots(this._renderContext),this._isRendering=!1},e.prototype.renderSelection=function(e){this._isRendering=!0;for(var t=0;t<_.MAX_SLOTS;++t)this._renderInternalSlot(t,e);this._isRendering=!1},e.prototype._copyFramebufferToTexture=function(e){var t=this._gl;t.bindTexture(t.TEXTURE_2D,this._framebuffer.texture),t.copyTexImage2D(t.TEXTURE_2D,0,this._framebuffer.format,e[0],e[1],e[2],e[3],0),this._renderContext.framebufferTex=this._framebuffer.texture,this._framebuffer.copied=!0},e.prototype._renderInternalSlot=function(e,t){this._bindParameters.view=t.camera.viewMatrix,this._bindParameters.proj=t.camera.projectionMatrix,this._bindParameters.viewInvTransp=t.camera.viewInverseTransposeMatrix,V[0]=t.camera.near,V[1]=t.camera.far,this._bindParameters.nearFar=V,this._bindParameters.lightingData=this._lighting.get(),this._bindParameters.viewport=t.camera.fullViewport,this._bindParameters.framebufferTex=this.offscreenRenderingEnabled?this._renderContext.offscreenRenderingHelper.getColorTexture():this._framebuffer.texture,this._bindParameters.shadowMap=t.shadowMap,this._bindParameters.pixelRatio=this._pixelRatio,this._bindParameters.instanceParameters=void 0,this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO();for(var r in this._mat2dataInstanced){var a=this._mat2dataInstanced[r],i=a[t.pass];i&&i.beginSlot(e)&&(!i.isVisible||i.isVisible())&&this._renderInternalInstanced(a,i,this._bindParameters,e,t.visibleContent,t.filterContent,t.filterFaceRange,!1)}if(t.filterContent)for(var r in this._mat2dataMerged){var a=this._mat2dataMerged[r],i=a[t.pass];i&&i.beginSlot(e)&&(!i.isVisible||i.isVisible())&&this._renderInternalInstanced(a,i,this._bindParameters,e,null,t.filterContent,t.filterFaceRange,!0)}else{for(var n=this._programRep.getProgramsUsingUniform("model"),s=this._programRep.getProgramsUsingUniform("modelNormal"),o=0;o<n.length;o++){var d=n[o];d.use(),d.uniformMatrix4fv("model",S),s.indexOf(d)>-1&&d.uniformMatrix4fv("modelNormal",S)}for(var r in this._mat2dataMerged){var a=this._mat2dataMerged[r],i=a[t.pass];i&&i.beginSlot(e)&&(!i.isVisible||i.isVisible())&&this._renderInternalMerged(a,i,this._bindParameters,e)}}},e.prototype._renderInternalInstanced=function(e,t,r,a,i,n,s,o){var d=this._gl,l=!1,h=t.getDrawMode(d),f=this._bindParameters.extensions.angleInstancedArrays;for(var u in e.origin2data){var m=e.origin2data[u];r.origin=m.origin;var p=!1;if(t.instanced)for(var g in m.perGeometryDataInfo){var _=m.perGeometryDataInfo[g];l||(t.bind(d,r),l=!0),p||(m.vbo.bind(),m.vbo.setPointers(t.getProgram()),t.bindView(d,r),p=!0),_.instanceBuffer.bind(),_.instanceBuffer.setPointers(t.getProgram());var c=_.to-_.from,v=_.refCount;h===d.TRIANGLES&&(this._stats.trianglesRendered+=v*c/3),f.drawArraysInstancedANGLE(h,_.from,c,v),this._stats.drawCallsAngleInstanced++,this._stats.instancesDrawnAngle+=v}else{var R=m.instances;for(var x in R){var y=R[x],I=y.idx,b=y.displayedIndexRange;s&&(b=s),b&&0===b.length||i&&!i.get(I)||n&&!n.get(I)||(l||(t.bind(d,r),l=!0),p||(m.vbo.bind(),m.vbo.setPointers(t.getProgram()),t.bindView(d,r),p=!0),o||t.bindInstance(d,y),this._stats.drawCallsInstanced++,h===d.TRIANGLES&&(this._stats.trianglesRendered+=(y.to-y.from)/3),b?this._drawArraysFaceRange(b,y.from,h):d.drawArrays(h,y.from,y.to-y.from))}}}l&&t.release(d,r)},e.prototype._drawArraysFaceRange=function(e,t,r){for(var a=this._gl,i=0;i<e.length;i++){var n=e[i];a.drawArrays(r,n[0]+t,n[1]-n[0]+1)}this._stats.drawCallsFragmented+=e.length-1},e.prototype._renderInternalMerged=function(e,t,r){var a=this._gl,i=!1;for(var n in e.origin2data){var s=e.origin2data[n];if(r.origin=s.origin,!s.displayedIndexRange||0!==s.displayedIndexRange.length){i||(t.bind(a,r),i=!0),s.vbo.bind(),s.vbo.setPointers(t.getProgram()),t.bindView(a,r),this._stats.drawCallsMerged++;var o=t.getDrawMode(a);o===a.TRIANGLES&&(this._stats.trianglesRendered+=s.vbo.getNum()/3),s.displayedIndexRange?this._drawArraysFaceRange(s.displayedIndexRange,0,o):a.drawArrays(o,0,s.vbo.getNum())}}i&&t.release(a,r)},e.prototype._updateGlobalUniforms=function(e){for(var t=this._programRep.getProgramsUsingUniform("proj"),r=0;r<t.length;r++)t[r].uniformMatrix4fv("proj",e);if(this._lighting){t=this._programRep.getProgramsUsingUniform("lightDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r])}},e.prototype.print=function(){var e=Object.keys(this._mat2dataMerged).length,t=Object.keys(this._mat2dataInstanced).length;console.log("number of materials (merged/instanced): "+e+"/"+t);var r=0;for(var a in this._mat2dataMerged){var i=this._mat2dataMerged[a];for(var n in i.origin2data)r+=Object.keys(i.origin2data[n].instances).length}var s=0;for(var a in this._mat2dataInstanced){var i=this._mat2dataInstanced[a];for(var n in i.origin2data)s+=Object.keys(i.origin2data[n].instances).length}console.log("number of instances (merged/instanced): "+r+"/"+s)},e.prototype.isEmpty=function(){for(var e in this._mat2dataInstanced){var t=this._mat2dataInstanced[e];for(var r in t.origin2data)if(!A(t.origin2data[r].instances))return!1}for(var e in this._mat2dataMerged){var t=this._mat2dataMerged[e];for(var r in t.origin2data)if(!A(t.origin2data[r].instances))return!1}return!0},e.prototype.modify=function(e,t,r,a){this._isRendering&&console.warn("Renderer.modify called while rendering");var i=[],n=[];this._mergedOrInstanced(e,i,n);var s=[],o=[];this._mergedOrInstanced(t,s,o);var d={};r&&this._performUpdates(r,d);var l=[];this._modifyMerged(i,s,l,d),this._modifyInstanced(n,o,l),this._updateMergedFaceranges(d),this._releaseMaterials(l),this._modifyMaterials(a),this._needsRender=!0},e.prototype._isInstanced=function(e){var t=!1,r=T(e.data.faces.indices).length;return t=t||e.material.canBeMerged===!1,t=t||e.material.instanced,t=t||e.material.isBackdrop,e.singleUse?t:t=t||r>this._threshold},e.prototype._mergedOrInstanced=function(e,t,r){for(var a=0;a<e.length;++a){var i=T(e[a].data.faces.indices).length;if(!(1>i)){var n=this._isInstanced(e[a]);n?r.push(e[a]):t.push(e[a])}}},e.prototype._performUpdates=function(e,t){for(var r=0;r<e.length;r++){var a=e[r],i=a.renderGeometry,n=this._isInstanced(i),s=a.updateType;2&s&&this._updateFaceranges(i,n,t),4&s||!n&&16&s?this._updateVertexAttributes(i,n):n&&16&s?this._updateInstanceTransformation(i,n):8&s&&this._updateColorAttributes(i)}},e.prototype._updateFaceranges=function(e,t,r){var a=e.material,i=a.getId(),n=e.origin.id,s=t?this._mat2dataInstanced:this._mat2dataMerged,o=s[i],d=o.origin2data[n],l=d.instances[e.uniqueName];l&&(l.displayedIndexRange=e.displayedIndexRange,t||(r[this._modifiedMergedFacerangesKey(i,n)]=d))},e.prototype._updateMergedFaceranges=function(e){for(var t in e){var a=e[t];a.displayedIndexRange=[];var i=a.instances,n=!0;for(var s in i){var o=i[s];o.displayedIndexRange?(a.displayedIndexRange.push.apply(a.displayedIndexRange,r.offsetIntervals(o.displayedIndexRange,o.from)),n=!1):a.displayedIndexRange.push([o.from,o.to-1])}a.displayedIndexRange=n?null:r.mergeIntervals(a.displayedIndexRange)}},e.prototype._updateVertexAttributes=function(e,t){var r,a,i=e.material,n=i.getId(),s=e.origin.id,o=t?this._mat2dataInstanced:this._mat2dataMerged,d=o[n],l=d.origin2data[s],h=l.instances[e.uniqueName];if(!t){var f=e.origin.vec3;C(U,-f[0],-f[1],-f[2]),E.multiply(U,e.transformation,z),E.inverse(z,q),E.transpose(q),r=z,a=q}var u=i.getVertexBufferLayout().getStride();I(h.from+i.getOutputAmount(T(e.data.faces.indices).length)/u===h.to,"material VBO layout has changed"),i.fillInterleaved(e.data,r,a,e.instanceParameters,l.buffer.getArray(),h.from*u),l.vbo.updateSubData(l.buffer.getArray(),h.from*u,h.to*u)},e.prototype._updateInstanceTransformation=function(e,t){var r=e.origin.vec3,a=t?this._mat2dataInstanced:this._mat2dataMerged,i=a[e.material.getId()],n=i.origin2data[e.origin.id],s=n.instances[e.uniqueName];C(U,-r[0],-r[1],-r[2]),E.multiply(U,e.transformation,s.transformation),E.inverse(s.transformation,s.transformationNormal),E.transpose(s.transformationNormal,s.transformationNormal);var o=n.perGeometryDataInfo[e.data.id],d=o.instanceBufferData;if(d){var l=d.getSlot(e.idx);d.fill(l,0,s.transformation),d.fill(l,16,s.transformationNormal);var h=d.getOffset(l);o.instanceBuffer.updateSubData(d.getArray(),h,h+32)}},e.prototype._updateColorAttributes=function(e){var t=e.material,r=t.getId(),a=e.origin.id,i=this._isInstanced(e),n=i?this._mat2dataInstanced:this._mat2dataMerged,s=n[r],o=s.origin2data[a],d=o.instances[e.uniqueName],l={};l[P.COLOR]=!0;var h=t.getVertexBufferLayout().getStride();I(d.from+t.getOutputAmount(T(e.data.faces.indices).length)/h===d.to,"material VBO layout has changed"),t.fillInterleaved(e.data,void 0,void 0,e.instanceParameters,o.buffer.getArray(),d.from*h,l),o.vbo.updateSubData(o.buffer.getArray(),d.from*h,d.to*h)},e.prototype._modifyMerged=function(e,t,r,a){var n=this._compMat2delta(e,t,!1);for(var s in n){var o=n[s];for(var d in o){var l=o[d],f=l.optimalCount,u=l.material,m=u.getVertexBufferLayout(),p=m.getStride(),_=this._mat2dataMerged[s];if(null==_){I(f>0);var c=u.getRenderPriority();_={origin2data:{}},_[g.MATERIAL]=this._materialRep.aquire(u),_[g.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(u),_[g.MATERIAL_NORMAL]=this._materialRep.aquireNormal(u),_[g.MATERIAL_DEPTH]=this._materialRep.aquireDepth(u),_[g.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(u),this._mat2dataMerged[s]=_,this._orderedRendering&&this._insertIntoRenderOrder(_,c,"merged")}var v=_.origin2data[d];if(null==v&&(I(f>0),v={instances:{},vbo:new h(void 0,m,this._gl),buffer:new i(f),optimalCount:0,origin:l.origin},_.origin2data[d]=v),f>0){var R=v.buffer.getSize(),x=v.buffer.getArray(),y=f<l.sparseCount/2,b=v.buffer.resize(y?f:l.sparseCount),A=l.toRemove;if(y||b){R=0;for(var M=v.buffer.getArray(),D=!1,O=0,P=A.length;P>O;++O){var S=v.instances[A[O].uniqueName];v.optimalCount-=(S.to-S.from)*p,delete v.instances[A[O].uniqueName]}var B={};for(var w in v.instances){var S=v.instances[w];I(null==B[S.from]),B[S.from]=S}for(var F in B){var S=B[F],H=S.from*p,N=S.to*p;M.set(x.subarray(H,N),R),S.from=R/p,R+=N-H,S.to=R/p,S.displayedIndexRange&&(D=!0)}I(R===v.optimalCount)}else for(var O=0,L=A.length;L>O;++O){var V=A[O].uniqueName;I(void 0!==v.instances[V]);var H=v.instances[V].from*p,N=v.instances[V].to*p;v.buffer.erase(H,N),delete v.instances[V],v.optimalCount-=N-H}C(U,-l.origin[0],-l.origin[1],-l.origin[2]);for(var j=l.toAdd,Q=!1,O=0,k=j.length;k>O;++O){var X=j[O],K=X.data;E.multiply(U,X.transformation,z),E.inverse(z,q),E.transpose(q);var Y=R;u.fillInterleaved(K,z,q,X.instanceParameters,v.buffer.getArray(),R);var W=u.getOutputAmount(T(K.faces.indices).length),Z=Y+W;I(null==v.instances[X.uniqueName]);var S=new G(X.name,Y/p,Z/p,X.displayedIndexRange,void 0,void 0,X.idx);X.displayedIndexRange&&(Q=!0),v.instances[X.uniqueName]=S,v.optimalCount+=W,R+=W}I(v.optimalCount===f),v.vbo.setData(v.buffer.getArray(),v.buffer.getSize()),(Q||v.displayedIndexRange)&&(a[this._modifiedMergedFacerangesKey(s,d)]=v)}else I(0===f),v.vbo.dispose(),delete _.origin2data[d],0===Object.keys(_.origin2data).length&&(r.push(s),delete this._mat2dataMerged[s],this._orderedRendering&&this._removeFromRenderOrder(_,"merged"))}}},e.prototype._modifyInstanced=function(e,t,r){var a=this._compMat2delta(e,t,!0);for(var s in a){var o=a[s];for(var d in o){var l=o[d];if(0!==l.optimalCount){var f=l.material,u=this._mat2dataInstanced[s];if(null==u){var m=f.getRenderPriority();u={origin2data:{}},u[g.MATERIAL]=this._materialRep.aquire(f),u[g.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(f),u[g.MATERIAL_NORMAL]=this._materialRep.aquireNormal(f),u[g.MATERIAL_DEPTH]=this._materialRep.aquireDepth(f),u[g.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(f),this._mat2dataInstanced[s]=u,this._orderedRendering&&this._insertIntoRenderOrder(u,m,"instanced")}var p=f.getVertexBufferLayout(),_=u[g.MATERIAL].instanced?f.getInstanceBufferLayout():null,c=_&&_.hasAttribute("instanceColor"),v=p.getStride(),R=u.origin2data[d];null==R&&(R={instances:{},vbo:new h(void 0,p,this._gl),buffer:new i(l.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:l.origin},u.origin2data[d]=R);var x=R.buffer.getSize(),y=R.buffer.getArray(),b=l.optimalCount<l.sparseCount/2,A=R.buffer.resize(b?l.optimalCount:l.sparseCount);for(var M in l.perGeometryDelta){var D=R.perGeometryDataInfo[M];if(D&&D.instanceBufferData){var O=l.perGeometryDelta[M].removeCount;O>0&&D.instanceBufferData.prepareFree(O)}}var P=l.toRemove;if(b||A){for(var S=0,B=P.length;B>S;++S){var w=P[S];delete R.instances[w.uniqueName];var M=w.data.id,D=R.perGeometryDataInfo[M],F=D;0===--F.refCount&&null==l.dataId2refCount[M]?(R.optimalCount-=(F.to-F.from)*v,delete R.perGeometryDataInfo[M]):D.instanceBufferData&&D.instanceBufferData.free(w.idx)}x=0;var H=R.buffer.getArray(),N={};for(var L in R.perGeometryDataInfo){var F=R.perGeometryDataInfo[L];I(null==N[F.from]),N[F.from]=F}for(name in N){var F=N[name],V=F.from*v,z=F.to*v;H.set(y.subarray(V,z),x),F.from=x/v,x+=z-V,F.to=x/v}for(name in R.instances){var q=R.instances[name];q.from=R.perGeometryDataInfo[q.dataId].from,q.to=R.perGeometryDataInfo[q.dataId].to}}else for(var S=0,j=P.length;j>S;++S){var w=P[S];delete R.instances[w.uniqueName];var M=w.data.id,D=R.perGeometryDataInfo[M];if(0===--D.refCount&&null==l.dataId2refCount[M]){var V=D.from*v,z=D.to*v;R.buffer.erase(V,z),R.optimalCount-=z-V,delete R.perGeometryDataInfo[M]}else D.instanceBufferData&&D.instanceBufferData.free(w.idx)}C(U,-l.origin[0],-l.origin[1],-l.origin[2]);for(var M in l.perGeometryDelta){var D=R.perGeometryDataInfo[M];if(D&&D.instanceBufferData){var Q=l.perGeometryDelta[M].addCount;Q>0&&D.instanceBufferData.prepareAllocate(Q)}}for(var k=l.toAdd,S=0,X=k.length;X>S;++S){var w=k[S],K=w.data,M=K.id,D=R.perGeometryDataInfo[M];if(null==D){f.fillInterleaved(K,void 0,void 0,void 0,R.buffer.getArray(),x);var Y=f.getOutputAmount(T(K.faces.indices).length),V=x/v;x+=Y;var z=x/v;R.optimalCount+=Y,D={refCount:1,from:V,to:z,instanceBuffer:null,instanceBufferData:null},_&&(D.instanceBuffer=new h(void 0,_,this._gl),D.instanceBufferData=new n(_.getStride(),l.perGeometryDelta[M].addCount)),R.perGeometryDataInfo[M]=D}else++D.refCount;I(D.from*v<=R.buffer.getSize()&&D.to*v<=R.buffer.getSize());var W=E.create();E.multiply(U,w.transformation,W);var q=new G(w.name,D.from,D.to,w.displayedIndexRange,W,w.instanceParameters,w.idx,M),Z=D.instanceBufferData;if(Z){var J=Z.allocate(w.idx);Z.fill(J,0,q.transformation),Z.fill(J,16,q.transformationNormal),c&&Z.fill(J,32,w.instanceParameters.color)}R.instances[w.uniqueName]=q}I(R.optimalCount===l.optimalCount),R.vbo.setData(R.buffer.getArray(),R.buffer.getSize());for(var M in R.perGeometryDataInfo){var $=R.perGeometryDataInfo[M];if($.instanceBuffer){var et=l.perGeometryDelta[M];if(et.addCount+et.removeCount>0){var tt=$.instanceBufferData.compact();$.instanceBuffer.setData(tt,tt.length)}}}}else{var rt=this._mat2dataInstanced[s];rt.origin2data[d].vbo.dispose(),delete rt.origin2data[d],0===Object.keys(rt.origin2data).length&&(r.push(s),delete this._mat2dataInstanced[s],this._orderedRendering&&this._removeFromRenderOrder(rt,"instanced"))}}}},e.prototype._compMat2delta=function(e,t,r){var a={};return this._updateMat2delta(e,!0,r,a),this._updateMat2delta(t,!1,r,a),a},e.prototype._updateMat2delta=function(e,t,r,a){for(var i=0,n=e.length;n>i;++i){var s=e[i],o=s.origin,d=s.material,l=d.getId(),h=r?this._mat2dataInstanced[l]:this._mat2dataMerged[l],f=h&&h.origin2data[o.id],u=a[l];null==u&&(u={},a[l]=u);var m=u[o.id];if(null==m){if(m={optimalCount:null==f?0:f.optimalCount,sparseCount:null==f?0:f.buffer.getSize(),material:d,toAdd:[],toRemove:[],perGeometryDelta:null,origin:o.vec3},r){var p={};if(void 0!==f)for(var g in f.perGeometryDataInfo)p[g]=f.perGeometryDataInfo[g].refCount;m.dataId2refCount=p,m.perGeometryDelta={}}u[o.id]=m}var _=d.getOutputAmount(T(s.data.faces.indices).length);if(r){var c=s.data.id,v=m.perGeometryDelta[c];v||(v={addCount:0,removeCount:0},m.perGeometryDelta[c]=v),t?(v.addCount++,null==m.dataId2refCount[c]&&(m.dataId2refCount[c]=0),1===++m.dataId2refCount[c]&&(m.optimalCount+=_,m.sparseCount+=_),m.toAdd.push(s)):(v.removeCount++,0===--m.dataId2refCount[c]&&(delete m.dataId2refCount[c],m.optimalCount-=_),m.toRemove.push(s))}else t?(m.optimalCount+=_,m.sparseCount+=_,m.toAdd.push(s)):(m.optimalCount-=_,m.toRemove.push(s))}},e.prototype._modifiedMergedFacerangesKey=function(e,t){return e+"_"+t},e.prototype._insertIntoRenderOrder=function(e,t,r){for(var a=e[g.MATERIAL].getMaterialId(),i=this._renderOrder.length,n=0;i>n&&this._renderOrder[n][0]>=t;){var s=this._renderOrder[n][1];if(s.id===a)return I(!s[r],"matData for type already exists"),void(s[r]=e);n++}var o={id:a,instanced:null,merged:null};o[r]=e,this._renderOrder.splice(n,0,[t,o])},e.prototype._removeFromRenderOrder=function(e,t){for(var r=e[g.MATERIAL].getMaterialId(),a=0;this._renderOrder[a][1].id!==r;)a++;var i=this._renderOrder[a][1];i[t]=null,i.instanced||i.merged||this._renderOrder.splice(a,1)},e.prototype._updateRenderOrder=function(e,t){for(var r=t.length,a=0;r>a&&t[a][1].id!==e;)a++;if(r>a){var i=t[a][1],n=i.merged||i.instanced,s=n[g.MATERIAL].getRenderPriority(),o=t[a][0];if(s!==t[a][0]){t[a][0]=s;var d=s>o?-1:1;for(a+=d;a>-1&&r>a&&d*t[a][0]>d*s;){var l=t[a];t[a]=t[a-d],t[a-d]=l,a+=d}}}},e.prototype._modifyMaterials=function(e){for(var t in e)this._materialRep.updateMaterialParameters(t)},e.prototype.modifyRenderOrder=function(e){if(this._orderedRendering){for(var t in e)this._updateRenderOrder(t,this._renderOrder);this._needsRender=!0}},e.prototype._releaseMaterials=function(e){if(Array.isArray(e))for(var t=e,r=0;r<t.length;r++)this._materialRep.release(t[r]),this._materialRep.releaseDepthShadowMap(t[r]),this._materialRep.releaseNormal(t[r]),this._materialRep.releaseDepth(t[r]),this._materialRep.releaseHighlight(t[r]);else this._materialRep.release(e),this._materialRep.releaseDepthShadowMap(e),this._materialRep.releaseNormal(e),this._materialRep.releaseDepth(e),this._materialRep.releaseHighlight(e)},e.prototype._name2indices=function(e){for(var t=new R,r=0;2>r;++r){var a=0===r?this._mat2dataMerged:this._mat2dataInstanced;for(var i in a){var n=a[i].origin2data;for(var s in n){var o=n[s].instances;for(var d in o){var l=o[d];void 0!==e[l.name]&&t.set(l.idx)}}}}return t},e}(),L=function(){function e(){this.reset()}return e.prototype.reset=function(){this.trianglesRendered=0,this.drawCallsInstanced=0,this.drawCallsAngleInstanced=0,this.drawCallsMerged=0,this.drawCallsFragmented=0,this.instancesDrawnAngle=0,this.VBOallocatedSize=0,this.VBOoptimalSize=0,this.VBOusedSize=0},e}(),G=function(){function e(e,t,r,a,i,n,s,o){this.name=e,this.from=t,this.to=r,this.displayedIndexRange=a,this.transformation=i,this.instanceParameters=n,this.idx=s,this.dataId=o,null!=i&&(this.transformationNormal=E.create(),E.set(i,this.transformationNormal),E.inverse(this.transformationNormal,this.transformationNormal),E.transpose(this.transformationNormal,this.transformationNormal))}return e}(),V=M.create(),U=E.identity(),z=E.create(),q=E.create();return N});