// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","dojo/string","../lib/lights","../lib/ModelContentType","../lib/ModelDirtySet","../lib/RenderGeometry","../lib/Util","../lib/gl-matrix"],function(t,e,i,n,o,r,a,s,d){var l=s.assert,g=s.verify,h=d.vec3d,c=d.mat4d,u=s.logWithBase,f=1e4,p=10,y=function(){function t(){this.dirtySet=new r(this),this.ambientLight=new n.AmbientLight([1,1,1],.3),this.directionalLight=new n.DirectionalLight([1,1,1],.7,h.normalize([1,1,1])),this._uniqueName2idx={},this._uniqueIdx=0,this._id2origin={},this._modelListeners=[],this.content={};for(var t in o)this.content[o[t]]={}}return t.prototype.getAll=function(t){var e=this.content[t];return l(void 0!==e),e},t.prototype.get=function(t,e){return this.getAll(t)[e]},t.prototype.add=function(t,e){var i=this.content[t];l(void 0!==i);var n=e.getId();l(null==i[n],"Model/Stage already contains object to be added"),i[n]=e,t===o.LAYER&&this.notifyDirty(t,e,"layerAdded"),this._notifyContentAdded(t,e)},t.prototype.remove=function(t,e){var i=this.content[t];l(void 0!==i);var n=i[e];return l(void 0!==n,"Model/Stage doesn't contain object to be removed"),delete i[e],t===o.TEXTURE&&n.unload(),t===o.LAYER&&this.notifyDirty(t,n,"layerRemoved"),this._notifyContentRemoved(t,n),n},t.prototype.getDirtySet=function(){return this.dirtySet},t.prototype.notifyDirty=function(t,e,i,n){this.dirtySet.handleUpdate(e,i,n)},t.prototype.getAmbientLight=function(){return this.ambientLight},t.prototype.setAmbientLight=function(t){this.ambientLight.set(t)},t.prototype.getDirectionalLight=function(){return this.directionalLight},t.prototype.setDirectionalLight=function(t){this.directionalLight.set(t)},t.prototype.getSelection=function(){return this.selection},t.prototype.setSelection=function(t,e){this.selection=t,this.selectionFaceRange=e},t.prototype.getSelectionFaceRange=function(){return this.selectionFaceRange},t.prototype.getOrigin=function(t,e,i){void 0===i&&(i=p);var n=0,o=e*i/f;o>1&&(n=Math.ceil(u(o,2)));var r=Math.pow(2,n)*f,a=Math.round(t[0]/r),s=Math.round(t[1]/r),d=Math.round(t[2]/r),l=n+"_"+a+"_"+s+"_"+d,g=this._id2origin[l];return null==g&&(g={vec3:h.createFrom(a*r,s*r,d*r),id:l},this._id2origin[l]=g),g},t.prototype.getGeometryRenderGeometries=function(t,e,i){for(var n=t.getId(),o=e.geometry,r=o.getData(),s=!!o.singleUse,d=r.getFaces(),l=r.getVertexAttr(),g=r.getId(),h=e.materials,u=e.instanceParameters,f=t.getCombinedTransformation(e),p=c.maxScale(f),y=e.origin,m=t.getVisibleIndexRanges(e),v=0,b=o.getNumGroups();b>v;++v){var L=o.getBoundingInfo(v),A=e.getId()+"#"+v,R=this._uniqueName2idx[A];null==R&&(R=this._uniqueIdx++,this._uniqueName2idx[A]=R);var _={};for(var I in d[v].indices)_[I]=l[I];var x={faces:d[v],vertexAttr:_,id:g+"#"+v},M=new a(x,L,h[v],f,p,t.getCastShadow(),s,n,A,R,v);M.origin=y||this.getOrigin(M.center,M.bsRadius),M.displayedIndexRange=m?m[v]:null,M.instanceParameters=u?e.instanceParameters[v]:null,i.push(M)}},t.prototype.formatDebugInfo=function(t){var e=[];if(t){e[0]="<table>";for(var n in o){var r=o[n];e[0]+="<tr><td>"+r+'</td><td style="text-align: right">'+Object.keys(this.getAll(r)).length+"</td></tr>"}e[0]+="</table>",e[1]=this.dirtySet.formatDebugInfo(!0)}else{e[0]="";for(var n in o){var r=o[n];e[0]+=i.pad(String(Object.keys(this.getAll(r)).length),6," ")+" "+r+", "}e[1]=this.dirtySet.formatDebugInfo(!1)}return e},t.prototype.validateContent=function(){var t=this.getAll(o.OBJECT);for(var e in t)this.validateObject(t[e]);var i=this.getAll(o.LAYER);for(name in i)this.validateLayer(i[name]);var n=this.getAll(o.MATERIAL);for(name in n)this.validateMaterial(n[name])},t.prototype.validateObject=function(t){for(var e=t.geometryRecords,i=0;i<e.length;++i){var n=e[i];l(null!=this.get(o.GEOMETRY,n.geometry.id));var r=n.geometry.numGroups;l(r<=n.materials.length,"object materials do not match geometry groups"),g(r===n.materials.length,"object materials do not match geometry groups");for(var a=0;r>a;++a)l(null!=this.get(o.MATERIAL,n.materials[a].getId()))}},t.prototype.validateLayer=function(t){for(var e=t.getObjects(),i=0;i<e.length;++i){var n=this.get(o.OBJECT,e[i].getId());l(null!=n)}},t.prototype.validateMaterial=function(t){for(var e=t.getAllTextureIds(),i=0;i<e.length;++i){var n=this.get(o.TEXTURE,e[i]);l(null!=n)}},t.prototype.addModelListener=function(t){l(-1===this._modelListeners.indexOf(t)),this._modelListeners.push(t)},t.prototype.removeModelListener=function(t){var e=this._modelListeners.indexOf(t);l(-1!==e),this._modelListeners.splice(e,e)},t.prototype._notifyContentAdded=function(t,e){this._modelListeners.forEach(function(i){i.contentAdded&&i.contentAdded(t,e)})},t.prototype._notifyContentRemoved=function(t,e){this._modelListeners.forEach(function(i){i.contentRemoved&&i.contentRemoved(t,e)})},t.ContentType=o,t}();return y});