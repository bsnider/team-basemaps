// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","../lib/GLTextureRep","../lib/GLSLProgramRep","../lib/GLMaterialRep","../lib/ShaderSnippets","../lib/GLSLShaderRep","../lib/GLVBORep","../lib/TextureRenderer","../lib/Util","../lib/gl-matrix","../lib/webgl-utils","../lib/GLDefaultState","./Model","./Viewport","../materials/repository","../lib/SSAOHelperObscurance","../lib/HighlightHelper","../lib/OffscreenRenderingHelper","../../../../core/sniff","../lib/tracer"],function(e,t,i,r,s,n,a,h,o,p,d,l,_,u,c,g,R,v,w,f,m){var y=d.vec3d,x=d.vec4d,C=function(){function e(e,t,r,n){var a=this;this._backgroundColor=x.createFrom(1,1,1,1),this._lightDirection=y.createFrom(0,1,0),this._didRender=!1,this._needsRender=!0,this._idleSuspend=!0,this._shouldRender=!1,this._screenCaptureQueue=[],this._container=e,this._stage=t,this._initializeContext(n),this._initializeShaders(),this._vboRep=new h;var p=function(){return a._viewport.getCamera().viewport};this._textureRep=new i(t.getAll(u.ContentType.TEXTURE),this._programRep,p,this._gl),this._materialRep=new s(this._textureRep,this._programRep),this._viewport=new c(this._programRep,this._vboRep,this._materialRep,this._textureRep,this._gl),this._initializeViewportCamera(),this._textureRenderer=new o(this._gl,this._canvas,this._programRep,this._materialRep,this._textureRep,r),this._initializeFrameTask()}return e.prototype._initializeFrameTask=function(){var e=this;this._frameTask={preRender:function(){if(m.begin(),e._stage.processDirty(),e.needsRender()){e._shouldRender=!0;var t=e._viewport.getCamera();t.setGLViewport(e._gl),e._gl.clearColor.apply(e._gl,e._backgroundColor),e._gl.clear(16640)}else e._shouldRender=!1},render:function(){e._shouldRender&&(e._didRender=!0,e._gl.web3DDefaultState.apply(),e._viewport.render(e._lightDirection,null))},postRender:function(){m.end()},update:function(){e._performScreenCaptures(),e.resetNeedsRender()}}},e.prototype._initializeViewportCamera=function(){var e=this._container.getBoundingClientRect(),t=this._viewport.getCamera();t.viewport[2]=e.width,t.viewport[3]=e.height,this._viewport.setCamera(t)},e.prototype._initializeContext=function(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");var t={alpha:e.alpha||!1};null!=e.antialias&&(t.antialias=e.antialias,f("ff")&&e.antialias===!1&&(t.stencil=!0));var i=l.setupWebGL(this._canvas,t);this._gl=m.instrumentContext(i[0]),this._gl.pixelStorei(37440,!0),this._gl.web3DDefaultState=new _(this._gl),this._container.appendChild(this._canvas)},e.prototype._initializeShaders=function(){this._shaderSnippets=new n,this._shaderRep=new a,this._programRep=new r,g.initializeShaders(this._shaderSnippets,this._shaderRep,this._programRep,this._gl),v.loadShaders(this._shaderSnippets,this._shaderRep,this._programRep,this._gl),R.loadShaders(this._shaderSnippets,this._shaderRep,this._programRep,this._gl),w.loadShaders(this._shaderSnippets,this._shaderRep,this._programRep,this._gl)},e.prototype.dispose=function(){this._viewport.dispose(),this._viewport=null,this._textureRenderer.dispose(),this._textureRenderer=null,this._programRep.dispose(),this._programRep=null,this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._container=null,this._canvas=null,this._gl=null},e.prototype.getCombinedStats=function(){return this._viewport.getCombinedStats()},e.prototype.setNeedsRender=function(){this._didRender=!1,this._needsRender=!0},e.prototype.resetNeedsRender=function(){this._didRender&&(this._needsRender=!1,this._didRender=!1),this._viewport.resetNeedsRender(),this._textureRep.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||!this._idleSuspend||this._viewport.needsRender()||this._textureRep.needsRender()},e.prototype.getFrameTask=function(){return this._frameTask},e.prototype.setLights=function(e,t){var i=e,r=t;y.set(r.direction,this._lightDirection),x.set4(i.color[0],i.color[1],i.color[2],i.intensity,b.ambient),x.set4(r.color[0],r.color[1],r.color[2],r.intensity,b.diffuse),x.set4(r.color[0],r.color[1],r.color[2],Math.min(r.intensity+i.intensity,1),b.specular),y.set(r.direction,b.direction),this._viewport.setLightingData(b),this._needsRender=!0},e.prototype.getViewParams=function(e){var t=this._viewport.getViewParams(e);return(!e||e.backgroundColor)&&(t.backgroundColor=this._backgroundColor),t},e.prototype.setViewParams=function(e){this._needsRender=!0,e.backgroundColor&&(this._backgroundColor=e.backgroundColor),this._viewport.setViewParams(e)},e.prototype.setRenderParams=function(e){this._needsRender=!0,"anisotropicFiltering"in e&&this._textureRep.setMaxAnisotropy(e.anisotropicFiltering),"backfaceCulling"in e&&(this._gl.web3DDefaultState.cullEnabled=e.backfaceCulling),void 0!==e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend),this._viewport.setRenderParams(e)},e.prototype.getRenderParams=function(){var e=this._viewport.getRenderParams();return e.anisotropicFiltering=this._textureRep.getMaxAnisotropy(),e.backfaceCulling=this._gl.web3DDefaultState.cullEnabled,e.idleSuspend=this._idleSuspend,e},e.prototype.has=function(e){return"s3tc"===e?!!this._gl.getExtension("WEBGL_compressed_texture_s3tc"):!1},e.prototype.getFrustumObjects=function(){return this._viewport.getFrustumObjects()},e.prototype.modify=function(e,t,i,r){this._viewport.modify(e,t,i,r)},e.prototype.setSelectionObject=function(e,t){this._viewport.setSelectionObject(e,t)},e.prototype.setCamera=function(e){this._viewport.setCamera(e)},e.prototype.getCamera=function(){return this._viewport.getCamera()},e.prototype.getPickRay=function(e,t,i){this._viewport.getPickRay(e,t,i)},e.prototype.pickRayWithBeginPoint=function(e,t,i,r,s){this._viewport.pickRayWithBeginPoint(e,t,i,r,s)},e.prototype.getCanvas=function(){return this._canvas},e.prototype.getTextureGraphicsRenderer=function(){return this._textureRenderer},e.prototype.requestScreenCapture=function(e,t){this._screenCaptureQueue.push({settings:e||{},callback:t}),this._needsRender=!0},e.prototype.getAllTexturesLoaded=function(){return 0===this._textureRep.getLoadingCount()},e.prototype.getTextureLoaded=function(e){return this._textureRep.getIsLoaded(e)},e.prototype.addTextureListener=function(e){this._textureRep.addTextureListener(e)},e.prototype.removeTextureListener=function(e){this._textureRep.removeTextureListener(e)},e.prototype.addExternalRenderer=function(e,t){return this._viewport.addExternalRenderer(e,t)?(t.initializeRenderContext({gl:this._gl,shaderSnippets:this._shaderSnippets,shaderRep:this._shaderRep,programRep:this._programRep,textureRep:this._textureRep}),!0):!1},e.prototype.removeExternalRenderer=function(e){return this._viewport.removeExternalRenderer(e)},e.prototype._performScreenCaptures=function(){if(0!==this._screenCaptureQueue.length){for(var e=0;e<this._screenCaptureQueue.length;e++){var t=this._screenCaptureQueue[e],i={x:0,y:0,width:this._canvas.width,height:this._canvas.height},r={x:0,y:0,width:this._canvas.width,height:this._canvas.height},s=t.settings.area;if(s&&(i.x=s.x,i.y=s.y,i.width=s.width,i.height=s.height),void 0!==t.settings.width&&void 0!==t.settings.height){var n=t.settings.width/t.settings.height;if(i.height*n<i.width){var a=i.height*n;i.x+=Math.floor((i.width-a)/2),i.width=Math.floor(a)}else{var h=i.width/n;i.y+=Math.floor((i.height-h)/2),i.height=Math.floor(h)}r.width=t.settings.width,r.height=t.settings.height}else r.width=i.width,r.height=i.height;var o=this._canvas;if(0!==i.x||0!==i.y||i.width!==this._canvas.width||i.height!==this._canvas.height||0!==r.x||0!==r.y||r.width!==this._canvas.width||r.height!==this._canvas.height){this._resizeCanvas||(this._resizeCanvas=document.createElement("canvas")),this._resizeCanvas.width=r.width,this._resizeCanvas.height=r.height;var d=this._resizeCanvas.getContext("2d"),l=new Uint8Array(i.width*i.height*4);this._gl.readPixels(i.x,this._canvas.height-(i.y+i.height),i.width,i.height,6408,5121,l);var _=d.getImageData(r.x,r.y,r.width,r.height);p.resampleHermite(l,i.width,i.height,_.data,r.width,r.height,!0),d.putImageData(_,r.x,r.y),o=this._resizeCanvas,d=null}var u={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"}[t.settings.format?t.settings.format.toLowerCase():"png"],c=1;void 0!==t.settings.quality&&(c=t.settings.quality/100);var g=o.toDataURL(u,c);t.callback({dataURL:g,x:r.x,y:r.y,width:r.width,height:r.height})}this._screenCaptureQueue=[]}},e}(),b={ambient:x.create(),diffuse:x.create(),specular:x.create(),direction:y.create()};return C});