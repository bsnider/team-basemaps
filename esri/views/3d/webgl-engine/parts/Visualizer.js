// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","../lib/Renderer","../lib/SSAOHelperObscurance","../lib/ShadowMap","../lib/NearFarCalc","../lib/Util","../lib/gl-matrix","../lib/RenderPass","../lib/HighlightHelper","../lib/OffscreenRenderingHelper"],function(e,t,a,s,r,i,n,o,d,h,p){var l=o.vec3d,_=o.mat4d,u=n.assert,g=function(){function e(e,t,n,o,d){this._drawShadowMapDebugQuad=!1,this._drawSSAOMapDebugQuad=!1,this._needsRender=!0,this._content={},this._gl=d,this._renderer=new a(e,t,n,o,d,!1),this._programRep=e,this._shadowMap=new r(e,d),this._ssaoHelper=new s(e,o,d),this._nearFarCalc=new i,this._highlightHelper=new h(e,o,d),this._offscreenRenderingHelper=new p(e,d)}return e.prototype.getCombinedStats=function(){return this._renderer.getCombinedStats()},e.prototype.dispose=function(){this._renderer.dispose(),this._shadowMap.getEnableState()&&this._shadowMap.setEnableState(!1),this._ssaoHelper.getEnableState()&&this._ssaoHelper.setEnableState(!1),this._highlightHelper.getEnableState()&&this._highlightHelper.setEnableState(!1),this._offscreenRenderingHelper.getEnableState()&&this._offscreenRenderingHelper.setEnableState(!1)},e.prototype.setLightingData=function(e){this._renderer.setLightingData(e)},e.prototype.getLightingData=function(){return this._renderer.getLightingData()},e.prototype.getViewParams=function(e){var t=e||{};return(!e||e.pixelRatio)&&(t.pixelRatio=this._renderer.getPixelRatio()),t},e.prototype.setViewParams=function(e){null!=e.pixelRatio&&this._renderer.setPixelRatio(e.pixelRatio)},e.prototype.setRenderParams=function(e){void 0!==e.shadowMapResolution&&this._shadowMap.getEnableState()===!1&&this._shadowMap.setTextureResolution(e.shadowMapResolution),void 0!==e.shadowMap&&e.shadowMap!==this._shadowMap.getEnableState()&&this._shadowMap.setEnableState(e.shadowMap),void 0!==e.shadowMapMaxCascades&&this._shadowMap.setMaxNumCascades(e.shadowMapMaxCascades),!0!==this._highlightHelper.getEnableState()&&this._highlightHelper.setEnableState(!0),void 0!==e.ssao&&e.ssao!==this._ssaoHelper.getEnableState()&&this._ssaoHelper.setEnableState(e.ssao),void 0!==e.ssaoAttenuation&&this._ssaoHelper.setAttenuation(e.ssaoAttenuation),void 0!==e.ssaoRadius&&this._ssaoHelper.setRadius(e.ssaoRadius),void 0!==e.ssaoFilterRadius&&this._ssaoHelper.setFilterRadius(e.ssaoFilterRadius),void 0!==e.ssaoSamples&&this._ssaoHelper.setSamples(e.ssaoSamples),void 0!==e.drawShadowMapDebugQuad&&(this._drawShadowMapDebugQuad=e.drawShadowMapDebugQuad),void 0!==e.drawSSAODebugQuad&&(this._drawSSAOMapDebugQuad=e.drawSSAODebugQuad),this._renderer.ssaoEnabled=this._ssaoHelper.getEnableState()?!0:!1,void 0!==e.offscreenRendering&&e.offscreenRendering!==this._offscreenRenderingHelper.getEnableState()&&(this._offscreenRenderingHelper.setEnableState(e.offscreenRendering),this._renderer.offscreenRenderingEnabled=e.offscreenRendering),this._needsRender=!0},e.prototype.getRenderParams=function(){var e={};return this._shadowMap.getIsSupported()&&(e.shadowMap=this._shadowMap.getEnableState(),e.shadowMapResolution=this._shadowMap.getTextureResolution(),e.shadowMapMaxCascades=this._shadowMap.getMaxNumCascades()),this._ssaoHelper.getIsSupported()&&(e.ssao=this._ssaoHelper.getEnableState(),e.ssaoAttenuation=this._ssaoHelper.getAttenuation(),e.ssaoRadius=this._ssaoHelper.getRadius(),e.ssaoFilterRadius=this._ssaoHelper.getFilterRadius(),e.ssaoSamples=this._ssaoHelper.getSamples()),e},e.prototype.modify=function(e,t,a,s){this._renderer.modify(e,t,a,s);for(var r=0,i=t.length;i>r;++r)delete this._content[t[r].uniqueName];for(var r=0,n=e.length;n>r;++r)this._content[e[r].uniqueName]=e[r];for(var r=0,o=a.length;o>r;++r)u(this._content[a[r].renderGeometry.uniqueName]===a[r].renderGeometry)},e.prototype.getContent=function(){return this._content},e.prototype.getPickRay=function(e,t,a,s,r,i){l.unproject(l.createFrom(e[0],e[1],0),s,a.projectionMatrix,a.fullViewport,r),l.unproject(l.createFrom(e[0],e[1],1),s,a.projectionMatrix,a.fullViewport,i)},e.prototype.getProjectionMatrix=function(e,t,a,s,r){var i=n.fovx2fovy(t,e[2],e[3]);_.perspective(180*i/Math.PI,e[2]/e[3],a,s,r)},e.prototype.setSelectionObject=function(e,t){this._renderer.setSelectionObject(e,t)},e.prototype.addExternalRenderer=function(e,t){return this._renderer.addExternalRenderer(e,t)},e.prototype.removeExternalRenderer=function(e){return this._renderer.removeExternalRenderer(e)},e.prototype.getExternalRenderers=function(){return this._renderer.getExternalRenderers()},e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._renderer.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._renderer.needsRender()},e.prototype.render=function(e,t,a,s){var r,i=e.viewport;if((this._shadowMap.getEnableState()||this._ssaoHelper.getEnableState())&&(r=this._nearFarCalc.calculateSceneNearFar(e,this._content,a)),this._shadowMap.getEnableState()){this._shadowMap.prepare(e,t,this._content,a,r);for(var n=this._shadowMap.getCascades(),o=0;o<n.length;++o){var h=n[o];h.camera.setGLViewport(this._gl),this._renderer.renderGeometryPass(d.MATERIAL_DEPTH_SHADOWMAP,h.camera,a)}this._shadowMap.finish(s),e.setGLViewport(this._gl)}if(this._shadowMap.bindAll(this._programRep),this._renderer.renderAuxiliaryBuffers(e,a,this._shadowMap,this._ssaoHelper,r,s,this._offscreenRenderingHelper),this._renderer.render(e,a,this._shadowMap,this._ssaoHelper,s,this._highlightHelper,this._offscreenRenderingHelper),this._drawShadowMapDebugQuad&&this._shadowMap.getEnableState()){var p=_.ortho(i[0],i[2],i[1],i[3],-1,1);this._shadowMap.drawDebugQuad(p)}if(this._drawSSAOMapDebugQuad&&this._ssaoHelper.getEnableState()){var p=_.ortho(i[0],i[2],i[1],i[3],-1,1);this._ssaoHelper.drawQuad(p)}},e}();return g});