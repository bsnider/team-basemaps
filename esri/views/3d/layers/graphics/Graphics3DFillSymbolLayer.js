// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../../../core/declare","../../../../core/screenUtils","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DDrapedGraphicLayer","./ElevationAligners","./Graphics3DSymbolCommonCode","./lineUtils","../../../../geometry/Polygon","../../../../Color","../../lib/glMatrix","../../support/aaBoundingBox","../../webgl-engine/Stage","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/ColorMaterial","../../webgl-engine/lib/Util","./earcut/earcut"],function(e,t,i,r,a,n,o,l,s,u,h,c,_,d,g,p,m,y,v,f){var x=v.VertexAttrConstants,E=h.vec3d,O=h.mat4d,D=e([i],{_prepareResources:function(){this._prepareFillResources(),this._prepareOutlineResources(),this.resolve()},_prepareFillResources:function(){var e=this._getStageIdHint(),t=this._getMaterialOpacityAndColor(),i={color:t,transparent:t[3]<1||this._isPropertyDriven("opacity"),polygonOffset:!1,vertexColors:!0};this._material=new y(i,e+"_colormat"),this._context.stage.add(_.ModelContentType.MATERIAL,this._material)},_prepareOutlineResources:function(){var e=this.symbol.outline;if(this._hasOutline=!!(e&&e.size&&e.color),this._hasOutline){var i={idHint:this._getStageIdHint()+"_outline",color:this._getOutlineColor(),width:t.pt2px(this.symbol.outline.size)};this._outlineMaterial=i.width>2?l.createRibbonMaterial(i):l.createNativeMaterial(i),this._context.stage.add(_.ModelContentType.MATERIAL,this._outlineMaterial)}},destroy:function(){this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(_.ModelContentType.MATERIAL,this._material.getId()),this._material=null),this._outlineMaterial&&(this._context.stage.remove(_.ModelContentType.MATERIAL,this._outlineMaterial.getId()),this._outlineMaterial=null)},createGraphics3DGraphic:function(e,t){var i=e.geometry;if("polyline"!==i.type&&"polygon"!==i.type&&"extent"!==i.type)return this._logWarning("unsupported geometry type for fill symbol: "+i.type),null;var r="graphic"+e.id,a=this._getVertexOpacityAndColor(t,Uint8Array,255),n=this._getGraphicElevationInfo(e);return n.mode===o.ELEV_MODES.ON_THE_GROUND?this._createAsOverlay(e,a,n,r):this._createAs3DShape(e,a,n,r,e.id)},layerPropertyChanged:function(e,t,i){if("opacity"===e){var r=this._material.getColor();return r[3]=this._getMaterialOpacity(),this._material.setColor(r),this._material.setTransparent(r[3]<1),!0}if("elevationInfo"===e){var a=this._elevationInfo.mode;this._updateElevationInfo();var l=this._elevationInfo.mode;if(null==a||null==l)return!1;var s=o.ELEV_MODES;if(a===s.ON_THE_GROUND&&l===s.ON_THE_GROUND)return!0;if(a!==l&&(a===s.ON_THE_GROUND||l===s.ON_THE_GROUND))return!1;var u=l===s.RELATIVE_TO_GROUND?n.perVertexElevationAligner:null,h=this._context.elevationProvider,c=this._context.renderCoordsHelper;for(var _ in t){var d=t[_],g=d._graphics[i];if(g){var p=d.graphic;g.elevationAligner=u,g.elevationInfo.set(this._getGraphicElevationInfo(p)),n.perVertexElevationAligner(g,h,c)}}return!0}return!1},setDrawOrder:function(e,t,i){this._material&&(this._material.setRenderPriority(e+t/2),i[this._material.getId()]=!0),this._outlineMaterial&&(this._outlineMaterial.setRenderPriority(e),i[this._outlineMaterial.getId()]=!0)},_createAs3DShape:function(e,t,i,a,l){var s,u=this._getPolyGeometry(e),h=u.hasZ,c=!1;if(null!=u.rings?(c=!0,s=u.rings):s=u.paths,0===s.length)return this._logWarning("no paths found for line symbol"),null;var _=this._getOutlineGeometry(u,s),g=o.getGeometryVertexData3D(_,h,u.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,i);b.idHint=a,b.color=t,b.isRings=c,b.data=g;var p;if(this._hasOutline&&(p=new g.vertexData.constructor(g.vertexData)),b.outNum=0,b.outGeometries=[],b.outTransforms=[],b.outMaterials=[],this._createAs3DShapeFill(b),b.data.vertexData=p,this._createAs3DShapeOutline(b),0===b.outNum)return null;var m=this._context.layer.id,y=new d({geometries:b.outGeometries,materials:b.outMaterials,transformations:b.outTransforms,castShadow:!1,metadata:{layerId:m,graphicId:l},idHint:a}),v=null;return i.mode===o.ELEV_MODES.RELATIVE_TO_GROUND&&(v=n.perVertexElevationAligner),new r(this,y,b.outGeometries,null,null,v,i)},_createAs3DShapeFill:function(e){for(var t=e.data.geometryData.polygons,i=e.data.eleVertexData,r=e.data.vertexData,a=0;a<t.length;++a){var n=t[a],l=n.count,s=n.index;if(!this._context.clippingExtent||(o.computeBoundingBox(i,s,l,G),!o.boundingBoxClipped(G,this._context.clippingExtent))){var u=new Float64Array(i.buffer,3*s*i.BYTES_PER_ELEMENT,3*l),h=new Float64Array(r.buffer,3*s*r.BYTES_PER_ELEMENT,3*l),c=n.holeIndices.map(function(e){return e-s}),_=f(u,c,3);if(0!==_.length){o.chooseOrigin(r,s,l,R),o.subtractCoordinates(r,s,l,R);var d=this._createFillGeometry(_,0,h,u,e.color,!1),p=new g(d,e.idHint);p.singleUse=!0;var m=O.identity();O.translate(m,R,m),e.outGeometries.push(p),e.outMaterials.push([this._material]),e.outTransforms.push(m),e.outNum++}}}},_createAs3DShapeOutline:function(e){if(this._hasOutline)for(var t=e.data.geometryData.outlines,i=e.data.eleVertexData,r=e.data.vertexData,a=0;a<t.length;++a){var n=t[a],s=n.index,u=n.count;if(!this._context.clippingExtent||(o.computeBoundingBox(i,s,u,G),!o.boundingBoxClipped(G,this._context.clippingExtent))){o.chooseOrigin(r,s,u,R),o.subtractCoordinates(r,s,u,R);var h=new Float64Array(i.buffer,3*s*i.BYTES_PER_ELEMENT,3*u),c=new Float64Array(r.buffer,3*s*r.BYTES_PER_ELEMENT,3*u),_=l.createPolylineGeometry(c,h,e.isRings,A,0,!1),d=new g(_,e.idHint+"outline"+a);d.singleUse=!0;var p=O.identity();O.translate(p,R,p),e.outGeometries.push(d),e.outMaterials.push([this._outlineMaterial]),e.outTransforms.push(p),e.outNum++}}},_createAsOverlay:function(e,t,i,r){var n,l=this._getPolyGeometry(e),s=!1;null!=l.rings?(s=!0,n=l.rings):n=l.paths;var u=this._getOutlineGeometry(l,n);if(0===u.length)return null;this._material.setRenderPriority(this._symbolLayerOrder+this._symbolLayerOrderDelta/2),this._hasOutline&&this._outlineMaterial.setRenderPriority(this._symbolLayerOrder);var h=o.getGeometryVertexDataDraped(u,l.spatialReference,this._context.overlaySR);b.idHint=r,b.color=t,b.isRings=s,b.data=h;var _;return this._hasOutline&&(_=new h.vertexData.constructor(h.vertexData)),b.outNum=0,b.outGeometries=[],b.outBoundingBox=c.create(c.NEGATIVE_INFINITY),this._createAsOverlayFill(b),b.data.vertexData=_,this._createAsOverlayOutline(b),b.outNum>0?new a(this,b.outGeometries,null,null,b.outBoundingBox):null},_createAsOverlayFill:function(e){for(var t=e.data.vertexData,i=e.data.geometryData.polygons,r=0;r<i.length;++r){var a=i[r],n=a.count,l=a.index,s=new Float64Array(t.buffer,3*l*t.BYTES_PER_ELEMENT,3*n),u=a.holeIndices.map(function(e){return e-l}),h=f(s,u,3);if(0!==h.length&&(o.computeBoundingBox(t,l,n,G),!o.boundingBoxClipped(G,this._context.clippingExtent))){c.expand(e.outBoundingBox,G),o.chooseOrigin(t,l,n,R),o.subtractCoordinates(t,l,n,R),o.setZ(t,l,n,this._getDrapedZ());var _=O.identity();O.translate(_,R,_);var d=this._createFillGeometry(h,l,t,null,e.color,!0),g=new m(d);g.material=this._material;var p=G;g.center=[.5*(p[0]+p[3]),.5*(p[1]+p[4]),0],g.bsRadius=.5*Math.sqrt((p[3]-p[0])*(p[3]-p[0])+(p[4]-p[1])*(p[4]-p[1])),g.transformation=_,g.name=e.idHint,g.uniqueName=e.idHint+"#"+d.id,e.outGeometries.push(g),e.outNum++}}},_createAsOverlayOutline:function(e){if(this._hasOutline)for(var t=e.data.vertexData,i=e.data.geometryData.outlines,r=0;r<i.length;++r){var a=i[r],n=a.index,s=a.count;if(o.computeBoundingBox(t,n,s,G),!o.boundingBoxClipped(G,this._context.clippingExtent)){c.expand(e.outBoundingBox,G),o.chooseOrigin(t,n,s,R),o.subtractCoordinates(t,n,s,R),o.setZ(t,n,s,this._getDrapedZ());var u=new Float64Array(t.buffer,3*n*t.BYTES_PER_ELEMENT,3*s),h=O.identity();O.translate(h,R,h);var _=l.createPolylineGeometry(u,null,e.isRings,A,0,!0),d=new m(_);d.material=this._outlineMaterial;var g=G;d.center=[.5*(g[0]+g[3]),.5*(g[1]+g[4]),0],d.bsRadius=.5*Math.sqrt((g[3]-g[0])*(g[3]-g[0])+(g[4]-g[1])*(g[4]-g[1])),d.transformation=h,d.name=e.idHint+"outline",d.uniqueName=e.idHint+"outline#"+_.id,e.outGeometries.push(d),e.outNum++}}},_getOutlineGeometry:function(e,t){return e._outlineSegments?l.createOutlineGeometryFromSegments(t,e._outlineSegments):t},_getOutlineColor:function(){var e=this._getLayerOpacity(),t=this.symbol.outline.color;return e*=t.a,this._mixinColorAndOpacity(u.toUnitRGB(t),e)},_getPolyGeometry:function(e){var t=e.geometry;return"extent"===t.type&&(t=s.fromExtent(t)),t},_createFillGeometry:function(e,t,i,r,a,n){for(var o=e.length,l=new Uint32Array(o),s=new Uint32Array(o),u=0;o>u;u++)l[u]=e[u]+t,s[u]=0;var h={},c={};h[x.POSITION]=l,h[x.COLOR]=s,c[x.POSITION]={size:3,data:i},c[x.COLOR]={size:4,data:a},r&&(c.mapPos={size:3,data:r},h.mapPos=l);var _=[{type:"triangle",indices:h,positionKey:x.POSITION}];return n?{faces:_[0],vertexAttr:c,id:p.getNewId().toString()}:new p(_,c)}}),G=c.create(),R=E.create(),A=new Float32Array([255,255,255,255]),b={idHint:null,color:null,isRings:!1,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};return D});