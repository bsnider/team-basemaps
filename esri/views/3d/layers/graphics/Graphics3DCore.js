// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","../../../../core/watchUtils","../../../../core/arrayUtils","../../support/projectionUtils","../../../../geometry/Point","../../../../geometry/Extent","../../webgl-engine/Stage","../../webgl-engine/lib/Util","../../webgl-engine/lib/Layer","../../webgl-engine/lib/FloatingBoxLocalOriginFactory","../../lib/glMatrix","../graphics/SymbolConverter","../graphics/Graphics3DGraphic","../graphics/Graphics3DSymbol","../graphics/graphicUtils","../../../../core/Error","../../support/aaBoundingBox","../../support/mathUtils","../../../../core/promiseUtils","dojo/Deferred"],function(e,i,t,a,r,s,n,h,l,o,p,c,y,d,g,u,b,m,f,v,w){function C(e){return"point"===e.type}function D(e){return"polygon"===e.type}var G=c.vec3d,x=!1,S="VISIBILITY_GRAPHIC",V=new s,I=G.create(),R=function(){function e(){this.sharedResources=null,this.streamDataSupplier=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.layerOrder=null,this.clippingExtent=null,this.renderSpatialReference=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.localOriginFactory=null}return e}(),E=function(){function e(){this.graphics={},this.graphicsDrapedIds={},this.graphicsBySymbol={},this.graphicsKeys=[],this.symbols={},this.computedExtent=null,this.symbolCreationContext=new R,this.hasDraped=!1,this.updatingGraphicIds={},this.tilingSchemeHandle=null,this.stageLayer=null,this.labelStageLayer=null,this.stage=null,this.onComputedExtentChange=null,this.graphicTransformFunc=null,this.eventHandles=[],this.viewSR=null,this.layerView=null,this.layer=null,this.elevation=null,this.scaleVisibility=null,this.spatialIndex=null,this.labeling=null,this.whenGraphics3DGraphicRequests={}}return e.prototype.initialize=function(e,i,a,r,s,n,h,l,o,c){var y=this;this.layerView=e,this.layer=i,this.viewSR=e.view.spatialReference,this.elevation=a,this.scaleVisibility=s,this.spatialIndex=n,this.labeling=h,this.onComputedExtentChange=l,this.graphicTransformFunc=o,this.initializeStage(this.layerView.view,this.layer.id),this.symbolCreationContext.sharedResources=r,this.symbolCreationContext.renderer=this.layer.renderer,this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataSupplier=r.streamDataSupplier,this.symbolCreationContext.renderSpatialReference=this.layerView.view.renderSpatialReference,this.symbolCreationContext.renderCoordsHelper=this.layerView.view.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerOrder=0,this.symbolCreationContext.localOriginFactory=new p(5e6,16),this.symbolCreationContext.elevationProvider=c,this.tilingSchemeHandle=t.when(c,"tilingScheme",function(e){e.spatialReference.equals(y.symbolCreationContext.overlaySR)||(y.symbolCreationContext.overlaySR=c.spatialReference,y.recreateAllGraphics())}),this.eventHandles.push(this.layerView.watch("suspended",function(){return y.suspendedChange()})),this.eventHandles.push(t.on(e,"loadedGraphics","change",function(e){return y.graphicsCollectionChanged(e)},function(){y.clearSymbolsAndGraphics(),y.graphicsCollectionChanged({added:y.layerView.loadedGraphics.toArray(),removed:[]})}))},e.prototype.destroy=function(){var e=this;if(this.clear(),this.stage){var i=[this.stageLayer.getId()];this.labelStageLayer&&i.push(this.labelStageLayer.getId()),this.stage.removeFromViewContent(i),i.forEach(function(i){return e.stage.remove(h.ModelContentType.LAYER,i)}),this.stageLayer=null,this.labelStageLayer=null,this.stage=null}this.tilingSchemeHandle&&(this.tilingSchemeHandle.remove(),this.tilingSchemeHandle=null),this.eventHandles.forEach(function(e){return e.remove()}),this.eventHandles=null,this.onComputedExtentChange=null,this.viewSR=null,this.scaleVisibility=null,this.labeling=null,this.layerView=null;for(var t in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[t].reject(new b("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null},e.prototype.clear=function(){var e=!1;for(var i in this.graphics)e=e||this.graphics[i].isDraped(),this.graphics[i].destroy();this.graphics={},this.graphicsKeys=null;for(var t in this.symbols)this.symbols[t].destroy();this.symbols={},this.graphicsBySymbol={},this.hasDraped=!1,e&&this.layerView._notifyDrapedDataChange()},e.prototype.initializeStage=function(e,i){this.stage=e._stage,this.stageLayer=new o(i,{state:this.layerView.suspended?"HIDDEN":"VISIBLE"},i),this.stage.add(h.ModelContentType.LAYER,this.stageLayer);var t=[this.stageLayer.getId()];this.labeling&&(this.labelStageLayer=new o(i,{state:this.layerView.suspended?"HIDDEN":"IGNORED"},i+"_labels"),this.stage.add(h.ModelContentType.LAYER,this.labelStageLayer),t.push(this.labelStageLayer.getId())),this.stage.addToViewContent(t)},e.prototype.setDrawingOrder=function(e){this.symbolCreationContext.layerOrder=e;var i={},t={};for(var a in this.graphics){var r=this.graphics[a];r.setDrawOrder(e,i,t)}for(var s in t){var n=this.symbols[s];n.setDrawOrder(e,i)}l.objectEmpty(i)||(this.stage.getTextureGraphicsRenderer().updateRenderOrder(i),this.layerView._notifyDrapedDataChange())},e.prototype.suspendedChange=function(){this.layerView.suspended===!0?(this.stageLayer.setState("HIDDEN"),this.labelStageLayer&&this.labelStageLayer.setState("HIDDEN"),this.hideAllGraphics()):this.layerView.suspended===!1&&(this.stageLayer.setState("VISIBLE"),this.labelStageLayer&&this.labelStageLayer.setState("IGNORED"),this.updateAllGraphicsVisibility())},e.prototype.getGraphics3DGraphics=function(){return this.graphics},e.prototype.getGraphics3DGraphicById=function(e){return this.graphics[e]},e.prototype.getGraphics3DGraphicsKeys=function(){return null===this.graphicsKeys&&(this.graphicsKeys=Object.keys(this.graphics)),this.graphicsKeys},e.prototype.numNodesUpdating=function(){return Object.keys(this.updatingGraphicIds).length},e.prototype.whenGraphics3DGraphic=function(e){var i=this.graphics[e.id];if(i)return v.resolve(i);var t=this.whenGraphics3DGraphicRequests[e.id];return t||(t=new w,this.whenGraphics3DGraphicRequests[e.id]=t),t},e.prototype.boundsForGraphics3DGraphic=function(e,i){void 0===i&&(i=m.create());var t=this.layerView.view.spatialReference,a=this.layerView.view.renderSpatialReference,s=this.layerView.view.basemapTerrain.spatialReference,n=function(e,i,s){return r.bufferToBuffer(e,a,i,e,t,i,s)},h=function(e,i,a){return r.bufferToBuffer(e,s,i,e,t,i,a)},l=e.getProjectedBoundingBox(n,h,i);if(!l)return null;var o=e.isDraped(),p=this.symbolCreationContext.elevationProvider;if(o&&p){m.center(l,I),V.x=I[0],V.y=I[1],V.z=void 0,V.spatialReference=t;var c=p.getElevation(V)||0;l[2]=Math.min(l[2],c),l[5]=Math.max(l[5],c)}return l},e.prototype.whenGraphicBounds=function(e){var i=this;return t.whenOnce(this.layerView,"loadedGraphics").then(function(){if(i.layerView.loadedGraphics.some(function(i){return i===e}))return i.whenGraphics3DGraphic(e);throw new b("internal:graphic-not-part-of-view","Graphic is not part of this view")}).then(function(e){return i.boundsForGraphics3DGraphic(e)})},e.prototype.graphicsCollectionChanged=function(e){var i=this.graphicTransformFunc?this.graphicTransformFunc(e.added):e.added;this.add(i),this.remove(e.removed)},e.prototype.graphicUpdateHandler=function(e){var i=this.graphics[e.graphic.id];if(i)switch(e.property){case"visible":var t=i.setVisibilityFlag(S,e.newValue);t&&(i.isDraped()&&this.layerView._notifyDrapedDataChange(),this.labeling&&this.layerView.view.labelManager.setDirty())}},e.prototype.beginGraphicUpdate=function(e){this.updatingGraphicIds[e.id]=!0,this.layerView.get("symbols-updating")||this.layerView.set("symbols-updating",!0),this.layerView._evaluateUpdatingState()},e.prototype.endGraphicUpdate=function(e){e&&delete this.updatingGraphicIds[e.id],this.layerView.get("symbols-updating")&&l.objectEmpty(this.updatingGraphicIds)&&(this.layerView.view.flushDisplayModifications(),this.layerView.set("symbols-updating",!1)),this.layerView._evaluateUpdatingState()},e.prototype.expandComputedExtent=function(i){var t,a,s,h,l,o;if(C(i))t=a=i.x,s=h=i.y,i.z&&(l=o=i.z);else if(D(i)){var p=i.extent;if(!p)return;t=p.xmin,a=p.xmax,s=p.ymin,h=p.ymax,l=p.zmin,o=p.zmax}var c=this.viewSR,y=e.tmpVec;if(!i.spatialReference.equals(c))if(r.xyzToVector(t,s,0,i.spatialReference,y,c))t=y[0],s=y[1],r.xyzToVector(a,h,0,i.spatialReference,y,c),a=y[0],h=y[1];else if(x)throw new Error("Geometry has incompatible spatial reference");if(f.isFinite(t)&&f.isFinite(a)&&f.isFinite(s)&&f.isFinite(h)){var d=this.computedExtent;d?(d.xmin=Math.min(t,d.xmin),d.xmax=Math.max(a,d.xmax),d.ymin=Math.min(s,d.ymin),d.ymax=Math.max(h,d.ymax)):(d=new n(t,s,a,h,i.spatialReference),this.computedExtent=d),f.isFinite(l)&&!f.isFinite(o)&&(d.zmin=null!=d.zmin?Math.min(l,d.zmin):l,d.zmax=null!=d.zmax?Math.max(o,d.zmax):o),this.onComputedExtentChange&&this.onComputedExtentChange()}},e.prototype.updateHasDraped=function(){this.hasDraped=!1;for(var e in this.graphicsDrapedIds)if(this.graphicsDrapedIds.hasOwnProperty(e)){this.hasDraped=!0;break}},e.prototype.elevationInfoChange=function(){this.labeling&&this.labeling.elevationInfoChange();for(var e in this.graphicsBySymbol){var i=this.symbols[e],t=this.graphicsBySymbol[e];if(i.layerPropertyChanged("elevationInfo",t))for(var a in t)for(var r=t[a],s=r.graphic,n=r._labelGraphics,h=0;h<n.length;h++){var l=n[h],o=l.graphics3DSymbolLayer;o.updateGraphicElevationInfo(s,l)}else this.recreateSymbol(e)}},e.prototype.clearSymbolsAndGraphics=function(){this.clear(),this.elevation&&this.elevation.clear(),this.labeling&&this.labeling.clear()},e.prototype.recreateAllGraphics=function(){this.clearSymbolsAndGraphics(),this.computedExtent=null,this.onComputedExtentChange&&this.onComputedExtentChange(),this.layerView.loadedGraphics&&this.layerView.view.basemapTerrain.tilingScheme&&this.add(this.layerView.loadedGraphics.toArray())},e.prototype.recreateSymbol=function(e){var i=this.graphicsBySymbol[e],t=[],a=!1;for(var r in i){var s=i[r],n=s.isDraped();n&&(delete this.graphicsDrapedIds[r],a=!0),t.push(s.graphic),s.destroy(),this.graphics[r]=null}this.graphicsBySymbol[e]={};var h=this.symbols[e];h.destroy(),this.symbols[e]=null,this.updateHasDraped(),a&&this.layerView._notifyDrapedDataChange(),this.add(t)},e.prototype.add=function(e){if(this.layerView.view.basemapTerrain.tilingScheme){for(var i=e.length,t=new Array(i),a=new Array(i),r=new Array(i),s=0;i>s;s++){var n=e[s],h=n.geometry;if(h){this.expandComputedExtent(h);var l=this.layerView.getRenderingInfo?this.layerView.getRenderingInfo(n):{symbol:n.symbol};if(l&&l.symbol){a[s]=l.symbol,r[s]=l;var o=this.getOrCreateGraphics3DSymbol(a[s],l.renderer);o&&(t[s]=o,this.beginGraphicUpdate(n))}}}for(var s=0;i>s;s++)this.waitForSymbol(t[s],a[s],e[s],r[s])}},e.prototype.waitForSymbol=function(e,i,t,a){var r=this;e&&e.then(function(){r.graphicsBySymbol[i.id]||(r.graphicsBySymbol[i.id]={}),r.createGraphics3DGraphic(e,t,a),r.endGraphicUpdate(t),r.labeling&&r.layerView.view.labelManager.setDirty()},function(){r.endGraphicUpdate(t)})},e.prototype.remove=function(e){for(var i=!1,t=e.length,a=0;t>a;a++){var r=e[a].id,s=this.graphics[r];if(s){var n=s.isDraped();n&&(delete this.graphicsDrapedIds[r],i=!0);var h=s.graphics3DSymbol.symbol.id;s.destroy(),delete this.graphics[r],delete this.graphicsBySymbol[h][r],this.graphicsKeys=null}}this.updateHasDraped(),i&&this.layerView._notifyDrapedDataChange(),this.labeling&&this.layerView.view.labelManager.setDirty()},e.prototype.getOrCreateGraphics3DSymbol=function(e,i){var t=this.symbols[e.id];if(!t){var a=y.toWeb3DSymbol(e,!0,!1);if(a){var r=void 0;if(i&&i.backgroundFillSymbol){var s=y.toWeb3DSymbol(i.backgroundFillSymbol,!1,!0);s&&(r=s.symbolLayers)}t=new g(a,this.symbolCreationContext,r),this.symbols[e.id]=t}}return t},e.prototype.createGraphics3DGraphic=function(e,i,t){if(!this.graphics[i.id]){var a=e.createGraphics3DGraphic(i,t);this.labeling&&this.labeling.layerLabelsEnabled()&&(a=this.labeling.createLabelsForGraphic(i,a)),this.graphics[i.id]=a,this.graphicsKeys=null,this.graphicsBySymbol[e.symbol.id][i.id]=a,a.initialize(this.stageLayer,this.labelStageLayer,this.stage);var r=a.isDraped();r&&(this.graphicsDrapedIds[i.id]=!0,this.hasDraped=!0,this.layerView._notifyDrapedDataChange()),a.centroid=null,"point"!==i.geometry.type&&a instanceof d&&(a.centroid=u.computeCentroid(i.geometry,this.viewSR));var s=this.scaleVisibility&&this.scaleVisibility.scaleRangeActive();this.spatialIndex&&this.spatialIndex.shouldAddToSpatialIndex(i,a,s)&&this.spatialIndex.addGraphicToSpatialIndex(i,a),s&&this.scaleVisibility.updateGraphicScaleVisibility(i,a),a.setVisibilityFlag(S,i.visible&&!this.layerView.suspended);var n=this.whenGraphics3DGraphicRequests[i.id];n&&(n.resolve(a),delete this.whenGraphics3DGraphicRequests[i.id])}},e.prototype.rendererChange=function(e){this.symbolCreationContext.renderer=e,this.recreateAllGraphics()},e.prototype.opacityChange=function(){var e=!1;for(var i in this.graphicsBySymbol){var t=this.symbols[i],a=this.graphicsBySymbol[i];if(t.layerPropertyChanged("opacity"),!e)for(var r in a)if(a[r].isDraped()){this.layerView._notifyDrapedDataChange(),e=!0;break}}},e.prototype.setClippingExtent=function(e,i){var t=this.symbolCreationContext.clippingExtent,s=[];return this.symbolCreationContext.clippingExtent=r.extentToBoundingRect(e,s,i)?[s[0],s[1],-1/0,s[2],s[3],1/0]:null,!a.equals(this.symbolCreationContext.clippingExtent,t)},e.prototype.updateAllGraphicsVisibility=function(){var e=this;if(this.layerView.loadedGraphics){var i=!1;this.layerView.loadedGraphics.forEach(function(t){var a=e.getGraphics3DGraphicById(t.id);if(a){var r=a.setVisibilityFlag(S,t.visible);if(e.scaleVisibility){var s=e.scaleVisibility.updateGraphicScaleVisibility(t,a);r=r||s}r&&a.isDraped()&&(i=!0)}}),i&&this.layerView._notifyDrapedDataChange(),this.layerView.view.labelManager.setDirty()}},e.prototype.hideAllGraphics=function(){var e=this;if(this.layerView.loadedGraphics){var i=!1;this.layerView.loadedGraphics.forEach(function(t){var a=e.getGraphics3DGraphicById(t.id);if(a){var r=a.setVisibilityFlag(S,!1);r&&a.isDraped()&&(i=!0)}}),i&&this.layerView._notifyDrapedDataChange(),this.layerView.view.labelManager.setDirty()}},e.tmpVec=c.vec3d.create(),e}();return E});