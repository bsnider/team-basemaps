// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../../../core/declare","dojo/_base/lang","dojo/when","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DDrapedGraphicLayer","./ElevationAligners","./Graphics3DSymbolCommonCode","./SignedDistanceFunctions","../../../../core/urlUtils","../../../../core/screenUtils","../../../../config","../../../../Color","../../../../geometry/Polygon","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/HUDMaterial"],function(e,t,i,r,n,o,s,a,l,c,u,h,d,_,p,g,f,m,v,y,R,I){function x(e){return"cross"===e||"x"===e}function O(e){var t,i=P,r=i*w;switch("primitive:"===e.substring(0,10)&&(e=e.substring(10)),e){case G.PRIM_CIRCLE:t=l.computeSignedDistancefieldCicle(i,r);break;case G.PRIM_SQUARE:t=l.computeSignedDistancefieldSquare(i,r,!1);break;case G.PRIM_KITE:t=l.computeSignedDistancefieldSquare(i,r,!0);break;case G.PRIM_CROSS:t=l.computeSignedDistancefieldCrossAndX(i,r,!1);break;case G.PRIM_X:t=l.computeSignedDistancefieldCrossAndX(i,r,!0)}return new R(t,"sdf_"+e,{mipmap:!1,wrapClamp:!0,width:P,height:P,components:4})}var E=g.vec3d,b=g.mat4d,S=b.identity(),M=[0,0,1],D=[0,0,0,0],T=["center","bottom","top","left","right","bottom-left","bottom-right","top-left","top-right"],A="circle",C=16,z=1.5,P=128,w=.5,G={PRIM_CIRCLE:"circle",PRIM_SQUARE:"square",PRIM_CROSS:"cross",PRIM_X:"x",PRIM_KITE:"kite"},U=e([r],{_prepareResources:function(){var e=this.symbol,t=null!=e.size?u.pt2px(e.size):C;this._size=null,this._symbolTextureRatio=1,this._primitive=null;var i=this._getStageIdHint();this._isPropertyDriven("size")&&64>t&&(t=64);var r=e.resource||{primitive:A},n={anchorPos:this._getAnchorPos(e)},o=r.href||r.dataURI;if(o)n.color=this._getFillColor(e,null),n.outlineColor=this._getOutlineColor(e),n.outlineSize=this._getOutlineSize(e,null),n.textureIsSignedDistanceField=!1,this._prepareImageResources(o,t,n,i);else{var s=r.primitive||A,a="primitive:"+s;if(this._primitive=s,n.color=this._getFillColor(e,s),n.outlineColor=this._getOutlineColor(e),n.outlineSize=this._getOutlineSize(e,s),x(s)&&0===n.outlineSize)return void this.reject();this.texture=this._context.sharedResources.textures.acquire(a,O),this._textureURI=a,n.textureIsSignedDistanceField=!0,n.textureId=this.texture.getId(),this._createMaterialsAndAddToStage(n,this._context.stage,i),this._size=[t,t],this._symbolTextureRatio=1/w,this.resolve()}},_getOutlineDefaultSize:function(e){return x(e)?z:0},_getOutlineSize:function(e,t){return e.outline&&null!=e.outline.size?u.pt2px(e.outline.size):this._getOutlineDefaultSize(t)},_getOutlineColor:function(e){var t=this._getLayerOpacity();if(e.outline){if(null!=e.outline.color){var i=d.toUnitRGB(e.outline.color),r=e.outline.color.a*t;return[i[0],i[1],i[2],r]}return[0,0,0,t]}return[0,0,0,t]},_getFillColor:function(e,t){return x(t)?D:this._getMaterialOpacityAndColor()},_getAnchorPos:function(e){return T.indexOf(e.anchor)>-1?e.anchor:"center"},_prepareImageResources:function(e,t,r,n){0===e.indexOf("http")&&"https:"===location.protocol&&(e=e.replace(/^http:/i,"https:"));var o=function(e){if(!this.isRejected()){var i=e.params,o=i.width/i.height;this._size=t?o>1?[t,t/o]:[t*o,t]:[i.width,i.height],r.textureId=e.getId(),this._createMaterialsAndAddToStage(r,this._context.stage,n),this.resolve()}}.bind(this),s="data:image/svg"===e.substring(0,14),a=".svg"===e.substring(e.length-4,e.length),l=s||a;if(l){var u=e;0===u.indexOf("//")&&(u=window.location.protocol+u);var d=new Image,_=!s&&c.hasSameOrigin(u,window.location.href);s?d.src=u:_||c.canUseXhr(u)?(_||(d.crossOrigin="anonymous"),d.src=u):(h.request.proxyUrl&&(u=h.request.proxyUrl+"?"+u),d.src=u),d.onerror=function(){this.reject()}.bind(this),d.onload=function(){var e=d.width,r=d.height,n=1;e&&r&&(n=e/r),null!=t&&(n>1?(e=t,r=Math.round(t/n)):(r=t,e=Math.round(t*n)));var s=document.createElement("canvas");s.width=e,s.height=r;var a=s.getContext("2d");a.drawImage(d,0,0,e,r);var l=s.toDataURL();i(this._context.sharedResources.textures.acquire(l),o,function(){this.reject()}),this.textureURI=l}.bind(this),d.onerror=function(){console.warn("Failed to create Icon primitive"),this.reject()}.bind(this)}else i(this._context.sharedResources.textures.acquire(e),o,function(){this.reject()}.bind(this)),this._textureURI=e},_createMaterialsAndAddToStage:function(e,i,r){var n=t.clone(e);n.occlusionTest=!1,n.shaderPolygonOffset=0,this._drapedMaterial=new I(n,r+"_iconDraped"),i.add(f.ModelContentType.MATERIAL,this._drapedMaterial),e.occlusionTest=!0,this._material=new I(e,r+"_icon"),i.add(f.ModelContentType.MATERIAL,this._material)},destroy:function(){this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(f.ModelContentType.MATERIAL,this._material.getId()),this._material=null),this._drapedMaterial&&(this._context.stage.remove(f.ModelContentType.MATERIAL,this._drapedMaterial.getId()),this._drapedMaterial=null),this._textureURI&&(this._context.sharedResources.textures.release(this._textureURI),this._textureURI=null)},createGraphics3DGraphic:function(e,t,i){var r=e.geometry;if("extent"===r.type&&(r=_.fromExtent(r)),"polyline"===r.type)r=a.placePointOnPolyline(r);else if("polygon"===r.type)r=a.placePointOnPolygon(r);else if("point"!==r.type)return this._logWarning("unsupported geometry type for icon symbol: "+r.type),null;var n="graphic"+e.id,o=1;if(this._isPropertyDriven("size")&&t.size){for(var s=0;3>s;s++)t.size[s]&&(t.size[s]=u.pt2px(t.size[s]));var l=this._size[0]>this._size[1]?this._size[0]:this._size[1];isFinite(t.size[0])?o=t.size[0]/l:"symbolValue"===t.size[0]?o=1:isFinite(t.size[2])&&(o=t.size[2]/l)}var c=this._getVertexOpacityAndColor(t);o*=this._symbolTextureRatio;var h=[this._size[0]*o,this._size[1]*o],d=this._getGraphicElevationInfo(e);return d.mode===a.ELEV_MODES.ON_THE_GROUND?this._createAsOverlay(e,r,c,h,d,n,e.id,i):this._createAs3DShape(e,r,c,h,d,n,e.id,i)},layerPropertyChanged:function(e,t,i){if("opacity"===e){var r=this._getFillColor(this.symbol,this._primitive);this._drapedMaterial.setParameterValues({color:r}),this._material.setParameterValues({color:r});var n=this._getOutlineColor(this.symbol);return this._drapedMaterial.setParameterValues({outlineColor:n}),this._material.setParameterValues({outlineColor:n}),!0}if("elevationInfo"===e){var o=this._elevationInfo.mode;this._updateElevationInfo();var l=this._elevationInfo.mode,c=a.ELEV_MODES;if(o===c.ON_THE_GROUND&&l===c.ON_THE_GROUND)return!0;if(o!==l&&(o===c.ON_THE_GROUND||l===c.ON_THE_GROUND))return!1;var u=this._context.elevationProvider,h=this._context.renderCoordsHelper,d=s.perObjectElevationAligner;for(var _ in t){var p=t[_],g=p._graphics[i];if(g){var f=p.graphic,m=this._getGraphicElevationInfo(f);g.elevationAligner=l===c.RELATIVE_TO_GROUND?d:null,g.elevationInfo.set(m),d(g,u,h)}}return!0}return!1},setDrawOrder:function(e,t,i){this._drapedMaterial&&(this._drapedMaterial.setRenderPriority(e),i[this._drapedMaterial.getId()]=!0)},_defaultElevationInfoNoZ:{mode:a.ELEV_MODES.RELATIVE_TO_GROUND,offset:0},_getGraphicElevationInfo:function(e){var t=this.inherited(arguments);return t.mode!==a.ELEV_MODES.RELATIVE_TO_GROUND||0!==t.offset||e.geometry.get("hasZ")||(t.offset=1/this._context.renderCoordsHelper.unitInMeters),t},_createAs3DShape:function(e,t,i,r,o,l,c){var u=v.createPointGeometry(M,null,i,r),h=new m(u,l),d=[h],_=this._context.layer.id,p=a.createStageObjectForPoint.call(this,t,d,[[this._material]],null,null,o,l,_,c);if(null===p)return null;var g=null;o.mode===a.ELEV_MODES.RELATIVE_TO_GROUND&&(g=s.perObjectElevationAligner);var f=new n(this,p,d,null,null,g,o);return f.getScreenSize=function(e,t){return function(){return[e,t]}}(r[0]/this._symbolTextureRatio,r[1]/this._symbolTextureRatio),a.extendPointGraphicElevationInfo(f,t,this._context.elevationProvider),f},_createAsOverlay:function(e,t,i,r,n,s){this._drapedMaterial.setRenderPriority(this._symbolLayerOrder);var l=E.create();p.pointToVector(t,l,this._context.overlaySR),l[2]=this._getDrapedZ();var c=this._context.clippingExtent;if(c&&!a.pointInBox2D(l,c))return null;var u=v.createPointGeometry(M,l,i,r,!0),h=new y(u);h.material=this._drapedMaterial,h.center=l,h.bsRadius=0,h.transformation=S,h.name=s,h.uniqueName=s+"#"+u.id;var d=new o(this,[h],null,null);return d.getScreenSize=function(e,t){return function(){return[e,t]}}(r[0]/this._symbolTextureRatio,r[1]/this._symbolTextureRatio),d}});return U.VALID_ANCHOR_STRINGS=T,U});