// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../../../core/declare","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DDrapedGraphicLayer","./ElevationAligners","./Graphics3DSymbolCommonCode","./lineUtils","../../../../core/screenUtils","../../../../geometry/Polygon","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/RenderGeometry"],function(e,t,i,r,a,n,o,l,s,h,_,c,g,u){var p=h.vec3d,y=h.mat4d,m=e([t],{_prepareResources:function(){var e=this.symbol,t=this._isPropertyDriven("size"),i={idHint:this._getStageIdHint(),width:this._getWidth(e),color:this._getMaterialOpacityAndColor()};if(t||i.width>2)t&&(i.width=0),i.miterLimit=e.miterLimit,i.join=e.join,this._isNativeLineMaterial=!1,this._material=o.createRibbonMaterial(i);else{if(!(i.width>0))return void this.reject();this._isNativeLineMaterial=!0,this._material=o.createNativeMaterial(i)}this._context.stage.add(_.ModelContentType.MATERIAL,this._material),this.resolve()},_getWidth:function(e){return null!=e.size?l.pt2px(e.size):1},destroy:function(){this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(_.ModelContentType.MATERIAL,this._material.getId()),this._material=null)},createGraphics3DGraphic:function(e,t){var i=e.geometry;if("polyline"!==i.type&&"polygon"!==i.type&&"extent"!==i.type)return this._logWarning("unsupported geometry type for line symbol: "+i.type),null;var r="polygon"===i.type||"extent"===i.type?"rings":"paths",a="graphic"+e.id,o=this._getVertexOpacityAndColor(t,Float32Array,255),s=0;t.size&&this._isPropertyDriven("size")&&(s=n.getSingleSizeDriver(t.size),s=l.pt2px(s));var h=this._getGraphicElevationInfo(e);return h.mode===n.ELEV_MODES.ON_THE_GROUND?this._createAsOverlay(e,r,o,s,h,a):this._createAs3DShape(e,r,o,s,h,a,e.id)},layerPropertyChanged:function(e,t,i){if("opacity"===e){if(this._isNativeLineMaterial){var r=this._material.getColor();r[3]=this._getMaterialOpacity(),this._material.setColor(r)}else{var o=this._material.getParameterValues();o.color[3]=this._getMaterialOpacity(),this._material.setParameterValues({color:o.color})}return!0}if("elevationInfo"===e){var l=this._elevationInfo.mode;this._updateElevationInfo();var s=this._elevationInfo.mode;if(null==l||null==s)return!1;var h=n.ELEV_MODES;if(l===h.ON_THE_GROUND&&s===h.ON_THE_GROUND)return!0;if(l!==s&&(l===h.ON_THE_GROUND||s===h.ON_THE_GROUND))return!1;var _=s===h.RELATIVE_TO_GROUND?a.perVertexElevationAligner:null,c=this._context.elevationProvider,g=this._context.renderCoordsHelper;for(var u in t){var p=t[u],y=p._graphics[i];if(y){var m=p.graphic;y.elevationAligner=_,y.elevationInfo.set(this._getGraphicElevationInfo(m)),a.perVertexElevationAligner(y,c,g)}}return!0}return!1},_getOutlineGeometry:function(e,t){return e._outlineSegments?o.createOutlineGeometryFromSegments(t,e._outlineSegments):t},_getGeometry:function(e){var t=e.geometry;return"extent"===t.type&&(t=s.fromExtent(t)),t},_createAs3DShape:function(e,t,r,l,s,h,_){var u=this._getGeometry(e),m=u.hasZ,d=u[t],v=this._getOutlineGeometry(u,d);if(v.length>0){for(var f=[],E=[],x=[],D=p.create(),O=new Array(6),G=n.getGeometryVertexData3D(v,m,u.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,s),b=G.geometryData.outlines,A=G.eleVertexData,R=G.vertexData,M=0;M<b.length;++M){var N=b[M],S=N.index,w=N.count;if(!this._context.clippingExtent||(n.computeBoundingBox(A,S,w,O),!n.boundingBoxClipped(O,this._context.clippingExtent))){n.chooseOrigin(R,S,w,D),n.subtractCoordinates(R,S,w,D);var L=new Float64Array(A.buffer,3*S*A.BYTES_PER_ELEMENT,3*w),T=new Float64Array(R.buffer,3*S*R.BYTES_PER_ELEMENT,3*w),I=o.createPolylineGeometry(T,L,"rings"===t,r,l,!1),C=new g(I,h+"path"+M);C.singleUse=!0,f.push(C),E.push([this._material]);var P=y.identity();y.translate(P,D,P),x.push(P)}}var V=this._context.layer.id,U=new c({geometries:f,materials:E,transformations:x,castShadow:!1,metadata:{layerId:V,graphicId:_},idHint:h}),B=null;return s.mode===n.ELEV_MODES.RELATIVE_TO_GROUND&&(B=a.perVertexElevationAligner),new i(this,U,f,null,null,B,s)}return this._logWarning("no paths found for line symbol"),null},_createAsOverlay:function(e,t,i,a,l,s){var h=this._getGeometry(e);this._material.setRenderPriority(this._symbolLayerOrder);var _=h[t],c=this._getOutlineGeometry(h,_);if(c.length>0){for(var g=[],m=new Array(6),d=p.create(),v=n.getGeometryVertexDataDraped(c,h.spatialReference,this._context.overlaySR),f=v.vertexData,E=v.geometryData.outlines,x=0;x<E.length;++x){var D=E[x],O=D.index,G=D.count;if(n.computeBoundingBox(f,O,G,m),!n.boundingBoxClipped(m,this._context.clippingExtent)){n.chooseOrigin(f,O,G,d),n.subtractCoordinates(f,O,G,d),n.setZ(f,O,G,this._getDrapedZ());var b=new Float64Array(f.buffer,3*O*f.BYTES_PER_ELEMENT,3*G),A=y.identity();y.translate(A,d,A);var R=o.createPolylineGeometry(b,null,"rings"===t,i,a,!0),M=new u(R);M.material=this._material,M.center=[.5*(m[0]+m[3]),.5*(m[1]+m[4]),0],M.bsRadius=.5*Math.sqrt((m[3]-m[0])*(m[3]-m[0])+(m[4]-m[1])*(m[4]-m[1])),M.transformation=A,M.name=s,M.uniqueName=s+"#"+R.id,g.push(M)}}return new r(this,g,null,null,m)}return null}});return m});