// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","dojo/promise/all","dojo/Deferred","../../webgl-engine/lib/TextTextureAtlas","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/materials/HUDMaterial","../../../../layers/support/LabelClass","../../lib/glMatrix"],function(e,t,a,r,l,i,s,n,o){var h,c=o.vec3d,f="VISIBILITY_LABEL_SHOW",b=function(){function e(){this.textTextureAtlas=null,this.hudMaterialCollection=null,this.showLabelsChangeOnResume=!1,this.labelClasses=[],this.eventHandles=[],this.layerView=null,this.layer=null,this.graphicsCore=null}return e.prototype.initialize=function(e,t,a){var r=this;this.layerView=e,this.layer=t,this.graphicsCore=a,this.layerView.view.labelManager.addSceneServiceLayerView(this),this.eventHandles.push(this.layerView.watch("suspended",function(){return r.suspendedChange()}))},e.prototype.destroy=function(){this.layerView.view.labelManager.removeSceneServiceLayerView(this),this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null),this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null),this.labelClasses=null,this.eventHandles.forEach(function(e){return e.remove()}),this.eventHandles=null,this.layerView=null,this.layer=null,this.graphicsCore=null},e.prototype.clear=function(){this.layerView.view.labelManager.setDirty(),this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null),this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null)},e.prototype.suspendedChange=function(){this.layerView.suspended===!1&&this.showLabelsChangeOnResume&&this.showLabelsChange()},e.prototype.initLabelingInfo=function(){var e=this,t=new r;return this.layer.then(function(){var r=e.layer.labelingInfo;if(r){e.labelClasses=new Array(r.length);for(var l=[],i=0;i<r.length;i++){var s=e.graphicsCore.getOrCreateGraphics3DSymbol(r[i].symbol);s.then(function(t,a){e.labelClasses[t]={labelClass:r[t],graphics3DSymbolLayer:a,graphics3DGraphics:[]}}.bind(e,i,s)),l.push(s)}a(l).then(function(){t.resolve()})}else t.resolve()}),t.promise},e.prototype.createLabelsForGraphic=function(e,t){if(this.labelClasses&&this.labelClasses.length>0&&t._graphics[0])for(var a=0;a<this.labelClasses.length;a++){var r=this.labelClasses[a];if(n.evaluateWhere(r.labelClass.where,e.attributes)){var s=r.labelClass.getLabelExpression();if(s){var o=n.buildLabelText(s,e.attributes,this.layer.fields);if(o){var h=r.graphics3DSymbolLayer.childGraphics3DSymbols[0],c=this.evalLabelPlacementParams(e,t);null==this.textTextureAtlas&&(this.textTextureAtlas=new l(this.layer.id,this.layerView.view._stage),this.hudMaterialCollection=new i(this.layerView.view._stage));var b=h.createGraphics3DGraphic(e,{text:o,centerOffset:c.centerOffset,translation:c.translation,screenOffset:c.screenOffset,anchor:c.anchor},this.hudMaterialCollection,this.textTextureAtlas);b&&(b._labelClass=r.labelClass,t.addLabelGraphic(b),r.graphics3DGraphics.push(t),b.setVisibilityFlag(f,this.layerLabelsEnabled()),this.layerView.view.labelManager.setInitialLabelGraphicState(b));break}}}}return t},e.prototype.evalLabelPlacementParams=function(e,t){var a=this.layer.labelingInfo[0],r=p[a.labelPlacement]||p["default"];if("polygon"===e.geometry.type)return{anchor:"center"};if("polyline"===e.geometry.type)return{anchor:"center"};if("extent"===e.geometry.type)return{anchor:"center"};if("point"!==e.geometry.type)return{anchor:r.anchor};var l=t.graphics3DSymbol.symbol.symbolLayers.getItemAt(0),i={screenOffset:[0,0],centerOffset:[0,0,0,-1],translation:t.getCenterObjectSpace(),anchor:r.anchor};if("Icon"===l.type){var n=t._graphics[0].getScreenSize();if(t.isDraped())i.anchor="center";else{var o=t._graphics[0].stageObject.getGeometryRecords()[0].materials[0];if(o instanceof s){var h=o.getParams();i.screenOffset=[n[0]/2*(r.normalizedOffset[0]-2*(h.anchorPos[0]-.5)),n[1]/2*(r.normalizedOffset[1]-2*(h.anchorPos[1]-.5))]}else i.screenOffset=[n[0]/2*r.normalizedOffset[0],n[1]/2*r.normalizedOffset[1]]}}else if("Object"===l.type){var f=t._graphics[0].getBoundingBoxObjectSpace(),n=[f[3]-f[0],f[4]-f[1],f[5]-f[2]],b=1.1,u=Math.max(n[0],n[1]);i.centerOffset[0]=u*b/2*r.normalizedOffset[0],i.translation[2]+=n[2]*b/2*r.normalizedOffset[1];var g=c.length(n);i.centerOffset[2]=g*b/2*r.normalizedOffset[2]}return i},e.prototype.layerLabelsEnabled=function(){return this.layer.labelsVisible},e.prototype.getGraphics3DGraphics=function(){return this.graphicsCore.getGraphics3DGraphics()},e.prototype.getGraphics3DGraphicsKeys=function(){return this.graphicsCore.getGraphics3DGraphicsKeys()},e.prototype.showLabelsChange=function(){var e=this;if(this.layerView.suspended)return void(this.showLabelsChangeOnResume=!0);if(this.layerView.loadedGraphics){var t=this.layerLabelsEnabled();this.layerView.loadedGraphics.forEach(function(a){var r=e.graphicsCore.getGraphics3DGraphicById(a.id);if(r){if(t&&0===r._labelGraphics.length){r=e.createLabelsForGraphic(a,r);for(var l=0;l<r._labelGraphics.length;l++){var i=r._labelGraphics[l];i.initialize(e.graphicsCore.labelStageLayer,e.layerView.view._stage)}}for(var l=0;l<r._labelGraphics.length;l++){var i=r._labelGraphics[l];i.setVisibilityFlag(f,t)}}}),this.layerView.view.labelManager.setDirty(),this.showLabelsChangeOnResume=!1}},e.prototype.elevationInfoChange=function(){this.labelClasses&&this.labelClasses.forEach(function(e){e.graphics3DSymbolLayer.layerPropertyChanged("elevationInfo",{})})},e}(),p={"above-center":{normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{normalizedOffset:[0,0,1],anchor:"center"},"center-left":{normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{normalizedOffset:[1,0,0],anchor:"left"}},u={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(var g in u){var y=u[g];h=p[g],y.forEach(function(e){p[e]=h})}return Object.freeze&&(Object.freeze(p),Object.keys(p).forEach(function(e){Object.freeze(p[e]),Object.freeze(p[e].normalizedOffset)})),b});