// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/typescript","../../../core/watchUtils","../../../core/promiseUtils","../../../core/lang","dojo/_base/lang","dojox/color","dojo/has","../../layers/LayerView","../../../Graphic","../../../symbols/Symbol3D","./i3s/I3SUtil","./i3s/I3SProjectionUtil","./support/LayerViewUpdatingPercentage","../support/projectionUtils","../support/aaBoundingBox","../webgl-engine/Stage","../webgl-engine/lib/Layer","../webgl-engine/lib/Geometry","../webgl-engine/lib/GeometryData","../webgl-engine/lib/Object3D","../webgl-engine/lib/Texture","../webgl-engine/materials/Material","../webgl-engine/lib/Util","../webgl-engine/lib/base64Binary","../lib/glMatrix"],function(e,t,r,i,a,n,s,o,d,l,u,c,g,h,m,p,f,v,y,_,b,I,x,M,O,T,A,w,D){function E(e){return e.getMetadata()}function R(){return c}function L(e,t){var r,i=!1;t.encoding===m.DDS_ENCODING_STRING?r=O.DDS_ENCODING:i=!(C(e.width)&&C(e.height));var a=t.usedByEngineMats.some(function(e){return e.getParams().atlasRegions});return{mipmap:!a&&!t.atlas&&!i,wrapClamp:a||t.atlas||!t.wrap,encoding:r,noUnpackFlip:!0}}function j(e,t){for(var r=t.toLowerCase(),i=0,a=Object.keys(e);i<a.length;i++){var n=a[i];if(n.toLowerCase()===r)return e[n]}return null}var B=A.assert,P=A.clamp,C=A.isPowerOfTwo,S=A.fallbackIfUndefined,F=A.objectEmpty,V=A.VertexAttrConstants,U=!1,N=!1,G=!0,z=!1,k=!1,q=!1,X=!1,H=_.ModelContentType,Y=[.8,.8,.8],J=[.5,.5,.5],K=64,Q=9,W=1,Z=null,$=function(e){function t(){e.apply(this,arguments)}return r(t,e),t.prototype.initialize=function(){var e=this.layer.version,t=!u("trident")||e.major>1||1===e.major&&e.minor>3;this.useCompressedTextures=this.view.has("s3tc")&&t,this._initGraphicsController(),this.dbg=!1,this.maxGpuMemory=1e3,this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._matId2Meta={},this._texId2Meta={},this._requestedTexImageIds={},this._nodeId2Meta={},this._colorOverride=null;for(var r=new Uint8Array(256),i=0;i<r.length;i++)r[i]=255;this._whiteTexture=new O(r,"white",{width:8,height:8}),this._stage.add(_.ModelContentType.TEXTURE,this._whiteTexture),this._layerEventHandles=[n.init(this.layer,"renderer",this._rendererChange.bind(this)),n.watch(this.layer,"opacity",this._opacityChange.bind(this)),n.init(this.view,"clippingArea",this._clippingAreaChanged.bind(this))],this._addThisLayerToStage(),this.setVisibility(!this.suspended),this.debugNodeVis=N,this.debugLODVis=!1},t.prototype.destroy=function(){this._stage.remove(_.ModelContentType.TEXTURE,this._whiteTexture.getId()),this._removeThisLayerFromStage();var e=function(e){e.remove()};this._layerEventHandles.forEach(e),this._stage=null,this._controller.destroy(),this._matId2Meta=null,this._texId2Meta=null,this._nodeId2Meta=null},t.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t},t.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},t.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t},t.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},t.prototype.isBundleAlreadyAddedToStage=function(e,t){var r=!1,i=!1;if(null!=this._nodeId2Meta[e.id]&&this._nodeId2Meta[e.id].engineObjectsPerBundle&&this._nodeId2Meta[e.id].engineObjectsPerBundle[t]){i=!0;for(var a=this._nodeId2Meta[e.id].engineObjectsPerBundle[t],n=0;n<a.length;n++){var s=a[n];if(r=s.isPartiallyHidden())break}}return{wasPartiallyHidden:r,alreadyLoaded:i}},t.prototype._initGraphicsController=function(){var e=this,t={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:this.isBundleAlreadyAddedToStage.bind(this),isOverMemory:this.isOverMemory.bind(this),removeNodeData:this._removeNodeDataFromStage.bind(this),removeFeatures:this._removeFeatures.bind(this),getAddedFeatures:this._getAddedFeatures.bind(this),areAllBundlesLoaded:this._areAllBundlesLoaded.bind(this),wholeNodeSwitchEnabled:!0},r={additionalStartNodeLoadingHandler:this._startNodeLoading.bind(this),additionalCancelNodeLoadingHandler:this.cancelNodeLoading.bind(this),getTexturePrefetchFunctions:function(){return{_calcDesiredTextureLOD:e._calcDesiredTextureLOD.bind(e),_imageIsPartOfTextureBundle:e._imageIsPartOfTextureBundle.bind(e),_matId2Meta:e._matId2Meta,_texId2Meta:e._texId2Meta,useCompressedTextures:function(){return e.useCompressedTextures}}},_nodeDebugVisualizer:this._nodeDebugVisualizer,setPolygonOffset:this._setPolygonOffset.bind(this),traversalOptions:{initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1,allowPartialOverlaps:!1},getLoadedAttributes:this.getLoadedAttributes.bind(this),setAttributeData:this.setAttributeData.bind(this)};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r})},t.prototype.setMaxGpuMemory=function(e){this.maxGpuMemory=e},t.prototype.setVisibility=function(e){if(this._stage&&this._engineLayer){var t=this._engineLayer.getId(),r=this._stage.getViewContent(),i=r.indexOf(t)>=0;if(!!e===i)return;var a=[t];null!=this._nodeDebugVisualizer&&a.push(this._nodeDebugVisualizer.engineLayer.getId()),e?this._stage.addToViewContent(a):this._stage.removeFromViewContent(a)}},t.prototype.getEngineLayer=function(){return this._engineLayer},t.prototype.getStats=function(){var e={nodesInIndex:0,knownFeatures:0,displayedFeatures:0,displayedGeometries:0,displayedComponents:0,geometryDataSize:0,activeMaterials:0};if(!this._controller)return e;for(var t in this._controller.nodeIndex)if(this._controller.nodeIndex.hasOwnProperty(t)){e.nodesInIndex++;var r=this._controller.nodeIndex[t];if(null==r.features)continue;for(var i=0;i<r.features.length;i++)e.knownFeatures++}return e.activeMaterials=Object.keys(this._matId2Meta).length,e},t.prototype._addThisLayerToStage=function(){var e=this._stage;this._initTexture=new O(null,"i3sInitTexture"),e.add(H.TEXTURE,this._initTexture);var t=this.layer.id,r=new b(t,{},t);this._engineLayer=r,e.add(H.LAYER,r),null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose(),N&&(this._nodeDebugVisualizer=m.makeNodeDebugVisualizer(e,this.view.renderCoordsHelper,t),window._nodeDebugVisualizer=this._nodeDebugVisualizer)},t.prototype._removeThisLayerFromStage=function(){if(this.cancelNodeLoading(),null!=this._engineLayer){var e=this._stage;e.remove(H.TEXTURE,this._initTexture.getId());for(var t in this._controller.nodeIndex)if(this._controller.nodeIndex.hasOwnProperty(t)){var r=this._controller.nodeIndex[t];this._removeNodeDataFromStage(r),delete this._controller.nodeIndex[t]}B(F(this._nodeId2Meta)),B(F(this._matId2Meta)),B(F(this._texId2Meta)),e.remove(H.LAYER,this._engineLayer.getId()),null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose(),this._nodeDebugVisualizer=void 0,this._matId2Meta={},this._texId2Meta={},this._requestedTexImageIds={},this._nodeId2Meta={},this._engineLayer=void 0,this.gpuMemoryEstimate=0}},t.prototype._startNodeLoading=function(){this._updateAllTextureLOD()},t.prototype.cancelNodeLoading=function(){null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.clear(),this._requestedTexImageIds={}},t.prototype._isAllHidden=function(e){for(var t=this._nodeId2Meta[e.id].engineObjects,r=0;r<t.length;r++)if(!t[r].isAllHidden())return!1;return!0},t.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta[e.id];return t&&1===t.engineObjects.length?E(t.engineObjects[0]).loadedAttributes:void 0},t.prototype.setAttributeData=function(e,t,r){var i=this._nodeId2Meta[e.id];if(i&&1===i.engineObjects.length){var a=i.engineObjects[0],n=E(a);n.loadedAttributes=t,n.attributeData=r,this._setObjectSymbology(a)}},t.prototype._createUnitTestData=function(e){var t=this.view.navigation.targetCamera,r=[],i={viewParams:{eye:t.eye,center:t.center,up:t.up,viewMatrix:t.viewMatrix,projectionMatrix:t.projectionMatrix,fovX:t.fovX,viewport:t.viewport,perPixelRatio:t.perPixelRatio},visibleObjects:r},a=e.getAll("objects");for(var n in a){var s=a[n];if(s.getParentLayer()===this._engineLayer){var o=E(s),d=o.features,l=o.i3sNode,u=d.map(function(e){return e.id});u.sort();var c={featureIDs:u,nodeId:l};i.visibleObjects.push(c)}}return console.debug(""+i.visibleObjects.length),JSON.stringify(i)},t.prototype.isOverMemory=function(){return this.gpuMemoryEstimate>this.maxGpuMemory?(console.warn("over memory: "+this.gpuMemoryEstimate+" tex "+this.texMemoryEstimate+" geom "+this.geoMemoryEstimate),!0):!1},t.prototype._getAddedFeatures=function(e){var t=this._nodeId2Meta[e];if(null==t)return null;for(var r=[],i=this._nodeId2Meta[e].engineObjects,a=0;a<i.length;a++){var n=i[a];r=r.concat(E(n).features)}return r},t.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){var i=this.layer.opacity;null==i&&(i=1);var a=1-P(S(t.transparency,0),0,1),n=i*a,s=1>n||e&&o.endsWith(e.channels,"a")||t.useVertexColorAlpha===!0||r;return{opacity:n,transparent:s}},t.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null!=e.doubleSided?e.doubleSided:!0},t.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},t.prototype._createEngineMaterial=function(e,t,r,i,a,n){var s,o;null!=e&&(o=this._texId2Meta[t],s=o&&o.engineTex?o.engineTex.getId():this._initTexture.getId());var l,u,c=r.params,g=S(c.diffuse,Y);null!=e&&(u=m.getAppropriateTextureEncoding(e.encoding,this.useCompressedTextures),l=u>-1?e.encoding[u]:e.encoding);var h="";"standard"!==r.type&&(h+="Unknown material type '"+r.type+"', must be 'standard'"),void 0===c.reflectivity&&(h+="Material parameter 'reflectivity' is missing."),h.length>0&&this.layer.warningEvent(h,1);var p={ambient:this._colorOverride||g,diffuse:this._colorOverride||g,specular:S(c.specular,J),shininess:S(c.shininess,K),atlasRegions:c.vertexRegions,textureId:s&&this._colorOverride?this._whiteTexture.getId():s,vertexColors:!0,flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(c),cullFace:this._calcEngineMaterialCullFaceParams(c)},f=this._calcEngineMaterialTransparencyParams(e,c);d.mixin(p,f);var v=new T(p,i);if(v.metadata={i3sMatId:i,i3sTexId:t,i3sTex:e,i3sMatParams:c},null!=e){o?o.usedByEngineMats.push(v):(o={id:t,featureMBS:{},usedByEngineMats:[v],images:e.images,encoding:l,encodingIdx:u,atlas:e.atlas===!0,wrap:"none"!==e.wrap[0]||"none"!==e.wrap[1]},this._texId2Meta[t]=o);for(var y=0;y<a.length;y++){var _=a[y];o.featureMBS[_.id]=_.engineMBS}if(void 0!==n[t]){if(null==o.engineTex){var b=n[t],I=b.data,x=L(I,o);o.engineTex=new O(I,o.id,x),this._stage.add(H.TEXTURE,o.engineTex),o.desiredLOD=n[t].desiredLOD,o.curLOD=o.desiredLOD,this.memEstimateTextureAdded(o.engineTex)}for(var M=o.engineTex.getId(),A=0;A<o.usedByEngineMats.length;A++){var w=o.usedByEngineMats[A];null==this._colorOverride&&w.setParameterValues({textureId:M}),w.metadata.originalTextureId=M}n[t].createdTextureForDomImage(),delete n[t]}else this._updateTextureLOD(o)}return this._matId2Meta[i]||(this._matId2Meta[i]={}),this._matId2Meta[i][t]={engineMat:v,refCount:1},z&&console.debug("new mat "+v.getId()),v},t.prototype._createVertexAndIndexArrays=function(e,t,r){var i,a=!0,n=e.params.vertexAttributes,s={};for(var o in n)if(n.hasOwnProperty(o)){if("classification"===o)continue;var d=n[o];i=m.valueType2TypedArrayClassMap[d.valueType],B(null!=i,"unsupported vertex attribute value type: "+d.valueType),s[o]={data:new i(t,d.byteOffset,d.count*d.valuesPerElement),size:d.valuesPerElement}}if(a&&null==s[V.COLOR]){i=m.valueType2TypedArrayClassMap.UInt8,s[V.COLOR]={data:new i(4*n.position.count),size:4};for(var l=0;l<s[V.COLOR].data.length;l++)s[V.COLOR].data[l]=l%3===0?255:0}var u=!1;null==s[V.NORMAL]&&(u=!0,i=m.valueType2TypedArrayClassMap.Float32,s[V.NORMAL]={data:new i(3*n.position.count),size:3});var c,g=[],h=e.params.faces;if(null!=h&&"PerAttributeArray"!==e.params.topology){var p={};for(name in h)if(h.hasOwnProperty(name)){var f=h[name];B(f.count%3===0),B(f.count===h.position.count),B("UInt32"===f.valueType),p[name]=f.byteOffset}var v=e.params.components.length;c=new Array(v);for(var y=h.position.componentIndices||[0],_=0;v>_;_++){var b=e.params.components[_],I=v-1>_?y[_+1]-y[_]:h.position.count-y[_],x={type:"triangle",positionKey:"position",indices:{},componentRange:[y[_],y[_]+I]};for(name in h)h.hasOwnProperty(name)&&(x.indices[name]=new Uint32Array(t,p[name],I),p[name]+=4*I);if(a&&null==x.indices[V.COLOR]){x.indices[V.COLOR]=new Uint32Array(I);for(var l=0;I>l;l++)x.indices[V.COLOR][l]=l}if(u&&null==x.indices[V.NORMAL]){x.indices[V.NORMAL]=new Uint32Array(I);for(var l=0;I>l;l++)x.indices[V.NORMAL][l]=l}c[_]=x;var M=b.textureID||"none",O=void 0;if("none"!==M&&(O=r.textureDefinitions[M],B(void 0!==O,"geometry wants unknown texture "+M)),O&&O.atlas===!0&&null!=O.regions){B(O.regions.length>0,"texture marked as atlas carries no region definition");var T=O.regions[b.regionID].subimageRegion,A=[65536*T[0],65536*(T[2]-T[0]),65536*(1-T[3]),65536*(T[3]-T[1])];g=g.concat(A);for(var w=new Uint32Array(I),D=0;I>D;D++)w[D]=g.length/4-1;x.indices[V.REGION]=w}}}else{var x={type:"triangle",positionKey:"position",indices:{}},E=s.position.data.length/s.position.size;if(E>W||null==Z){for(;E>W;)W*=2;Z=new Uint32Array(W);for(var l=0;W>l;l++)Z[l]=l}var R=new Uint32Array(Z.buffer,0,E);for(var L in s)x.indices[L]=R;var j=x.indices[x.positionKey];x.componentRange=[0,null!=j?j.length-1:0],c=[x]}if(g.length>0){var P=new Uint16Array(g);s[V.REGION]={data:P,size:4}}return{indexArrays:c,vertexArrays:s}},t.prototype._createEngineMats=function(e,t,r,i,a){for(var n=e.params.components.length,s=new Array(n),o=0;n>o;o++){var d=e.params.components[o],l=d.materialID,u=r.materialDefinitions[l];null!=u.href&&(u=i[u.hrefConcat].materialDefinitions[l]),B(void 0!==u,"geometry wants unknown material "+l);var c=d.textureID||"none",g=void 0;"none"!==c&&((null==r.textureDefinitions||null==r.textureDefinitions[c])&&this.layer.warningEvent("textureDefinitions missing in shared resource",1),g=r.textureDefinitions[c]);var h=void 0;if(this._matId2Meta[l]&&this._matId2Meta[l][c]){var m=this._matId2Meta[l][c];h=m.engineMat,m.refCount++,z&&console.debug("reused mat "+h.getId()+", increased refcount "+m.refCount)}else h=this._createEngineMaterial(g,c,u,l,t,a);s[o]=h}return s},t.prototype._areAllBundlesLoaded=function(e,t){if(null==this._nodeId2Meta[e.id]||null==this._nodeId2Meta[e.id].engineObjectsPerBundle)return!1;for(var r=0;r<e.featureData.length;r++){if(null==this._nodeId2Meta[e.id].engineObjectsPerBundle[r])return!1;if(!t)for(var i=this._nodeId2Meta[e.id].engineObjectsPerBundle[r],a=0;a<i.length;a++)if(i[a].isPartiallyHidden())return!1}return!0},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._findGraphic=function(e){for(var t=j(e.attributes,this._getObjectIdField()),r=0,i=Object.keys(this._nodeId2Meta);r<i.length;r++)for(var a=i[r],n=this._nodeId2Meta[a].engineObjects,s=0;s<n.length;s++){var o=n[s],d=E(o),l=d.featureIds.indexOf(t);if(-1!==l)return{node:this._controller.nodeIndex[a],nodeId:a,bundleNr:s,index:l}}return null},t.prototype.whenGraphicBounds=function(e){var t=this._findGraphic(e);if(null!=t){for(var r=this._nodeId2Meta[t.nodeId].engineObjects[t.bundleNr],i=E(r),a=i.faceRanges[t.index],n=r.geometries[0].calculateBoundingInfo(0,a),o=n.bbMin,d=n.bbMax,l=[],u=0;8>u;++u){var c=[1&u?o[0]:d[0],2&u?o[1]:d[1],4&u?o[2]:d[2]];D.mat4d.multiplyVec3(r.objectTransformation,c),l[3*u]=c[0],l[3*u+1]=c[1],l[3*u+2]=c[2]}if(v.bufferToBuffer(l,this.view.renderSpatialReference,0,l,this.view.spatialReference,0,8)){for(var g=y.create(y.NEGATIVE_INFINITY),h=0;h<l.length;h+=3)for(var m=0;3>m;m++)g[m]=Math.min(g[m],l[h+m]),g[m+3]=Math.max(g[m+3],l[h+m]);return s.resolve(g)}}return s.reject()},t.prototype.whenGraphicAttributes=function(e,t){var r=this,i=j(e.attributes,this._getObjectIdField()),a=function(){return r._findGraphic(e)};return m.whenGraphicAttributes(this.layer,e,i,t,a)},t.prototype.getGraphicsFromStageObject=function(e,t){var r=E(e),i=e.getFaceRangeIndexFromTriangleNr(t);if(null!=i&&null!=r.graphics&&null!=r.graphics[0].attributes)return s.resolve(r.graphics[i]);if(null!=i&&null!=r.featureIds&&null!=r.featureIds[i]){var a={};a[this._getObjectIdField()]=r.featureIds[i];for(var n=0,o=Object.keys(r.attributeData);n<o.length;n++){var d=o[n];a[d]=r.attributeData[d][i]}var l=new g(null,null,a);return l.layer=this.layer,s.resolve(l)}return s.reject()},t.prototype._calculateNormals=function(e,t){var r=t.normal,i=t.position,a=e[0].indices.normal,n=e[0].indices.position;B(a.length===n.length);for(var s=D.vec3.create(),o=D.vec3.create(),d=0;d<n.length;d+=3){var l=3*n[d],u=i.data[l],c=i.data[l+1],g=i.data[l+2];l=3*n[d+1],s[0]=i.data[l]-u,s[1]=i.data[l+1]-c,s[2]=i.data[l+2]-g,l=3*n[d+2],o[0]=i.data[l]-u,o[1]=i.data[l+1]-c,o[2]=i.data[l+2]-g,D.vec3.cross(s,o,s),D.vec3.normalize(s);for(var h=0;3>h;h++){var m=3*a[d+h];r.data[m]=s[0],r.data[m+1]=s[1],r.data[m+2]=s[2]}}},t.prototype._addBundle=function(e,t,r,i,a,n,s){if(this.debugNodeVis===!0&&null!=this._nodeDebugVisualizer){var o="grey";switch(e.level){case 1:o="red";break;case 2:o="green";break;case 3:o="blue";break;case 4:o="yellow";break;case 5:o="magenta";break;case 6:o="brown"}this._nodeDebugVisualizer.show(e,this._controller.crsIndex,o)}var d=this._stage,l={};l[H.OBJECT]={},l[H.GEOMETRY]={},l[H.MATERIAL]={},l[H.TEXTURE]={};var u=this._engineLayer,c=u.getId(),h=i[e.sharedResource.hrefConcat];if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle&&this._nodeId2Meta[e.id].engineObjectsPerBundle[s])return this._hideFaceRangesOutsideBoundingBox(e,this._clippingArea),void(null!=a&&a.done());if(!this.isOverMemory()){if(null==this._nodeId2Meta[e.id]&&(this._nodeId2Meta[e.id]={engineObjects:[],engineObjectsPerBundle:[]}),this._nodeId2Meta[e.id].engineObjectsPerBundle[s]=[],q&&null==this.allUnitTestData&&(this.allUnitTestData={}),null==t)return void(null!=a&&a.done());for(var m=0;m<t.length;m++){var f=t[m].geometries,v=t[m].features,y=t[m].featureDataAttributes,_=i[e.geometryData[s].hrefConcat];B(_ instanceof ArrayBuffer,"I3S: geometry data is not an ArrayBuffer"),null==_._isReprojected&&(_._isReprojected={});for(var b=v[0].id.toString(),O=[],T=[],A=[],R=void 0,L=0;L<f.length;++L){var j=f[L];z&&console.debug("adding geometry "+L);var P=this._createVertexAndIndexArrays(j,_,h);if(!G||0!==P.indexArrays.length){var C=this._createEngineMats(j,v,h,i,n),S=void 0;q&&(S={},S.inputPositions=w.encode(new Uint8Array(P.vertexArrays.position.data.buffer)));var F=_._isReprojected[j.id],V=this._controller.isMeshPyramid?p.ReprojectionTypes.PER_VERTEX:p.ReprojectionTypes.BOUNDINGBOX;R=p.reprojectPoints(V,P.vertexArrays.position.data,P.vertexArrays.normal.data,e.mbs,F,this._controller.crsIndex,this._controller.crsVertex,this.view.renderSpatialReference),_._isReprojected[j.id]=!0,this._controller.isMeshPyramid&&this._calculateNormals(P.indexArrays,P.vertexArrays),q&&(S.perVertexReprojectedPositions=w.encode(new Uint8Array(P.vertexArrays.position.data.buffer)),S.matrices=R,S.mbs=e.mbs,S.crsIndex=this._controller.crsIndex,S.crsVertex=this._controller.crsVertex,S.crsEngine=this.view.renderSpatialReference);var N=D.mat4d.create(j.transformation);D.mat4d.multiply(R.localTrafo,N,N);for(var X=0;X<C.length;X++){var Y=C[X];l[H.MATERIAL][Y.getId()]=Y}var J=new I(new x(P.indexArrays,P.vertexArrays),b+"_"+L);this.memEstimateGeometryAdded(J.getData()),l[H.GEOMETRY][J.getId()]=J,O[L]=J,T[L]=N,A[L]=C,q&&(this.allUnitTestData[J.getId()]=S)}}for(var K=[],Q=0;Q<v.length;Q++){var W=y[Q],Z=new g(void 0,void 0,W);Z.set("layer",this.layer),K.push(Z)}var $={graphics:K,i3sNode:e.id,ceLayer:c,features:v,faceRanges:t[m].faceRanges,featureIds:t[m].featureIds,attributeData:r?r.attributeData:null,loadedAttributes:r?r.loadedAttributes:null,layerId:this.layer.id},et=new M({idHint:e.id,name:b,geometries:O,materials:A,transformations:T,castShadow:!0,metadata:$}),tt=D.mat4d.create();D.mat4d.identity(tt),D.mat4d.multiply(tt,R.globalTrafo,tt),et.setObjectTransformation(tt),this._nodeId2Meta[e.id].engineObjectsPerBundle[s].push(et),this._nodeId2Meta[e.id].engineObjects.push(et),l[H.OBJECT][et.getId()]=et,this._setObjectSymbology(et),null!=this._clippingArea&&this._hideFaceRangesOutsideBoundingBox(e,this._clippingArea)}if(k){for(var v="",rt=this._nodeId2Meta[e.id].engineObjectsPerBundle[s],it=0;it<rt.length;it++)for(var at=E(rt[it]).features,Q=0;Q<at.length;Q++)v+="f "+at[Q].id+" rf "+at[Q].rootFeature+", ";console.debug("_addNodeDataToStage node "+e.id+" bundle "+s+" features "+v)}if(U){var nt=function(e){return Object.keys(e).length};console.log("objs: "+nt(l[H.OBJECT])+" geoms: "+nt(l[H.GEOMETRY])+" mats: "+nt(l[H.MATERIAL])+" texts: "+nt(l[H.TEXTURE]))}d.beginMod();var st=l[H.OBJECT];for(var ot in st)st.hasOwnProperty(ot)&&u.addObject(st[ot]);for(var dt in l)if(l.hasOwnProperty(dt)){var lt=l[dt];for(name in lt)if(lt.hasOwnProperty(name)){if(null!=d.get(dt,name))continue;d.add(dt,lt[name])}}d.endMod(),null!=a&&a.done()}},t.prototype._clippingAreaChanged=function(){var e=this,t=[];if(this._clippingArea=v.extentToBoundingBox(this.view.clippingArea,t,this.view.renderSpatialReference)?t:null,this._controller){var r=this._controller.nodeIndex;r&&Object.keys(this._nodeId2Meta).forEach(function(t){return e._hideFaceRangesOutsideBoundingBox(r[t],e._clippingArea)}),this._controller.updateClippingArea(this.view.clippingArea)}},t.prototype._hideFaceRangesOutsideBoundingBox=function(e,t){if(this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){var r=[0,0,0,0];v.mbsToMbs(e.mbs,this._controller.crsIndex,r,this.view.renderSpatialReference);for(var i=null!=t?m.intersectBoundingBoxWithMbs(t,r):2,a=this._nodeId2Meta[e.id].engineObjects,n=0;n<a.length;n++){var s=a[n];if(0!==i){if(s.unhideAllFaceRange(),2!==i){var o=s.getObjectTransformation(),d=s.getGeometryRecords()[0].transformation;if(D.mat4d.multiply(o,d),0===o[1]&&0===o[2]&&0===o[3]&&0===o[4]&&0===o[6]&&0===o[7]&&0===o[8]&&0===o[9]&&0===o[11]&&1===o[15]){for(var l=(t[0]-o[12])/o[0],u=(t[1]-o[13])/o[5],c=(t[2]-o[14])/o[10],g=(t[3]-o[12])/o[0],h=(t[4]-o[13])/o[5],p=(t[5]-o[14])/o[10],f=s.getGeometryRecords()[0].geometry.getData(),y=f.getFaces()[0].indices.position,_=f.getVertexAttr().position.data,b=[],I=s.getMetadata().faceRanges,x=void 0,M=void 0,O=void 0,T=void 0,A=void 0,w=void 0,E=0;E<I.length;E+=1){var R=I[E],L=R[0],j=R[1];x=M=O=Number.MAX_VALUE,T=A=w=-Number.MAX_VALUE;for(var B=L;j>=B;B+=1)for(var P=0;3>P;P+=1){var C=3*y[3*B+P],S=_[C],F=_[C+1],V=_[C+2];x=Math.min(S,x),M=Math.min(F,M),O=Math.min(V,O),T=Math.max(S,T),A=Math.max(F,A),w=Math.max(V,w)}var U=x>g||l>T||M>h||u>A||O>p||c>w;U&&b.push(R)}b.length>0&&(X?(this._setObjectSymbology(s),s.setFacerangeColors(b.map(function(e){return{faceRanges:e,color:[0,0,0,0]}}),"replace")):s.hideFaceRange(s.getGeometryRecords()[0],b))}}}else s.hideAllFaceRanges()}}},t.prototype._hideFeatures=function(e,t){for(var r=this._nodeId2Meta[e.id].engineObjects,i=0;i<r.length;i++){for(var a=r[i],n=[],s=E(a).features,o=a.getMetadata().faceRanges,d=0;d<t.length;d++)for(var l=t[d],u=0;u<s.length;u++)l===s[u].id&&(null!=o&&1===a.getGeometryRecords().length?n.push(o[u]):a.hideAllFaceRanges());n.length>0&&a.hideFaceRange(a.getGeometryRecords()[0],n)}},t.prototype._removeFeatures=function(e,t){null!=this._nodeId2Meta[e.id]&&(this._hideFeatures(e,t),this._isAllHidden(e)===!0&&(k&&console.debug("all hidden for node "+e.id+". removing."),this._removeNodeDataFromStage(e)))},t.prototype._removeNodeDataFromStage=function(e){if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){for(var t=this._stage,r=this._engineLayer,i=this._nodeId2Meta[e.id].engineObjects,a=0;a<i.length;++a){var n=i[a];r.removeObject(n);for(var s=n.getGeometryRecords(),o=0;o<s.length;o++){var d=s[o];this.memEstimateGeometryRemoved(d.geometry.getData()),t.remove(H.GEOMETRY,d.geometry.getId());for(var l=0;l<d.materials.length;l++){var u=d.materials[l],c=u.getId(),g=u.metadata.i3sMatId,h=u.metadata.i3sTexId||"none",m=this._matId2Meta[g][h];B(m.refCount>0),m.refCount--,z&&console.debug("decreased refcount material "+c+" "+("geometry "+o+", count "+m.refCount)),0===m.refCount&&this._removeMaterial(c,h,g,u,t)}}t.remove(H.OBJECT,n.getId())}delete this._nodeId2Meta[e.id]}},t.prototype._removeMaterial=function(e,t,r,i,a){if(a.remove(H.MATERIAL,e),"none"!==t){var n=this._texId2Meta[t],s=n.usedByEngineMats,o=s.indexOf(i);if(B(o>-1),s[o]=s[s.length-1],s.pop(),s.length<1){var d=n.engineTex;d&&d!==this._initTexture&&(this.memEstimateTextureRemoved(d),a.remove(H.TEXTURE,n.engineTex.getId())),n.engineTex=void 0,n.desiredLOD=-1,n.curLOD=-1,delete this._texId2Meta[t]}}delete this._matId2Meta[r][t],F(this._matId2Meta[r])&&delete this._matId2Meta[r]},t.prototype._updateAllTextureLOD=function(){for(var e in this._texId2Meta)if(this._texId2Meta.hasOwnProperty(e)){var t=this._texId2Meta[e];this._updateTextureLOD(t)}},t.prototype._calcDesiredTextureLOD=function(e,t){var r,i,a,n=0;for(var i in e)if(e.hasOwnProperty(i)){var a=e[i],s=2*a[3],o=s/D.vec3.dist(a,this._controller.camPos)*this._controller.screenSizeFactor;o>n&&(n=o)}for(n/=Q,r=t.length-1;r>0&&t[r].size<n;)r--;return r},t.prototype._updateTextureLOD=function(e){var t=this;e.desiredLOD=this._calcDesiredTextureLOD(e.featureMBS,e.images);var r=e.curLOD!==e.desiredLOD&&(e.curLOD<0||!e.curLOD||0===e.desiredLOD||e.desiredLOD>e.curLOD||e.desiredLOD<e.curLOD-1);if(r){if(0===e.images.length)return;var i=e.images[e.desiredLOD],a=e.encodingIdx>-1?i.hrefConcat[e.encodingIdx]:i.hrefConcat;if(!this._requestedTexImageIds[i.id]){var n={metadata:{texMeta:e,image:i}};this._requestedTexImageIds[i.id]=!0,this._imageIsPartOfTextureBundle(i)?this._controller.streamDataSupplier.request(a,"binary",n).then(this._extractTextureImageFromBlob.bind(this)):this._controller.streamDataSupplier.request(a,"image",n).then(function(e,r,i,a){t._textureImageLoaded(e,r,a.image,a.texMeta)})}}if(e.engineTex||(e.engineTex=this._initTexture,e.curLOD=-1),this.debugLODVis)for(var s=l.fromHsv(e.desiredLOD/e.images.length*270,100,100).toRgb().map(function(e){return e/255}),o=0;o<e.usedByEngineMats.length;o++){var d=e.usedByEngineMats[o],u={ambient:s,diffuse:s};d.setParameterValues(u)}},t.prototype._extractTextureImageFromBlob=function(e,t,r,i){var a=i.texMeta;if(a.desiredLOD<0||i.image.size>a.images[a.desiredLOD].size)return void delete this._requestedTexImageIds[i.image.id];var n=this;B("binary"===r);var s="";try{var o=0,d=0;a.encodingIdx>-1?(o=i.image.byteOffset[a.encodingIdx],d=i.image.length[a.encodingIdx]):(o=i.image.byteOffset,d=i.image.length);var l=new Uint8Array(t,o,d),u=new Blob([l],{type:a.encoding});s=window.URL.createObjectURL(u)}catch(c){s="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2P8zyD6n4ECwDhqAMNoGDCMhgEwDw2DdAAAdzkhQdS8dl8AAAAASUVORK5CYII=",console.error("error loading texture "+e+" "+c)}var g=new Image;g.onerror=function(){window.URL.revokeObjectURL(s),g.src="",g.onerror=void 0,g.onload=void 0},g.onload=function(){n._controller.queueAnimationFrameFunctionCall(n._textureImageLoaded,n,[e,g,i.image,i.texMeta,s],void 0,1),window.URL.revokeObjectURL(s),g.src="",g.onerror=void 0,g.onload=void 0},g.src=s},t.prototype._textureImageLoaded=function(e,t,r,i){if(delete this._requestedTexImageIds[r.id],!(i.desiredLOD<0)){var a=i.images[i.desiredLOD],n=i.images[i.curLOD];if((!this.isOverMemory()||!(null==n||r.size>n.size))&&(!n||r.size>n.size&&r.size<=a.size||r.size<n.size&&r.size>=a.size)){var s=i.engineTex;s&&s!==this._initTexture&&(this.memEstimateTextureRemoved(s),this._stage.remove(H.TEXTURE,i.engineTex.getId()));var o=L(t,i);i.engineTex=new O(t,i.id,o),this._stage.add(H.TEXTURE,i.engineTex),i.curLOD=i.desiredLOD,this.memEstimateTextureAdded(i.engineTex);for(var d=i.engineTex.getId(),l=0;l<i.usedByEngineMats.length;l++){var u=i.usedByEngineMats[l];null==this._colorOverride&&u.setParameterValues({textureId:d}),u.metadata.originalTextureId=d}if(r!==a&&(i.curLOD=i.images.indexOf(r),B(i.curLOD>-1),!this._requestedTexImageIds[a.id])){var c={metadata:{texMeta:i,image:a}};this._requestedTexImageIds[a.id]=!0,this._controller.streamDataSupplier.request(a.hrefConcat,"binary",c).then(this._extractTextureImageFromBlob.bind(this))}}}},t.prototype._imageIsPartOfTextureBundle=function(){return!this._controller.isMeshPyramid},t.prototype._setPolygonOffset=function(e,t){if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle)for(var r={polygonOffset:t},i=0;i<this._nodeId2Meta[e.id].engineObjectsPerBundle.length;i++)for(var a=this._nodeId2Meta[e.id].engineObjectsPerBundle[i],n=0;n<a.length;n++)for(var s=a[n].getGeometryRecords(),o=0;o<s.length;o++)for(var d=s[o].materials,l=0;l<d.length;l++)d[l].setParameterValues(r)},t.prototype._rendererChange=function(e){this._currentRenderer=e,e&&(e.colorInfo||e.sizeInfo)&&console.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead.")},t.prototype._getRenderer=function(e){if(!e||e.symbol)return null;var t=this._rndForScale||this._currentRenderer;return t},t.prototype._getSymbol=function(e){if(e.symbol)return e.symbol;var t=this._getRenderer(e);return t&&t.getSymbol(e)},t.prototype._getRenderingInfo=function(e){var t=this._getRenderer(e),r=this._getSymbol(e);if(!(r&&r instanceof h))return null;var i,a={symbol:r};if(t&&t.visualVariables)for(var n=t.getVisualVariableValues(e),s=0;s<n.length;s++){var o=n[s],d=o.variable.type;"color"===d&&(i=o.value)}return i&&(a.color=[i.r/255,i.g/255,i.b/255,i.a]),a},t.prototype._getSymbolFillColor=function(e){for(var t=e.symbolLayers,r=0;r<t.length;r++){var i=t.getItemAt(r);if("Fill"===i.type&&i.material&&i.material.color){var a=i.material.color;return[a.r/255,a.g/255,a.b/255,a.a]}}return void 0},t.prototype._setObjectSymbology=function(e){for(var t=E(e),r=[],i=t.graphics,a=!1,n=i.length,s=t.faceRanges?t.faceRanges.length:n,o={attributes:{}},d=function(e){s===n&&null==t.attributeData?o=i[e]:Object.keys(t.attributeData).forEach(function(r){o.attributes[r]=t.attributeData[r][e]});var d=l._getRenderingInfo(o),u=null!=t.faceRanges?t.faceRanges[e]:null;if(d){var c=d.color;null==c&&d.symbol&&(c=l._getSymbolFillColor(d.symbol)),c&&c[3]<1&&(a=!0),r.push({faceRanges:u,color:c})}else r.push({faceRanges:u,color:void 0})},l=this,u=0;s>u;u++)d(u);this.layer.cachedDrawingInfo.color?e.setFacerangeColors(r,"replace"):e.setFacerangeColors(r,"blend");for(var c=e.getGeometryRecords(),g=0;g<c.length;g++)for(var h=c[g],m=0;m<h.materials.length;m++){var p=h.materials[m],f=p.getParams().transparent,v=p.getParams().opacity;p.metadata.symbolIsTransparent=a;var y=this._calcEngineMaterialTransparencyParams(p.metadata.i3sTex,p.metadata.i3sMatParams,p.metadata.symbolIsTransparent);(f!==y.transparent||v!==y.opacity)&&p.setParameterValues({transparent:y.transparent,opacity:y.opacity})}},t.prototype._opacityChange=function(){for(var e in this._matId2Meta)for(var t in this._matId2Meta[e]){var r=this._matId2Meta[e][t].engineMat,i=r.getParams().transparent,a=r.getParams().opacity,n=this._calcEngineMaterialTransparencyParams(r.metadata.i3sTex,r.metadata.i3sMatParams,r.metadata.symbolIsTransparent);(i!==n.transparent||a!==n.opacity)&&r.setParameterValues({transparent:n.transparent,opacity:n.opacity})}},i([a.shared("esri.views.3d.layers.SceneLayerView3D")],t.prototype,"declaredClass",void 0),i([a.property()],t.prototype,"layer",void 0),i([a.property()],t.prototype,"view",void 0),t=i([a.subclass([f])],t)}(R());return $});