// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","../../lib/glMatrix","./I3SUtil","../../webgl-engine/lib/Util","../../support/projectionUtils","../graphics/Graphics3DSymbolCommonCode","../../../../geometry/Point"],function(t,e,i,r,s,o,n,a){var c=i.vec3d,h=i.vec4d,p=!1,l=function(){function t(t,e,i,r,o,n,p,l){void 0===l&&(l={}),this.indexSR=t,this.renderCoordsHelper=e,this.extent=r,this.errorMetric=o,this.elevationProvider=n,this.elevationInfo=p,this.options=l,this.fp=[],this._tmp1=[0,0,0],this._tmp2=[0,0,0],this._tmp3=[0,0,0],this._tmp0=[0,0,0],this.maxDistance=l.maxDistance||Number.MAX_VALUE,this.screenspaceErrorBias=l.screenspaceErrorBias||1,this.enableLoD=l.disableLod!==!1;for(var u=0;8>u;++u)this.fp[u]=h.create();s.matrix2frustumPlanes(i.viewMatrix,i.projectionMatrix,this.fp),this.engineSR=e.spatialReference,this._screenSizeFactor=1/i.perPixelRatio,this._camPos=i.eye,this._center=i.center,this._camDir=c.subtract(this._center,this._camPos,[0,0,0]),c.normalize(this._camDir),this.tmpPoint=new a({x:0,y:0,z:0,spatialReference:t})}return t.prototype.computedMbs=function(t){t.computedMbs||(t.computedMbs=h.create(),t.computedMbs[3]=-1);var e=t.computedMbs;return e[3]<0&&(e[0]=t.mbs[0],e[1]=t.mbs[1],e[2]=t.mbs[2],e[3]=t.mbs[3],this.elevationProvider&&(this.tmpPoint.x=e[0],this.tmpPoint.y=e[1],this.tmpPoint.z=e[2],e[2]=n.computeElevation(this.elevationProvider,this.tmpPoint,this.elevationInfo)),o.mbsToMbs(e,this.indexSR,e,this.engineSR)),e},t.prototype.isNodeVisible=function(t){var e=this.computedMbs(t);return this.isMBSinExtent(e)&&this.isMBSVisible(e)},t.prototype.isMBSinExtent=function(t){return this.extent?0!==r.intersectBoundingBoxWithMbs(this.extent,t):!0},t.prototype.isMBSVisible=function(t){var e=t[0],i=t[1],r=t[2],s=t[3],o=this.fp;return o[0][0]*e+o[0][1]*i+o[0][2]*r+o[0][3]<=s&&o[1][0]*e+o[1][1]*i+o[1][2]*r+o[1][3]<=s&&o[2][0]*e+o[2][1]*i+o[2][2]*r+o[2][3]<=s&&o[3][0]*e+o[3][1]*i+o[3][2]*r+o[3][3]<=s&&o[4][0]*e+o[4][1]*i+o[4][2]*r+o[4][3]<=s&&o[5][0]*e+o[5][1]*i+o[5][2]*r+o[5][3]<=s},t.prototype.calcScreenSpaceSize=function(t,e){var i=this.computedMbs(t),r=i[3],s=c.dist2(i,this._camPos)-r*r;return 0>s?.5*Number.MAX_VALUE:e/Math.sqrt(s)*this._screenSizeFactor},t.prototype.calcAngleDependentLoD=function(t){var e=this.computedMbs(t),i=e[3],r=Math.abs(e[0]*(e[0]-this._camPos[0])+e[1]*(e[1]-this._camPos[1])+e[2]*(e[2]-this._camPos[2]))/c.length(e),s=(r+i)/c.dist(e,this._camPos);return Math.min(1,s)},t.prototype.hasLOD=function(t){return this.enableLoD&&void 0!==t.lodSelection||void 0!==t.precision},t.prototype.hasFeatures=function(t){return null!=t.features&&t.features.length>0||null!=t.featureData},t.prototype.getDistancePlanarMode=function(t,e,i){var r=t[0]-e[0],s=t[1]-e[1],o=t[2]-e[2],n=r+r+s*s;if(i*i>=n)return Math.abs(o);var a=Math.sqrt(n)-i;return Math.sqrt(o*o+a*a)},t.prototype.getDistanceGlobeMode=function(t,e,i){var r=c.length(e),s=c.length(t)-r;c.scale(t,c.dot(t,e)/c.length2(t),this._tmp0);var o=c.dist2(e,this._tmp0);if(i*i>=o)return Math.abs(s);var n=c.scale(e,1/r,this._tmp0),a=i,h=r,p=a*a/2/h,l=c.scale(n,h-p,this._tmp1),u=t,m=c.subtract(u,l,this._tmp2),d=c.subtract(m,c.scale(n,c.dot(n,m),this._tmp3),this._tmp2),b=c.add(l,c.scale(d,a/c.length(d),this._tmp2),this._tmp2),f=c.dist(u,b);if(s>=2e5){var g=c.subtract(u,b,this._tmp1),v=c.dot(g,n)/c.length(g);.08>v&&(v=1e-4),f/=v}return f},t.prototype.getDistance=function(t,e,i){return this.engineSR===o.SphericalRenderSpatialReference?this.getDistanceGlobeMode(t,e,i):this.getDistancePlanarMode(t,e,i)},t.prototype.isTooHighLOD=function(t){if(t.lodSelection&&t.lodSelection.length>0){if(this.hasFeatures(t)===!1)return!1;for(var e=0;e<t.lodSelection.length;e++){var i=t.lodSelection[e];if(null==this.errorMetric||i.metricType===this.errorMetric){if("screenSpaceRelative"===i.metricType){var r=this.computedMbs(t),s=this.getDistance(this._camPos,r,r[3]),o=2*s/this._screenSizeFactor;return p&&(console.debug("----node id "+t.id),console.debug("dist "+s),console.debug("screenSpaceRelative "+o),console.debug("lodMetric.maxError "+i.maxError),console.debug(i.maxError>o?"isTooHighLOD false":"isTooHighLOD true")),i.maxError<=o}if("maxScreenThreshold"===i.metricType){var n=this.calcScreenSpaceSize(t,t.mbs[3]);return this.options.angleDependentLoD&&(n*=this.calcAngleDependentLoD(t)),n*this.screenspaceErrorBias<i.maxError}if("removedFeatureDiameter"===i.metricType){var a=this.calcScreenSpaceSize(t,i.maxError);return a*this.screenspaceErrorBias<10}}}}return!1},t.prototype.isChosenLOD=function(t,e,i,r){if(t.lodSelection&&t.lodSelection.length>0){var s=null!=i?i:this.isTooHighLOD(t),o=e?null!=r?r:this.isTooHighLOD(e):!1;return(s||!t.children)&&!o}return!0},t.prototype.distToPOI=function(t,e){var i=this.computedMbs(t);return c.dist(i,e)-i[3]},t}();return l});