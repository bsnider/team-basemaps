// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../../core/declare","dojo/promise/all","dojo/Deferred","dojo/_base/lang","dojo/io-query","../../../config","../../../layers/support/LabelClass","../../../core/urlUtils","../../../core/watchUtils","../../../geometry/support/webMercatorUtils","../../../geometry/support/scaleUtils","../../layers/GraphicsLayerView","../../../layers/graphics/controllers/SnapshotController","../../../geometry/SpatialReference","../../../geometry/Extent","../../../processors/SpatialIndex","./graphics/SymbolConverter","./graphics/TextureCollection","./graphics/Graphics3DSymbol","./graphics/Graphics3DGraphic","./graphics/graphicUtils","./support/LayerViewUpdatingPercentage","../support/ResourceController","../lib/glMatrix","../support/earthUtils","../support/projectionUtils","../support/intersectionUtils","../webgl-engine/Stage","../webgl-engine/lib/Util","../webgl-engine/lib/Layer","../webgl-engine/lib/FloatingBoxLocalOriginFactory","../webgl-engine/materials/HUDMaterial","../support/PromiseLightweight","../webgl-engine/lib/TextTextureAtlas","../webgl-engine/lib/MaterialCollection","../../../core/arrayUtils"],function(e,i,t,a,s,r,n,l,h,o,c,d,p,u,g,_,v,y,m,b,f,x,S,C,w,E,D,G,R,I,L,V,O,H,U,T){var A=function(e){e.remove()},M=function(e){return e.wkid===u.WGS84.wkid},P="VISIBILITY_SCALERANGE",F="VISIBILITY_GRAPHIC",N="VISIBILITY_SCALERANGE_LABEL",z="VISIBILITY_LABEL_SHOW",B=300,j=20,k=1.2,Q=-.3*w.earthRadius,q=.5*w.earthRadius*Math.PI,W=.9*w.earthRadius,Y=!1,K=C.vec4d,X=C.vec3d,J=X.create(),Z=e([d,x],{declaredClass:"esri.views.3d.layers.GraphicsLayerView3D",supportsDraping:!0,hasDraped:!1,drawingOrder:0,"symbols-updating":!1,_progressMaxNumNodes:1,updateElevation:!0,_overlayUpdating:!1,initialize:function(){this._stage=this.view._stage,this._stageLayer=new I(this.layer.id,{state:this.suspended?"HIDDEN":"VISIBLE"},this.layer.id),this._stage.add(G.ModelContentType.LAYER,this._stageLayer),this._labelStageLayer=new I(this.layer.id,{state:this.suspended?"HIDDEN":"IGNORED"},this.layer.id+"_labels"),this._stage.add(G.ModelContentType.LAYER,this._labelStageLayer),this._stage.addToViewContent([this._stageLayer.getId(),this._labelStageLayer.getId()]),this.view.labelManager.addSceneServiceLayerView(this),this._streamDataSupplier=this.view.resourceController.registerClient(this,S.ClientType.SYMBOLOGY,this._addUrlToken.bind(this)),this._symbols={},this._graphics={},this._graphicsKeys={},this._graphicsBySymbol={},this._elevationDirtyGraphicsQueue=[],this._elevationDirtyGraphicsSet={},this._updatingGraphicIds={},this._graphicsDrapedIds={},this.textTextureAtlas=null,this.hudMaterialCollection=null,this._sharedResources={textures:new y(this._streamDataSupplier,this._stage,{wrapClamp:!0})},this._symbolCreationContext={sharedResources:this._sharedResources,renderer:this.layer.renderer,stage:this._stage,streamDataSupplier:this._streamDataSupplier,elevationProvider:null,renderSpatialReference:this.view.renderSpatialReference,renderCoordsHelper:this.view.renderCoordsHelper,overlaySR:null,layer:this.layer,layerOrder:this.view.getDrawingOrder(this.layer.uid)||0,localOriginFactory:new L(5e6,16),clippingExtent:null},this._graphicsController=null,this._graphicsControllerClientSideFiltering=!1,this._graphicsCollection=null,this._graphicsCollectionEventHandle=null,this._graphicsControllerEventHandles=[],this._graphicsControllerLoading=!0,this._initGraphicsController(),this._spatialIndex=new _,this._spatialIndexNumGraphics=0,this._spatialIndexNumPendingQueries=0,this.view.resourceController.registerIdleFrameWorker(this,{needsUpdate:this._needsIdleUpdate,idleFrame:this._idleUpdate}),this._viewChangeListenerHandles=[],this._viewChangeUpdate=this._viewChangeUpdate.bind(this),this._viewChangeListenerHandles.push(this.view.on("resize",this._viewChangeUpdate)),this._viewChangeListenerHandles.push(this.view.navigation.on("currentViewChanged",this._viewChangeUpdate)),this._frustumVisibilityDirty=!0,this._frustumVisibility=!0,this._scaleVisibilityDirty=!0,this._scaleVisibility=!0,this._scaleVisibilityQuery=!1,this._clippingChangedHandle=this.view.watch("clippingArea",this._updateClippingExtent.bind(this)),this._updateClippingExtent(),this._updateSuspendScaleVisibleFinish=this._updateSuspendScaleVisibleFinish.bind(this),this._viewChangeUpdate(),this.computedExtent=null,this._suspendResumeExtent=null,this._suspendResumeExtentEngine={extent:new Array(4),planes:new Array(4),maxSpan:0,center:{origin:X.create(),direction:X.create()}},this._suspendResumeExtentEngineDirty=!0;for(var e=0;4>e;e++)this._suspendResumeExtentEngine.extent[e]={origin:X.create(),direction:X.create(),cap:{next:null,direction:X.create()}},this._suspendResumeExtentEngine.planes[e]=K.create();this._suspendResumeExtentEngine.planes[4]=K.create(),this.on("suspend",function(){this._stageLayer.setState("HIDDEN"),this._labelStageLayer.setState("HIDDEN"),this._hideAllGraphics(),this.updateElevation=!1}.bind(this)),this.on("resume",function(){this._stageLayer.setState("VISIBLE"),this._labelStageLayer.setState("IGNORED"),this.updateElevation&&this._markAllGraphicsElevationDirty(),this._showLabelsChangeOnResume&&this._showLabelsChange(),this.view.basemapTerrain&&this._updateGraphicsVisibility()}),this._layerEventHandles=[this.layer.watch("renderer",this._rendererChange.bind(this)),this.layer.watch("opacity",this._opacityChange.bind(this)),this.layer.watch("elevationInfo",this._elevationInfoChange.bind(this)),this.layer.watch("showLabels",this._showLabelsChange.bind(this)),this.layer.watch("minScale",this._layerMinMaxScaleChangeHandler.bind(this)),this.layer.watch("maxScale",this._layerMinMaxScaleChangeHandler.bind(this)),this.layer.on("graphic-update",this._graphicUpdateHandler.bind(this))],this._scaleChangeEventHandle=null,this._elevationUpdateEventHandle=null,this._showLabelsChangeOnResume=!1,this._labelClasses=[],this.addResolvingPromise(this._initLabelingInfo()),this._basemapTerrainEventHandle=this.view.watch("basemapTerrain",this._basemapTerrainChanged.bind(this)),this._basemapTerrainChanged(this.view.basemapTerrain),this._viewIsSpherical="global"===this.view.viewingMode;var i=new t;this._viewSR=null,this._renderSREqualsViewSR=null,this.fullExtentInViewSpatialReference=null,h.whenOnce(this,"view.spatialReference",function(e){this._viewSR=e,this._renderSREqualsViewSR=this.view.renderSpatialReference.equals(e),this._symbolCreationContext.overlaySR=e;var t=this.get("layer.fullExtent.spatialReference");t&&!t.equals(e)&&"local"===this.view.viewingMode&&r.geometryService?r.geometryService.project([this.layer.fullExtent],e).then(function(e){e&&Array.isArray(e)&&1===e.length&&(this.fullExtentInViewSpatialReference=e[0])}.bind(this)).always(function(){i.resolve()}):i.resolve()}.bind(this)),this.addResolvingPromise(i.promise)},_addUrlToken:function(e){if(-1!==e.indexOf("?token=")||0===e.indexOf("data:"))return e;var i=a.mixin({token:this.layer.token});return i=s.objectToQuery(i),e+=i?"?"+i:"",null==this._canUseXhr&&(this._canUseXhr=l.canUseXhr(e)),this._canUseXhr?e:l.addProxy(e)},_updateClippingExtent:function(){var e=this._symbolCreationContext.clippingExtent,i=[];this._symbolCreationContext.clippingExtent=E.extentToBoundingRect(this.view.clippingArea,i,this.view.spatialReference)?[i[0],i[1],-1/0,i[2],i[3],1/0]:null,T.equals(this._symbolCreationContext.clippingExtent,e)||this._graphicsController&&(this._graphicsControllerClientSideFiltering?this._recreateAllGraphics():this._graphicsController.extent?(this._graphicsController.extent=null,this._graphicsControllerClientSideFiltering=!0):this._graphicsController.extent=this.view.clippingArea)},_basemapTerrainChanged:function(e){this._symbolCreationContext.elevationProvider=e,this._tilingSchemeHandle&&this._tilingSchemeHandle.remove(),e?this._tilingSchemeHandle=h.whenOnce(e,"tilingScheme",this._recreateAllGraphics.bind(this)):this._recreateAllGraphics(),e?(this._elevationUpdateEventHandle=e.on("elevation-change",this._elevationUpdateHandler.bind(this)),this.updateElevation=!1,this._layerMinMaxScaleChangeHandler()):(this._elevationUpdateEventHandle&&(this._elevationUpdateEventHandle.remove(),this._elevationUpdateEventHandle=null),this._scaleChangeEventHandle&&(this._scaleChangeEventHandle.remove(),this._scaleChangeEventHandle=null))},_getVerticalUnitValueForSR:function(e){var i=c.getUnitValueForSR(e);return i>1e5?1:i},_scaleVerticalUnits:function(e,i){function t(e,i){for(var t=0;t<e.length;++t)for(var a=e[t],s=0;s<a.length;++s){var r=a[s];r[2]*=i}}for(var a=0;a<e.length;++a){var s=e[a].geometry;if(!s.hasZ)return;s.z?s.z*=i:s.paths?t(s.paths,i):s.rings&&t(s.rings,i)}},_getVerticalUnitScale:function(){if("esri.layers.FeatureLayer"===this.layer.declaredClass){var e=this.layer.spatialReference,i=this.view.spatialReference;if(e.equals(i))return 1;var t=this._getVerticalUnitValueForSR(e),a=this._getVerticalUnitValueForSR(i);return t/a}return 1},_initGraphicsController:function(){var e=this.layer.createGraphicsController({layerView:this,options:{maxPageSize:B,extent:this.view.clippingArea}});h.whenTrueOnce(this.view,"basemapTerrain.ready",function(){i([this,e]).then(function(e){if(this._graphicsController=e[1],this._graphicsController instanceof p){var i=this._graphicsController.on("query-end",function(){this._graphicsControllerLoading=!1,this._evaluateUpdatingState()}.bind(this));this._graphicsControllerEventHandles.push(i)}else this._graphicsControllerLoading=!1;this._graphicsCollection=this._graphicsController.graphics,this._graphicsCollectionEventHandle=this._graphicsCollection.on("change",this._collectionChangeHandler.bind(this)),this._graphicsCollection.length>0&&this.add(this._graphicsCollection.toArray()),this._evaluateUpdatingState()}.bind(this))}.bind(this))},_viewChangeUpdate:function(){this._frustumVisibilityDirty=!0},destroy:function(){this._graphicsCollection=null,this._graphicsCollectionEventHandle&&this._graphicsCollectionEventHandle.remove(),this._graphicsControllerEventHandles.forEach(A),this._elevationUpdateEventHandle&&(this._elevationUpdateEventHandle.remove(),this._elevationUpdateEventHandle=null),this._tilingSchemeHandle&&this._tilingSchemeHandle.remove(),this._layerEventHandles.forEach(A),this._scaleChangeEventHandle&&(this._scaleChangeEventHandle.remove(),this._scaleChangeEventHandle=null),this._basemapTerrainEventHandle.remove(),this._basemapTerrainEventHandle=null;var e=[this._stageLayer.getId(),this._labelStageLayer.getId()];this._stage.removeFromViewContent(e),this._stage.remove(G.ModelContentType.LAYER,e[0]),this._stage.remove(G.ModelContentType.LAYER,e[1]),this.view.resourceController.deregisterIdleFrameWorker(this),this.view.labelManager.removeSceneServiceLayerView(this);var i=!1;for(var t in this._graphics)i=i||this._graphics[t].isDraped(),this._graphics[t].destroy();this._graphics={},this._graphicsKeys=null;for(var a in this._symbols)this._symbols[a].destroy();this._graphicsDrapedIds={},this.hasDraped=!1,this._viewChangeListenerHandles.forEach(A),this._clippingChangedHandle.remove(),null!=this._controller&&this._controller.destroy(),i&&this.emit("draped-data-change"),this._spatialIndex&&this._spatialIndex.destroy()},add:function(e){this.isResolved()?this._add(e):this.then(function(){this._add(e)}.bind(this))},remove:function(e){for(var i=!1,t=e.length,a=0;t>a;a++){var s=e[a].id,r=this._graphics[s];if(r){var n=r.isDraped();n&&(delete this._graphicsDrapedIds[s],i=!0);var l=r.graphics3DSymbol.symbol.id;r.destroy(),delete this._graphics[s],delete this._graphicsBySymbol[l][s],this._graphicsKeys=null}}this._updateHasDraped(),i&&this.emit("draped-data-change"),this.view.labelManager.setDirty()},getRenderingInfo:function(){var e=this.inherited(arguments);if(e&&e.color){var i=e.color;e.color=[i.r/255,i.g/255,i.b/255,i.a]}return e},_drawingOrderSetter:function(e){this._symbolCreationContext.layerOrder=e;var i={},t={};for(var a in this._graphics){var s=this._graphics[a];s.setDrawOrder(e,i,t)}for(var r in t){var n=this._symbols[r];n.setDrawOrder(e,i)}return R.objectEmpty(i)||(this.view._stage.getTextureGraphicsRenderer().updateRenderOrder(i),this.emit("draped-data-change")),e},getGraphicsFromStageObject:function(e){var i=null;if(this._graphicsCollection){var t=e.getMetadata();this._graphicsCollection.some(function(e){return e.id===t.graphicId?(i=e,e):!1})}var a=new O.Promise;return null!=i?a.done(i):a.reject(),a},getGraphics3DGraphics:function(){return this._graphics},getGraphics3DGraphicsKeys:function(){return null==this._graphicsKeys&&(this._graphicsKeys=Object.keys(this._graphics)),this._graphicsKeys},_collectionChangeHandler:function(e){var i=this._getVerticalUnitScale();if(1!==i){var t=e.added.slice();this._scaleVerticalUnits(t,i),this.add(t)}else this.add(e.added);this.remove(e.removed)},_needsIdleUpdate:function(){return this._frustumVisibilityDirty||this.view.basemapTerrain&&(this._scaleVisibilityDirty||this._elevationDirtyGraphicsQueue.length>0)},_idleUpdate:function(e){if(!(this._frustumVisibilityDirty&&(this._updateSuspendFrustumVisible(),this._frustumVisibilityDirty=!1,e.done())||!this.view.basemapTerrain||this._scaleVisibilityDirty&&(this._updateSuspendScaleVisible(),this._scaleVisibilityDirty=!1,e.done()))){var i=this._elevationDirtyGraphicsQueue.length;if(i>0){for(var t=this._stageLayer.getId(),a=this._labelStageLayer.getId(),s=0,r=0;i>r;r++){var n=this._elevationDirtyGraphicsQueue[r],l=this._graphics[n];if(l&&l.alignWithElevation(this.view.basemapTerrain,this.view.renderCoordsHelper),delete this._elevationDirtyGraphicsSet[n],s++,s>=j){if(this.view._stage.processDirtyLayer(t),this.view._stage.processDirtyLayer(a),e.done())break;s=0}}this.view._stage.processDirtyLayer(t),this.view._stage.processDirtyLayer(a),this._elevationDirtyGraphicsQueue.splice(0,r+1),this.view.labelManager.setDirty()}this._evaluateUpdatingState()}},_add:function(e){if(this.view.basemapTerrain.tilingScheme){for(var i=e.length,t=this._scaleRangeEnabled(),a=new Array(i),s=new Array(i),r=new Array(i),n=0;i>n;n++){var l=e[n],h=l.geometry;if(null!=h){this._expandComputedExtent(h);var o=this.getRenderingInfo(l);if(o){s[n]=o.symbol,r[n]=o;var c=this._getOrCreateGraphics3DSymbol(s[n],o.renderer);c&&(a[n]=c,this._beginGraphicUpdate(l))}}}for(var n=0;i>n;n++){var d=a[n];d&&d.then(function(e,i,a,s){this._graphicsBySymbol[i.id]||(this._graphicsBySymbol[i.id]={}),this._createCanvas3DGraphic(a,e,s,t),this._endGraphicUpdate(e),this.view.labelManager.setDirty()}.bind(this,e[n],s[n],d,r[n]),function(e){this._endGraphicUpdate(e)}.bind(this,e[n]))}}},_getOrCreateGraphics3DSymbol:function(e,i){var t=this._symbols[e.id];if(!t){var a=v.toWeb3DSymbol(e,!0,!1);if(a){var s;if(i&&i.backgroundFillSymbol){var r=v.toWeb3DSymbol(i.backgroundFillSymbol,!1,!0);r&&(s=r.symbolLayers)}t=new m(a,this._symbolCreationContext,s),this._symbols[e.id]=t}}return t},_createCanvas3DGraphic:function(e,i,t,a){if(!this._graphics[i.id]){var s=e.createGraphics3DGraphic(i,t);this.layerLabelsEnabled()&&(s=this._createLabelsForGraphic(i,s,t)),this._graphics[i.id]=s,this._graphicsKeys=null,this._graphicsBySymbol[e.symbol.id][i.id]=s,s.initialize(this._stageLayer,this._labelStageLayer,this._stage);var r=s.isDraped();r&&(this._graphicsDrapedIds[i.id]=!0,this.hasDraped=!0),s.centroid=null,"point"!==i.geometry.type&&s instanceof b&&(s.centroid=f.computeCentroid(i.geometry,this._viewSR));var n=!this.suspended;if(this._shouldAddToSpatialIndex(i,s,a)){var l=this._addGraphicToSpatialIndex(i,s);a&&l&&(n=n&&this._graphicVisibleAtScale(i,s))}var h=s.setVisibilityFlag(P,n),o=s.setVisibilityFlag(F,i.visible),c=h!==o;c&&r&&this.emit("draped-data-change")}},_shouldAddToSpatialIndex:function(e,i,t){return t||i.mustAlignToTerrain()},_addGraphicsToSpatialIndex:function(){if(this._graphicsCollection)for(var e=this._graphicsCollection.toArray(),i=e.length,t=this._scaleRangeEnabled(),a=0;i>a;a++){var s=e[a],r=this._graphics[s.id];r&&!r.addedToSpatialIndex&&this._shouldAddToSpatialIndex(s,r,t)&&this._addGraphicToSpatialIndex(s,r)}},_addGraphicToSpatialIndex:function(e,i){var t=e.geometry.spatialReference,a=this._viewSR,s={id:e.id};if(t.equals(a))s.geometry=e.geometry.toJSON(!0);else{var r;if(M(t)&&a.isWebMercator)r=o.geographicToWebMercator(e.geometry);else{if(!t.isWebMercator||!M(a))return console.warn("Cannot convert graphic geometry to map spatial reference, elevation and scale updates are disabled"),!1;r=o.webMercatorToGeographic(e.geometry)}s.geometry=r.toJSON(!0)}this._spatialIndexNumGraphics++,this._spatialIndex.runProcess([s],this.layer.id),i.addedToSpatialIndex=!0},_recreateSymbol:function(e){var i=this._graphicsBySymbol[e],t=[],a=!1;for(var s in i){var r=i[s],n=r.isDraped();n&&(delete this._graphicsDrapedIds[s],a=!0),t.push(r.graphic),r.destroy(),this._graphics[s]=null}this._graphicsBySymbol[e]={};var l=this._symbols[e];l.destroy(),this._symbols[e]=null,this._updateHasDraped(),a&&this.emit("draped-data-change"),this.add(t)},_clearSymbolsAndGraphics:function(){var e=!1;for(var i in this._graphics)e=e||this._graphics[i].isDraped(),this._graphics[i].destroy();this._graphics={},this._graphicsKeys=null;for(var t in this._symbols)this._symbols[t].destroy();this._symbols={},this._graphicsBySymbol={},this._elevationDirtyGraphicsSet={},this._elevationDirtyGraphicsQueue=[],this._updatingGraphicIds={},this._graphicsDrapedIds={},this.hasDraped=!1,e&&this.emit("draped-data-change"),this.view.labelManager.setDirty(),this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null),this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null)},_initLabelingInfo:function(){var e=new t;return this.layer.then(function(){var t=this.layer.labelingInfo;if(t){this._labelClasses=new Array(t.length);for(var a=[],s=0;s<t.length;s++){var r=this._getOrCreateGraphics3DSymbol(t[s].symbol);r.then(function(e,i){this._labelClasses[e]={labelClass:t[e],graphics3DSymbolLayer:i,graphics3DGraphics:[]}}.bind(this,s,r)),a.push(r)}i(a).then(function(){e.resolve()})}else e.resolve()}.bind(this)),e.promise},_createLabelsForGraphic:function(e,i,t){if(this._labelClasses&&this._labelClasses.length>0)for(var a=0;a<this._labelClasses.length;a++){var s=this._labelClasses[a];if(n.evaluateWhere(s.labelClass.where,e.attributes)){var r=s.labelClass.getLabelExpression();if(r){var l=n.buildLabelText(r,e.attributes,this.layer.fields);if(l){var h=s.graphics3DSymbolLayer.childGraphics3DSymbols[0],o=this._evalLabelPlacementParams(e,i,t);null==this.textTextureAtlas&&(this.textTextureAtlas=new H(this.layer.id,this._stage),this.hudMaterialCollection=new U(this._stage));var c=h.createGraphics3DGraphic(e,{text:l,centerOffset:o.centerOffset,translation:o.translation,screenOffset:o.screenOffset,anchor:o.anchor},this.hudMaterialCollection,this.textTextureAtlas);c&&(c._labelClass=s.labelClass,i.addLabelGraphic(c),s.graphics3DGraphics.push(i),c.setVisibilityFlag(z,this.layerLabelsEnabled()),this.view.labelManager.setInitialLabelGraphicState(c));break}}}}return i},_evalLabelPlacementParams:function(e,i){var t=this.layer.labelingInfo[0],a=$[t.labelPlacement]||$["default"];if("polygon"===e.geometry.type)return{anchor:"center"};if("polyline"===e.geometry.type)return{anchor:"center"};if("extent"===e.geometry.type)return{anchor:"center"};if("point"!==e.geometry.type)return{anchor:a.anchor};var s,r=i.graphics3DSymbolLayer.symbol.symbolLayers[0],n={screenOffset:[0,0],centerOffset:[0,0,0,-1],translation:i.getCenterObjectSpace(),anchor:a.anchor};if("Icon"===r.type)if(s=i._graphics[0].getScreenSize(),i.isDraped())n.anchor="center";else{var l=i._graphics[0].stageObject.getGeometryRecords()[0].materials[0];if(l instanceof V){var h=l.getParams();n.screenOffset=[s[0]/2*(a.normalizedOffset[0]-2*(h.anchorPos[0]-.5)),s[1]/2*(a.normalizedOffset[1]-2*(h.anchorPos[1]-.5))]}else n.screenOffset=[s[0]/2*a.normalizedOffset[0],s[1]/2*a.normalizedOffset[1]]}else if("Object"===r.type){var o=i._graphics[0].getBoundingBoxObjectSpace();s=[o[3]-o[0],o[4]-o[1],o[5]-o[2]];var c=1.1,d=Math.max(s[0],s[1]);n.centerOffset[0]=d*c/2*a.normalizedOffset[0],n.translation[2]+=s[2]*c/2*a.normalizedOffset[1];var p=X.length(s);n.centerOffset[2]=p*c/2*a.normalizedOffset[2]}return n},_recreateAllGraphics:function(){this._clearSymbolsAndGraphics(),this.computedExtent=null,this._updateSuspendResumeExtent(),this._graphicsCollection&&this.view.basemapTerrain.tilingScheme&&this.add(this._graphicsCollection.toArray())},_rendererChange:function(e){this._symbolCreationContext.renderer=e,this._recreateAllGraphics()},_opacityChange:function(){var e=!1;for(var i in this._graphicsBySymbol){var t=this._symbols[i],a=this._graphicsBySymbol[i];if(t.layerPropertyChanged("opacity"),!e)for(var s in a)if(a[s].isDraped()){this.emit("draped-data-change"),e=!0;break}}},layerLabelsEnabled:function(){return this.layer.get("labelsVisible")},_showLabelsChange:function(){if(this.get("suspended"))return void(this._showLabelsChangeOnResume=!0);if(this._graphicsCollection){var e=this.layerLabelsEnabled();this._graphicsCollection.forEach(function(i){var t=this._graphics[i.id];if(t){if(e&&0===t._labelGraphics.length){var a=this.getRenderingInfo(i);t=this._createLabelsForGraphic(i,t,a);for(var s=0;s<t._labelGraphics.length;s++){var r=t._labelGraphics[s];r.initialize(this._labelStageLayer,this._stage)}}for(s=0;s<t._labelGraphics.length;s++)r=t._labelGraphics[s],r.setVisibilityFlag(z,e)}}.bind(this)),this.view.labelManager.setDirty(),this._showLabelsChangeOnResume=!1}},_elevationInfoChange:function(){this._labelClasses&&this._labelClasses.forEach(function(e){e.graphics3DSymbolLayer.layerPropertyChanged("elevationInfo",{})});for(var e in this._graphicsBySymbol){var i=this._symbols[e],t=this._graphicsBySymbol[e];if(i.layerPropertyChanged("elevationInfo",t))for(var a in t)for(var s=t[a],r=s.graphic,n=s._labelGraphics,l=0;l<n.length;l++){var h=n[l];h.graphics3DSymbolLayer.updateGraphicElevationInfo(r,h)}else this._recreateSymbol(e)}},_scaleUpdateHandler:function(e){if(!this.suspended&&this._spatialIndexNumGraphics>0){var i=e.extent,t=e.scale;this._spatialIndexNumPendingQueries++,this._spatialIndex.intersects(i,void 0,void 0,!0).then(function(e){this._spatialIndexNumPendingQueries--;for(var a=this._visibleAtScale(t),s=!1,r=e.results.length,n=0;r>n;n++){var l=e.results[n],h=this._graphics[l];if(h){var o=h.centroid;if(o&&(i[0]>o.x||i[1]>o.y||i[2]<o.x||i[3]<o.y))continue;for(var c=h.setVisibilityFlag(P,a),d=0;d<h._labelGraphics.length;d++){var p=h._labelGraphics[d];if(p._labelClass&&null!=p._labelClass.minScale&&null!=p._labelClass.maxScale){var u=this._visibleAtScaleLabel(t,p._labelClass);c=c||p.setVisibilityFlag(N,u)}}c&&this.view.labelManager.setDirty(),c&&h.isDraped()&&(s=!0)}}s&&this.emit("draped-data-change")}.bind(this))}this._scaleVisibilityDirty=!0},_visibleAtScaleLabel:function(e,i){return e>i.maxScale&&(!i.minScale||e<i.minScale)},_visibleAtScale:function(e){var i=this.layer.get("minScale"),t=this.layer.get("maxScale");return e>t&&(!i||i>e)},_graphicVisibleAtScale:function(e,i){var t;if(i.centroid?t=i.centroid:"point"===e.geometry.type&&(t=e.geometry),t){var a=this.view.basemapTerrain,s=a?this.view.basemapTerrain.getScale(t):1;return this._visibleAtScale(s)}return!0},_scaleRangeEnabled:function(){var e=this.layer.get("minScale");return null!==e&&e>0&&8e7>e||this.layer.get("maxScale")>1e3},_layerMinMaxScaleChangeHandler:function(){var e=this.view.basemapTerrain;if(e){var i=this._scaleRangeEnabled();i&&!this._scaleChangeEventHandle?(this._scaleChangeEventHandle=this.view.basemapTerrain.on("scale-change",this._scaleUpdateHandler.bind(this)),this.suspended||this._addGraphicsToSpatialIndex()):!i&&this._scaleChangeEventHandle&&(this._scaleChangeEventHandle.remove(),this._scaleChangeEventHandle=null),this.suspended||this._updateGraphicsVisibility(),this._scaleVisibilityDirty=!0}},_graphicUpdateHandler:function(e){var i=this._graphics[e.graphic.id];if(i)switch(e.property){case"visible":var t=i.setVisibilityFlag(F,e.newValue);t&&(i.isDraped()&&this.emit("draped-data-change"),this.view.labelManager.setDirty())}},_updateGraphicsVisibility:function(){if(null!=this._graphicsCollection){var e=!1;this._graphicsCollection.forEach(function(i){var t=this._graphics[i.id];if(t){var a=this._graphicVisibleAtScale(i,t),s=t.setVisibilityFlag(P,a);s&&t.isDraped()&&(e=!0)}}.bind(this)),e&&this.emit("draped-data-change"),this.view.labelManager.setDirty()}},_hideAllGraphics:function(){if(this._graphicsCollection){var e=!1;this._graphicsCollection.forEach(function(i){var t=this._graphics[i.id];if(t){var a=t.setVisibilityFlag(P,!1);a&&t.isDraped()&&(e=!0)}}.bind(this)),e&&this.emit("draped-data-change"),this.view.labelManager.setDirty()}},_updateSuspendResumeExtentEngine:function(){if(this._suspendResumeExtentEngineDirty){this._suspendResumeExtentEngineDirty=!1;var e,i=this._suspendResumeExtent,t=this._suspendResumeExtentEngine,a=this.view.renderCoordsHelper.worldUpAtPosition;if(X.set3(i[0],i[1],Q,t.extent[0].origin),X.set3(i[2],i[1],Q,t.extent[1].origin),X.set3(i[2],i[3],Q,t.extent[2].origin),X.set3(i[0],i[3],Q,t.extent[3].origin),!this._renderSREqualsViewSR){var s=this._viewSR,r=this.view.renderSpatialReference;for(e=0;4>e;e++)E.vectorToVector(t.extent[e].origin,s,t.extent[e].origin,r)}for(X.add(t.extent[0].origin,t.extent[2].origin,t.center.origin),X.scale(t.center.origin,.5),a(t.center.origin,t.center.direction),e=0;4>e;e++){var n=t.extent[e];a(n.origin,n.direction);var l=t.extent[3==e?0:e+1];n.cap.next=l.origin,X.direction(l.origin,n.origin,n.cap.direction),X.cross(t.extent[e].cap.direction,t.extent[e].direction,t.planes[e]),t.planes[e][3]=-X.dot(t.planes[e],t.extent[e].origin)}t.maxSpan=Math.max(Math.abs(i[0]-i[2]),Math.abs(i[1]-i[3]))}},_isVisibleInFrustumGlobal:function(){var e=this._suspendResumeExtentEngine,i=this.view.getFrustum();if(X.dot(e.center.direction,i.direction)<0)return!0;for(var t=0;4>t;t++){var a=e.extent[t];if(X.dot(a.direction,i.direction)<0)return!0}return!1},_isVisibleInFrustum:function(){var e=this.view.getFrustum();if(this._updateSuspendResumeExtentEngine(),this._viewIsSpherical){if(this._suspendResumeExtentEngine.maxSpan>q)return!0;if(e.altitude()>=W)return this._isVisibleInFrustumGlobal()}for(var i=0;i<this._suspendResumeExtentEngine.extent.length;i++){var t=this._suspendResumeExtentEngine.extent[i];if(D.frustumRay(e.planes,t.origin,null,t.direction))return!0;if(D.frustumLineSegment(e.planes,t.origin,t.cap.next,t.cap.direction))return!0}for(i=0;i<e.lines.length;i++){var a=e.lines[i];if(D.frustumLineSegment(this._suspendResumeExtentEngine.planes,a.origin,a.endpoint,a.direction))return!0}return!1},_updateSuspendFrustumVisible:function(){if(this._suspendResumeExtent){var e=this._isVisibleInFrustum();e!==this._frustumVisibility&&(this._frustumVisibility=e,this.notifyChange("suspended"))}},_updateSuspendScaleVisibleFinish:function(e){this._scaleVisibilityQuery=!1,this._scaleVisibility!==e&&(this._scaleVisibility=e,this.notifyChange("suspended"))},_updateSuspendScaleVisible:function(){var e=this.view.basemapTerrain;this._suspendResumeExtent&&e&&this._scaleRangeEnabled()?this._scaleVisibilityQuery||(this._scaleVisibilityQuery=!0,e.queryVisibleScaleRange(this._suspendResumeExtent,this.layer.minScale,this.layer.maxScale,this._updateSuspendScaleVisibleFinish)):this._updateSuspendScaleVisibleFinish(!0)},canResume:function(){return this.inherited(arguments)&&this._frustumVisibility&&this._scaleVisibility?!0:!1},_elevationUpdateHandler:function(e){var i=e.extent;if(this.suspended){if(!this.updateElevation){var t=this.computedExtent;t&&i[2]>t.xmin&&i[0]<t.xmax&&i[3]>t.ymin&&i[1]<t.ymax&&(this.updateElevation=!0)}}else i[0]===-1/0?this._markAllGraphicsElevationDirty():this._spatialIndexNumGraphics>0&&(this._spatialIndexNumPendingQueries++,this._spatialIndex.intersects(i,void 0,void 0,!0).then(function(e){this._spatialIndexNumPendingQueries--;for(var i=e.results,t=i.length,a=0;t>a;a++){var s=i[a],r=this._graphics[s];r&&r.mustAlignToTerrain()&&this._markGraphicElevationDirty(s)}this._evaluateUpdatingState()}.bind(this)))},_markGraphicElevationDirty:function(e){this._elevationDirtyGraphicsSet[e]||(this._elevationDirtyGraphicsSet[e]=!0,this._elevationDirtyGraphicsQueue.push(e))},_markAllGraphicsElevationDirty:function(){for(var e in this._graphics)this._markGraphicElevationDirty(e);this._evaluateUpdatingState()},_evaluateUpdatingState:function(){var e=this._elevationDirtyGraphicsQueue.length+Object.keys(this._updatingGraphicIds).length;this._progressMaxNumNodes=Math.max(e,this._progressMaxNumNodes),0===e&&(this._progressMaxNumNodes=1),this.updatingPercentage=this._graphicsControllerLoading||this._overlayUpdating?100:100*e/this._progressMaxNumNodes,this.updating=e>0||this._spatialIndexNumPendingQueries>0||this._graphicsControllerLoading||this._overlayUpdating},_beginGraphicUpdate:function(e){this._updatingGraphicIds[e.id]=!0,this.get("symbols-updating")||this.set("symbols-updating",!0),this._evaluateUpdatingState()},_endGraphicUpdate:function(e){e&&delete this._updatingGraphicIds[e.id],this.get("symbols-updating")&&R.objectEmpty(this._updatingGraphicIds)&&(this.view.flushDisplayModifications(),this.set("symbols-updating",!1)),this._evaluateUpdatingState()},_expandComputedExtent:function(e){var i,t,a,s,r,n;if("point"===e.type)i=t=e.x,a=s=e.y,e.z&&(r=n=e.z);else{var l=e.extent;if(!l)return;i=l.xmin,t=l.xmax,a=l.ymin,s=l.ymax,r=l.zmin,n=l.zmax}var h=this._viewSR;if(!e.spatialReference.equals(h))if(E.xyzToVector(i,a,0,e.spatialReference,J,h))i=J[0],a=J[1],E.xyzToVector(t,s,0,e.spatialReference,J,h),t=J[0],s=J[1];else if(Y)throw new Error("Geometry has incompatible spatial reference");if(!(isNaN(i)||isNaN(t)||isNaN(a)||isNaN(s)||isNaN(r)||isNaN(n))){var o=this.computedExtent;o?(o.xmin=Math.min(i,o.xmin),o.xmax=Math.max(t,o.xmax),o.ymin=Math.min(a,o.ymin),o.ymax=Math.max(s,o.ymax)):(o=new g(i,a,t,s,e.spatialReference),this.computedExtent=o),null!=r&&null!=n&&(o.zmin=null!=o.zmin?Math.min(r,o.zmin):r,o.zmax=null!=o.zmax?Math.max(n,o.zmax):n),this._updateSuspendResumeExtent()}},_updateSuspendResumeExtent:function(){if(this.computedExtent){this._suspendResumeExtent||(this._suspendResumeExtent=K.create());var e=this.computedExtent,i=this._suspendResumeExtent,t=.5*e.width*(k-1),a=.5*e.height*(k-1);e.width<1e-7*e.height?t+=a/20:e.height<1e-7*e.width&&(a+=t/20),K.set4(e.xmin-t,e.ymin-a,e.xmax+t,e.ymax+a,i)}else this._suspendResumeExtent=null;this._frustumVisibilityDirty=!0,this._scaleVisibilityDirty=!0,this._suspendResumeExtentEngineDirty=!0},_updateHasDraped:function(){this.hasDraped=!1;for(var e in this._graphicsDrapedIds)if(this._graphicsDrapedIds.hasOwnProperty(e)){this.hasDraped=!0;break}},getStats:function(){function e(e){return e&&e.length||null}function i(e){return e&&e.toArray().length||null}function t(e){return e&&Object.keys(e).length||null}var a=0,s=0,r=0,n=0;for(var l in this._graphics){var h=this._graphics[l];h&&h.areVisibilityFlagsSet(P,null)&&a++,h&&h.areVisibilityFlagsSet(F,null)&&s++,h&&h.areVisibilityFlagsSet(N,null)&&r++,h&&h.areVisibilityFlagsSet(z,null)&&n++}var o=4,c="null";this._suspendResumeExtent&&(c=this._suspendResumeExtent.map(function(e){return e.toPrecision(o)}).join(", "));var d="null";return this.computedExtent&&(d=[this.computedExtent.xmin,this.computedExtent.ymin,this.computedExtent.xmax,this.computedExtent.ymax].map(function(e){return e.toPrecision(o)}).join(", ")),{numCollection:i(this._graphicsCollection),numGraphics:t(this._graphics),numDraped:t(this._graphicsDrapedIds),numUpdatingGraphics:t(this._updatingGraphicIds),numVisibleScale:a,numVisibleGraphic:s,numVisibleLabelScale:r,numVisibleShowLabels:n,numElevationDirty:e(this._elevationDirtyGraphicsQueue),visibilityFrustum:this._frustumVisibility,resumeExtent:c,computedExtent:d,suspended:this.suspended}}}),$={"above-center":{normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{normalizedOffset:[0,0,1],anchor:"center"},"center-left":{normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{normalizedOffset:[1,0,0],anchor:"left"}},ei={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};
for(var ii in ei){var ti=ei[ii],ai=$[ii];ti.forEach(function(e){$[e]=ai})}return Object.freeze&&(Object.freeze($),Object.keys($).forEach(function(e){Object.freeze($[e]),Object.freeze($[e].normalizedOffset)})),Z});