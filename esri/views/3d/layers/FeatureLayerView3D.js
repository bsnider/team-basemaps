// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessoireSupport/typescript","dojo/promise/all","./graphics/Graphics3DSpatialIndex","./graphics/Graphics3DLayerViewCore","./graphics/graphicUtils","./support/LayerViewUpdatingPercentage","../../layers/GraphicsLayerView","../../../layers/FeatureLayer","../../../layers/graphics/controllers/SnapshotController","../support/PromiseLightweight","../../../core/watchUtils","./support/projectExtentUtils","../../../core/Error","../../../core/promiseUtils","../../../layers/graphics/QueryEngine"],function(e,t,r,i,n,s,a,o,l,u,p,h,c,d,y,g,m,f,w){function C(){return p}var x=300,v=1.2,_=function(e){function t(){e.call(this)}return r(t,e),t.prototype.dojoConstructor=function(){this.controller=null,this.supportsDraping=!0,this._overlayUpdating=null,this._progressMaxNumNodes=0,this._eventHandles=[],this._controllerClientSideFiltering=!1,this._suspendResumeExtent=null,this.fullExtentInViewSpatialReference=null,this._destroyed=!1},t.prototype.initialize=function(){var e=this;this.spatialIndex=new a,this.layerViewCore=new o({owner:this,layer:this.layer,spatialIndex:this.spatialIndex,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,labelingEnabled:this.layer.isInstanceOf(h),elevationAlignmentEnabled:!0,verticalScaleEnabled:!0,updateSuspendResumeExtent:function(){return e.updateSuspendResumeExtent()},updateClippingExtent:function(t){return e.updateClippingExtent(t)}}),this.layerViewCore.initialize(),this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this.createController(),this.layerViewCore.labeling&&this.addResolvingPromise(this.layerViewCore.labeling.initLabelingInfo());var t=g.toView(this).then(function(t){e.fullExtentInViewSpatialReference=t});t&&this.addResolvingPromise(t),this._evaluateUpdatingState()},t.prototype.destroy=function(){this._destroyed=!0,this._eventHandles.forEach(function(e){return e.remove()}),this._eventHandles=null,this.controller&&(this.controller.destroy(),this.controller=null),this.layerViewCore&&(this.layerViewCore.destroy(),this.layerViewCore=null),this.spatialIndex&&(this.spatialIndex.destroy(),this.spatialIndex=null),this.loadedGraphics=null},t.prototype.getRenderingInfo=function(){var e=this.inherited(arguments);if(e&&e.color){var t=e.color;e.color=[t.r/255,t.g/255,t.b/255,t.a]}return e},t.prototype.getGraphicsFromStageObject=function(e){var t=e.getMetadata().graphicId,r=null;this.loadedGraphics&&this.loadedGraphics.some(function(e){return e.id===t?(r=e,!0):!1});var i=new d.Promise;return null!==r?i.done(r):i.reject(),i},t.prototype.getGraphics3DGraphics=function(){return this.layerViewCore.graphicsCore.getGraphics3DGraphics()},t.prototype.getGraphics3DGraphicsKeys=function(){return this.layerViewCore.graphicsCore.getGraphics3DGraphicsKeys()},t.prototype.queryGraphics=function(){return this._queryEngine?this._queryEngine.queryFeatures():this._rejectQuery()},t.prototype.queryFeatures=function(e){return this._queryEngine?this._queryEngine.queryFeatures(e):this._rejectQuery()},t.prototype.queryObjectIds=function(e){return this._queryEngine?this._queryEngine.queryObjectIds(e):this._rejectQuery()},t.prototype.queryFeatureCount=function(e){return this._queryEngine?this._queryEngine.queryFeatureCount(e):this._rejectQuery()},t.prototype.queryExtent=function(e){return this._queryEngine?this._queryEngine.queryExtent(e):this._rejectQuery()},t.prototype.whenGraphicBounds=function(e){return this.layerViewCore.graphicsCore.whenGraphicBounds(e)},t.prototype._rejectQuery=function(){return f.reject(new m("FeatureLayerView3D","Not ready to execute query"))},t.prototype._notifySuspendedChange=function(){this.notifyChange("suspended")},t.prototype._notifyDrapedDataChange=function(){this.emit("draped-data-change")},t.prototype.canResume=function(){return this.inherited(arguments)&&this.layerViewCore&&this.layerViewCore.canResume()},t.prototype._evaluateUpdatingState=function(){if(this.layerViewCore.elevationAlignment){var e=0;e+=this.layerViewCore.elevationAlignment.numNodesUpdating(),e+=this.layerViewCore.graphicsCore.numNodesUpdating();var t=!1;t=t||this.controller&&this.controller.isQueryInProgress,t=t||this._overlayUpdating,t=t||!(this.view.basemapTerrain&&this.view.basemapTerrain.ready);var r=!1;r=r||e>0,r=r||t,r=r||this.spatialIndex.isUpdating(),this._progressMaxNumNodes=Math.max(e,this._progressMaxNumNodes),0===e&&(this._progressMaxNumNodes=1),this.updatingPercentage=t?100:100*e/this._progressMaxNumNodes,this.updating=r}else this.updating=!1,this.updatingPercentage=100},t.prototype.createController=function(){var e=this,t=this.layer.createGraphicsController({layerView:this,options:{maxPageSize:x,extent:this.view.clippingArea}});y.whenTrueOnce(this.view,"basemapTerrain.ready",function(){s([e,t]).then(function(t){var r=t[1];r instanceof c&&(e.controller=r,e._eventHandles.push(e.controller.watch("isQueryInProgress",function(){return e._evaluateUpdatingState()}))),e.loadedGraphics=r.graphics,e._queryEngine=new w({features:e.loadedGraphics,objectIdField:e.layer.objectIdField}),e._evaluateUpdatingState()})})},t.prototype.updateClippingExtent=function(e){return this.controller?this._controllerClientSideFiltering?!1:this.controller.extent?(this.controller.extent=null,this._controllerClientSideFiltering=!0,!0):(this.controller.extent=e,!0):!1},t.prototype.updateSuspendResumeExtent=function(){var e=this.layerViewCore.graphicsCore.computedExtent;return this._suspendResumeExtent=l.enlargeExtent(e,this._suspendResumeExtent,v),this._suspendResumeExtent},t.prototype.getStats=function(){var e=this.layerViewCore.graphicsCore.getGraphics3DGraphics(),t=4,r="null",i=this._suspendResumeExtent;i&&(r=[i[0],i[1],i[2],i[3]].map(function(e){return e.toPrecision(t)}).join(", "));var n="null",s=this.layerViewCore.graphicsCore.computedExtent;return s&&(n=[s.xmin,s.ymin,s.xmax,s.ymax].map(function(e){return e.toPrecision(t)}).join(", ")),{numCollection:this.loadedGraphics.length,numGraphics:Object.keys(e).length,numElevationUpdating:this.layerViewCore.elevationAlignment.numNodesUpdating(),numSpatialIndexUpdating:this.spatialIndex.numNodesUpdating(),numGraphicsUpdating:this.layerViewCore.graphicsCore.numNodesUpdating(),visibilityFrustum:this.layerViewCore.frustumVisibility.canResume(),visibilityScale:this.layerViewCore.scaleVisibility.canResume(),resumeExtent:r,computedExtent:n,updating:this.updating,suspended:this.suspended}},i([n.shared("esri.views.3d.layers.FeatureLayerView3D")],t.prototype,"declaredClass",void 0),i([n.property({setter:function(e){return this.layerViewCore.graphicsCore.setDrawingOrder(e),e}})],t.prototype,"drawingOrder",void 0),i([n.property()],t.prototype,"loadedGraphics",void 0),t=i([n.subclass([u])],t)}(C());return _});