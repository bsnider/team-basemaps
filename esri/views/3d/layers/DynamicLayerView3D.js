// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../../core/declare","../../layers/LayerView","../../../geometry/Extent","../../../core/urlUtils","./support/projectExtentUtils","../lib/glMatrix","../webgl-engine/Stage","../webgl-engine/lib/Texture","../webgl-engine/lib/RenderGeometry","../webgl-engine/lib/GeometryData","../webgl-engine/lib/GeometryUtil","../webgl-engine/materials/Material","../webgl-engine/lib/Util"],function(e,t,r,i,a,n,s,o,l,d,h,g,m){var c=m.assert,u=n.mat4d,y=m.VertexAttrConstants,f=function(e){e.remove()},v=e(t,{declaredClass:"esri.views.3d.layers.DynamicLayerView3D",supportsDraping:!0,hasDraped:!0,drawingOrder:0,_updatingOverlay:!1,constructor:function(){this._extents=[],this._images=[],this.fullExtentInViewSpatialReference=null},initialize:function(){this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this.on("suspend",function(){this.clear(),this.emit("draped-data-change")}.bind(this)),this.on("resume",function(){for(var e=this._extents.length,t=0;e>t;t++)this.fetch(t)}.bind(this));var e=this.notifyChange.bind(this,"suspended");this._layerPropertyWatches=[this.layer.watch("opacity",this._opacityChangeHandler.bind(this)),this.layer.watch("exportImageParameters.version",this._refetch.bind(this)),this.layer.watch("minScale",e),this.layer.watch("maxScale",e)],this.view.resourceController.registerIdleFrameWorker(this,{idleBegin:function(){this._hasScaleRange()&&this.notifyChange("suspended")}});var t=a.toView(this).then(function(e){this.fullExtentInViewSpatialReference=e}.bind(this));t&&this.addResolvingPromise(t)},destroy:function(){this.clear(),this._layerPropertyWatches.forEach(f),this._layerPropertyWatches.length=0,this.view.resourceController.deregisterIdleFrameWorker(this)},setDrapingExtent:function(e,t,r,i){var a,n=(t[2]-t[0])/(t[3]-t[1]);a=n>1.0001?[i,i/n]:.9999>n?[i*n,i]:[i,i],this._extents[e]={extent:t,spatialReference:r,imageSize:a},this.suspended||this.fetch(e)},fetch:function(e){var t=this._extents[e],a=t.extent,n=new r(a[0],a[1],a[2],a[3],t.spatialReference);this.layer.getImageUrl({extent:n,width:t.imageSize[0],height:t.imageSize[1]},function(t){this._images[e]||(this._images[e]={texture:null,material:null,rendergeometry:null,domImage:null,worldExtent:a,loading:!1});var r=this._images[e],n=r.domImage||new Image;0!==t.indexOf("data:")&&i.canUseXhr(t)&&(n.crossOrigin="anonymous"),n.src=t,r.loading=!0,n.onload=function(){c(r.domImage===n),r.worldExtent=a,this._createStageObjects(e,n),0===e&&this._images[1]&&this._images[1].rendergeometry&&this._createStageObjects(1,null),r.loading=!1,this._evaluateUpdatingState(),this.emit("draped-data-change")}.bind(this),n.onerror=function(){r.loading=!1,this._clearDomImage(r),this._evaluateUpdatingState()}.bind(this),r.domImage=n,this._evaluateUpdatingState()}.bind(this))},clear:function(){for(var e in this._images)this.clearImage(e)},clearImage:function(e){var t=this._images[e];t&&(t.htmlImage&&(t.htmlImage.removeAttribute("src"),t.htmlImage.removeAttribute("onload"),t.htmlImage.removeAttribute("onerror"),t.htmlImage=null),t.rendergeometry&&(this.view._stage.getTextureGraphicsRenderer().removeRenderGeometries([t.rendergeometry]),t.rendergeometry=null),t.texture&&(this.view._stage.remove(s.ModelContentType.TEXTURE,t.texture.getId()),t.texture=null),t.material&&(this.view._stage.remove(s.ModelContentType.MATERIAL,t.material.getId()),t.material=null),this._clearDomImage(t),t.loading=!1)},canResume:function(){if(!this.inherited(arguments))return!1;var e=this.layer.minScale,t=this.layer.maxScale;if(e>0||t>0){var r=this.view.scale;if(t>r||e>0&&r>e)return!1}return!0},_refetch:function(){for(var e=0;e<this._extents.length;e++)this._extents[e]&&this.fetch(e)},_drawingOrderSetter:function(e,t){if(e!==t){var r={};this._images.forEach(function(t){t&&t.material&&(t.material.setRenderPriority(e),r[t.material.getId()]=!0)}),m.objectEmpty(r)||(this.view._stage.getTextureGraphicsRenderer().updateRenderOrder(r),this.emit("draped-data-change"))}return e},_hasScaleRange:function(){return this.get("layer.minScale")>0||this.get("layer.maxScale")>0},_opacityChangeHandler:function(e){this._images.forEach(function(t){t&&t.material&&t.material.setParameterValues({opacity:e})}.bind(this)),this.emit("draped-data-change")},_clearDomImage:function(e){e.domImage&&(e.domImage.removeAttribute("src"),e.domImage.removeAttribute("onload"),e.domImage.removeAttribute("onerror"),e.domImage=null)},_evaluateUpdatingState:function(){if(this._updatingOverlay)return void this.set("updating",!0);var e=!1;for(var t in this._images){var r=this._images[t];if(r.loading){e=!0;break}}this.set("updating",e)},_createStageObjects:function(e,t){var r=this.view._stage,i=r.getTextureGraphicsRenderer(),a=this._images[e];t?(a.texture&&r.remove(s.ModelContentType.TEXTURE,a.texture.getId()),a.texture=new o(t,"dynamicMapLayer",{width:t.width,height:t.height}),r.add(s.ModelContentType.TEXTURE,a.texture)):c(a.texture),a.material?t&&a.material.setParameterValues({textureId:a.texture.getId()}):(a.material=new g({ambient:[1,1,1],diffuse:[0,0,0],transparent:!0,opacity:this.layer.get("opacity"),textureId:a.texture.getId()},"dynamicMapLayer"),a.material.setRenderPriority(this.drawingOrder),r.add(s.ModelContentType.MATERIAL,a.material));var n,d=-1;if(0===e){var m=a.worldExtent,y=[[m[0],m[1],d],[m[2],m[1],d],[m[2],m[3],d],[m[0],m[3],d]];n=h.createSquareGeometry(y,!0)}else{c(1===e);var f=this._images[0].worldExtent;if(!f)return;n=p(f,a.worldExtent,d)}var v=new l(n);v.material=a.material,v.origin={vec3:[0,0,0],id:"0_0"},v.transformation=u.identity(),v.name="dynamicMapLayer",v.uniqueName="dynamicMapLayer#"+n.id,i.addRenderGeometries([v]),a.rendergeometry&&i.removeRenderGeometries([a.rendergeometry]),a.rendergeometry=v}}),p=function(){var e=new Float32Array([0,0,1]);return function(t,r,i){for(var a=[t[1]-r[1],t[3]-t[1],r[3]-t[3],123456],n=[t[0]-r[0],t[2]-t[0],r[2]-t[2],123456],s=r[2]-r[0],o=r[3]-r[1],l=n[0]>0&&n[2]>0?3:2,h=a[0]>0&&a[2]>0?3:2,g=(h+1)*(l+1),m=new Float32Array(3*g),c=new Float32Array(2*g),u=new Uint32Array(6*(h*l-1)),f=0,v=0,p=0,w=0,_=0,x=0;4>x;x++){var I=a[x];if(!(0>=I)){for(var b=0,S=0;4>S;S++){var R=n[S];0>=R||(m[v++]=r[0]+b,m[v++]=r[1]+f,m[v++]=i,c[p++]=b/s,c[p++]=f/o,3>S&&3>x&&(1!==S||1!==x)&&(u[_++]=w,u[_++]=w+1,u[_++]=w+l+1,u[_++]=w+1,u[_++]=w+l+2,u[_++]=w+l+1),w++,b+=R)}f+=I}}var E={};E[y.POSITION]={size:3,data:m},E[y.NORMAL]={size:3,data:e},E[y.UV0]={size:2,data:c};for(var O={},T=new Uint32Array(u.length),A=0;A<T.length;A++)T[A]=0;return O[y.POSITION]=u,O[y.NORMAL]=T,O[y.UV0]=u,{faces:{type:"triangle",indices:O,positionKey:y.POSITION},vertexAttr:E,id:d.getNewId().toString()}}}();return v});