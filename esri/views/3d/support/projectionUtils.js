// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../../geometry/SpatialReference","../../../geometry/Point","./mathUtils","./earthUtils","../lib/glMatrix","../webgl-engine/lib/BufferVectorMath"],function(e,n,t,r,a,i){var u=a.vec3d,l=a.mat4d,f=i.Vec3Compact,o=u.create(),c=u.create(),s=u.create(),m=t.deg2rad(1),x=t.rad2deg(1),h=new e({wkt:'      GEOCCS["Spherical geocentric",        DATUM["Not specified",          SPHEROID["Sphere",'+r.earthRadius+',0]],        PRIMEM["Greenwich",0.0,          AUTHORITY["EPSG","8901"]],        UNIT["m",1.0],        AXIS["Geocentric X",OTHER],        AXIS["Geocentric Y",EAST],        AXIS["Geocentric Z",NORTH]      ]    '}),M={SphericalRenderSpatialReference:h,vectorToVector:function(e,n,t,r){return 2===e.length?(o[0]=e[0],o[1]=e[1],o[2]=0,e=o):e===t&&(u.set(e,o),e=o),this.bufferToBuffer(e,n,0,t,r,0,1)},pointToVector:function(e,n,t){return o[0]=e.x,o[1]=e.y,o[2]=e.z||0,this.bufferToBuffer(o,e.spatialReference,0,n,t,0,1)},vectorToPoint:function(e,t,r,a){var i;return"esri.SpatialReference"===r.declaredClass?(a=r,i=new n({spatialReference:a})):(i=r,a=a||i.spatialReference),this.bufferToBuffer(e,t,0,o,a,0,1)?(i.x=o[0],i.y=o[1],i.z=o[2],i.spatialReference=a,i):null},xyzToVector:function(e,n,t,r,a,i){return o[0]=e,o[1]=n,o[2]=t,this.bufferToBuffer(o,r,0,a,i,0,1)},bufferToBuffer:function(e,n,t,r,a,i,u){u=u||1;var l,f,o=v(n),s=v(a),m=t+3*u;if(o!==s||o===R.UNKNOWN&&!n.equals(a)){if(!(o>R.UNKNOWN&&s>R.UNKNOWN))return!1;var x;if(s!==R.WGS84){var h=p[s];if(o!==R.WGS84)for(x=G[o],l=t,f=i;m>l;l+=3,f+=3)x(e,l,c,0,n.wkid),h(c,0,r,f);else for(l=t,f=i;m>l;l+=3,f+=3)h(e,l,r,f)}else for(x=G[o],l=t,f=i;m>l;l+=3,f+=3)x(e,l,r,f,n.wkid)}else if(r!==e||t!==i)for(l=t,f=i;m>l;l++,f++)r[f]=e[l];return!0},convertExtent:function(e,n){if(null==e)return null;var t=[0,0,0],r=[0,0,0],a=this.xyzToVector(e.xmin,e.ymin,e.zmin||0,e.spatialReference,t,n);return a=a&&this.xyzToVector(e.xmax,e.ymax,e.zmax||0,e.spatialReference,r,n),a?[t,r]:null},computeLinearTransformation:function(e,n,t,r){var a=v(e),i=v(r);if(a===i&&(a!==R.UNKNOWN||e.equals(r)))return l.identity(t),l.translate(t,n),!0;if(i===R.ENGINE_SPHR){var u=G[a];if(u){u(n,0,c,0,e.wkid),d(c,0,s,0);var f=m*c[0],o=m*c[1],x=Math.sin(f),h=Math.cos(f),M=Math.sin(o),N=Math.cos(o),E=t;return E[0]=-x,E[4]=-M*h,E[8]=N*h,E[12]=s[0],E[1]=h,E[5]=-M*x,E[9]=N*x,E[13]=s[1],E[2]=0,E[6]=N,E[10]=M,E[14]=s[2],E[3]=0,E[7]=0,E[11]=0,E[15]=1,!0}}else if(i===R.WEBMERC&&(a===R.WGS84||a===R.ENGINE_SPHR)){G[a](n,0,c,0,e.wkid);var S=m*c[1];T(c,0,s,0),l.identity(t),l.translate(t,s);var y=1/Math.cos(S);return l.scale(t,[y,y,1]),!0}return!1},mbsToMbs:function(e,n,t,r){var a=v(n),i=v(r);if(a===i&&(a!==R.UNKNOWN||n.equals(r)))return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],!0;if(i===R.ENGINE_SPHR){var u=G[a];if(u)return u(e,0,c,0,n.wkid),d(c,0,t,0),t[3]=e[3],!0}else if(i===R.WEBMERC&&(a===R.WGS84||a===R.ENGINE_SPHR)){G[a](e,0,c,0,n.wkid);var l=m*c[1];if(l=Math.abs(l)+Math.asin(e[3]/(N+e[2])),T(c,0,t,0),l>.9999*Math.PI)t[3]=Number.MAX_VALUE;else{var f=1/Math.cos(l);t[3]=f*e[3]}return!0}return!1},extentToBoundingBox:function(e,n,t){if(null==e)return!1;var r=!0;return o[0]=null!=e.xmin?e.xmin:0,o[1]=null!=e.ymin?e.ymin:0,o[2]=null!=e.zmin?e.zmin:0,r=r&&this.bufferToBuffer(o,e.spatialReference,0,n,t,0,1),o[0]=null!=e.xmax?e.xmax:0,o[1]=null!=e.ymax?e.ymax:0,o[2]=null!=e.zmax?e.zmax:0,r=r&&this.bufferToBuffer(o,e.spatialReference,0,n,t,3,1),null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.zmin&&(n[2]=-1/0),null==e.xmax&&(n[3]=1/0),null==e.ymax&&(n[4]=1/0),null==e.zmax&&(n[5]=1/0),r},extentToBoundingRect:function(e,n,t){if(null==e)return!1;var r=!0;return o[0]=null!=e.xmin?e.xmin:0,o[1]=null!=e.ymin?e.ymin:0,o[2]=null!=e.zmin?e.zmin:0,r=r&&this.bufferToBuffer(o,e.spatialReference,0,o,t,0,1),n[0]=o[0],n[1]=o[1],o[0]=null!=e.xmax?e.xmax:0,o[1]=null!=e.ymax?e.ymax:0,o[2]=null!=e.zmax?e.zmax:0,r=r&&this.bufferToBuffer(o,e.spatialReference,0,o,t,0,1),n[2]=o[0],n[3]=o[1],null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.xmax&&(n[2]=1/0),null==e.ymax&&(n[3]=1/0),r},webMercator:{x2lon:function(e){return e/N},y2lat:function(e){return Math.PI/2-2*Math.atan(Math.exp(-1*e/N))},lon2x:function(e){return e*N},lat2y:function(e){var n=Math.sin(e);return N/2*Math.log((1+n)/(1-n))}}},N=r.earthRadius,R={UNKNOWN:0,ENGINE_SPHR:1,WGS84:2,WEBMERC:3},v=function(e){var n;return n=e===h?R.ENGINE_SPHR:e.isWGS84?R.WGS84:e.isWebMercator?R.WEBMERC:R.UNKNOWN},E=function(e,n,t,r){t[r++]=e[n++],t[r++]=e[n++],t[r]=e[n]},S=function(e,n,t,r){t[r++]=x*(e[n++]/N),t[r++]=x*(Math.PI/2-2*Math.atan(Math.exp(-1*e[n++]/N))),t[r]=e[n]},T=function(e,n,r,a){var i=.4999999*Math.PI,u=m*e[n+1];u=t.clamp(u,-i,i);var l=Math.sin(u);r[a++]=m*e[n]*N,r[a++]=N/2*Math.log((1+l)/(1-l)),r[a]=e[n+2]},d=function(e,n,t,r){var a=N+e[n+2],i=m*e[n+1],u=m*e[n],l=Math.cos(i);t[r++]=Math.cos(u)*l*a,t[r++]=Math.sin(u)*l*a,t[r]=Math.sin(i)*a},y=function(e,n,r,a){var i=f.length(e,n),u=t.asin(e[n+2]/i),l=Math.cos(u),o=(e[n+1]>0?1:-1)*t.acos(e[n]/(l*i));r[a++]=x*o,r[a++]=x*u,r[a]=i-N},p=[void 0,d,E,T],G=[void 0,y,E,S];return M});