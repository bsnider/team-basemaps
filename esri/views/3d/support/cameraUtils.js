// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/_base/lang","../../../geometry/SpatialReference","../../../config","../../../geometry/Point","../../../geometry/support/webMercatorUtils","../../../Camera","../lib/glMatrix","./mathUtils","./earthUtils","./projectionUtils","./cameraUtilsPlanar","./cameraUtilsSpherical"],function(e,t,n,r,i,a,o,c,l,u,f,v){function s(e){return e.spatialReference||t.WGS84}function d(e,t){return"global"===e.viewingMode?v[t]:f[t]}function g(e,t){var n=e.renderSpatialReference,r=d(e,"headingTiltToDirectionUp"),i=I.create();if(u.pointToVector(t.position,i,n)){var a=r(i,t.heading,t.tilt);I.add(a.direction,i);var o=e.navigation.getCameraIntersectTerrain(i,a.direction,a.up);return o.fov=c.deg2rad(t.fov),o}return null}function m(e,n,i){var o=e.renderSpatialReference,l=n.computeDirection(G),f=y(e,n.eye,l,n.up,X),v=s(e);return u.vectorToVector(n.eye,o,W,v)||(v=t.WGS84,u.vectorToVector(n.eye,o,W,v)),i?(i.position.x=W[0],i.position.y=W[1],i.position.z=W[2],i.position.spatialReference=v,i.heading=f.heading,i.tilt=f.tilt,i.fov=c.rad2deg(n.fov),i):new a(new r(W,v),f.heading,f.tilt,c.rad2deg(n.fov))}function p(e,t,r){var i=e.navigation.currentCamera,a=i.fovX,o=i.width/2;"global"===e.viewingMode&&null!=r&&(t*=Math.cos(c.deg2rad(r))),t/=e.renderCoordsHelper.unitInMeters;var l=n.screenDPI*U,u=l/t,f=o/u;return f/Math.tan(a/2)}function h(e,t,r){var i=e.navigation.currentCamera,a=i.fovX,o=t*Math.tan(a/2),l=i.width/2,u=l/o,f=n.screenDPI*U,v=f/u;return"global"===e.viewingMode&&(v/=Math.cos(c.deg2rad(r))),v*=e.renderCoordsHelper.unitInMeters}function T(e,t,n,r,i,a){var o=p(e,n,t.latitude);return x(e,t,o,r,i,a)}function x(e,t,n,r,i,o){var c=e.renderSpatialReference,l=S(e,r.heading,r.tilt,t,n,i),f=s(e),v=u.vectorToPoint(l.eye,c,f);return v?o?(o.position=v,o.heading=l.heading,o.tilt=l.tilt,o.fov=r.fov,o):new a(v,l.heading,l.tilt,r.fov):null}function M(e,t,n){if(u.pointToVector(t,n,e.renderSpatialReference),null==t.z){var r;if("global"===e.viewingMode)e._pickRay([0,0,0],n);else{var i=[n[0],n[1]-1,n[2]];e._pickRay(i,n)}if(!(r&&r.getMaxResult().getIntersectionPoint(n)&&0!==I.length2(n)||null==e.basemapTerrain)){var a=e.basemapTerrain.getElevation(t);null!=a&&e.renderCoordsHelper.setAltitude(a,n)}}}function y(e,t,n,r,i){return d(e,"directionToHeadingTilt")(t,n,r,i)}function C(e,t){return e.renderCoordsHelper.fromRenderCoords(t,_,e.spatialReference)?e.basemapTerrain&&(e.basemapTerrain.getElevation(_)||0)>_.z-1:!1}function S(t,n,i,a,o,c){var l=I.create(),f=t.renderSpatialReference;if(a&&a instanceof r?M(t,a,l):a?I.set(a,l):I.set(t.navigation.currentCamera.center,l),!(a&&a instanceof r)){var v=s(t);a=u.vectorToPoint(l,f,v)}o=Math.max(o,t.navigation.minPoiDist);var g=z(t,n,i,l,a,o,c),m=d(t,"eyeForCenterWithHeadingTilt"),p=m(l,o,g.heading,g.tilt);if(p.center=l,!(c&&c.noReset||"global"!==t.viewingMode)&&C(t,p.eye,p.tilt)){var h=t.navigation.constraints.tilt.min(o);return S(t,0,h,a,o,e.mixin({noReset:!0},c))}return p}function w(e,n,o,c,f){c instanceof a&&(f=c,c={});var v,d="global"===e.viewingMode,g=e.renderSpatialReference,m=s(e),p=t.WebMercator,h=n.spatialReference||p,T=0;null!=n.zmax&&null!=n.zmin&&(v=(n.zmax+n.zmin)/2,T=n.zmax-n.zmin);var x,M,y;if(d){var C=new r(n.xmin,n.ymin,h),w=new r(n.xmax,n.ymax,h);if(C=i.project(C,p),w=i.project(w,p),null===C||null===w)return;x=new r(F.center(C.x,w.x),(w.y+C.y)/2,p),null!=v&&(x.z=v);var R=l.getGreatCircleSpanAt(x,C,w);M=R.lon,y=R.lat,F.diff(C.x,w.x)>F.range/2&&(M+=l.halfEarthCircumference),M=Math.min(M,l.halfEarthCircumference),y=Math.min(y,l.halfEarthCircumference)}else i.canProject(n,m)&&(n=i.project(n,m)),M=n.xmax-n.xmin,y=n.ymax-n.ymin,x=new r({x:n.xmin+.5*M,y:n.ymin+.5*y,z:v,spatialReference:m});var b=e.navigation.currentCamera,z=1/Math.tan(b.fovX/2),P=1/Math.tan(b.fovY/2),E=1/Math.tan(b.fov/2),D=Math.max(.5*M*z,.5*y*P,.5*T*E)/V,H=S(e,o.heading,o.tilt,x,D,c),A=u.vectorToPoint(H.eye,g,m);return A?(f||(f=new a),f.position=A,f.heading=H.heading,f.tilt=H.tilt,f.fov=e.camera.fov,f):null}function R(e,t,n,r,i){var a,o,c=e.renderSpatialReference;if(t||(n||(n=e.navigation.currentCamera),t=m(e,n,i)),n)o=u.vectorToPoint(n.center,c,s(e)),a=n.distance;else{if(o=e.toMap(e.screenCenter),!o)return null;a=l.computeCarthesianDistance(t.position,o)}n||(n=e.navigation.currentCamera);var d=Math.tan(n.fovX/2),g=Math.tan(n.fovY/2),p=2*a*d*V,h=2*a*g*V;return"global"===e.viewingMode?v.toExtent(e,o,p,h,r):f.toExtent(e,o,p,h,r)}function b(e,t){var n=e.navigation.currentCamera,r=e.engineToScreen(n.center),i=e.toScreen(t),a=r.x-i.x,o=r.y-i.y,c=Math.sqrt(a*a+o*o),l=Math.max(e.width,e.height);return c>j*l}function z(e,t,n,r,i,a,o){if(o&&o.noReset||!b(e,i)){var c=E(e,r,a,n);c=e.navigation.constraints.tilt.apply(c,a),n=P(e,r,a,c)}else t=0,n=e.navigation.constraints.tilt.min(a);return{heading:t,tilt:n}}function P(e,t,n,r){return d(e,"lookAtTiltToEyeTilt")(t,n,r)}function E(e,t,n,r){return d(e,"eyeTiltToLookAtTilt")(t,n,r)}function D(e,t){var n=e.get("basemapTerrain.tilingScheme");return n?n.levelAtScale(t):void 0}function H(e,t){var n=e.get("basemapTerrain.tilingScheme");return n?n.scaleAtLevel(t):void 0}function A(e,n,r){var i=e.renderSpatialReference;n||(n=e.navigation.currentCamera);var a,o,c=t.WGS84;return n.center?(u.vectorToVector(n.center,i,k,c),a=k[1],o=n.distance):(a=n.position.latitude,u.pointToVector(n.position,W,i),u.pointToVector(r,k,i),o=I.dist(W,k)),h(e,o,a)}var I=o.vec3d,U=39.37,V=1,j=5,W=I.create(),k=I.create(),G=I.create(),X={heading:0,tilt:0},_=new r,F=new c.Cyclical(-20037508.342788905,20037508.342788905);return{externalToInternal:g,internalToExternal:m,scaleToDistance:p,distanceToScale:h,fromExtent:w,toExtent:R,fromCenterScale:T,fromCenterDistance:x,directionToHeadingTilt:y,eyeHeadingTiltForCenterPointAtDistance:S,scaleToZoom:D,zoomToScale:H,computeScale:A}});