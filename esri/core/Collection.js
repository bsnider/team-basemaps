// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/has","dojo/on","dojo/aspect","./ArrayPool","./ObjectPool","./Accessor","./Evented","./Scheduler","./accessorSupport/ensureType"],function(e,t,i,n,r,s,o,h,l){l=l.ensureType;var a=e("dojo-debug-messages"),c=function(){},u=i.after,f=0,d=function(e){return e&&e.isInstanceOf&&e.isInstanceOf(v)?!0:!1},m=function(e){return e?d(e)?e.toArray():e.length?Array.prototype.slice.apply(e):[]:[]},g=function(e){return e&&e.length?e[0]:void 0},_=function(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1};_.prototype.preventDefault=function(){this.cancellable&&(this.defaultPrevented=!0)},_.prototype.reset=function(e){this.defaultPrevented=!1,this.item=e};var p=new r(_,function(){this.item=null,this.target=null}),v=s.createSubclass([o],{declaredClass:"esri.core.Collection",properties:{length:{},items:{}},constructor:function(){this.id=(new Date).getTime().toString(16)+"-collection"+f++,this._chgListeners=[],this._notification=null,this._timer=null,this._items=[],this._dispatchColChange=this._dispatchColChange.bind(this)},normalizeCtorArgs:function(e){return e?Array.isArray(e)||e.isInstanceOf&&e.isInstanceOf(v)?{items:e}:e:{}},onchange:null,"onbefore-add":null,"onbefore-remove":null,"onafter-add":null,"onafter-remove":null,length:0,_itemsGetter:function(){return this._items},_itemsSetter:function(e){this._splice(0,this.length,m(e))},on:function(e,i){return t.parse(this,e,i,function(e,t){if("change"===t){e._notification&&e._dispatchColChange();var n={removed:!1,callback:i};return e._chgListeners.push(n),{remove:function(){this.remove=c,n.removed=!0,e._chgListeners.splice(e._chgListeners.indexOf(n),1)}}}return u(e,"on"+t,i,!0)})},hasEventListener:function(e){return"change"===e?this._chgListeners.length>0:this.inherited(arguments)},add:function(e,t){return t=this.getNextIndex(t),this._splice(t,0,[e]),this},addMany:function(e,t){t=this.getNextIndex(t),this._splice(t,0,m(e))},removeAll:function(){return this._splice(0,this.length)||[]},clone:function(){return this._createNewInstance({items:this._items})},concat:function(){var e=m(arguments).map(m);return this._createNewInstance({items:Array.prototype.concat.apply(this._items,e)})},drain:function(e,t){var i,n,r=this.removeAll();for(i=0,n=r.length;n>i;i++)e.call(t,r[i],i,r)},every:function(e,t){return this._items.every(e,t)},filter:function(e,t){var i;return i=2===arguments.length?this._items.filter(e,t):this._items.filter(e),this._createNewInstance({items:i})},find:function(e,t){if("function"!=typeof e)throw new TypeError(e+" is not a function");for(var i,n=this._items,r=0,s=this.length;s>r;r++)if(i=n[r],e.call(t,i,r,n))return i;return void 0},findIndex:function(e,t){if("function"!=typeof e)throw new TypeError(e+" is not a function");var i,n,r=this._items,s=this.length;for(n=0;s>n;n++)if(i=r[n],e.call(t,i,n,r))return n;return-1},forEach:function(e,t){return this._items.forEach(e,t)},getItemAt:function(e){return this._items[e]},getNextIndex:function(e){var t=this.length;return e=null==e?t:e,0>e?e=0:e>t&&(e=t),e},includes:function(e,t){return arguments.length?(t=t||0,-1!==this._items.indexOf(e,t)):!1},indexOf:function(e,t){var i=arguments.length;return 0===i?-1:1===i?this._items.indexOf(e):this._items.indexOf(e,t)},join:function(e){return arguments.length?this._items.join(e):this._items.join()},lastIndexOf:function(e,t){var i=arguments.length;return 1===i?this._items.lastIndexOf(e):2===i?this._items.lastIndexOf(e,t):-1},map:function(e,t){return new v({items:this._items.map(e,t)})},reorder:function(e,t){var i=this.indexOf(e),n=this._items.length-1;return-1===i?void 0:(t=null==t?n:t,0>t?t=0:t>n&&(t=n),i!==t&&(this._splice(i,1),this._splice(t,0,[e])),e)},pop:function(){var e=this._items;return e.length?g(this._splice(this._items.length-1,1)):void 0},push:function(){return this._splice(this._items.length,0,Array.prototype.slice.call(arguments)),this._items.length},reduce:function(e,t){var i=this._items;return 2===arguments.length?i.reduce(e,t):i.reduce(e)},reduceRight:function(e,t){var i=this._items;return 2===arguments.length?i.reduceRight(e,t):i.reduceRight(e)},remove:function(e){var t=this.indexOf(e);return this.removeAt(t)},removeAt:function(e){return e>=0&&e<this.length?g(this._splice(e,1)):void 0},removeMany:function(e){if(!e||!e.length)return e;d(e)&&(e=e.toArray());var t,i,n,r,s=this._items,o=[];for(t=0,i=e.length;i>t;t++)r=e[t],n=s.indexOf(r),n>-1&&(r=g(this._splice(n,1)),r&&o.push(r));return o},shift:function(){return this._items.length?g(this._splice(0,1)):void 0},slice:function(e,t){var i=arguments.length,n=null;return 0===i?n=this._items.slice():1===i?n=this._items.slice(e):2===i&&(n=this._items.slice(e,t)),this._createNewInstance({items:n})},some:function(e,t){return this._items.some(e,t)},sort:function(e){var t=this._splice(0,this._items.length);return t?(arguments.length?t.sort(e):t.sort(),this._splice(0,0,t),this):this},toArray:function(){return this._items.slice()},toLocaleString:function(){return this._items.toLocaleString()},toString:function(){return this._items.toString()},unshift:function(){return this._splice(0,0,Array.prototype.slice.call(arguments)),this._items.length},_createNewInstance:function(e){return new this.constructor(e)},_splice:function(e,t,i){var n,r,s,o,a,c=this._items,u=this.itemType;if(this.hasEventListener("change")&&!this._notification&&(this._notification={listeners:this._chgListeners.slice(),items:c.slice(),changes:[]},this._timer&&this._timer.remove(),this._timer=h.schedule(this._dispatchColChange)),t){if(n=c.splice(e,t),this.hasEventListener("before-remove")){for(a=p.acquire(),a.target=this,a.cancellable=!0,r=0,s=n.length;s>r;r++)o=n[r],a.reset(o),this.emit("before-remove",a),a.defaultPrevented&&(n.splice(r,1),c.splice(e,0,o),e+=1,r-=1,s-=1);p.release(a)}if(this.length=this._items.length,this.hasEventListener("after-remove")){for(a=p.acquire(),a.target=this,a.cancellable=!1,r=0,s=n.length;s>r;r++)o=n[r],a.reset(o),this.emit("after-remove",a);p.release(a)}this._notifyColChange(null,n)}return i&&i.length&&(u&&(i=i.map(l.bind(null,u))),this.hasEventListener("before-add")&&(a=p.acquire(),a.target=this,a.cancellable=!0,i=i.filter(function(e){return a.reset(e),this.emit("before-add",a),!a.defaultPrevented},this),p.release(a)),Array.prototype.splice.apply(c,[e,0].concat(i)),this.length=this._items.length,this.hasEventListener("after-add")&&(a=p.acquire(),a.target=this,a.cancellable=!1,i.forEach(function(e){a.reset(e),this.emit("after-add",a)},this),p.release(a)),this._notifyColChange(i,null)),n},_notifyColChange:function(e,t){var i=this.hasEventListener("change");i&&this._notification.changes.push({added:e,removed:t})},_dispatchColChange:function(){if(this._timer&&(this._timer.remove(),this._timer=null),this._notification){var e,t,i,r,s,o,h,l=this._notification,a=l.items,c=l.changes,u=n.acquire(),f=n.acquire(),d=n.acquire();for(this._notification=null,e=0,t=c.length;t>e;e++){if(r=c[e],r.added){if(s=r.added,f.length>0)for(i=s.length-1;i>=0;i--)o=f.indexOf(s[i]),-1!==o&&(s.splice(i,1),d.push(f.splice(o,1)[0]));u=u.concat(s)}if(r.removed){if(s=r.removed,u.length>0||d.length>0)for(i=s.length-1;i>=0;i--)o=u.indexOf(s[i]),-1!==o?(u.splice(o,1),s.splice(i,1)):(o=d.indexOf(s[i]),-1!==o&&d.splice(o,1));f=f.concat(s)}}if(d=d.filter(function(e){return a.indexOf(e)!==this._items.indexOf(e)},this),l.listeners&&(u.length||f.length||d.length))for(r={target:this,added:u,removed:f,moved:d},e=0,t=l.listeners.length;t>e;e++)h=l.listeners[e],h.removed||h.callback.call(this,r);n.release(u),n.release(f),n.release(d)}}}),y={};return v.ofType=function(e){var t=e.prototype.declaredClass;if(a&&!t)throw new Error("invalid type parameter, no declaredClass defined");if(!t)return v;if(t&&y[t]){if(a&&y[t].prototype.itemType!==e)throw new Error("The collection of type "+e.declaredClass+" already exists but the class implementation defers, due to a conflict of declaredClass values");return y[t]}var i=v.createSubclass({declaredClass:"esri.core.Collection<"+t+">"});return Object.defineProperty(i.prototype,"itemType",{value:e,configurable:!1,enumerable:!1,writable:!1}),y[t]=i,i},v});