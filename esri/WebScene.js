// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/extendsHelper","./core/tsSupport/decorateHelper","./Map","./core/Error","./core/requireUtils","./core/promiseUtils","./core/JSONSupporter","./core/LoadableAccessoire","./Basemap","./Viewpoint","./geometry/support/jsonUtils","./geometry/support/castUtils","./geometry/SpatialReference","./webscene/Presentation","./webscene/InitialViewProperties","./webscene/Environment","./portal/PortalItem","./portal/Portal","dojo/_base/lang","./core/accessoireSupport/typescript"],function(e,r,t,i,o,n,a,p,s,l,u,c,h,d,y,v,m,f,g,S,w,b){function A(){return o}var O={major:1,minor:3},M=function(r){function o(){r.call(this),this.basemap=null,this.clippingArea=null,this.clippingEnabled=null,this.version=null,this.authoringApp=null,this.authoringAppVersion=null,this.presentation=null,this.initialViewProperties=null,this.portalItem=null,this.resourceInfo=null}return t(o,r),o.prototype.initialize=function(){if(this.resourceInfo){var e=void 0;try{e=this._validateJSON(this.resourceInfo)}catch(r){return void this.addResolvingPromise(p.reject(r))}this.read(e)}},o.prototype.getDefaults=function(){return w.mixin(this.inherited(arguments),{presentation:{},initialViewProperties:{},version:{major:O.major,minor:O.minor}})},o.prototype.load=function(){return this.addResolvingPromise(this._loadFromSource()),this},o.prototype.toJSON=function(){var e={};this.initialViewProperties&&this.initialViewProperties.environment&&(e.environment=this.initialViewProperties.environment.toJSON()),this.initialViewProperties&&this.initialViewProperties.viewpoint&&(e.viewpoint=this.initialViewProperties.viewpoint.toJSON());var r={version:this.version.major+"."+this.version.minor,baseMap:this.basemap.toJSON(),operationalLayers:[],presentation:this.presentation.toJSON(),viewingMode:this.initialViewProperties?this.initialViewProperties.viewingMode:"global"};return r.spatialReference=this.initialViewProperties&&this.initialViewProperties.spatialReference?this.initialViewProperties.spatialReference.toJSON():y.WebMercator.toJSON(),0!==Object.keys(e).length&&(r.initialState=e),null!=this.authoringApp&&(r.authoringApp=this.authoringApp),null!=this.authoringAppVersion&&(r.authoringAppVersion=this.authoringAppVersion),null!=this.clippingArea&&(r.clippingArea={geometry:this.clippingArea.toJSON(),clip:!!this.clippingEnabled}),r},o.prototype.read=function(e){if(this.inherited(arguments),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)){var r=e.baseMap.elevationLayers.map(function(e){return{id:e.id}});this.presentation.slides.forEach(function(e){e.visibleLayers.addMany(r)})}return this},o.prototype._loadFromSource=function(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):p.resolve(null)},o.prototype._readAndLoadFromJSON=function(e){var r=this._validateJSON(e);return this.read(r),this._loadFromJSON(r)},o.prototype._loadFromJSON=function(r){var t=this,i=J.layerCreatorParams();return this.portalItem&&(i.portal=this.portalItem.portal||S.getDefault()),a.when(e,"./portal/creators/layersCreator").then(function(e){var o=[],n=r.operationalLayers,a=[];r.baseMap&&Array.isArray(r.baseMap.elevationLayers)&&a.push.apply(a,r.baseMap.elevationLayers);var s=function(e){return e.layers&&(e.layers=e.layers.filter(s)),"ArcGISTiledElevationServiceLayer"===e.layerType?(a.push(e),!1):!0};if(n&&(n=n.filter(s)),a.length>0){var l=w.mixin({},i);l.defaultLayerType="ArcGISTiledElevationServiceLayer",o.push.apply(o,e.populateOperationalLayers(t.ground.layers,a,l))}return n&&n.length>0&&o.push.apply(o,e.populateOperationalLayers(t.layers,n,i)),p.eachAlways(o).then(function(){})})},o.prototype._loadFromItem=function(e){var r=this;return e.load().then(function(e){return e.fetchData()}).then(function(e){return r.resourceInfo=e,r._readAndLoadFromJSON(e)})},o.prototype._validateVersion=function(e){var r=e.split("."),t=r[0],i=r[1],o=/^\s*\d+\s*$/;if(!t||!t.match||!t.match(o))throw new n("webscene:invalid-version","Expected major version to be a number, but got '"+e+"'",{version:e});if(!i||!i.match||!i.match(o))throw new n("webscene:invalid-version","Expected minor version to be a number, but got '"+e+"'",{version:e});var a=parseInt(t,10),p=parseInt(i,10);if(a!==O.major)throw new n("webscene:unsupported-version","Required major webscene version is '"+O.major+"', but got '"+e+"'",{version:e});return{major:a,minor:p}},o.prototype._validateJSON=function(e){var r=this._sanitizeJSON(e),t=this._validateVersion(r.version);return r.version=t.major+"."+t.minor,1===t.major&&t.minor<=2&&delete r.spatialReference,r},o.prototype._sanitizeJSON=function(e){return{version:e.version||"0.0",baseMap:e.baseMap,operationalLayers:e.operationalLayers,authoringApp:e.authoringApp||"",authoringAppVersion:e.authoringAppVersion||"",viewingMode:e.viewingMode||"",presentation:e.presentation&&v.sanitizeJSON(e.presentation)||{},initialState:e.initialState,spatialReference:e.spatialReference||y.WebMercator.toJSON(),clippingArea:e.clippingArea}},o.fromJSON=function(e){return new o({resourceInfo:e})},i([b.shared("esri.WebScene")],o.prototype,"declaredClass",void 0),i([b.shared({reader:{exclude:["baseMap","operationalLayers","spatialReference","initialState","viewingMode"],add:["basemap","clippingEnabled","initialViewProperties"]}})],o.prototype,"classMetadata",void 0),i([b.property({reader:function(e,r){if(!r.baseMap||!Array.isArray(r.baseMap.baseMapLayers)||0===r.baseMap.baseMapLayers.length)return null;var t=w.mixin({},r.baseMap);return delete t.elevationLayers,u.fromJSON(t)}})],o.prototype,"basemap",void 0),i([b.property({reader:function(e){return e&&e.geometry?h.fromJSON(e.geometry):null},setter:function(e){return d.cast(e)}})],o.prototype,"clippingArea",void 0),i([b.property({value:!1,reader:function(e,r){return r&&r.clippingArea?!!r.clippingArea.clip:void 0}})],o.prototype,"clippingEnabled",void 0),i([b.property({readOnly:!0,reader:function(e){var r=e.split("."),t=r[0],i=r[1];return{major:parseInt(t,10),minor:parseInt(i,10)}}})],o.prototype,"version",void 0),i([b.property()],o.prototype,"authoringApp",void 0),i([b.property()],o.prototype,"authoringAppVersion",void 0),i([b.property({type:v})],o.prototype,"presentation",void 0),i([b.property({type:m,reader:function(e,r){var t={};return r.initialState&&r.initialState.environment&&(t.environment=f.fromJSON(r.initialState.environment)),r.spatialReference&&(t.spatialReference=y.fromJSON(r.spatialReference)),r.viewingMode&&(t.viewingMode=r.viewingMode),r.initialState&&r.initialState.viewpoint&&(t.viewpoint=c.fromJSON(r.initialState.viewpoint)),new m(t)}})],o.prototype,"initialViewProperties",void 0),i([b.property({type:g})],o.prototype,"portalItem",void 0),i([b.property()],o.prototype,"resourceInfo",void 0),o=i([b.subclass([l,s])],o)}(A()),J=function(){function e(){}return e.propertyFilter=function(r,t){var i=t;switch(r.layerType){case"ArcGISFeatureLayer":i=e._featureLayerPropertyFilter(r,t)}return i},e.layerCreatorParams=function(){return{propertyFilter:e.propertyFilter}},e._featureLayerPropertyFilter=function(e,r){var t=0;return r.mode=t,r.returnZ=!0,r.outFields=["*"],r},e}();return M});