// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["require","dojo/_base/url","dojo/Deferred","../../config","../../kernel","../../core/declare","../../core/urlUtils","../../core/promiseUtils","../../core/requireUtils","../../request","./VectorTileTokenHandler"],function(e,t,r,i,n,s,o,l,a,u,c){var f=s(String,{constructor:function(e,t){this.value=e,this.token=t},valueOf:function(){var e=this.value,t=this.token;if(!t){var r=n.id&&n.id.findCredential(e);t=r&&r.token||null}return t&&(e+=(-1===e.indexOf("?")?"?":"&")+"token="+t),e},toString:function(){return this.valueOf()},replace:function(e,t){return String.prototype.replace.call(this.valueOf(),e,t)}}),h=s([],{loadMetadata:function(t,r,i){var n=null,s=i&&i.credential;return l.resolve(t).then(function(){return this._vectorTile?this._vectorTile:a.when(e,"../../views/2d/layers/vector-tile")}.bind(this)).then(function(e){this._vectorTile=e,this._vectorTile.config.ACCESS_TOKEN=r;var i;return this._vectorTile.tokenHandler?i=this._vectorTile.tokenHandler:(i=new c,this._vectorTile.tokenHandler=i),s&&i.addCredential(s),"string"!=typeof t?t:(n=h.isMapboxUrl(t)?this._vectorTile.normalizeStyleURL(t,r):o.normalize(t).replace(/\/*$/,""))?(this._corsify(n),u(this._appendToken(n,s),{query:{f:"json"},responseType:"json"}).then(function(e){return e.data})):void 0}.bind(this)).then(function(e){return this._processMetadata(n,e,i)}.bind(this)).then(function(e){return this._loadStyle(e,i)}.bind(this))},_configureStyle:function(e,t){var r=e.layerDefinition,i=e.style,n=e.serviceUrl,s=e.styleUrl;if(r&&i&&i.sources.esri){var o=r.tilejson||"2.0.0",l=r.tileInfo&&r.tileInfo.format||"pbf",a=r.tileMap?this._getAbsolutePath(r.tileMap,n):null,u=(r.tiles||[]).map(function(e){return new f(this._getAbsolutePath(e.valueOf(),n),t&&t.credential&&t.credential.token)}.bind(this));i.sources.esri={type:"vector",scheme:"xyz",tilejson:o,format:l,index:a,tiles:u,description:r.description,name:r.name},i.glyphs=this._corsify(this._getAbsolutePath(i.glyphs,s)),i.sprite=this._corsify(this._getAbsolutePath(i.sprite,s))}return{style:i,layerDefinition:r,serviceUrl:n,styleUrl:s}},_loadStyle:function(e,t){var i=new r,s=e.style,o=s.sources;return t&&t.tileServers&&Object.getOwnPropertyNames(o).forEach(function(r){var i=o[r],n=t.tileServers.map(function(r){return new f(this._getAbsolutePath(r,e.serviceUrl,t))}.bind(this));i.tiles=n,n.forEach(this._corsify)}.bind(this)),this._vectorTile.identityManager=n.id,i.resolve(e),i.promise},_processMetadata:function(e,t,r){var i,n,s,o,l=r&&r.credential;return t&&t.currentVersion?(i=t,s=e,o=this._getAbsolutePath(t.defaultStyles,s),this._corsify(o),u(this._appendToken(o,l),{query:{f:"json"},responseType:"json"}).then(function(e){return n=e.data,this._configureStyle({style:n,layerDefinition:i,styleUrl:o,serviceUrl:s},r)}.bind(this))):(n=t,o=e,t&&t.sources&&t.sources.esri&&t.sources.esri.url?(s=this._getAbsolutePath(t.sources.esri.url,o),this._corsify(s),u(this._appendToken(s,l),{query:{f:"json"},responseType:"json"}).then(function(e){return i=e.data,this._configureStyle({style:n,layerDefinition:i,styleUrl:o,serviceUrl:s},r)}.bind(this))):this._configureStyle({style:n,styleUrl:o}))},_appendToken:function(e,t){return t&&t.token&&-1===e.indexOf("token=")?e+=(-1===e.indexOf("?")?"?":"&")+"token="+t.token:e},_corsify:function(e){e=e.valueOf();var r=i.request.corsEnabledServers;if(!o.canUseXhr(e)){var n=new t(e);n=(n.host+(n.port?":"+n.port:"")).toLowerCase(),-1===r.indexOf(n)&&r.push(n)}return e},_getAbsolutePath:function(e,t){var r;if(t=t||"",t=o.urlToObject(t).path,/^https?:\/\//i.test(e))r=e;else{if(0===e.indexOf("//"))return location.protocol+e;t=t.replace(/(\/+\w+\.\w+)$/,""),/\/+$/.test(t)||(t+="/"),0===e.indexOf("/")?(e=e.substring(1),r=t+e):r=t+e}return o.normalize(r)}});return h.isMapboxUrl=function(e){return e.search(/^mapbox:\/\/styles\//)>-1},h.getCredentialFromUrl=function(e){var t,r=e;if("string"==typeof e&&!h.isMapboxUrl(r)){var i=o.urlToObject(r);i.query&&i.query.token&&(t={url:i.path,token:i.query.token})}return t},h});