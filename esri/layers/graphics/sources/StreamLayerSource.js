// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["../../../core/declare","dojo/_base/lang","dojo/Deferred","../../../core/Accessoire","../../../core/AccessoirePromise","../../../core/urlUtils","../../../core/promiseUtils","../../support/WebSocketConnector","../../../tasks/QueryTask","../../../request"],function(e,t,r,n,i,o,s,a,l,u){var c=e([n,i],{classMetadata:{properties:{url:{dependsOn:["layerDefinition"]},parsedUrl:{dependsOn:["url"]},connectionInfo:{dependsOn:["layerDefinition"]}}},getDefaults:function(e){var r=this.inherited(arguments),n=e.layer;return n&&(r=t.mixin(r,{url:n.url,connectionInfo:{direction:n.socketDirection,socketUrl:n.socketUrl}})),r},initialize:function(){this.addResolvingPromise(this._fetchLayers())},_connectionInfoGetter:function(){if(this.layer.hasMemorySource||this.layer.socketUrl)return{serviceSocketUrls:[this.layer.socketUrl]};var e,t,r,n,i={},s=this.layerDefinition,a=[],l=[],u=[];if(s.streamUrls&&s.streamUrls.forEach(function(e){"ws"===e.transport&&(a=e.urls,i.token=e.token)},this),a.forEach(function(e){0===e.lastIndexOf("wss",0)?u.push(e):l.push(e)}),e="https"===o.appUrl.scheme||0===this.url.lastIndexOf("https:",0)?u:0===l.length?u:l,e&&e.length>1)for(t=0;t<e.length-1;t++)r=t+Math.floor(Math.random()*(e.length-t)),n=e[r],e[r]=e[t],e[t]=n;return i.serviceSocketUrls=e,i},_latestUrlGetter:function(){var e=this.layerDefinition,t=e.keepLatestArchive&&e.keepLatestArchive.featuresUrl;return t=t?t:null},_latestQueryTaskGetter:function(){var e=this.latestUrl;return e?new l(e):null},_relatedFeaturesInfoGetter:function(){var e=this.layerDefinition||{},t=e.relatedFeatures;return t=t&&t.featuresUrl?t:null},_relatedFeaturesQueryTaskGetter:function(){var e=this.relatedFeaturesInfo,t=e?e.featuresUrl:null;return t?new l(t):null},_parsedUrlGetter:function(){return this.url?o.urlToObject(this.url):null},url:null,createWebSocketConnector:function(e){var n=this,i=new r;return n.then(function(){var r,o,s,l,u=n.connectionInfo,c=n.layer.spatialReference,h={};try{r=n.makeFilter()}catch(f){return void i.reject(f)}u?(u.socketUrl?s=[u.socketUrl]:u.serviceSocketUrls&&(s=u.serviceSocketUrls.map(function(e){return e+"/"+n.layer.socketDirection})),h.socketUrls=s,(r&&(r.where||r.geometry||r.outFields)||u.token)&&(o=t.mixin(o||{},{where:r.where,geometry:r.geometry,outFields:r.outFields,token:u.token})),e&&c&&e.wkid!==c.wkid&&(o=t.mixin(o||{},{outSR:e.wkid})),h.queryParams=o,h.layerSource=n,l=new a(h),i.resolve(l)):i.reject(new Error("No web socket urls found"))}),i.promise},getWebSocketToken:function(){return this._fetchLayer().then(function(){var e=null;return this.layerDefinition.streamUrls&&this.layerDefinition.streamUrls.some(function(t){return"ws"===t.transport?(e=t.token,!0):void 0},this),e}.bind(this))},makeFilter:function(e){var r,n=this.layer,i=null,o=null;return e?(e.hasOwnProperty("definitionExpression")&&(r=t.mixin(r||{},{where:e.definitionExpression})),e.hasOwnProperty("geometryDefinition")&&(i=e.geometryDefinition,i&&(i=i),r=t.mixin(r||{},{geometry:i}))):(n.hasOwnProperty("definitionExpression")&&n.definitionExpression&&(r=t.mixin(r||{},{where:n.definitionExpression})),n.hasOwnProperty("geometryDefinition")&&n.geometryDefinition&&(i=JSON.stringify(n.geometryDefinition.toJSON()),r=t.mixin(r||{},{geometry:i}))),n.hasOwnProperty("outFields")&&(n.outFields&&"*"!==n.outFields[0]&&(o=n.outFields.join(",")),r=t.mixin(r||{},{outFields:o})),r},_fetchLayers:function(){return this._fetchStreamLayer().then(function(e){return e.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),this.layerDefinition=e.data,this._fetchArchiveLayer()}.bind(this)).then(function(e){return this.archivedLayerDefinition=e&&e.data,this._fetchRelatedLayer()}.bind(this)).then(function(e){this.relatedLayerDefinition=e&&e.data}.bind(this))},_fetchStreamLayer:function(){return this._requestServiceDefinition({url:this.layer.parsedUrl.path,content:t.mixin({f:"json"},this.layer.parsedUrl.query)})},_fetchArchiveLayer:function(){var e=this.latestUrl;return e?this._requestServiceDefinition({url:e}):s.resolve()},_fetchRelatedLayer:function(){var e=this.relatedFeaturesInfo;return e?this._requestServiceDefinition({url:e.featuresUrl}):s.resolve()},_requestServiceDefinition:function(e){return e&&e.url?u(e.url,{query:t.mixin(e.content||{},{f:"json"}),responseType:"json",callbackParamName:"callback"}):s.reject(new Error("url is a required options property"))}});return c});