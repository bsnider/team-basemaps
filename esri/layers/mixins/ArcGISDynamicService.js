// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/_base/lang","./ArcGISMapService","../../PopupTemplate","../../core/Accessor","../../core/JSONSupport"],function(e,r,i,n,t){var s={visible:"visibleSublayers",definitionExpression:"layerDefs"},a=function(e){return function(r){var i=this._layer;i&&this._get(e)!==r&&(this._set(e,r),i.exportImageParameters.notifyChange(s[e]))}},l=t.createSubclass({properties:{definitionExpression:{value:null,set:a("definitionExpression")},id:{readOnly:!0},minScale:{readOnly:!0},maxScale:{readOnly:!0},popupTemplate:{type:i},url:{get:function(){return this._layer.parsedUrl.path+"/"+this.id}},title:{value:null},visible:{type:Boolean,set:a("visible")}},constructor:function(e){Object.defineProperty(this,"_layer",{value:e.layer,enumerable:!1,writable:!1}),delete e.layer}}),u=l.createSubclass({properties:{sublayers:{readOnly:!0}}}),o=function(e,r){e&&r&&["definitionExpression","title","visible","url","popupTemplate"].filter(function(e){return null!=r[e]}).forEach(function(i){e[i]=r[i]})},c=function(e,r){var i=function(r){e(r),r.sublayers&&r.sublayers.forEach(i)};r.forEach(i)},y=function(e){var r=[];return c(function(e){r.push(e)},e),r},p=function(e){return function(r){var i=e.map(function(e){return new e({layer:this})},this);if(!r)return i;var n=r.reduce(function(e,r){return null!=r.id&&(e[r.id]=r),e},{});return c(function(e){null!=n[e.id]?o(e,n[e.id]):e.visible=!1},i),i}},f=n.createSubclass({declaredClass:"esri.layers.mixins.ArcGISDynamicService::ExportImageParameters",properties:{layer:{},layers:{readOnly:!0,dependsOn:["visibleSublayers"],get:function(){var e=this.visibleSublayers;return e?e.length?"show:"+e.map(function(e){return e.id}).join(","):"show:-1":null}},layerDefs:{readOnly:!0,dependsOn:["visibleSublayers"],get:function(){var e=this.get("visibleSublayers").filter(function(e){return null!=e.definitionExpression});if(!e.length)return null;var r=/[:;]/,i=e.map(function(e){return e.definitionExpression}).some(r.test.bind(r));return i?JSON.stringify(e.reduce(function(e,r){return e[r.id]=r.definitionExpression,e},{})):e.map(function(e){return e.id+":"+e.definitionExpression}).join(";")}},version:{value:0,dependsOn:["layers","layerDefs","layer.dpi","layer.imageFormat","layer.imageTransparency","layer.gdbVersion"],get:function(){return this._get("version")+1}},visibleSublayers:{readOnly:!0,dependsOn:["layer.sublayers"],get:function(){var e=this.get("layer.sublayers"),r=[],i=function(e){e.visible&&(e.sublayers?e.sublayers.forEach(i):r.push(e))};return e.forEach(i),r}}},toJSON:function(){var e=this.layer;return{dpi:e.dpi,format:e.imageFormat,transparent:e.imageTransparency,gdbVersion:e.gdbVersion||null,layerTimeOptions:this.layerTimeOptions,layers:this.layers,layerDefs:this.layerDefs}}}),d=r.createSubclass({declaredClass:"esri.layers.mixins.ArcGISDynamicService",getDefaults:function(){return e.mixin(this.inherited(arguments),{exportImageParameters:{layer:this}})},_castSublayers:null,properties:{allSublayers:{readOnly:!0,dependsOn:["sublayers"],get:function(){var e=this.sublayers;return e?y(e):[]}},dpi:96,exportImageParameters:{value:null,type:f,readOnly:!0},gdbVersion:null,imageFormat:"png8",imageTransparency:!0,loaded:{value:!1},supportsRotation:{dependsOn:["version"],readOnly:!0,get:function(){return this.version>=10.3}},sublayers:{value:null,dependsOn:["loaded"],cast:function(e){return this._castSublayers?this._castSublayers(e):e},get:function(){return this._get("sublayers")},json:{readFrom:["layers","visibleLayers"],read:function(e,r){var n;if(r.layers){var n={},t=[];r.layers.map(function(e){var r={properties:{id:{value:e.id},visible:{value:e.defaultVisibility},minScale:{value:e.minScale},maxScale:{value:e.maxScale},popupTemplate:{value:e.popupInfo&&i.fromJSON(e.popupInfo)||null},title:{value:e.name}}};e.subLayerIds?(r.properties.sublayers={get:function(){return e.subLayerIds.map(function(e){return new n[e]({layer:this._layer})},this)}},r=u.createSubclass(r)):r=l.createSubclass(r),n[e.id]=r,-1===e.parentLayerId&&t.push(r)}),this._subLayerDefinitions=n,this._castSublayers=p(t)}else n=this._subLayerDefinitions;var s=this.__accessor__.store;if(s.has("sublayers")&&[s._values].concat(s._originStores).forEach(function(e){e.sublayers&&(e.sublayers=this._castSublayers(e.sublayers))},this),this._subLayerDefinitions&&r.visibleLayers){var a=this._get("sublayers");if(a)return c(function(e){e.visible=r.visibleLayers.indexOf(e.id)>-1?!0:!1},a),a}return null}}}},findSublayerById:function(e){var r=this.allSublayers;if(!r)return null;var i=null;return r.some(function(r){return r.id===e?(i=r,!0):!1}),i},getExportImageParameters:function(r){var i=this.version<10?r.extent:r.extent.clone().shiftCentralMeridian(),n=r.width,t=r.height,s=i&&i.spatialReference,a=null!=r.rotation&&0!==r.rotation&&this.supportsRotation?{rotation:-r.rotation}:{};return s=s&&(s.wkid||JSON.stringify(s.toJSON())),e.mixin({bbox:i&&i.xmin+","+i.ymin+","+i.xmax+","+i.ymax,bboxSR:s,imageSR:s,size:n+","+t},a,this.exportImageParameters.toJSON())}});return d});