// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.0/esri/copyright.txt for details.

define(["dojo/_base/array","../core/declare","dojo/_base/lang","dojo/Deferred","dojo/io-query","../request","../geometry/support/normalizeUtils","../layers/MapImageLayer","../layers/support/MapImage","./Task","./support/DataFile","./support/Date","./support/FeatureSet","./support/GPMessage","./support/GPResultImageLayer","./support/JobInfo","./support/LinearUnit","./support/ParameterValue","./support/RasterData"],function(e,t,a,s,r,n,i,l,u,o,c,p,d,h,m,f,b,S,R){var g=t(o,{declaredClass:"esri.tasks.Geoprocessor",url:null,constructor:function(){this._updateTimers=[],this._handleExecuteResponse=this._handleExecuteResponse.bind(this),this._handleGetResultImageResponse=this._handleGetResultImageResponse.bind(this),this._handleGetResultDataResponse=this._handleGetResultDataResponse.bind(this)},updateDelay:1e3,processSpatialReference:null,outSpatialReference:null,__msigns:[{n:"execute",c:1,a:[{i:0,p:["*"]}],e:2},{n:"submitJob",c:1,a:[{i:0,p:["*"]}],e:3}],_gpEncode:function(t,s,r){var n;for(n in t){var i=t[n];a.isArray(i)?t[n]=JSON.stringify(e.map(i,function(e){return this._gpEncode({item:e},!0).item},this)):i instanceof Date&&(t[n]=i.getTime())}return this._encode(t,s,r)},_decode:function(t){var s,r=t.dataType,n=S.fromJSON(t);if(-1!==e.indexOf(["GPBoolean","GPDouble","GPLong","GPString"],r))return n;if("GPLinearUnit"===r)n.value=b.fromJSON(n.value);else if("GPFeatureRecordSetLayer"===r||"GPRecordSet"===r)n.value=d.fromJSON(n.value);else if("GPDataFile"===r)n.value=c.fromJSON(n.value);else if("GPDate"===r)s=n.value,n.value=a.isString(s)?p.fromJSON({date:s}):Date.fromJSON(s);else if("GPRasterData"===r||"GPRasterDataLayer"===r){var i=t.value.mapImage;n.value=i?u.fromJSON(i):R.fromJSON(n.value)}else if(-1!==r.indexOf("GPMultiValue:")){var l=r.split(":")[1];s=n.value,n.value=e.map(s,function(e){return this._decode({paramName:"_name",dataType:l,value:e}).value},this)}else console.log(this.declaredClass+" : GP Data type not handled. : "+n.dataType),n=null;return n},submitJob:function(e,t){var r=this.outSpatialReference,i=t.assembly,l=this._gpEncode(a.mixin({},this.parsedUrl.query,{f:"json","env:outSR":r?r.wkid||JSON.stringify(r.toJSON()):null,"env:processSR":this.processSpatialReference?this.processSpatialReference.wkid||JSON.stringify(this.processSpatialReference.toJSON()):null},e),null,i&&i[0]),u=new s,o=this._jobUpdateHandler.bind(this);return n(this.parsedUrl.path+"/submitJob",{query:l,callbackParamName:"callback"}).then(function(e){o(e.data,u)}).then(null,function(e){u.reject(e)}),u.promise},_jobUpdateHandler:function(e,t){var a,s,r=e.jobId,n=f.fromJSON(e);switch(clearTimeout(this._updateTimers[r]),this._updateTimers[r]=null,t.progress(n),n.jobStatus){case"job-submitted":case"job-executing":case"job-waiting":case"job-new":a=this._getJobStatus.bind(this),s=this._jobUpdateHandler.bind(this),this._updateTimers[r]=setTimeout(function(){a(r).then(function(e){s(e,t)})},this.updateDelay);break;default:t.resolve(n)}},_getJobStatus:function(e){return n(this.parsedUrl.path+"/jobs/"+e,{query:a.mixin({},this.parsedUrl.query,{f:"json"}),callbackParamName:"callback"}).then(function(e){return e.data})},getResultData:function(e,t){return n(this.parsedUrl.path+"/jobs/"+e+"/results/"+t,{query:a.mixin({},this.parsedUrl.query,{f:"json",returnType:"data"}),callbackParamName:"callback"}).then(this._handleGetResultDataResponse)},_handleGetResultDataResponse:function(e){return this._decode(e.data)},checkJobStatus:function(e){return n(this.parsedUrl.path+"/jobs/"+e,{query:a.mixin({},this.parsedUrl.query,{f:"json"}),callbackParamName:"callback"}).then(this._handleCheckJobStatusResponse)},_handleCheckJobStatusResponse:function(e){return f.fromJSON(e.data)},cancelJob:function(e){return n(this.parsedUrl.path+"/jobs/"+e+"/cancel",{query:a.mixin({},this.parsedUrl.query,{f:"json"}),callbackParamName:"callback"}).then(function(e){return e.data})},execute:function(e,t){var s=this.outSpatialReference,r=t.assembly,i=this._gpEncode(a.mixin({},this.parsedUrl.query,{f:"json","env:outSR":s?s.wkid||JSON.stringify(s.toJSON()):null,"env:processSR":this.processSpatialReference?this.processSpatialReference.wkid||JSON.stringify(this.processSpatialReference.toJSON()):null},e),null,r&&r[0]);return n(this.parsedUrl.path+"/execute",{query:i,callbackParamName:"callback"}).then(this._handleExecuteResponse)},_handleExecuteResponse:function(e){var t=e.data,a=t.results||[],s=t.messages||[];return{results:a.map(this._decode,this),messages:s.map(h.fromJSON)}},getResultImage:function(e,t,s){var r=this._gpEncode(a.mixin({},this.parsedUrl.query,{f:"json"},s.toJSON()));return n(this.parsedUrl.path+"/jobs/"+e+"/results/"+t,{query:r,callbackParamName:"callback"}).then(this._handleGetResultImageResponse)},_handleGetResultImageResponse:function(e){return this._decode(e.data)},cancelJobStatusUpdates:function(e){clearTimeout(this._updateTimers[e]),this._updateTimers[e]=null},getResultImageLayer:function(e,t,a){var s,n;if(null==t){var i=this.parsedUrl.path.indexOf("/GPServer/");s=this.parsedUrl.path.substring(0,i)+"/MapServer/jobs/"+e}else s=this.parsedUrl.path+"/jobs/"+e+"/results/"+t;return this.parsedUrl.query&&(s+="?"+r.objectToQuery(this.parsedUrl.query)),n=null==t?new l(s,{imageParameters:a}):new m(s,{imageParameters:a})}});return i._createWrappers(g),g});